<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
:root{
  --primary:#004aad; --accent:#ffcc33; --bg:#f5f9ff; --card:#fff;
}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:var(--primary);color:#fff;padding:16px;text-align:center;display:flex;align-items:center;gap:10px;justify-content:center;font-weight:700;}
header img{height:40px;}
.wrap{max-width:1200px;margin:20px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:14px;}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.warn{background:#ff7043}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
}
</style>
</head>
<body>
<header id="instituteHeader">
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">â€”</span>
</header>
<div class="wrap">

  <!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div><strong>Ø£Ø¶Ù Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</strong></div>
    </div>
    <form id="teacherForm" style="margin-top:12px">
      <div style="display:flex;flex-wrap:wrap;gap:10px">
        <div style="flex:1">
          <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
          <input id="teacherName" type="text" required>
        </div>
        <div style="flex:1">
          <label>Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="teacherPhone" type="tel">
        </div>
        <div style="flex:1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ</label>
          <input id="teacherNote" type="text">
        </div>
        <div style="flex-basis:100%;display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button type="submit" class="btn">âœ… Ø­ÙØ¸</button>
          <button type="button" id="clearTeacherForm" class="btn ghost">Ù…Ø³Ø­</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</strong> <span id="totalTeachers" class="badge">0</span></div>
      <div class="no-print">
        <input type="text" id="searchTeacher" placeholder="Ø¨Ø­Ø«..." style="padding:6px;border-radius:6px;border:1px solid #ddd"/>
        <button id="applyTeacherFilter" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
    </div>
    <table class="table" id="teachersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¹Ø¯Ø¯ Ø·Ù„Ø§Ø¨Ù‡</th><th>Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù‡</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø¹Ù‡Ø¯</th><th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°</strong>
      <div>
        <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const teacherForm=document.getElementById('teacherForm');
const teachersTableBody=document.querySelector('#teachersTable tbody');
const totalTeachers=document.getElementById('totalTeachers');
const clearTeacherForm=document.getElementById('clearTeacherForm');
const searchTeacher=document.getElementById('searchTeacher');
const applyTeacherFilter=document.getElementById('applyTeacherFilter');
const modal=document.getElementById('modal');
const modalBody=document.getElementById('modalBody');
const modalTitle=document.getElementById('modalTitle');
const closeModal=document.getElementById('closeModal');
const instituteNameHeader=document.getElementById('instituteName');
const instituteLogo=document.getElementById('instituteLogo');

let teachersCache=[]; 
let studentsCache=[]; 
let settingsData={};

onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href='login.html'; } 
  else{ document.body.style.visibility='visible'; initPage(); }
});

async function initPage(){
  await loadSettings();
  await loadTeachers();
  await loadStudents();
  renderTeachers();
}

async function loadSettings(){
  try{
    const snap = await getDoc(doc(db,'settings','info'));
    if(snap.exists()){ settingsData=snap.data(); }
    if(settingsData.name) instituteNameHeader.textContent=settingsData.name;
    if(settingsData.logo) instituteLogo.src=settingsData.logo;
    if(settingsData.colors){
      document.documentElement.style.setProperty('--primary',settingsData.colors.primary||'#004aad');
      document.documentElement.style.setProperty('--accent',settingsData.colors.accent||'#ffcc33');
      document.documentElement.style.setProperty('--bg',settingsData.colors.bg||'#f5f9ff');
      document.documentElement.style.setProperty('--card',settingsData.colors.card||'#fff');
    }
  }catch(e){console.error('loadSettings',e);}
}

async function loadTeachers(){
  teachersCache=[];
  try{
    const snap = await getDocs(collection(db,'teachers'));
    snap.forEach(d=>teachersCache.push({id:d.id,...d.data()}));
  }catch(e){console.error(e);}
}

async function loadStudents(){
  studentsCache=[];
  try{
    const snap = await getDocs(collection(db,'students'));
    snap.forEach(d=>studentsCache.push({id:d.id,...d.data()}));
  }catch(e){console.error(e);}
}

/* --- Save teacher --- */
teacherForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=document.getElementById('teacherName').value.trim();
  const phone=document.getElementById('teacherPhone').value.trim();
  const note=document.getElementById('teacherNote').value.trim();
  if(!name){alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨'); return;}
  try{
    await addDoc(collection(db,'teachers'),{name,phone,note,createdAt:new Date()});
    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³ØªØ§Ø°'); teacherForm.reset(); loadTeachers(); renderTeachers();
  }catch(e){console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');}
});

clearTeacherForm.addEventListener('click',()=>teacherForm.reset());

/* --- Render teachers --- */
function renderTeachers(filter=''){
  teachersTableBody.innerHTML='';
  teachersCache.forEach(t=>{
    if(filter && !t.name.includes(filter)) return;
    const tr=document.createElement('tr');
    const hisStudents = studentsCache.filter(s=>s.subjects.some(sub=>sub.teacherId===t.id));
    let totalDue=0; let remainingInstitute=0;
    hisStudents.forEach(s=>{
      s.subjects.forEach(sub=>{
        if(sub.teacherId===t.id){
          const paid = sub.fee-(sub.remaining||0);
          const due = (paid* (settingsData.teacherPercent||50)/100);
          totalDue+=due;
          remainingInstitute+=paid-due;
        }
      });
    });
    tr.innerHTML=`<td>${t.name}</td><td>${t.phone||'-'}</td><td>${hisStudents.length}</td><td>${totalDue.toFixed(2)}</td><td>${remainingInstitute.toFixed(2)}</td>
      <td>
        <button class="btn small viewBtn">Ø¹Ø±Ø¶</button>
        <button class="btn small">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn small">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>`;
    const [viewBtn, editBtn, delBtn] = tr.querySelectorAll('button');
    viewBtn.addEventListener('click',()=>showModal(t,hisStudents));
    editBtn.addEventListener('click',()=>editTeacher(t));
    delBtn.addEventListener('click',async()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø° Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
        await deleteDoc(doc(db,'teachers',t.id));
        alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); loadTeachers(); renderTeachers();
      }
    });
    teachersTableBody.appendChild(tr);
  });
  totalTeachers.textContent=teachersCache.length;
}

function showModal(teacher,hisStudents){
  modalTitle.textContent=`Ø£Ø³ØªØ§Ø°: ${teacher.name}`;
  modalBody.innerHTML=`
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${teacher.phone||'-'}</p>
    <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${teacher.note||'-'}</p>
    <h4>Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ¯ÙØ¹Ø§ØªÙ‡Ù…:</h4>
    ${hisStudents.map(s=>{
      const subs=s.subjects.filter(sub=>sub.teacherId===teacher.id);
      return `<div><strong>${s.name}</strong> - ${subs.map(sub=>{
        const paid=sub.fee-(sub.remaining||0);
        const due=(paid*(settingsData.teacherPercent||50)/100).toFixed(2);
        return `${sub.name}: Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù‡ ${due} / ${sub.fee}`;
      }).join('<br>')}</div><hr>`;
    }).join('')}
  `;
  modal.classList.add('open');
}

closeModal.addEventListener('click',()=>modal.classList.remove('open'));

applyTeacherFilter.addEventListener('click',()=>renderTeachers(searchTeacher.value.trim()));

function editTeacher(t){
  document.getElementById('teacherName').value=t.name;
  document.getElementById('teacherPhone').value=t.phone||'';
  document.getElementById('teacherNote').value=t.note||'';
  teacherForm.onsubmit=async e=>{
    e.preventDefault();
    try{
      await updateDoc(doc(db,'teachers',t.id),{
        name:document.getElementById('teacherName').value.trim(),
        phone:document.getElementById('teacherPhone').value.trim(),
        note:document.getElementById('teacherNote').value.trim()
      });
      alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°'); teacherForm.reset(); loadTeachers(); renderTeachers();
    }catch(e){console.error(e);alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');}
  };
}
</script>
</body>
</html>