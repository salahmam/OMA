<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family:'Cairo',sans-serif;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;
  direction:rtl;
  visibility:hidden;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;
  padding:18px 16px;
  text-align:center;
  font-size:20px;
  font-weight:700;
  box-shadow:0 3px 12px rgba(2,20,40,0.08);
}
.wrap{max-width:1200px;margin:22px auto;padding:12px;display:flex;flex-direction:column;gap:18px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input[type="text"], input[type="tel"], input[type="number"], select, textarea{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.warn{background:#ff7043}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.add-subj{display:inline-block;margin-top:6px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.actions button{margin:0 6px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.flex{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
.left,.right{flex:1;display:flex;flex-direction:column;gap:10px}
.subject-field{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</header>
<div class="wrap">

<!-- Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° -->
<div class="card">
  <strong>Ø£Ø¶Ù/ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³ØªØ§Ø°</strong>
  <form id="teacherForm" style="margin-top:12px">
    <div class="form-grid">
      <div class="two">
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input id="teacherName" type="text" required />
      </div>
      <div class="two">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="teacherPhone" type="tel" required />
      </div>
      <div style="width:100%">
        <label>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§</label>
        <div id="teacherSubjectsContainer"></div>
        <button id="addTeacherSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
        <input id="teacherStages" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„Ù‰ØŒ Ø«Ø§Ù†ÙŠØ©" />
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª / Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</label>
        <input id="teacherGroups" type="text" placeholder="Ù…Ø«Ø§Ù„: A, B, 101" />
      </div>
      <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveTeacherBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
        <button id="clearTeacherFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>
  </form>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</strong>
    <span id="totalTeachers" class="badge">0</span>
  </div>
  <table id="teachersTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ù…Ø±Ø§Ø­Ù„</th>
        <th>Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</th>
        <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
<div class="card">
  <strong>Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</strong>
  <table id="teacherPaymentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:8px">
    <p>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù„Øº: <span id="totalAmount">0</span></p>
    <p>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª: <span id="totalPayments">0</span></p>
    <p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø¹Ù‡Ø¯: <span id="remainingAmount">0</span></p>
  </div>
</div>

<div id="modal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user => {
  if(!user){ window.location.href="login.html"; }
  else { document.body.style.visibility="visible"; loadTeachers(); }
});

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©
const teacherForm = document.getElementById("teacherForm");
const teacherSubjectsContainer = document.getElementById("teacherSubjectsContainer");
const addTeacherSubjectBtn = document.getElementById("addTeacherSubjectBtn");
const teachersTableBody = document.querySelector("#teachersTable tbody");
let editingTeacherId = null;

// Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
addTeacherSubjectBtn.addEventListener("click", ()=>{
  const div = document.createElement("div");
  div.classList.add("subject-field");
  div.innerHTML = `
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="teacherSubjName" required />
    <button type="button" class="btn warn small removeSubjBtn">âŒ</button>
  `;
  teacherSubjectsContainer.appendChild(div);
  div.querySelector(".removeSubjBtn").addEventListener("click", ()=>teacherSubjectsContainer.removeChild(div));
});

// Ù…Ø³Ø­ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©
document.getElementById("clearTeacherFormBtn").addEventListener("click", ()=>{
  teacherForm.reset(); teacherSubjectsContainer.innerHTML=""; editingTeacherId=null;
});

// Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø°
teacherForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("teacherName").value.trim();
  const phone = document.getElementById("teacherPhone").value.trim();
  const stages = document.getElementById("teacherStages").value.trim();
  const groups = document.getElementById("teacherGroups").value.trim();
  const subjects = Array.from(document.querySelectorAll(".teacherSubjName")).map(i=>i.value.trim()).filter(s=>s);

  if(!name || !phone || subjects.length===0){ alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"); return; }

  try{
    if(editingTeacherId){
      await updateDoc(doc(db,"teachers",editingTeacherId), {name,phone,stages,groups,subjects});
      editingTeacherId=null;
    } else {
      await addDoc(collection(db,"teachers"), {name,phone,stages,groups,subjects,createdAt:new Date()});
    }
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù†Ø¬Ø§Ø­");
    teacherForm.reset(); teacherSubjectsContainer.innerHTML="";
    loadTeachers();
  } catch(err){console.error(err); alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadTeachers(){
  const snapshot = await getDocs(collection(db,"teachers"));
  teachersTableBody.innerHTML="";
  let total=0;
  snapshot.forEach(docSnap=>{
    const t = {...docSnap.data(),id:docSnap.id};
    total++;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.name}</td>
      <td>${t.phone}</td>
      <td>${t.stages}</td>
      <td>${t.groups}</td>
      <td>${t.subjects.join(", ")}</td>
      <td class="actions">
        <button class="btn small" data-id="${t.id}" onclick="editTeacher('${t.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn small" data-id="${t.id}" onclick="deleteTeacher('${t.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button class="btn ghost small" data-id="${t.id}" onclick="showTeacherDetails('${t.id}')">â„¹ï¸ ØªÙØ§ØµÙŠÙ„</button>
      </td>
    `;
    teachersTableBody.appendChild(tr);
  });
  document.getElementById("totalTeachers").innerText=total;
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°
window.editTeacher = async id=>{
  const docSnap = await getDocs(collection(db,"teachers"));
  docSnap.forEach(d=>{
    if(d.id===id){
      const t = d.data();
      document.getElementById("teacherName").value=t.name;
      document.getElementById("teacherPhone").value=t.phone;
      document.getElementById("teacherStages").value=t.stages;
      document.getElementById("teacherGroups").value=t.groups;
      teacherSubjectsContainer.innerHTML="";
      t.subjects.forEach(s=>{
        const div = document.createElement("div");
        div.classList.add("subject-field");
        div.innerHTML = `<input type="text" class="teacherSubjName" value="${s}" /><button type="button" class="btn warn small removeSubjBtn">âŒ</button>`;
        teacherSubjectsContainer.appendChild(div);
        div.querySelector(".removeSubjBtn").addEventListener("click", ()=>teacherSubjectsContainer.removeChild(div));
      });
      editingTeacherId=id;
    }
  });
};

// Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø°
window.deleteTeacher = async id=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³ØªØ§Ø°ØŸ")){
    await deleteDoc(doc(db,"teachers",id));
    loadTeachers();
  }
};

// Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
window.showTeacherDetails = async id=>{
  const docSnap = await getDocs(collection(db,"teachers"));
  let tData=null;
  docSnap.forEach(d=>{ if(d.id===id) tData=d.data(); });
  if(!tData) return;
  const modal=document.getElementById("modal");
  const body=document.getElementById("modalBody");
  body.innerHTML=`
    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${tData.name}</p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${tData.phone}</p>
    <p><strong>Ø§Ù„Ù…Ø±Ø§Ø­Ù„:</strong> ${tData.stages}</p>
    <p><strong>Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª:</strong> ${tData.groups}</p>
    <p><strong>Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> ${tData.subjects.join(", ")}</p>
  `;
  modal.classList.add("open");
};
document.getElementById("closeModal").addEventListener("click", ()=>document.getElementById("modal").classList.remove("open"));
</script>
</body>
</html>