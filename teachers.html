<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ุฅุฏุงุฑุฉ ุงูุฃุณุงุชุฐุฉ โ ุงููุนูุฏ</title>
<style>
:root{--primary:#004aad;--accent:#ffcc33;--bg:#f5f9ff;--card:#fff;}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:var(--primary);color:#fff;padding:16px;text-align:center;font-weight:700;}
.wrap{max-width:1200px;margin:20px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:14px;}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input,select,textarea{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.warn{background:#ff7043}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.subject-row > *{flex:1}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.search{flex:1;min-width:180px}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
  .print-page{box-shadow:none;margin:0;padding:0}
}
.small-note{font-size:12px;color:#546e7a}
</style>
</head>
<body>
<header id="instituteName">โ</header>
<div class="wrap">

  <!-- ุฅุถุงูุฉ / ุชุนุฏูู ุฃุณุชุงุฐ -->
  <div class="card">
    <strong id="formTitle">ุฃุถู ุฃุณุชุงุฐ ุฌุฏูุฏ</strong>
    <div class="small-note">ุฃุถูู ูุงุฏุฉ+ูุฑุญูุฉ+ูุฑูุจ ููุฌููุนุฉ ูุฑุชุจุทุฉ. ูููู ุชูุฑุงุฑูุง ูุนุฏุฉ ูุฌููุนุงุช.</div>
    <form id="teacherForm" style="margin-top:12px">
      <div class="form-grid">
        <div class="two">
          <label>ุงูุงุณู ุงููุงูู</label>
          <input id="name" type="text" required />
        </div>
        <div class="two">
          <label>ุฑูู ุงูููุจุงูู</label>
          <input id="phone" type="tel" />
        </div>
        <div class="two">
          <label>ุงูุนููุงู</label>
          <input id="address" type="text" />
        </div>
        <div class="two">
          <label>ููุงุญุธุงุช</label>
          <input id="note" type="text" />
        </div>

        <div style="width:100%">
          <label>ุงูุนูุงุตุฑ (ุงููุงุฏุฉ + ุงููุฑุญูุฉ + ุงููุฑูุจ) โ ุฃุถู ูู ุงุฑุชุจุงุท ููุฌููุนุฉ</label>
          <div id="subjectsContainer"></div>
          <div style="margin-top:8px">
            <button id="addSubjectBtn" type="button" class="btn ghost small">โ ุฅุถุงูุฉ ุนูุตุฑ (ูุงุฏุฉ+ูุฑุญูุฉ+ูุฑูุจ)</button>
          </div>
        </div>

        <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveTeacherBtn" class="btn" type="submit">โ ุญูุธ ุงูุฃุณุชุงุฐ</button>
          <button id="clearFormBtn" type="button" class="btn ghost">ูุณุญ ุงูุญููู</button>
        </div>
      </div>
    </form>
  </div>

  <!-- ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div><strong>ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ</strong> <span id="totalCount" class="badge">0</span></div>
      <div class="controls no-print">
        <input id="searchBox" class="search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุฃุณุชุงุฐ ุฃู ุงููุงุฏุฉ..." />
        <select id="filterStage"><option value="">ูู ุงููุฑุงุญู</option></select>
        <select id="filterGroup"><option value="">ูู ุงููุฑูุจุงุช</option></select>
        <button id="applyFiltersBtn" class="btn">ุชุทุจูู ุงูููุงุชุฑ</button>
      </div>
    </div>

    <table class="table" id="teachersTable">
      <thead>
        <tr>
          <th>ุงูุงุณู</th><th>ุงููุงุชู</th><th>ุนุฏุฏ ุงูุนูุงุตุฑ</th><th>ุฅุฌูุงูู ูุณุชุญู (ุชูุฑูุจู)</th><th>ุฎูุงุฑุงุช</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- ููุฏุงู ุงูุชูุงุตูู -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ุชูุงุตูู ุงูุฃุณุชุงุฐ</strong>
      <div>
        <button id="printTeacherBtn" class="btn no-print">๐จ๏ธ ุทุจุงุนุฉ ุงูุงุณุชูุงุฑุฉ</button>
        <button id="closeModal" class="btn ghost">ุฅุบูุงู</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const teacherForm = document.getElementById('teacherForm');
const clearFormBtn = document.getElementById('clearFormBtn');
const teachersTableBody = document.querySelector('#teachersTable tbody');
const searchBox = document.getElementById('searchBox');
const filterStage = document.getElementById('filterStage');
const filterGroup = document.getElementById('filterGroup');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const totalCount = document.getElementById('totalCount');
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const printTeacherBtn = document.getElementById('printTeacherBtn');
const instituteNameHeader = document.getElementById('instituteName');

let teachersData = [];
let studentsData = [];
let editingTeacherId = null;
const STAGES = ["ุงูุงูู ุงุจุชุฏุงุฆู","ุงูุซุงูู ุงุจุชุฏุงุฆู","ุงูุซุงูุซ ุงุจุชุฏุงุฆู","ุงูุฑุงุจุน ุงุจุชุฏุงุฆู","ุงูุฎุงูุณ ุงุจุชุฏุงุฆู","ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู","ุงูุงูู ุงุนุฏุงุฏู","ุงูุซุงูู ุงุนุฏุงุฏู","ุงูุซุงูุซ ุงุนุฏุงุฏู","ุงูุฑุงุจุน ุงุนุฏุงุฏู (ุซุงููู)","ุงูุฎุงูุณ ุงุนุฏุงุฏู","ุงูุณุงุฏุณ ุงุนุฏุงุฏู - ุนููู","ุงูุณุงุฏุณ ุงุนุฏุงุฏู - ุงุฏุจู"];
const GROUPS = ["A","B","C","D","E","F","G","H"];
let settingsData = { name:'ุงููุนูุฏ', instituteFeePercent:10 }; // 10% ููุณุจุฉ ุงูุชุฑุงุถูุฉ

onAuthStateChanged(auth, user=>{
  if(!user){ window.location.href='login.html'; }
  else{ document.body.style.visibility='visible'; initPage(); }
});

async function initPage(){
  await loadSettings();
  populateStageGroup();
  await loadStudents();
  await loadTeachers();
}

async function loadSettings(){
  try{
    const sdoc = await getDoc(doc(db,'settings','info'));
    if(sdoc.exists()) settingsData = sdoc.data();
    instituteNameHeader.textContent = settingsData.name || 'ุงููุนูุฏ';
  }catch(e){ console.warn(e); }
}

function populateStageGroup(){
  STAGES.forEach(s=>filterStage.innerHTML += `<option value="${s}">${s}</option>`);
  GROUPS.forEach(g=>filterGroup.innerHTML += `<option value="${g}">${g}</option>`);
}

async function loadStudents(){
  studentsData=[];
  try{
    const q=query(collection(db,'students'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    snap.forEach(d=>studentsData.push({id:d.id,...d.data()}));
  }catch(e){ console.error('loadStudents', e); }
}

function createSubjectRow(data={}){
  const wrapper=document.createElement('div');
  wrapper.className='subject-row';
  wrapper.innerHTML=`
    <input class="subjName" placeholder="ุงุณู ุงููุงุฏุฉ" value="${data.subject||''}" />
    <select class="subjStage">
      <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option>
      ${STAGES.map(s=>`<option value="${s}" ${s===data.stage?'selected':''}>${s}</option>`).join('')}
    </select>
    <select class="subjGroup">
      <option value="">ุงุฎุชุฑ ุงููุฑูุจ</option>
      ${GROUPS.map(g=>`<option value="${g}" ${g===data.group?'selected':''}>${g}</option>`).join('')}
    </select>
    <button type="button" class="btn warn small removeSubj">โ</button>
  `;
  wrapper.querySelector('.removeSubj').addEventListener('click',()=>wrapper.remove());
  subjectsContainer.appendChild(wrapper);
}
addSubjectBtn.addEventListener('click',()=>createSubjectRow());

clearFormBtn.addEventListener('click',()=>{
  teacherForm.reset();
  subjectsContainer.innerHTML='';
  editingTeacherId=null;
  document.getElementById('formTitle').textContent='ุฃุถู ุฃุณุชุงุฐ ุฌุฏูุฏ';
});

// ุญูุธ / ุชุนุฏูู ุงูุฃุณุชุงุฐ ูุน ุญุณุงุจ ูุณุจุฉ ุงููุนูุฏ
teacherForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  if(!name){ alert('ุฃุฏุฎู ุงุณู ุงูุฃุณุชุงุฐ'); return; }

  const subjects = Array.from(subjectsContainer.querySelectorAll('.subject-row')).map(row=>{
    const subj = row.querySelector('.subjName').value.trim();
    const stage = row.querySelector('.subjStage').value;
    const group = row.querySelector('.subjGroup').value;
    return { subject:subj, stage, group, payments:[], total:0, received:0, remaining:0 };
  }).filter(s=>s.subject && s.stage && s.group);

  if(subjects.length===0){ alert('ุฃุถู ุนูุตุฑ ูุงุญุฏ ุนูู ุงูุฃูู'); return; }

  try{
    if(editingTeacherId){
      await updateDoc(doc(db,'teachers',editingTeacherId),{name, subjects});
      editingTeacherId=null;
    } else {
      await addDoc(collection(db,'teachers'),{name, subjects, createdAt:new Date()});
    }
    teacherForm.reset();
    subjectsContainer.innerHTML='';
    await loadTeachers();
  }catch(e){ console.error(e); alert('ุญุฏุซ ุฎุทุฃ'); }
});

// ุชุญููู ุงูุฃุณุงุชุฐุฉ ูุญุณุงุจ ุงููุณุชุญู ุจุนุฏ ุฎุตู ูุณุจุฉ ุงููุนูุฏ
async function loadTeachers(){
  teachersData=[];
  teachersTableBody.innerHTML='';
  try{
    const q=query(collection(db,'teachers'),orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    for(const docSnap of snap.docs){
      const t = {id:docSnap.id,...docSnap.data()};
      t.subjects.forEach(sub=>{
        let total=0;
        studentsData.forEach(st=>{
          if(st.stage===sub.stage && st.group===sub.group){
            const stSub=(st.subjects||[]).find(ss=>ss.name===sub.subject);
            if(stSub) total+=parseFloat(stSub.fee||0);
          }
        });
        const percent=settingsData.instituteFeePercent||0;
        sub.total = total*(1-percent/100);
        sub.received=(sub.payments||[]).reduce((a,b)=>a+(b.amount||0),0);
        sub.remaining=Math.max(0, sub.total-sub.received);
      });
      teachersData.push(t);

      const tr=document.createElement('tr');
      const approxTotal=t.subjects.reduce((a,b)=>a+(b.total||0),0);
      tr.innerHTML=`
        <td>${t.name}</td>
        <td>${t.phone||'-'}</td>
        <td>${t.subjects.length}</td>
        <td>${approxTotal}</td>
        <td>
          <button class="btn small" onclick="showTeacher('${t.id}')">ุนุฑุถ</button>
          <button class="btn small ghost" onclick="startEditTeacher('${t.id}')">โ๏ธ</button>
          <button class="btn small warn" onclick="deleteTeacher('${t.id}')">๐๏ธ</button>
        </td>
      `;
      teachersTableBody.appendChild(tr);
    }
    totalCount.textContent=teachersData.length;
  }catch(e){ console.error(e); }
}

// ุจุงูู ุงูุฏูุงู ูุซู startEditTeacher, showTeacher, deleteTeacher, printTeacherBtn
// ุชุจูู ููุง ูู ูุน ุงูุชุฃูุฏ ูู ุฃู ูู ุญุณุงุจุงุช totals ุชุดูู ุฎุตู ูุณุจุฉ ุงููุนูุฏ

</script>
</body>
</html>