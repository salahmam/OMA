Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ 
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© â€” Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
:root{--primary:#004aad;--accent:#ffcc33;--bg:#f5f9ff;--card:#fff;}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:var(--primary);color:#fff;padding:16px;text-align:center;font-weight:700;}
.wrap{max-width:1200px;margin:20px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:14px;}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input,select,textarea{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.warn{background:#ff7043}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.subject-row > *{flex:1}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.search{flex:1;min-width:180px}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
  .print-page{box-shadow:none;margin:0;padding:0}
}
.small-note{font-size:12px;color:#546e7a}
</style>
</head>
<body>
<header id="instituteName">â€”</header>
<div class="wrap">

  <!-- Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³ØªØ§Ø° -->
  <div class="card">
    <strong id="formTitle">Ø£Ø¶Ù Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</strong>
    <div class="small-note">Ø£Ø¶ÙÙ Ù…Ø§Ø¯Ø©+Ù…Ø±Ø­Ù„Ø©+ÙƒØ±ÙˆØ¨ ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø±ØªØ¨Ø·Ø©. ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ù„Ø¹Ø¯Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.</div>
    <form id="teacherForm" style="margin-top:12px">
      <div class="form-grid">
        <div class="two">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" type="text" required />
        </div>
        <div class="two">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="phone" type="tel" />
        </div>
        <div class="two">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="address" type="text" />
        </div>
        <div class="two">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="note" type="text" />
        </div>

        <div style="width:100%">
          <label>Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ø§Ù„Ù…Ø§Ø¯Ø© + Ø§Ù„Ù…Ø±Ø­Ù„Ø© + Ø§Ù„ÙƒØ±ÙˆØ¨) â€” Ø£Ø¶Ù ÙƒÙ„ Ø§Ø±ØªØ¨Ø§Ø· ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø©</label>
          <div id="subjectsContainer"></div>
          <div style="margin-top:8px">
            <button id="addSubjectBtn" type="button" class="btn ghost small">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± (Ù…Ø§Ø¯Ø©+Ù…Ø±Ø­Ù„Ø©+ÙƒØ±ÙˆØ¨)</button>
          </div>
        </div>

        <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveTeacherBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
          <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</strong> <span id="totalCount" class="badge">0</span></div>
      <div class="controls no-print">
        <input id="searchBox" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ùˆ Ø§Ù„Ù…Ø§Ø¯Ø©..." />
        <select id="filterStage"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option></select>
        <select id="filterGroup"><option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option></select>
        <button id="applyFiltersBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
    </div>

    <table class="table" id="teachersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°</strong>
      <div>
        <button id="printTeacherBtn" class="btn no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
        <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
// -------------- IMPORTS (Ù…Ø¬Ù…Ù‘Ø¹Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚ Ù‡Ù†Ø§) --------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// safety: log early so we can see if module loads
console.log('teachers.js module loaded');

// ---------------- Firebase config + init ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------------- Elements ----------------
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const teacherForm = document.getElementById('teacherForm');
const saveTeacherBtn = document.getElementById('saveTeacherBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const teachersTableBody = document.querySelector('#teachersTable tbody');
const searchBox = document.getElementById('searchBox');
const filterStage = document.getElementById('filterStage');
const filterGroup = document.getElementById('filterGroup');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const totalCount = document.getElementById('totalCount');
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const printTeacherBtn = document.getElementById('printTeacherBtn');
const instituteNameHeader = document.getElementById('instituteName');

// ---------------- State ----------------
let teachersData = [];
let studentsData = [];
let editingTeacherId = null;
const STAGES = ["Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø¹Ù„Ù…ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ø¯Ø¨ÙŠ"];
const GROUPS = ["A","B","C","D","E","F","G","H"];
let settingsData = { name: '' };

// ---------------- Auth guard (require login) ----------------
onAuthStateChanged(auth, user => {
  if(!user) {
    window.location.href = 'login.html';
  } else {
    document.body.style.visibility = 'visible';
    initPage();
  }
});

// ---------------- Init ----------------
async function initPage(){
  await loadSettings();
  populateStageGroup();
  await loadStudents();
  await loadTeachers();
  populateFilters();
}

// ---------------- Load settings ----------------
async function loadSettings(){
  try{
    const sdoc = await getDoc(doc(db,'settings','info'));
    if(sdoc && sdoc.exists()) settingsData = sdoc.data();
    instituteNameHeader.textContent = settingsData.name || 'Ø§Ù„Ù…Ø¹Ù‡Ø¯';
    if(settingsData.colors){
      document.documentElement.style.setProperty('--primary', settingsData.colors.primary || '#004aad');
      document.documentElement.style.setProperty('--accent', settingsData.colors.accent || '#ffcc33');
      document.documentElement.style.setProperty('--bg', settingsData.colors.bg || '#f5f9ff');
      document.documentElement.style.setProperty('--card', settingsData.colors.card || '#fff');
    }
  }catch(e){ console.warn(e); }
}

// ---------------- Populate stage/group selects ----------------
function populateStageGroup(){
  STAGES.forEach(s=>{
    filterStage.innerHTML += `<option value="${s}">${s}</option>`;
  });
  GROUPS.forEach(g=>{
    filterGroup.innerHTML += `<option value="${g}">${g}</option>`;
  });
}

// ---------------- Load students (to compute totals) ----------------
async function loadStudents(){
  studentsData = [];
  try{
    const q = query(collection(db,'students'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    snap.forEach(d => studentsData.push({id:d.id,...d.data()}));
  }catch(e){ console.error('loadStudents', e); }
}

// ---------------- Add / remove subject-row UI ----------------
function createSubjectRow(data = {}) {
  const wrapper = document.createElement('div');
  wrapper.className = 'subject-row';
  wrapper.innerHTML = `
    <input class="subjName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value="${data.subject||data.name||''}" />
    <select class="subjStage">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
      ${STAGES.map(s=>`<option value="${s}" ${s=== (data.stage||'') ? 'selected' : '' }>${s}</option>`).join('')}
    </select>
    <select class="subjGroup">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>
      ${GROUPS.map(g=>`<option value="${g}" ${g=== (data.group||'') ? 'selected' : '' }>${g}</option>`).join('')}
    </select>
    <button type="button" class="btn warn small removeSubj">âŒ</button>
  `;
  wrapper.querySelector('.removeSubj').addEventListener('click', ()=> wrapper.remove());
  subjectsContainer.appendChild(wrapper);
  return wrapper;
}
addSubjectBtn.addEventListener('click', ()=> createSubjectRow());

// ---------------- Clear form ----------------
clearFormBtn.addEventListener('click', ()=>{
  teacherForm.reset();
  subjectsContainer.innerHTML = '';
  editingTeacherId = null;
  document.getElementById('formTitle').textContent = 'Ø£Ø¶Ù Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯';
});

// ---------------- Save teacher ----------------
teacherForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const note = document.getElementById('note').value.trim();

  const subjects = Array.from(subjectsContainer.querySelectorAll('.subject-row')).map(row=>{
    const subj = row.querySelector('.subjName').value.trim();
    const stage = row.querySelector('.subjStage').value;
    const group = row.querySelector('.subjGroup').value;
    return { subject: subj, stage, group, payments: [], total: 0, received: 0, remaining: 0 };
  }).filter(s=>s.subject && s.stage && s.group);

  if(subjects.length === 0){ alert('Ø£Ø¶Ù Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ù…Ø§Ø¯Ø©+Ù…Ø±Ø­Ù„Ø©+ÙƒØ±ÙˆØ¨)'); return; }
  if(!name){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°'); return; }

  try{
    if(editingTeacherId){
      await updateDoc(doc(db,'teachers',editingTeacherId), { name, phone, address, note, subjects });
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°');
      editingTeacherId = null;
      document.getElementById('formTitle').textContent = 'Ø£Ø¶Ù Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯';
    } else {
      await addDoc(collection(db,'teachers'), { name, phone, address, note, subjects, createdAt: new Date() });
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù†Ø¬Ø§Ø­');
    }
    teacherForm.reset();
    subjectsContainer.innerHTML = '';
    await loadTeachers();
  }catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
});

// ---------------- Load teachers and compute totals ----------------
async function loadTeachers(){
  teachersData = [];
  try{
    const q = query(collection(db,'teachers'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    teachersTableBody.innerHTML = '';
    for(const docSnap of snap.docs){
      const t = { id: docSnap.id, ...(docSnap.data()) };
      // compute totals for each subject element
      for(const sub of (t.subjects||[])){
        // sum fees from students matching subject+stage+group
        let total = 0;
        studentsData.forEach(st=>{
          if(st.stage === sub.stage && st.group === sub.group){
            const studentSub = (st.subjects||[]).find(ss => ss.name === (sub.subject || sub.name));
            if(studentSub) total += parseFloat(studentSub.fee || 0);
          }
        });
        sub.total = total;
        sub.received = (sub.payments || []).reduce((a,b)=>a + (b.amount||0), 0);
        sub.remaining = Math.max(0, (sub.total||0) - sub.received);
      }
      teachersData.push(t);

      // create table row
      const tr = document.createElement('tr');
      const approxTotal = t.subjects.reduce((a,b)=>a + (b.total||0), 0);
      tr.innerHTML = `
        <td>${t.name}</td>
        <td>${t.phone || '-'}</td>
        <td>${t.subjects.length}</td>
        <td>${approxTotal}</td>
        <td>
          <button class="btn small" onclick="showTeacher('${t.id}')">Ø¹Ø±Ø¶</button>
          <button class="btn small ghost" onclick="startEditTeacher('${t.id}')">âœï¸</button>
          <button class="btn small warn" onclick="deleteTeacher('${t.id}')">ğŸ—‘ï¸</button>
        </td>
      `;
      teachersTableBody.appendChild(tr);
    }
    totalCount.textContent = teachersData.length;
  }catch(e){ console.error('loadTeachers', e); }
}

// ---------------- start edit teacher ----------------
window.startEditTeacher = function(id){
  const t = teachersData.find(x=>x.id===id); if(!t) return;
  editingTeacherId = id;
  document.getElementById('formTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°';
  document.getElementById('name').value = t.name || '';
  document.getElementById('phone').value = t.phone || '';
  document.getElementById('address').value = t.address || '';
  document.getElementById('note').value = t.note || '';
  subjectsContainer.innerHTML = '';
  (t.subjects||[]).forEach(s => createSubjectRow({ subject: s.subject, stage: s.stage, group: s.group }));
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// ---------------- delete teacher ----------------
window.deleteTeacher = async function(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³ØªØ§Ø°ØŸ')) return;
  try{
    await deleteDoc(doc(db,'teachers',id));
    await loadTeachers();
  }catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù'); }
};

// ---------------- show teacher details (modal) ----------------
window.showTeacher = async function(id){
  const t = teachersData.find(x=>x.id===id);
  if(!t) return;
  modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°: ${t.name}`;
  const totalAll = t.subjects.reduce((a,b)=>a + (b.total||0), 0);
  const receivedAll = t.subjects.reduce((a,b)=>a + (b.received||0), 0);
  const remainingAll = t.subjects.reduce((a,b)=>a + (b.remaining||0), 0);

  let rightInfo = `
    <table style="width:100%;border-collapse:collapse">
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø§Ù„Ø§Ø³Ù…</th><td style="border:1px solid #ddd;padding:8px">${t.name}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø§Ù„Ù‡Ø§ØªÙ</th><td style="border:1px solid #ddd;padding:8px">${t.phone || '-'}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td style="border:1px solid #ddd;padding:8px">${t.address || '-'}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td style="border:1px solid #ddd;padding:8px">${t.note || '-'}</td></tr>
    </table>
  `;

  let leftInfo = `
    <table style="width:100%;border-collapse:collapse">
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚</th><td style="border:1px solid #ddd;padding:8px">${totalAll}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th><td style="border:1px solid #ddd;padding:8px">${receivedAll}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><td style="border:1px solid #ddd;padding:8px">${remainingAll}</td></tr>
      <tr><th style="background:#eee;border:1px solid #ddd;padding:8px;text-align:right">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±</th><td style="border:1px solid #ddd;padding:8px">${t.subjects.length}</td></tr>
    </table>
  `;

  let subjectsHtml = t.subjects.map((s, idx)=> {
    const paymentsHtml = (s.payments||[]).map(p=>`<div>${p.amount} â€” ${p.date}</div>`).join('') || '<div>-</div>';
    return `<div style="border:1px solid #eee;padding:8px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${s.subject}</strong> â€” <span style="color:#546e7a">${s.stage} â€” ${s.group}</span></div>
        <div>
          <button class="btn small addPaymentBtn" data-idx="${idx}">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
        </div>
      </div>
      <div style="margin-top:8px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.total || 0} â€” Ù…Ø³ØªÙ„Ù…: ${s.received || 0} â€” Ù…ØªØ¨Ù‚ÙŠ: ${s.remaining || 0}</div>
      <div style="margin-top:8px"><strong>Ø§Ù„Ø¯ÙØ¹Ø§Øª:</strong><br>${paymentsHtml}</div>
    </div>`;
  }).join('');

  modalBody.innerHTML = `<div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="width:48%">${rightInfo}</div>
      <div style="width:48%">${leftInfo}</div>
    </div>
    <hr>
    <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±</h4>
    ${subjectsHtml}
    <div style="margin-top:12px;text-align:right"><button id="savePaymentsBtn" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button></div>
  `;

  modal.classList.add('open');

  modalBody.querySelectorAll('.addPaymentBtn').forEach(btn=>{
    btn.addEventListener('click', async (ev)=>{
      const idx = parseInt(btn.dataset.idx);
      const amountStr = prompt('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø©:');
      if(!amountStr) return;
      const amt = parseFloat(amountStr);
      if(isNaN(amt) || amt <= 0){ alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); return; }
      const date = new Date().toLocaleDateString();
      if(!t.subjects[idx].payments) t.subjects[idx].payments = [];
      t.subjects[idx].payments.push({ amount: amt, date });
      t.subjects[idx].received = (t.subjects[idx].payments || []).reduce((a,b)=>a + (b.amount||0), 0);
      let total = 0;
      studentsData.forEach(st => {
        if(st.stage === t.subjects[idx].stage && st.group === t.subjects[idx].group){
          const stsub = (st.subjects||[]).find(ss=>ss.name === t.subjects[idx].subject);
          if(stsub) total += parseFloat(stsub.fee || 0);
        }
      });
      t.subjects[idx].total = total;
      t.subjects[idx].remaining = Math.max(0, (t.subjects[idx].total || 0) - (t.subjects[idx].received || 0));
      showTeacher(t.id);
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©');
    });
  });

  document.getElementById('savePaymentsBtn').addEventListener('click', async ()=>{
    try{
      await updateDoc(doc(db,'teachers',t.id), { subjects: t.subjects });
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      await loadTeachers();
    }catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
  });
};

// ---------------- close modal ----------------
closeModalBtn.addEventListener('click', ()=> modal.classList.remove('open'));

// ---------------- print teacher form (professional) ----------------
printTeacherBtn.addEventListener('click', ()=>{
  const title = modalTitle.textContent.replace('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°:','').trim();
  const teacher = teachersData.find(t => t.name === title);
  if(!teacher){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  teacher.subjects.forEach(s=>{
    s.received = (s.payments || []).reduce((a,b)=>a + (b.amount||0), 0);
    let total = 0;
    studentsData.forEach(st =>{
      if(st.stage === s.stage && st.group === s.group){
        const stsub = (st.subjects||[]).find(ss=>ss.name === s.subject);
        if(stsub) total += parseFloat(stsub.fee || 0);
      }
    });
    s.total = total;
    s.remaining = Math.max(0, s.total - s.received);
  });

  const totalAll = teacher.subjects.reduce((a,b)=>a + (b.total||0), 0);
  const receivedAll = teacher.subjects.reduce((a,b)=>a + (b.received||0), 0);
  const remainingAll = Math.max(0, totalAll - receivedAll);

  let paymentsRows = '';
  teacher.subjects.forEach(s=>{
    if((s.payments||[]).length === 0){
      paymentsRows += `<tr><td>${s.subject}</td><td>-</td><td>-</td></tr>`;
    } else {
      s.payments.forEach(p=>{
        paymentsRows += `<tr><td>${s.subject}</td><td style="text-align:center">${p.amount}</td><td style="text-align:center">${p.date}</td></tr>`;
      });
    }
  });

  const institute = settingsData.name || '';

  const html = `
  <html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø£Ø³ØªØ§Ø°</title>
  <style>
    body{font-family:'Cairo',sans-serif; margin:20px; color:#102027;}
    .header{text-align:center;margin-bottom:12px}
    .header h1{color:#004aad;margin:0}
    .top{display:flex;gap:12px;justify-content:space-between;margin-bottom:12px}
    .box{width:48%;border:1px solid #ddd;padding:10px;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background:#004aad;color:#fff}
    .footer{display:flex;justify-content:space-between;margin-top:24px}
    .sign{width:45%;text-align:center;border-top:1px dashed #777;padding-top:8px}
  </style>
  </head><body>
    <div class="header"><h1>${institute}</h1><h3>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø£Ø³ØªØ§Ø°</h3></div>
    <div class="top">
      <div class="box">
        <h4 style="margin:0 0 8px 0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</h4>
        <table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><td>${teacher.name}</td></tr>
        <tr><th>Ø§Ù„Ù‡Ø§ØªÙ</th><td>${teacher.phone||'-'}</td></tr>
        <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td>${teacher.address||'-'}</td></tr>
        <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>${teacher.note||'-'}</td></tr></table>
      </div>

      <div class="box">
        <h4 style="margin:0 0 8px 0">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
        <table>
          <tr><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚</th><td>${totalAll}</td></tr>
          <tr><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><td>${receivedAll}</td></tr>
          <tr><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><td>${remainingAll}</td></tr>
          <tr><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±</th><td>${teacher.subjects.length}</td></tr>
        </table>
      </div>
    </div>

    <h4>Ø§Ù„Ø¯ÙØ¹Ø§Øª (Ø§Ù„Ù…Ø§Ø¯Ø© â€” Ø§Ù„Ù…Ø¨Ù„Øº â€” Ø§Ù„ØªØ§Ø±ÙŠØ®)</h4>
    <table>
      <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody>${paymentsRows}</tbody>
    </table>

    <div class="footer">
      <div class="sign">Ø®ØªÙ… Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
      <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
    </div>
  </body></html>
  `;

  const w = window.open('','_blank','width=900,height=700');
  w.document.write(html); w.document.close(); w.focus(); w.print();
});

// ---------------- Filters / Search ----------------
applyFiltersBtn.addEventListener('click', ()=>{
  const filter = { name: searchBox.value.trim(), stage: filterStage.value, group: filterGroup.value };
  renderFiltered(filter);
});
function renderFiltered(filter){
  const tbody = teachersTableBody;
  tbody.innerHTML = '';
  let list = teachersData.slice();
  if(filter.name) list = list.filter(t => t.name.includes(filter.name) || t.subjects.some(s=>s.subject.includes(filter.name)));
  if(filter.stage) list = list.filter(t => t.subjects.some(s=>s.stage === filter.stage));
  if(filter.group) list = list.filter(t => t.subjects.some(s=>s.group === filter.group));
  list.forEach(t => {
    const tr = document.createElement('tr');
    const approxTotal = t.subjects.reduce((a,b)=>a + (b.total||0), 0);
    tr.innerHTML = `<td>${t.name}</td><td>${t.phone||'-'}</td><td>${t.subjects.length}</td><td>${approxTotal}</td>
      <td>
        <button class="btn small" onclick="showTeacher('${t.id}')">Ø¹Ø±Ø¶</button>
        <button class="btn small ghost" onclick="startEditTeacher('${t.id}')">âœï¸</button>
        <button class="btn small warn" onclick="deleteTeacher('${t.id}')">ğŸ—‘ï¸</button>
      </td>`;
    tbody.appendChild(tr);
  });
  totalCount.textContent = list.length;
}

// ---------------- Initial load ----------------
async function loadInitial(){
  await loadStudents();
  await loadTeachers();
  populateFilters();
}
function populateFilters(){
  // fill stage/group selects in subject rows defaults if needed
}
loadInitial();

</script>
</body>
</html>