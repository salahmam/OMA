<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</title>
<style>
:root{--primary:#004aad;--accent:#ffcc33;--bg:#f5f9ff;--card:#fff;}
*{box-sizing:border-box;}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:visible;}
header{background:var(--primary);color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:16px;}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-bottom:8px;}
.btn.warn{background:#ff7043;}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12);}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px;}
.subject-field{display:flex;gap:6px;align-items:center;margin-bottom:6px;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.actions button{margin:0 4px;}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto;}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.filters select{flex:1;}
/* ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  body{background:#fff;color:#000;}
  table, th, td{border:1px solid #000;}
  th, td{padding:8px;text-align:right;}
  .btn{display:none;}
  header{display:none;}
  .modal .box{border:none;box-shadow:none;overflow:visible;}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</header>
<div class="wrap">

<!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° -->
<div class="card">
  <strong>Ø£Ø¶Ù Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</strong>
  <form id="teacherForm">
    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input id="name" type="text" required>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
    <input id="phone" type="tel" required>
    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
    <input id="address" type="text">
    <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
    <select id="stage">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
      <option>Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option>Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option>Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
      <option>Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
      <option>Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
      <option>Ø±Ø§Ø¨Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø±Ø§Ø¨Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
      <option>Ø®Ø§Ù…Ø³ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø®Ø§Ù…Ø³ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
      <option>Ø³Ø§Ø¯Ø³ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø¹Ù„Ù…ÙŠ</option><option>Ø³Ø§Ø¯Ø³ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£Ø¯Ø¨ÙŠ</option>
    </select>
    <label>Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="group">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>
      <option>A</option><option>B</option><option>C</option>
      <option>D</option><option>E</option><option>F</option>
      <option>G</option><option>H</option>
    </select>
    <div>
      <label>Ø§Ù„Ù…ÙˆØ§Ø¯</label>
      <div id="subjectsContainer"></div>
      <button type="button" id="addSubjectBtn" class="btn ghost small">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
    </div>
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
    <input id="note" type="text">
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button type="submit" class="btn">âœ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
      <button type="button" id="clearFormBtn" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div>
  </form>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</strong>
  <table id="teachersTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
        <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="printTeacherBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const teacherForm = document.getElementById("teacherForm");
const teachersTableBody = document.querySelector("#teachersTable tbody");
const subjectsContainer = document.getElementById("subjectsContainer");
const addSubjectBtn = document.getElementById("addSubjectBtn");
let teachersData = [];

// Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
addSubjectBtn.addEventListener("click",()=>{
  const div = document.createElement("div");
  div.classList.add("subject-field");
  div.innerHTML = `
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subjName" required />
    <button type="button" class="btn warn small removeSubjBtn">âŒ</button>
  `;
  subjectsContainer.appendChild(div);
  div.querySelector(".removeSubjBtn").addEventListener("click",()=>subjectsContainer.removeChild(div));
});

// Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø°
teacherForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  const stage = document.getElementById("stage").value;
  const group = document.getElementById("group").value;
  const note = document.getElementById("note").value.trim();

  const subjects = [];
  document.querySelectorAll(".subject-field").forEach(sub=>{
    const subjName = sub.querySelector(".subjName").value.trim();
    if(subjName) subjects.push({name:subjName, payments:[], remaining:0});
  });

  if(subjects.length===0){ alert("Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}

  try{
    await addDoc(collection(db,"teachers"),{
      name, phone, address, stage, group, note, subjects, createdAt:new Date()
    });
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù†Ø¬Ø§Ø­");
    teacherForm.reset();
    subjectsContainer.innerHTML="";
    loadTeachers();
  }catch(err){console.error(err);alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadTeachers(){
  try{
    const snapshot = await getDocs(collection(db,"teachers"));
    teachersTableBody.innerHTML="";
    teachersData=[];
    snapshot.forEach(docSnap=>{
      const t = {...docSnap.data(),id:docSnap.id};
      teachersData.push(t);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.name}</td>
        <td>${t.phone}</td>
        <td>${t.stage}</td>
        <td>${t.group}</td>
        <td>${t.subjects.map(s=>s.name).join("<br>")}</td>
        <td class="actions">
          <button class="btn small" onclick="showTeacher('${t.id}')">ğŸ” Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
        </td>
      `;
      teachersTableBody.appendChild(tr);
    });
  }catch(err){console.error(err);}
}

window.showTeacher = async function(id){
  const t = teachersData.find(x=>x.id===id);
  if(!t) return;
  const modal = document.getElementById("modal");
  const body = document.getElementById("modalBody");

  let subjectsHtml = t.subjects.map((s,index)=>{
    const remaining = s.remaining || 0;
    return `
      <div style="margin-bottom:6px">
        <b>${s.name}</b> - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining}
        <button class="btn small addPaymentBtn" data-subject="${index}">ğŸ’° Ø¯ÙØ¹Ø©</button>
        <div>Ø§Ù„Ø¯ÙØ¹Ø§Øª:<br>${(s.payments||[]).map(p=>p.amount+" Ø¨ØªØ§Ø±ÙŠØ® "+p.date).join("<br>")}</div>
      </div>
    `;
  }).join("");

  body.innerHTML = `
    <h3>${t.name}</h3>
    <p>Ø§Ù„Ù‡Ø§ØªÙ: ${t.phone}</p>
    <p>Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${t.stage}</p>
    <p>Ø§Ù„ÙƒØ±ÙˆØ¨: ${t.group}</p>
    <p>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${t.address}</p>
    <p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${t.note}</p>
    <h4>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª:</h4>
    ${subjectsHtml}
  `;

  modal.classList.add("open");

  body.querySelectorAll(".addPaymentBtn").forEach(btn=>{
    btn.addEventListener("click", async()=>{
      const subIndex = btn.dataset.subject;
      const payment = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:");
      if(payment && !isNaN(payment)){
        const date = new Date().toLocaleDateString();
        if(!t.subjects[subIndex].payments) t.subjects[subIndex].payments=[];
        t.subjects[subIndex].payments.push({amount:parseFloat(payment),date});
        t.subjects[subIndex].remaining = (t.subjects[subIndex].remaining||0) - parseFloat(payment);
        if(t.subjects[subIndex].remaining < 0) t.subjects[subIndex].remaining = 0;
        const docRef = doc(db,"teachers",t.id);
        await updateDoc(docRef,{subjects:t.subjects});
        showTeacher(t.id);
        alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© ${payment} Ø¨ØªØ§Ø±ÙŠØ® ${date}`);
      }
    });
  });
};

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
document.getElementById("closeModal").addEventListener("click",()=>{document.getElementById("modal").classList.remove("open");});

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°
document.getElementById("printTeacherBtn").addEventListener("click",()=>{
  const content = document.getElementById("modalBody").innerHTML;
  const printWindow = window.open("","Ø·Ø¨Ø§Ø¹Ø©","height=700,width=900");
  printWindow.document.write(`<html><head><title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</title>
  <style>
    body{font-family:'Cairo',sans-serif;direction:rtl;padding:20px;}
    h3,h4{color:#004aad;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #000;padding:8px;text-align:right;}
  </style>
  </head><body>${content}</body></html>`);
  printWindow.document.close();
  printWindow.print();
});

loadTeachers();
</script>
</body>
</html>