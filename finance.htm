<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:linear-gradient(90deg,var(--primary),#007bff);color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-bottom:8px;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
@media print{
  body{background:white;}
  header,.filters,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</header>
<div class="wrap">

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ / Ø¯ÙØ¹Ø© -->
<div class="card">
  <strong>Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø¯ÙØ¹Ø©</strong>
  <form id="financeForm">
    <label>Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ø®Ø¯Ù…Ø©</label>
    <input id="financeSubject" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø­ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª" required>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø° / Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
    <select id="financeTeacher" required></select>
    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
    <input id="totalAmount" type="number" min="0" required>
    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
    <input id="receivedAmount" type="number" min="0" required>
    <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
    <input id="remainingAmount" type="number" readonly>
    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
    <input id="paymentDate" type="date" required>
    <button type="submit" class="btn">âœ… Ø­ÙØ¸</button>
  </form>
</div>

<!-- ÙÙ„Ø§ØªØ± -->
<div class="filters card">
  <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
  <select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ø®Ø¯Ù…Ø©</label>
  <input id="filterSubject" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
  <button id="applyFilter" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
  <button id="printReport" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
<div class="card">
  <strong>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</strong>
  <table id="financeTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ø®Ø¯Ù…Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯</th>
        <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ğŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user)=>{
  if(!user){ window.location.href="login.html"; } 
  else{ document.body.style.visibility="visible"; loadTeachers(); loadFinance(); }
});

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
const financeForm = document.getElementById("financeForm");
const financeTeacher = document.getElementById("financeTeacher");
const totalAmountInput = document.getElementById("totalAmount");
const receivedAmountInput = document.getElementById("receivedAmount");
const remainingAmountInput = document.getElementById("remainingAmount");
const paymentDateInput = document.getElementById("paymentDate");
const financeTableBody = document.querySelector("#financeTable tbody");
const filterTeacher = document.getElementById("filterTeacher");
const filterSubject = document.getElementById("filterSubject");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
let teachersData = [];
async function loadTeachers(){
  const snapshot = await getDocs(collection(db,"teachers"));
  financeTeacher.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersData = [];
  snapshot.forEach(docSnap=>{
    const t = {...docSnap.data(), id:docSnap.id};
    teachersData.push(t);
    financeTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
    filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø¨
let instituteSharePercent = 0;
async function loadSettings(){
  const snapshot = await getDocs(collection(db,"settings"));
  snapshot.forEach(docSnap=>{
    const s = docSnap.data();
    instituteSharePercent = s.instituteShare || 0;
  });
}
loadSettings();

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function updateRemaining(){
  const total = parseFloat(totalAmountInput.value)||0;
  const received = parseFloat(receivedAmountInput.value)||0;
  const instituteShare = (total * instituteSharePercent)/100;
  remainingAmountInput.value = (total - received - instituteShare).toFixed(2);
}
totalAmountInput.addEventListener("input", updateRemaining);
receivedAmountInput.addEventListener("input", updateRemaining);

// Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ / Ø§Ù„Ø¯ÙØ¹Ø©
financeForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const subject = document.getElementById("financeSubject").value.trim();
  const teacherId = financeTeacher.value;
  const total = parseFloat(totalAmountInput.value)||0;
  const received = parseFloat(receivedAmountInput.value)||0;
  const remaining = parseFloat(remainingAmountInput.value)||0;
  const date = paymentDateInput.value;
  if(!subject || !teacherId || !total || !date){ alert("Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"); return;}
  await addDoc(collection(db,"finance"),{
    subject, teacherId, total, received, remaining, date, createdAt:new Date()
  });
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ / Ø§Ù„Ø¯ÙØ¹Ø©");
  financeForm.reset();
  remainingAmountInput.value="";
  loadFinance();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
async function loadFinance(filter={}){
  const snapshot = await getDocs(query(collection(db,"finance"), orderBy("createdAt","desc")));
  financeTableBody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const f = {...docSnap.data(),id:docSnap.id};
    if(filter.teacherId && f.teacherId !== filter.teacherId) return;
    if(filter.subject && !f.subject.includes(filter.subject)) return;
    const teacherName = teachersData.find(t=>t.id===f.teacherId)?.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    financeTableBody.innerHTML += `
      <tr>
        <td>${f.subject}</td>
        <td>${teacherName}</td>
        <td>${f.total}</td>
        <td>${f.received}</td>
        <td>${instituteSharePercent}%</td>
        <td>${f.remaining}</td>
        <td>${f.date}</td>
        <td><button class="btn warn" onclick="deleteFinance('${f.id}')">âŒ Ø­Ø°Ù</button></td>
      </tr>
    `;
  });
}

// Ø­Ø°Ù Ù…ØµØ±ÙˆÙ
window.deleteFinance = async(id)=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){
    await deleteDoc(doc(db,"finance",id));
    loadFinance();
  }
}

// Ø§Ù„ÙÙ„Ø§ØªØ±
document.getElementById("applyFilter").addEventListener("click",()=>{
  const f = { teacherId: filterTeacher.value, subject: filterSubject.value.trim() };
  loadFinance(f);
});

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
document.getElementById("printReport").addEventListener("click",()=>{
  window.print();
});
</script>
</body>
</html>
