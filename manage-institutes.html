<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المعاهد - نظام OMA</title>
<style>
:root {
  --primary:#004aad;
  --bg:#f5f9ff;
  --card:#fff;
}

body {
  font-family:'Cairo',sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
}

h2 { text-align:center; color:var(--primary); }
.form-container {
  background:var(--card);
  padding:25px;
  max-width:600px;
  margin:20px auto;
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
}

input, select, button {
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}

button {
  background:var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  transition:0.3s;
}

button:hover { background:#003a8c; }

.label { font-weight:bold; margin-bottom:5px; display:block; }
.institutes-list { margin-top:30px; background:#eef4ff; padding:20px; border-radius:10px; }
.institute-item { 
  padding:12px; 
  border-bottom:1px solid #ccc; 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  flex-wrap:wrap;
}
.institute-item:last-child { border-bottom:none; }
.action-buttons button {
  margin:2px; 
  padding:6px 10px; 
  border-radius:6px; 
  font-size:13px;
}
.btn-edit { background:#ffcc33; color:#000; }
.btn-delete { background:#e74c3c; color:#fff; }
@media(max-width:600px){ .institute-item{flex-direction:column;align-items:flex-start;} }
</style>
</head>
<body>

<h2>إدارة المعاهد</h2>

<div class="form-container">
  <label class="label">اسم المعهد</label>
  <input type="text" id="instituteName" placeholder="أدخل اسم المعهد">

  <label class="label">شعار المعهد</label>
  <input type="file" id="instituteLogo" accept="image/*">

  <label class="label">البريد الإلكتروني لمدير المعهد</label>
  <input type="email" id="adminEmail" placeholder="example@mail.com">

  <label class="label">كلمة المرور لمدير المعهد</label>
  <input type="password" id="adminPassword" placeholder="********">

  <label class="label">مدة الاشتراك</label>
  <select id="subscriptionType">
    <option value="lifetime">مدى الحياة</option>
    <option value="trial">تجريبي</option>
  </select>

  <button id="createBtn">إنشاء المعهد</button>
  <p id="statusMsg" style="color:red;"></p>
</div>

<div class="institutes-list" id="institutesList">
  <h3 style="color:var(--primary)">قائمة المعاهد</h3>
  <div id="listContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { 
  getAuth, createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const createBtn = document.getElementById("createBtn");
const listContainer = document.getElementById("listContainer");
const statusMsg = document.getElementById("statusMsg");

// تحميل المعاهد
async function loadInstitutes(){
  listContainer.innerHTML = "";
  const snapshot = await getDocs(collection(db,"institutes"));
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement("div");
    div.classList.add("institute-item");
    div.innerHTML = `
      <div>
        <strong>${data.name}</strong><br>
        البريد: ${data.adminEmail}<br>
        الاشتراك: ${data.subscriptionType}
      </div>
      <div class="action-buttons">
        <button class="btn-edit" onclick="editInstitute('${docSnap.id}')">تعديل</button>
        <button class="btn-delete" onclick="deleteInstitute('${docSnap.id}')">حذف</button>
      </div>
    `;
    listContainer.appendChild(div);
  });
}

// إنشاء معهد
createBtn.addEventListener("click", async ()=>{
  const name = instituteName.value.trim();
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  if(!name || !email || !password){
    statusMsg.textContent = "الرجاء تعبئة جميع الحقول.";
    return;
  }

  statusMsg.textContent = "جاري إنشاء المعهد...";
  try{
    let logoUrl="";
    if(instituteLogo.files.length>0){
      const file=instituteLogo.files[0];
      const logoRef=ref(storage,`logos/${Date.now()}_${file.name}`);
      await uploadBytes(logoRef,file);
      logoUrl=await getDownloadURL(logoRef);
    }

    const userCred=await createUserWithEmailAndPassword(auth,email,password);
    const adminId=userCred.user.uid;

    const docRef=await addDoc(collection(db,"institutes"),{
      name, adminId, adminEmail:email, logoUrl,
      subscriptionType:subscriptionType.value,
      createdAt:serverTimestamp()
    });

    await addDoc(collection(db,"users"),{
      uid:adminId, type:"instituteAdmin", instituteId:docRef.id, email, createdAt:serverTimestamp()
    });

    statusMsg.style.color="green";
    statusMsg.textContent="✅ تم إنشاء المعهد بنجاح!";
    instituteName.value="";
    adminEmail.value="";
    adminPassword.value="";
    instituteLogo.value="";
    loadInstitutes();
  }catch(err){
    console.error(err);
    statusMsg.textContent="⚠️ حدث خطأ أثناء إنشاء المعهد.";
  }
});

// تعديل معهد
window.editInstitute = async (id)=>{
  const newName = prompt("أدخل الاسم الجديد للمعهد:");
  if(!newName) return;
  await updateDoc(doc(db,"institutes",id),{name:newName});
  loadInstitutes();
};

// حذف معهد
window.deleteInstitute = async (id)=>{
  if(confirm("هل أنت متأكد من حذف هذا المعهد؟")){
    await deleteDoc(doc(db,"institutes",id));
    loadInstitutes();
  }
};

loadInstitutes();
</script>
</body>
</html>