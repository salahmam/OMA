<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</title>
<style>
:root {
  --primary:#004aad;
  --bg:#f5f9ff;
  --card:#fff;
  --accent:#ffcc33;
}
body {
  font-family: 'Cairo', sans-serif;
  background: var(--bg);
  margin:0;
  padding:20px;
}
h2 { text-align:center; color:var(--primary); margin-bottom:20px; }
.institute-card {
  background: var(--card);
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  margin-bottom:20px;
}
.institute-header {
  display:flex;
  justify-content: space-between;
  align-items:center;
  flex-wrap: wrap;
}
.institute-header h3 { margin:0; color:var(--primary); }
.institute-actions button {
  margin-left:5px;
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  color:white;
  font-weight:bold;
  transition:0.3s;
}
.editBtn { background:#004aad; }
.editBtn:hover { background:#003a8c; }
.deleteBtn { background:#d32f2f; }
.deleteBtn:hover { background:#b71c1c; }
.institute-colors { margin-top:10px; display:flex; gap:10px; flex-wrap: wrap; }
.color-box { width:40px; height:40px; border-radius:5px; border:1px solid #ccc; }
#logoutBtn {
  background-color: #d32f2f;
  color:white;
  border:none;
  padding:12px 20px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  margin:20px auto 0;
  display:block;
  transition:0.3s;
}
#logoutBtn:hover { background-color:#b71c1c; }
</style>
</head>
<body>

<h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</h2>
<div id="institutesContainer"></div>
<button id="logoutBtn">ðŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const institutesContainer = document.getElementById("institutesContainer");

let currentUser = null;

// Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async (user)=>{
  if(!user) window.location.href="institute-login.html";
  else {
    currentUser = user;
    loadInstitutesForUser();
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function loadInstitutesForUser(){
  institutesContainer.innerHTML = "";
  const userDoc = await doc(db,"users",currentUser.uid).get();
  const userSnap = await getDocs(collection(db,"users"));
  const userRef = doc(db,"users",currentUser.uid);
  const userDataSnap = await getDocs(collection(db,"users"));
  const usersCollection = collection(db,"users");

  const userDocSnap = await doc(db,"users",currentUser.uid);
  const userData = (await userDocSnap.get()).data();

  // superAdmin ÙŠØ±Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯
  let querySnapshot;
  if(userData.type==="superAdmin"){
    querySnapshot = await getDocs(collection(db,"institutes"));
  } else if(userData.type==="instituteAdmin"){
    querySnapshot = await getDocs(collection(db,"institutes"));
    querySnapshot = querySnapshot.docs.filter(d=>d.id===userData.instituteId).map(d=>({id:d.id,data:d.data()}));
  } else return;

  for(const docSnap of querySnapshot){
    const data = docSnap.data? docSnap.data : docSnap.data();
    const instituteId = docSnap.id ? docSnap.id : docSnap.id;
    const card = document.createElement("div");
    card.classList.add("institute-card");
    card.innerHTML = `
      <div class="institute-header">
        <h3>${data.name}</h3>
        <div class="institute-actions">
          ${userData.type==="superAdmin"?'<button class="editBtn">ØªØ¹Ø¯ÙŠÙ„</button>':'<button class="editBtn">ØªØ¹Ø¯ÙŠÙ„</button>'}
        </div>
      </div>
      <p>Ø§Ù„Ø¨Ø±ÙŠØ¯: ${data.email || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
      <p>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${data.subscriptionType || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
      <div class="institute-colors">
        <div class="color-box" style="background:${data.colors?.primary || "#004aad"}" title="Primary"></div>
        <div class="color-box" style="background:${data.colors?.bg || "#f5f9ff"}" title="Background"></div>
        <div class="color-box" style="background:${data.colors?.card || "#fff"}" title="Card"></div>
        <div class="color-box" style="background:${data.colors?.accent || "#ffcc33"}" title="Accent"></div>
      </div>
    `;

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù‡Ø¯
    card.querySelector(".editBtn").addEventListener("click", async()=>{
      const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", data.name);
      if(!newName) return;
      const newPrimary = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:", data.colors?.primary || "#004aad");
      const newBg = prompt("Ø£Ø¯Ø®Ù„ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©:", data.colors?.bg || "#f5f9ff");
      const newCard = prompt("Ø£Ø¯Ø®Ù„ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª:", data.colors?.card || "#fff");
      const newAccent = prompt("Ø£Ø¯Ø®Ù„ Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ²:", data.colors?.accent || "#ffcc33");

      await updateDoc(doc(db,"institutes",instituteId),{
        name:newName,
        colors:{primary:newPrimary,bg:newBg,card:newCard,accent:newAccent}
      });
      loadInstitutesForUser();
    });

    institutesContainer.appendChild(card);
  }
}

// Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", async()=>{
  await signOut(auth);
  alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
  window.location.href="institute-login.html";
});
</script>
</body>
</html>