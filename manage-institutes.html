<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</title>
<style>
:root {
  --primary: #004aad;
  --accent: #ffcc33;
  --bg: #f5f9ff;
  --card: #fff;
}
body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 0; }
header { background: var(--primary); color: #fff; text-align: center; padding: 15px; font-size: 20px; }
.container { padding: 30px; display: flex; flex-direction: column; gap: 25px; max-width: 700px; margin: auto; }
.card { background: var(--card); padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
input, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
button { background: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
button:hover { background: #003a8c; }
.error { color:red; font-size: 14px; margin:5px 0; }
.success { color:green; font-size: 14px; margin:5px 0; }
.institute-list { margin-top: 15px; border-top:1px solid #ccc; padding-top: 15px; }
.institute-item { padding: 8px 0; border-bottom:1px solid #eee; display:flex; justify-content: space-between; }
</style>
</head>
<body>

<header>ğŸ“Œ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</header>

<div class="container">

  <div class="card">
    <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
    <p class="error" id="errorMsg"></p>
    <p class="success" id="successMsg"></p>

    <input type="text" id="instituteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯" required />
    <input type="email" id="adminEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯" required />
    <input type="password" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø¯ÙŠØ±" required />

    <label>Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
    <input type="file" id="instituteLogo" accept="image/*" />

    <label>Ù„ÙˆÙ† Ø±Ø¦ÙŠØ³ÙŠ</label>
    <input type="color" id="colorPrimary" value="#004aad" />
    <label>Ù„ÙˆÙ† Ø«Ø§Ù†ÙˆÙŠ</label>
    <input type="color" id="colorAccent" value="#ffcc33" />

    <label>Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
    <select id="subscriptionType">
      <option value="lifetime">Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</option>
      <option value="year">Ø³Ù†Ø©</option>
      <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
    </select>

    <button id="createInstituteBtn">â• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
  </div>

  <div class="card">
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯</h3>
    <div id="instituteList" class="institute-list"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Ø¹Ù†Ø§ØµØ± HTML
const instituteNameInput = document.getElementById("instituteName");
const adminEmailInput = document.getElementById("adminEmail");
const adminPasswordInput = document.getElementById("adminPassword");
const logoInput = document.getElementById("instituteLogo");
const colorPrimaryInput = document.getElementById("colorPrimary");
const colorAccentInput = document.getElementById("colorAccent");
const subscriptionSelect = document.getElementById("subscriptionType");
const createBtn = document.getElementById("createInstituteBtn");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");
const instituteListDiv = document.getElementById("instituteList");

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
async function loadInstitutes() {
  instituteListDiv.innerHTML = "";
  const querySnapshot = await getDocs(collection(db,"institutes"));
  querySnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement("div");
    div.className = "institute-item";
    div.innerHTML = `<span>${data.name}</span><span>${data.subscriptionType}</span>`;
    instituteListDiv.appendChild(div);
  });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯
createBtn.addEventListener("click", async ()=>{
  const name = instituteNameInput.value.trim();
  const email = adminEmailInput.value.trim();
  const password = adminPasswordInput.value.trim();
  const logoFile = logoInput.files[0];
  const primary = colorPrimaryInput.value;
  const accent = colorAccentInput.value;
  const subscriptionType = subscriptionSelect.value;

  errorMsg.textContent = "";
  successMsg.textContent = "";

  if(!name || !email || !password){
    errorMsg.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
    return;
  }

  createBtn.disabled = true;
  createBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...";

  try {
    // Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    let logoURL = "";
    if(logoFile){
      const logoRef = ref(storage, `institute-logos/${Date.now()}_${logoFile.name}`);
      await uploadBytes(logoRef, logoFile);
      logoURL = await getDownloadURL(logoRef);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙÙŠ Firebase Auth
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    const adminUid = userCred.user.uid;

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙÙŠ Firestore
    await addDoc(collection(db,"institutes"),{
      name,
      logo: logoURL,
      colors: { primary, accent },
      subscriptionType,
      createdAt: serverTimestamp(),
      adminUid
    });

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ collection users
    await addDoc(collection(db,"users"),{
      name: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯",
      email,
      type: "instituteAdmin",
      instituteId: adminUid, // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±
      createdAt: serverTimestamp()
    });

    successMsg.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
    instituteNameInput.value = "";
    adminEmailInput.value = "";
    adminPasswordInput.value = "";
    logoInput.value = "";

    loadInstitutes();
  } catch(err){
    console.error(err);
    errorMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯.";
  } finally {
    createBtn.disabled = false;
    createBtn.textContent = "â• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯";
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadInstitutes();
</script>

</body>
</html>