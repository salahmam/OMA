<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ - OMA</title>
<style>
:root {
  --primary:#004aad;
  --bg:#f5f9ff;
  --card:#fff;
}

body {
  font-family:'Cairo',sans-serif;
  background: var(--bg);
  margin:0;
  padding:20px;
}

h2 { text-align:center; color:var(--primary); margin-bottom:30px; }

.form-container {
  background: var(--card);
  padding:30px;
  max-width:600px;
  margin:0 auto 40px auto;
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
}

input, select, button {
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}

button {
  background: var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  transition:0.3s;
}

button:hover { background:#003a8c; }

.label { font-weight:bold; margin-bottom:5px; display:block; }

.institutes-list {
  margin-top:30px;
  background:#eef4ff;
  padding:20px;
  border-radius:10px;
}

.institutes-list h3 { margin-top:0; color:var(--primary); }

.institute-item {
  padding:10px;
  border-bottom:1px solid #ccc;
  display:flex;
  justify-content: space-between;
  align-items: center;
}

.institute-item:last-child { border-bottom:none; }

.institute-item button {
  margin-left:5px;
  padding:5px 10px;
  font-size:14px;
}

.color-box {
  display:inline-block;
  width:30px;
  height:30px;
  border-radius:5px;
  border:1px solid #ccc;
  vertical-align:middle;
  margin-left:10px;
}

#logoutBtn {
  background-color: #d32f2f;
  display:block;
  margin:30px auto;
  width:200px;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
#progressContainer {
  display:none;
  width:100%;
  background:#ccc;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:15px;
}

#progressBar {
  width:0%;
  height:20px;
  background:#004aad;
  text-align:center;
  color:white;
  font-weight:bold;
}
</style>
</head>
<body>

<h2>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯</h2>

<div class="form-container">
  <div id="progressContainer"><div id="progressBar">0%</div></div>

  <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="text" id="instituteName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯">

  <label class="label">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="file" id="instituteLogo" accept="image/*">

  <label class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="email" id="adminEmail" placeholder="example@mail.com">

  <label class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="password" id="adminPassword" placeholder="********">

  <label class="label">Ù„ÙˆÙ† Ø±Ø¦ÙŠØ³ÙŠ</label>
  <input type="color" id="colorPrimary" value="#004aad">

  <label class="label">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ©</label>
  <input type="color" id="colorBg" value="#f5f9ff">

  <label class="label">Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</label>
  <input type="color" id="colorCard" value="#ffffff">

  <label class="label">Ù„ÙˆÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ…ÙŠÙŠØ²</label>
  <input type="color" id="colorAccent" value="#ffcc33">

  <label class="label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
  <select id="subscriptionType">
    <option value="lifetime">Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</option>
    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
  </select>

  <button id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
  <button id="updateBtn" style="display:none;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
  <p id="statusMsg" style="color:red;"></p>
</div>

<div class="institutes-list" id="institutesList">
  <h3>Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h3>
  <div id="listContainer"></div>
</div>

<button id="logoutBtn">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const instituteName = document.getElementById("instituteName");
const instituteLogo = document.getElementById("instituteLogo");
const adminEmail = document.getElementById("adminEmail");
const adminPassword = document.getElementById("adminPassword");
const colorPrimary = document.getElementById("colorPrimary");
const colorBg = document.getElementById("colorBg");
const colorCard = document.getElementById("colorCard");
const colorAccent = document.getElementById("colorAccent");
const subscriptionType = document.getElementById("subscriptionType");
const createBtn = document.getElementById("createBtn");
const updateBtn = document.getElementById("updateBtn");
const statusMsg = document.getElementById("statusMsg");
const listContainer = document.getElementById("listContainer");
const logoutBtn = document.getElementById("logoutBtn");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");

let editingDocId = null;
let editingAdminId = null;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯
async function loadInstitutes() {
  listContainer.innerHTML = "";
  const querySnapshot = await getDocs(collection(db, "institutes"));
  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement("div");
    div.classList.add("institute-item");
    div.innerHTML = `
      <span>${data.name} - Ø§Ù„Ø¨Ø±ÙŠØ¯: ${data.adminEmail} - Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${data.subscriptionType}</span>
      <span>
        <button class="editBtn">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="deleteBtn">Ø­Ø°Ù</button>
      </span>
    `;
    div.querySelector(".editBtn").addEventListener("click", ()=>{
      editingDocId = docSnap.id;
      editingAdminId = data.adminId;
      instituteName.value = data.name;
      adminEmail.value = data.adminEmail;
      adminPassword.value = "";
      colorPrimary.value = data.colors.primary;
      colorBg.value = data.colors.bg;
      colorCard.value = data.colors.card;
      colorAccent.value = data.colors.accent;
      subscriptionType.value = data.subscriptionType;
      createBtn.style.display = "none";
      updateBtn.style.display = "block";
    });
    div.querySelector(".deleteBtn").addEventListener("click", async()=>{
      if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù‡Ø¯ØŸ")){
        await deleteDoc(doc(db,"institutes",docSnap.id));
        loadInstitutes();
      }
    });
    listContainer.appendChild(div);
  });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function saveInstitute(docId=null){
  const name = instituteName.value.trim();
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  if(!name || !email || (!docId && !password)){
    statusMsg.style.color="red";
    statusMsg.textContent="Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
    return;
  }

  statusMsg.style.color="black";
  statusMsg.textContent= docId ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù‡Ø¯..." : "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯...";
  progressContainer.style.display="block";
  progressBar.style.width="0%";
  progressBar.textContent="0%";

  try{
    let logoUrl = "";
    if(instituteLogo.files.length>0){
      const file = instituteLogo.files[0];
      const logoRef = ref(storage, `instituteLogos/${Date.now()}_${file.name}`);
      const uploadTask = uploadBytesResumable(logoRef, file);
      await new Promise((resolve, reject)=>{
        uploadTask.on('state_changed',
          (snapshot)=>{
            const progress = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes)*100);
            progressBar.style.width = progress+"%";
            progressBar.textContent = progress+"%";
          },
          (error)=>{ reject(error); },
          ()=>{ resolve(); }
        );
      });
      logoUrl = await getDownloadURL(ref(storage, `instituteLogos/${Date.now()}_${file.name}`));
    }

    if(docId){ // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù‡Ø¯
      const instituteRef = doc(db,"institutes",docId);
      await updateDoc(instituteRef,{
        name,
        colors:{
          primary: colorPrimary.value,
          bg: colorBg.value,
          card: colorCard.value,
          accent: colorAccent.value
        },
        subscriptionType: subscriptionType.value,
        logoUrl: logoUrl || undefined
      });

      statusMsg.style.color="green";
      statusMsg.textContent="ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
    } else { // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
      const userCred = await createUserWithEmailAndPassword(auth,email,password);
      const adminId = userCred.user.uid;
      const docRef = await addDoc(collection(db,"institutes"),{
        name,
        adminId,
        adminEmail: email,
        logoUrl,
        colors:{
          primary: colorPrimary.value,
          bg: colorBg.value,
          card: colorCard.value,
          accent: colorAccent.value
        },
        subscriptionType: subscriptionType.value,
        createdAt: serverTimestamp()
      });
      await addDoc(collection(db,"users"),{
        uid: adminId,
        type:"instituteAdmin",
        instituteId:docRef.id,
        email,
        createdAt:serverTimestamp()
      });
      statusMsg.style.color="green";
      statusMsg.textContent="ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
    }

    instituteName.value="";
    adminEmail.value="";
    adminPassword.value="";
    instituteLogo.value="";
    createBtn.style.display="block";
    updateBtn.style.display="none";
    editingDocId=null;
    editingAdminId=null;
    progressContainer.style.display="none";
    loadInstitutes();
  }catch(err){
    console.error(err);
    statusMsg.style.color="red";
    statusMsg.textContent="Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message;
    progressContainer.style.display="none";
  }
}

createBtn.addEventListener("click",()=>saveInstitute());
updateBtn.addEventListener("click",()=>saveInstitute(editingDocId));

// Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
const colorInputs = document.querySelectorAll('input[type="color"]');
colorInputs.forEach(input=>{
  input.style.backgroundColor=input.value;
  input.addEventListener('input',()=>input.style.backgroundColor=input.value);
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
loadInstitutes();

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
logoutBtn.addEventListener("click", async()=>{
  await signOut(auth);
  window.location.href="login.html";
});
</script>
</body>
</html>