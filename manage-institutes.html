<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</title>
<style>
:root {
  --primary:#004aad;
  --bg:#f5f9ff;
  --card:#fff;
}
body {
  font-family:'Cairo',sans-serif;
  background: var(--bg);
  margin:0;
  padding:20px;
}
h2 { text-align:center; color:var(--primary); margin-bottom:20px; }

.institute-list {
  max-width: 1000px;
  margin: auto;
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
}

.institute-item {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom:1px solid #ccc;
}

.institute-item:last-child { border-bottom:none; }

.institute-info { flex:1; min-width:200px; }

.institute-actions { display:flex; gap:5px; margin-top:5px; }

button {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  color:white;
  transition:0.3s;
}
.edit-btn { background:#ff9800; }
.edit-btn:hover { background:#e68900; }
.delete-btn { background:#d32f2f; }
.delete-btn:hover { background:#b71c1c; }

.modal {
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.modal-content {
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:500px;
  width:100%;
}
.modal-content h3 { margin-top:0; color:var(--primary); text-align:center; }
.modal-content label { display:block; margin-top:10px; font-weight:bold; }
.modal-content input, .modal-content select { width:100%; padding:8px; margin-top:5px; }
.modal-content button { margin-top:15px; width:100%; }
.close-btn { background:#555; }
.close-btn:hover { background:#333; }
</style>
</head>
<body>

<h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯</h2>
<div class="institute-list" id="institutesList"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù‡Ø¯ -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù‡Ø¯</h3>
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
    <input type="text" id="editName">
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±</label>
    <input type="email" id="editEmail">
    <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
    <input type="file" id="editLogo" accept="image/*">
    <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
    <input type="color" id="editPrimary">
    <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
    <input type="color" id="editBg">
    <label>Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</label>
    <input type="color" id="editCard">
    <label>Ù„ÙˆÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ…ÙŠÙŠØ²</label>
    <input type="color" id="editAccent">
    <label>Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
    <select id="editSubscription">
      <option value="lifetime">Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</option>
      <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
    </select>
    <button id="saveEditBtn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button class="close-btn" id="closeModal">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const institutesList = document.getElementById("institutesList");
const editModal = document.getElementById("editModal");
const closeModal = document.getElementById("closeModal");

let currentEditId = null;

// Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
const editName = document.getElementById("editName");
const editEmail = document.getElementById("editEmail");
const editLogo = document.getElementById("editLogo");
const editPrimary = document.getElementById("editPrimary");
const editBg = document.getElementById("editBg");
const editCard = document.getElementById("editCard");
const editAccent = document.getElementById("editAccent");
const editSubscription = document.getElementById("editSubscription");
const saveEditBtn = document.getElementById("saveEditBtn");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯
async function loadInstitutes() {
  institutesList.innerHTML = "";
  const querySnapshot = await getDocs(collection(db,"institutes"));
  querySnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement("div");
    div.classList.add("institute-item");
    div.innerHTML = `
      <div class="institute-info">
        <strong>${data.name}</strong><br>
        Ø§Ù„Ø¨Ø±ÙŠØ¯: ${data.adminEmail || data.email || "-"}<br>
        Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${data.subscriptionType || (data.plan?.type) || "-"}
      </div>
      <div class="institute-actions">
        <button class="edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="delete-btn">Ø­Ø°Ù</button>
      </div>
    `;

    // ØªØ¹Ø¯ÙŠÙ„
    div.querySelector(".edit-btn").addEventListener("click", ()=>{
      currentEditId = docSnap.id;
      editName.value = data.name || "";
      editEmail.value = data.adminEmail || data.email || "";
      editPrimary.value = data.colors?.primary || "#004aad";
      editBg.value = data.colors?.bg || "#f5f9ff";
      editCard.value = data.colors?.card || "#fff";
      editAccent.value = data.colors?.accent || "#ffcc33";
      editSubscription.value = data.subscriptionType || (data.plan?.type) || "lifetime";
      editModal.style.display = "flex";
    });

    // Ø­Ø°Ù
    div.querySelector(".delete-btn").addEventListener("click", async ()=>{
      if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ "${data.name}"ØŸ`)){
        await deleteDoc(doc(db,"institutes",docSnap.id));
        loadInstitutes();
      }
    });

    institutesList.appendChild(div);
  });
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
saveEditBtn.addEventListener("click", async()=>{
  if(!currentEditId) return;
  let updateData = {
    name: editName.value,
    adminEmail: editEmail.value,
    subscriptionType: editSubscription.value,
    colors:{
      primary: editPrimary.value,
      bg: editBg.value,
      card: editCard.value,
      accent: editAccent.value
    }
  };

  if(editLogo.files.length > 0){
    const file = editLogo.files[0];
    const logoRef = ref(storage, `instituteLogos/${Date.now()}_${file.name}`);
    await uploadBytes(logoRef,file);
    const logoUrl = await getDownloadURL(logoRef);
    updateData.logoUrl = logoUrl;
  }

  await updateDoc(doc(db,"institutes",currentEditId), updateData);
  editModal.style.display = "none";
  loadInstitutes();
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
closeModal.addEventListener("click", ()=>{ editModal.style.display = "none"; });

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
loadInstitutes();
</script>
</body>
</html>