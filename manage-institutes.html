<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</title>
<style>
  :root { --primary: #004aad; --bg: #f5f9ff; --card: #fff; }
  body { margin:0; font-family:'Cairo',sans-serif; background:var(--bg); }
  header { background: var(--primary); color:white; text-align:center; padding:15px; font-size:20px; font-weight:bold; }
  .container { max-width:900px; margin:30px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  h2 { color: var(--primary); margin-bottom:20px; text-align:center; }
  input, select { width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
  label { font-weight:bold; margin-bottom:5px; display:block; }
  button { background: var(--primary); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-size:16px; cursor:pointer; transition:0.3s; }
  button:hover { background:#003a8c; }
  .color-input { width:50px; height:30px; padding:0; border:none; margin-right:10px; vertical-align:middle; }
  table { width:100%; border-collapse:collapse; margin-top:25px; }
  th, td { border:1px solid #ccc; padding:10px; text-align:center; }
  th { background:#eef4ff; }
  .logo-preview { max-width:80px; max-height:50px; display:block; margin-top:10px; }
  .error { color:red; margin-bottom:15px; }
  .success { color:green; margin-bottom:15px; }
</style>
</head>
<body>
<header>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ - Ù†Ø¸Ø§Ù… OMA</header>
<div class="container">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
  <p class="error" id="errorMsg"></p>
  <p class="success" id="successMsg"></p>

  <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="email" id="adminEmail" placeholder="example@domain.com" required />

  <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="password" id="adminPassword" placeholder="********" required />

  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="text" id="instituteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯" required />

  <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="file" id="instituteLogo" accept="image/*" />
  <img id="logoPreview" class="logo-preview" src="" alt="Logo Preview" />

  <label>ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="color" id="colorPrimary" class="color-input" title="Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" value="#004aad" />
  <input type="color" id="colorAccent" class="color-input" title="Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ" value="#ffcc33" />

  <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
  <select id="licenseType">
    <option value="lifetime">Ø³Ù†Ø© Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</option>
    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
  </select>

  <button id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>

  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</th>
        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±</th>
        <th>Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
        <th>Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø®ÙŠØµ</th>
      </tr>
    </thead>
    <tbody id="instituteList"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const adminEmail = document.getElementById("adminEmail");
const adminPassword = document.getElementById("adminPassword");
const instituteName = document.getElementById("instituteName");
const instituteLogo = document.getElementById("instituteLogo");
const logoPreview = document.getElementById("logoPreview");
const colorPrimary = document.getElementById("colorPrimary");
const colorAccent = document.getElementById("colorAccent");
const licenseType = document.getElementById("licenseType");
const createBtn = document.getElementById("createBtn");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");
const instituteList = document.getElementById("instituteList");

// Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙˆØ± Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
instituteLogo.addEventListener("change", () => {
  const file = instituteLogo.files[0];
  if(file){
    logoPreview.src = URL.createObjectURL(file);
  }
});

// Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯
async function loadInstitutes(){
  instituteList.innerHTML = "";
  const querySnapshot = await getDocs(collection(db,"institutes"));
  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.name}</td>
      <td>${data.adminEmail}</td>
      <td>${data.logoURL ? `<img src="${data.logoURL}" width="60">` : ''}</td>
      <td>${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString() : ''}</td>
      <td>${data.licenseType}</td>
    `;
    instituteList.appendChild(tr);
  });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯
createBtn.addEventListener("click", async () => {
  errorMsg.textContent = "";
  successMsg.textContent = "";

  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  const name = instituteName.value.trim();
  const license = licenseType.value;
  const primaryColor = colorPrimary.value;
  const accentColor = colorAccent.value;
  const logoFile = instituteLogo.files[0];

  if(!email || !password || !name){
    errorMsg.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
    return;
  }

  createBtn.disabled = true;
  createBtn.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...";

  try{
    // 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    const adminUid = userCred.user.uid;

    // 2ï¸âƒ£ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù† ÙˆØ¬Ø¯
    let logoURL = "";
    if(logoFile){
      const storageRef = ref(storage, `instituteLogos/${adminUid}_${logoFile.name}`);
      await uploadBytes(storageRef, logoFile);
      logoURL = await getDownloadURL(storageRef);
    }

    // 3ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙÙŠ Firestore
    await addDoc(collection(db,"institutes"),{
      name: name,
      adminEmail: email,
      adminUid: adminUid,
      logoURL: logoURL,
      colors: { primary: primaryColor, accent: accentColor },
      licenseType: license,
      createdAt: serverTimestamp()
    });

    successMsg.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
    adminEmail.value = adminPassword.value = instituteName.value = "";
    instituteLogo.value = "";
    logoPreview.src = "";

    loadInstitutes();
  }catch(err){
    console.error(err);
    errorMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: "+err.message;
  }finally{
    createBtn.disabled = false;
    createBtn.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯";
  }
});

// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadInstitutes();
</script>
</body>
</html>