<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ - OMA</title>
<style>
:root {
  --primary:#004aad;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;background:var(--bg);margin:0;padding:18px;direction:rtl}
h2{text-align:center;color:var(--primary);margin-bottom:14px}
.container{max-width:980px;margin:0 auto}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:220px}
label{display:block;font-weight:700;margin-bottom:6px;color:#244}
input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d6dde9;font-size:14px;margin-bottom:10px}
input[type="file"]{padding:6px}
.color-box{display:inline-block;width:28px;height:28px;border-radius:6px;border:1px solid #ccc;vertical-align:middle;margin-left:8px}
.btn{background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--primary);color:var(--primary)}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #e6eef8}
.actions button{margin-left:6px}
.small{font-size:13px;color:#556}
#status{white-space:pre-wrap;margin-top:6px}
@media(max-width:720px){ .row{flex-direction:column} .col{min-width:unset} }
</style>
</head>
<body>
<div class="container">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯</h2>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
        <input id="instituteName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹Ù‡Ø¯ OMA - Ø¨ØºØ¯Ø§Ø¯" />
      </div>

      <div class="col">
        <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯ (ØµÙˆØ±Ø©)</label>
        <input id="instituteLogo" type="file" accept="image/*" />
      </div>

      <div class="col">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
        <input id="adminEmail" type="email" placeholder="admin@mail.com" />
      </div>

      <div class="col">
        <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
        <input id="adminPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
        <input id="colorPrimary" type="color" value="#004aad" />
        <span class="color-box" id="boxPrimary"></span>
      </div>
      <div class="col">
        <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
        <input id="colorBg" type="color" value="#f5f9ff" />
        <span class="color-box" id="boxBg"></span>
      </div>
      <div class="col">
        <label>Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</label>
        <input id="colorCard" type="color" value="#ffffff" />
        <span class="color-box" id="boxCard"></span>
      </div>
      <div class="col">
        <label>Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ²</label>
        <input id="colorAccent" type="color" value="#ffcc33" />
        <span class="color-box" id="boxAccent"></span>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
        <select id="subscriptionType">
          <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (30 ÙŠÙˆÙ…)</option>
          <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
          <option value="lifetime">Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</option>
        </select>
      </div>

      <div class="col">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</label>
        <input id="createdAt" type="date" />
      </div>

      <div class="col">
        <label>Ù…Ø¯Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© (Ø£ÙŠØ§Ù…) â€” Ø¥Ù† Ø§Ø®ØªØ±Øª ØªØ¬Ø±ÙŠØ¨ÙŠ</label>
        <input id="trialDays" type="number" min="1" value="30" />
      </div>

      <div class="col" style="display:flex;align-items:flex-end;gap:8px">
        <button id="createBtn" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
        <button id="updateBtn" class="btn" style="display:none;background:#2e7d32">ØªØ­Ø¯ÙŠØ«</button>
        <button id="clearBtn" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>

    <div id="status" class="small"></div>
  </div>

  <div class="card">
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯</h3>
    <div id="institutesList" style="max-height:360px;overflow:auto;"></div>
    <div style="margin-top:12px">
      <button id="refreshBtn" class="btn ghost">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>
  </div>

  <div style="text-align:center;margin-top:8px">
    <button id="logoutBtn" class="btn">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- Firebase SDKs (modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-functions.js";

/* ====== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase - Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const functions = getFunctions(app);

/* ---------- Ø¹Ù†Ø§ØµØ± DOM ---------- */
const instituteName = document.getElementById('instituteName');
const instituteLogo = document.getElementById('instituteLogo');
const adminEmail = document.getElementById('adminEmail');
const adminPassword = document.getElementById('adminPassword');
const colorPrimary = document.getElementById('colorPrimary');
const colorBg = document.getElementById('colorBg');
const colorCard = document.getElementById('colorCard');
const colorAccent = document.getElementById('colorAccent');
const subscriptionType = document.getElementById('subscriptionType');
const createdAt = document.getElementById('createdAt');
const trialDays = document.getElementById('trialDays');

const createBtn = document.getElementById('createBtn');
const updateBtn = document.getElementById('updateBtn');
const clearBtn = document.getElementById('clearBtn');
const refreshBtn = document.getElementById('refreshBtn');
const logoutBtn = document.getElementById('logoutBtn');

const boxPrimary = document.getElementById('boxPrimary');
const boxBg = document.getElementById('boxBg');
const boxCard = document.getElementById('boxCard');
const boxAccent = document.getElementById('boxAccent');

const statusEl = document.getElementById('status');
const institutesList = document.getElementById('institutesList');

let editingDocId = null;
let editingAdminId = null;

/* ===== helpers ===== */
function log(msg){ statusEl.textContent += msg + '\n'; statusEl.scrollTop = statusEl.scrollHeight; }
function clearLog(){ statusEl.textContent = ''; }
function setStatus(msg, color='black'){ statusEl.style.color = color; log(msg); }

/* Ø¹Ø±Ø¶ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
function updateColorBoxes(){
  boxPrimary.style.background = colorPrimary.value;
  boxBg.style.background = colorBg.value;
  boxCard.style.background = colorCard.value;
  boxAccent.style.background = colorAccent.value;
}
[colorPrimary, colorBg, colorCard, colorAccent].forEach(i=> i.addEventListener('input',updateColorBoxes));
updateColorBoxes();

/* ===== ØªØ­Ù‚Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„ ÙƒÙ€ superAdmin ===== */
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
onAuthStateChanged(auth, async user=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }
  // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙØ¹Ø±Ù‘Ù ÙÙŠ users collection ÙƒÙ€ superAdmin
  try{
    const uDoc = await getDoc(doc(db,'users',user.uid));
    if(!uDoc.exists() || uDoc.data().type !== 'superAdmin'){
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
      await signOut(auth);
      window.location.href = "login.html";
      return;
    }
  }catch(err){
    console.error(err);
  }
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  loadInstitutes();
});

/* ===== Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Storage ===== */
async function uploadLogoIfAny(file){
  if(!file) return '';
  const path = `instituteLogos/${Date.now()}_${file.name}`;
  const r = ref(storage, path);
  const snap = await uploadBytes(r, file);
  const url = await getDownloadURL(r);
  return { url, path };
}

/* ===== Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Cloud Function Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ (Ù…Ø³ØªØ­Ø³Ù†) =====
   Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© callable 'createInstitute' ÙÙŠ Cloud Functions.
   Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…ÙŠØ© Ø³ØªÙ†Ø´Ø¦ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth ÙˆØªØ¨Ù‚ÙŠ Ø¬Ù„Ø³Ø© superAdmin ÙƒÙ…Ø§ Ù‡ÙŠ.
*/
async function callCreateInstitute(payload){
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ callable
  const createInstitute = httpsCallable(functions, 'createInstitute');
  const res = await createInstitute(payload);
  return res.data;
}

/* ===== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯ ===== */
createBtn.addEventListener('click', async ()=>{
  clearLog();
  const name = instituteName.value.trim();
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  const colors = {
    primary: colorPrimary.value,
    bg: colorBg.value,
    card: colorCard.value,
    accent: colorAccent.value
  };
  const plan = subscriptionType.value;
  const created = createdAt.value ? new Date(createdAt.value).toISOString() : null;
  const trial = Number(trialDays.value || 30);

  if(!name || !email || !password){
    setStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø©: Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ØŒ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.', 'red'); return;
  }
  try{
    setStatus('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯) ...');
    const logoFile = instituteLogo.files[0];
    let logoUrl = '', logoPath = '';
    if(logoFile){
      const upl = await uploadLogoIfAny(logoFile);
      logoUrl = upl.url; logoPath = upl.path;
      setStatus('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±.');
    }

    setStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¹Ø¨Ø± Cloud Function ... (Ù„Ø§ ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ØªØºÙŠÙŠØ± Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„)');
    // Ù…Ù† Ø§Ù„Ø£ÙØ¶Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…ÙŠØ©
    const payload = {
      name,
      adminEmail: email,
      adminPassword: password,
      logoUrl,
      logoPath,
      colors,
      plan,
      createdAt: created,
      trialDays: plan === 'trial' ? trial : null
    };

    const result = await callCreateInstitute(payload);
    if(result && result.success){
      setStatus('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯: ' + result.instituteId + ')', 'green');
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      loadInstitutes();
      // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
      instituteName.value = ''; adminEmail.value=''; adminPassword.value=''; instituteLogo.value='';
    } else {
      setStatus('Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…ÙŠØ©: ' + (result?.message||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'red');
    }
  }catch(err){
    console.error(err);
    setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ' + (err.message || err), 'red');
  }
});

/* ===== ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ ===== */
async function loadInstitutes(){
  institutesList.innerHTML = '';
  try{
    const snap = await getDocs(collection(db,'institutes'));
    if(snap.empty){ institutesList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù‡Ø¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>'; return; }
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const item = document.createElement('div');
      item.className = 'list-item';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${d.name}</strong><div class="small">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±: ${d.adminEmail || '-'} â€” Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${d.subscriptionType || '-'}</div>`;
      const right = document.createElement('div');
      right.className = 'actions';
      const editBtn = document.createElement('button'); editBtn.textContent='ØªØ¹Ø¯ÙŠÙ„'; editBtn.className='btn ghost';
      const delBtn = document.createElement('button'); delBtn.textContent='Ø­Ø°Ù'; delBtn.className='btn';
      const previewBtn = document.createElement('button'); previewBtn.textContent='Ø¹Ø±Ø¶'; previewBtn.className='btn ghost';
      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      editBtn.addEventListener('click', async ()=>{
        editingDocId = docSnap.id;
        editingAdminId = d.adminId || null;
        instituteName.value = d.name || '';
        adminEmail.value = d.adminEmail || '';
        adminPassword.value = ''; // Ù„Ø§ Ù†Ø¸Ù‡Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        colorPrimary.value = (d.colors && d.colors.primary) || '#004aad';
        colorBg.value = (d.colors && d.colors.bg) || '#f5f9ff';
        colorCard.value = (d.colors && d.colors.card) || '#ffffff';
        colorAccent.value = (d.colors && d.colors.accent) || '#ffcc33';
        subscriptionType.value = d.subscriptionType || 'lifetime';
        updateColorBoxes();
        createBtn.style.display='none';
        updateBtn.style.display='inline-block';
        setStatus('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø«Ù… Ø§Ù„Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ«".', 'black');
      });
      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù† ÙŠÙØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Auth ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)ØŸ')) return;
        try{
          // Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Cloud Function Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©)
          const deleteInstitute = httpsCallable(functions,'deleteInstitute');
          setStatus('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¹Ø¨Ø± Cloud Function ...');
          const res = await deleteInstitute({ instituteId: docSnap.id, adminId: d.adminId });
          if(res.data && res.data.success){
            setStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­.', 'green');
            loadInstitutes();
          } else {
            // ÙƒÙ…Ù„Ù Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù†Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù…Ø­Ù„ÙŠÙ‹Ø§
            await deleteDoc(doc(db,'institutes',docSnap.id));
            setStatus('ØªÙ… Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù…Ø­Ù„ÙŠÙ‹Ø§. (Ø¥Ù† Ø£Ø±Ø¯Øª Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth Ø§Ø­Ø°ÙÙ‡ Ù…Ù† Console).', 'orange');
            loadInstitutes();
          }
        }catch(err){
          console.error(err);
          setStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + (err.message || err), 'red');
        }
      });
      previewBtn.addEventListener('click', ()=>{
        // Ø¹Ø±Ø¶ Ø¨Ø³ÙŠØ·: Ù†ÙØªØ­ ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ ÙˆØªÙ…Ø±ÙŠØ± id (Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙØ¹Ù„ÙŠ Ø­Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ)
        window.open('dashboard.html?instituteId=' + encodeURIComponent(docSnap.id),'_blank');
      });

      right.appendChild(previewBtn);
      right.appendChild(editBtn);
      right.appendChild(delBtn);
      item.appendChild(left);
      item.appendChild(right);
      institutesList.appendChild(item);
    });
  }catch(err){
    console.error(err);
    setStatus('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯: ' + (err.message || err), 'red');
  }
}

/* ===== ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù‡Ø¯ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Firestore) =====
   Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Auth (Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±) ÙŠØªØ·Ù„Ø¨ Admin SDK.
   Ù‡Ù†Ø§ Ù†Ø­Ø¯Ù‘Ø« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙˆÙ…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ FirestoreØ› Ù„Ø­Ø°Ù/ØªØºÙŠÙŠØ± Auth Ø§Ø³ØªØ®Ø¯Ù… Cloud Function.
*/
updateBtn.addEventListener('click', async ()=>{
  if(!editingDocId){ setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù‡Ø¯ Ù…ÙØ­Ø¯Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'red'); return; }
  const name = instituteName.value.trim();
  const email = adminEmail.value.trim();
  const colors = { primary: colorPrimary.value, bg: colorBg.value, card: colorCard.value, accent: colorAccent.value };
  const plan = subscriptionType.value;

  try{
    setStatus('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯) ...');
    let logoUrl = undefined;
    if(instituteLogo.files[0]){
      const upl = await uploadLogoIfAny(instituteLogo.files[0]);
      logoUrl = upl.url;
    }
    const instituteRef = doc(db,'institutes',editingDocId);
    const payload = {
      name, colors, subscriptionType: plan
    };
    if(logoUrl) payload.logoUrl = logoUrl;
    await updateDoc(instituteRef, payload);
    // ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ user Ø§Ù„Ù…Ø±ØªØ¨Ø· - (ÙÙ‚Ø· ÙÙŠ Firestore)
    if(editingAdminId){
      const userRef = doc(db,'users',editingAdminId);
      await updateDoc(userRef, { email });
    }
    setStatus('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 'green');
    // reset UI
    createBtn.style.display='inline-block';
    updateBtn.style.display='none';
    editingDocId = null; editingAdminId=null;
    instituteName.value=''; adminEmail.value=''; adminPassword.value=''; instituteLogo.value='';
    loadInstitutes();
  }catch(err){
    console.error(err);
    setStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + err.message, 'red');
  }
});

/* ===== Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
clearBtn.addEventListener('click', ()=>{
  instituteName.value=''; adminEmail.value=''; adminPassword.value=''; instituteLogo.value=''; createdAt.value='';
  createBtn.style.display='inline-block'; updateBtn.style.display='none'; editingDocId=null;
  setStatus('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'black');
});
refreshBtn.addEventListener('click', loadInstitutes);

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== */
logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href = 'login.html';
});
</script>
</body>
</html>