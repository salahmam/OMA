<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© â€” Ø±Ø³Ù…ÙŠØ© (Ø±Ø³ÙˆÙ…ÙŠØ©)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eaf6ee;
    --panel:#ffffff;
    --accent:#0b6b2e;
    --leaf:#2fa34a;
    --trunk:#7b4f2a;
    --muted:#40514e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
  header{height:64px;background:linear-gradient(90deg,var(--accent),#1f8b3a);color:white;display:flex;align-items:center;justify-content:space-between;padding:8px 16px}
  header h1{margin:0;font-size:18px}
  .app{display:flex;height:calc(100% - 64px)}
  .panel{width:320px;padding:14px;background:var(--panel);border-left:6px solid var(--accent);box-shadow:0 6px 18px rgba(11,107,46,0.08);overflow:auto}
  .main{flex:1;display:flex;flex-direction:column;gap:8px;padding:10px}
  .toolbar{display:flex;gap:8px;align-items:center}
  .toolbar button{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .toolbar .alt{background:#fff;color:var(--accent);border:1px solid rgba(11,107,46,0.12)}
  .row{display:flex;gap:8px;margin:8px 0}
  input[type="text"], input[type="number"]{padding:8px;border-radius:8px;border:1px solid #e6f1ea;flex:1}
  .canvas-area{flex:1;background:linear-gradient(180deg,#f7fffb,transparent);border-radius:12px;overflow:hidden;position:relative;border:1px dashed rgba(11,107,46,0.06)}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;padding:12px;z-index:80}
  .dialog{background:white;border-radius:10px;padding:12px;min-width:260px;max-width:90%}
  .dialog h3{margin:0 0 8px 0;font-size:16px}
  .node-card{font-weight:700;padding:6px 10px;border-radius:14px;background:linear-gradient(180deg,#ffffff,#ecffef);border:2px solid rgba(47,163,74,0.12);display:inline-block}
  /* small-mobile: panel full width toggle */
  @media (max-width:880px){
    .panel{width:100%;position:relative;z-index:10}
    .app{flex-direction:column}
  }
  /* tips */
  .hint{font-size:13px;color:#406b57;margin-top:8px}
  /* footer small */
  footer{font-size:12px;color:#2e5745;margin-top:6px}
  /* draggable cursor */
  .canvas-area.grabbing{cursor:grabbing}
</style>
</head>
<body>
<header>
  <h1>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© â€” Ø±Ø³ÙˆÙ…ÙŠØ© ğŸŒ³</h1>
  <div style="font-size:13px;opacity:.95">Ø§Ø¶ØºØ· â• Ù„Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ â€” Ø§Ø³Ø­Ø¨ Ù„Ù„ØªÙ†Ù‚Ù„ â€” Ù‚Ù… Ø¨Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¨Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù‚Ø±Øµ</div>
</header>

<div class="app">
  <aside class="panel" aria-label="Ø£Ø¯ÙˆØ§Øª">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:700;margin-bottom:6px">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø´Ø¬Ø±Ø©</div>
        <div style="font-size:13px;color:#2b6b45">Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ â€” Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="rootName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ (Ù…Ø«Ø§Ù„: Ø¬Ø¯ÙŠ)" value="Ø§Ù„Ø¬Ø¯">
      <button id="createRoot">Ø¥Ù†Ø´Ø§Ø¡</button>
    </div>

    <div style="margin-top:10px;font-weight:600">ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
    <div class="row">
      <input id="lvl1count" type="number" min="0" value="11" />
      <input id="lvl2count" type="number" min="0" value="5" />
    </div>
    <div class="row">
      <button id="generate" class="">ØªÙˆÙ„ÙŠØ¯ (Ù…Ø«Ø§Ù„ 11 Ã— 5)</button>
      <button id="clear" class="alt">Ù…Ø³Ø­</button>
    </div>

    <hr style="border:none;border-top:1px dashed #e6f1ea;margin:12px 0">

    <div style="font-weight:600;margin-bottom:6px">ØªØ¹Ù„ÙŠÙ…Ø§Øª</div>
    <ul style="padding-left:18px">
      <li>Ø§Ø¶ØºØ· <strong>â•</strong> Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ ÙˆØ±Ù‚Ø© Ù„Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯.</li>
      <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡.</li>
      <li>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù„ØªØªØ­Ø±ÙƒØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±.</li>
    </ul>
    <div class="hint">ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±. Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub Pages.</div>
    <footer>ØµÙ†Ø¹ Ù„Ùƒ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø¨Ø· Firebase Ù„Ø§Ø­Ù‚Ù‹Ø§</footer>
  </aside>

  <main class="main">
    <div class="toolbar">
      <button id="zoomIn">ØªÙƒØ¨ÙŠØ± +</button>
      <button id="zoomOut" class="alt">ØªØµØºÙŠØ± -</button>
      <button id="reset" class="alt">Ø¥Ø¹Ø§Ø¯Ø©</button>
      <div style="flex:1"></div>
      <button id="export" class="">Ø­ÙØ¸ ØµÙˆØ±Ø© PNG</button>
    </div>

    <div class="canvas-area" id="canvasArea" tabindex="0" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø¬Ø±Ø©">
      <!-- SVG will be injected here -->
      <svg id="svgRoot" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" style="touch-action:none">
        <!-- defs for leaf shape -->
        <defs>
          <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#2a6b2a" flood-opacity="0.12"/>
          </filter>
        </defs>
        <g id="panzoom">
          <!-- trunk background -->
        </g>
      </svg>
    </div>
  </main>
</div>

<!-- modal for name input -->
<div class="modal" id="modal">
  <div class="dialog" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…</h3>
    <input id="modalInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eef6ee;margin-top:6px" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="modalCancel" class="alt">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="modalOk" style="background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>
</div>

<script>
/*
  Ø´Ø¬Ø±Ø© Ø±Ø³ÙˆÙ…ÙŠØ©: ÙŠØ³ØªØ®Ø¯Ù… SVG Ù„Ø±Ø³Ù… Ø¬Ø°Ø¹ ÙˆÙ…Ù† Ø«Ù… Ø£ØºØµØ§Ù† (Ù…Ø³Ø§Ø±Ø§Øª) ÙˆØ¹Ù‚Ø¯ (Ø¯ÙˆØ§Ø¦Ø± / Ø¨Ø·Ø§Ù‚Ø§Øª Ø£ÙˆØ±Ø§Ù‚).
  Layout: Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø© Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (leaf count) Ø«Ù… ØªÙˆØ²ÙŠØ¹ X Ù„ÙƒÙ„ Ø¹Ù‚Ø¯Ø© Ù…Ø±ÙƒØ²ÙŠØ§Ù‹.
  Features: add child (modal), edit name (dblclick), delete (right-click menu via confirm), pan & zoom, generate.
*/

// Model
let idCounter = 1;
function makeNode(name){ return { id: 'n' + (idCounter++), name: name || 'Ø´Ø®Øµ', children: [], collapsed:false }; }
let root = null;

// SVG elements
const svg = document.getElementById('svgRoot');
const panzoom = document.getElementById('panzoom');
const canvasArea = document.getElementById('canvasArea');

// modal
const modal = document.getElementById('modal');
const modalInput = document.getElementById('modalInput');
const modalTitle = document.getElementById('modalTitle');
let modalCallback = null;

// constants for layout
const NODE_W = 120;
const NODE_H = 40;
const LEVEL_VSPACE = 110;
const SIBLING_HSPACE = 28;

// create root and render initial
function createRoot(name){
  root = makeNode(name || 'Ø§Ù„Ø¬Ø¯');
  render();
  fitToView();
}

// tree utilities: compute subtree leaf counts and x positions
function computeLayout(node, depth=0){
  // returns {minX, maxX}
  if(!node) return {min:0,max:0};
  node._depth = depth;
  if(!node.children || node.children.length===0){
    node._leafCount = 1;
    node._minX = 0;
    node._maxX = NODE_W;
    return {min:0,max:NODE_W};
  }
  // compute children ranges
  let curX = 0;
  let min = Infinity, max = -Infinity;
  for(const ch of node.children){
    const r = computeLayout(ch, depth+1);
    ch._offsetX = curX;
    curX += (r.max - r.min) + SIBLING_HSPACE;
    min = Math.min(min, r.min + ch._offsetX);
    max = Math.max(max, r.max + ch._offsetX);
  }
  // remove last sibling spacing
  curX -= SIBLING_HSPACE;
  // center current node over children
  const width = curX>0?curX:NODE_W;
  node._leafCount = node.children.reduce((s,c)=>s + (c._leafCount||1), 0);
  node._minX = 0;
  node._maxX = width;
  return {min:node._minX, max:node._maxX};
}

// assign final absolute positions
function assignPositions(node, originX=0, originY=0){
  // node._x center relative to originX
  const boxW = node._maxX - node._minX || NODE_W;
  // center this node in its box
  node._x = originX + boxW / 2;
  node._y = originY;
  // children
  if(node.children && node.children.length && !node.collapsed){
    for(const ch of node.children){
      const childOriginX = originX + (ch._offsetX || 0);
      const childOriginY = originY + LEVEL_VSPACE;
      assignPositions(ch, childOriginX, childOriginY);
    }
  }
}

// clear svg group
function clearSVG(){
  while(panzoom.firstChild) panzoom.removeChild(panzoom.firstChild);
}

// draw trunk (simple vertical trunk starting near top center)
function drawTrunk(){
  // optional aesthetic trunk path behind everything
  const w = svg.clientWidth;
  const trunk = document.createElementNS('http://www.w3.org/2000/svg','rect');
  trunk.setAttribute('x', (w/2 - 12));
  trunk.setAttribute('y', 20);
  trunk.setAttribute('width', 24);
  trunk.setAttribute('height', 120);
  trunk.setAttribute('rx',12);
  trunk.setAttribute('fill', 'url(#trunkGrad)');
  trunk.setAttribute('fill', '#935f3a');
  trunk.setAttribute('opacity', '0.12');
  panzoom.appendChild(trunk);
}

// render tree nodes and branches
function render(){
  clearSVG();
  if(!root) return;
  // compute layout
  computeLayout(root);
  // set large svg group to have enough space
  const totalW = Math.max(1000, root._maxX - root._minX + 200);
  const totalH = Math.max(600, (maxDepth(root)+1) * LEVEL_VSPACE + 200);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  // assign positions starting from top center offset
  const startX = 80;
  assignPositions(root, startX, 60);
  // draw soft trunk background
  // draw branches recursively
  drawBranchesAndNodes(root);
}

// compute max depth
function maxDepth(node){
  if(!node || !node.children || node.children.length===0) return 0;
  let m=0;
  for(const c of node.children) m = Math.max(m, 1+maxDepth(c));
  return m;
}

// draw branches and nodes recursively
function drawBranchesAndNodes(node){
  // draw branch from node to each child
  if(node.children && node.children.length && !node.collapsed){
    for(const ch of node.children){
      drawBranch(node, ch);
      drawBranchesAndNodes(ch);
    }
  }
  // draw node itself on top
  drawNode(node);
}

function drawBranch(parent, child){
  // curved path from parent.x,parent.y+20 to child.x,child.y-10
  const x1 = parent._x;
  const y1 = parent._y + NODE_H/2;
  const x2 = child._x;
  const y2 = child._y - NODE_H/2 + 6;

  const dx = (y2 - y1) * 0.6;
  // path using cubic bezier
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  const d = `M ${x1} ${y1} C ${x1} ${y1+dx} ${x2} ${y2-dx} ${x2} ${y2}`;
  path.setAttribute('d', d);
  path.setAttribute('fill','none');
  path.setAttribute('stroke', 'rgba(38, 102, 55, 0.18)');
  path.setAttribute('stroke-width', 10);
  path.setAttribute('stroke-linecap','round');
  path.setAttribute('filter','none');
  panzoom.appendChild(path);

  // thinner green line on top
  const path2 = document.createElementNS('http://www.w3.org/2000/svg','path');
  path2.setAttribute('d', d);
  path2.setAttribute('fill','none');
  path2.setAttribute('stroke', '#2fa34a');
  path2.setAttribute('stroke-width', 3);
  path2.setAttribute('stroke-linecap','round');
  panzoom.appendChild(path2);
}

function drawNode(node){
  // create group
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('transform', `translate(${node._x - NODE_W/2}, ${node._y - NODE_H/2})`);
  g.setAttribute('data-id', node.id);

  // leaf shape (ellipse with slight rotate)
  const leaf = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
  leaf.setAttribute('cx', NODE_W/2);
  leaf.setAttribute('cy', NODE_H/2);
  leaf.setAttribute('rx', NODE_W/2 + 12);
  leaf.setAttribute('ry', NODE_H/2 + 8);
  leaf.setAttribute('fill', 'url(#leafGrad)');
  leaf.setAttribute('fill', '#c8f0d0');
  leaf.setAttribute('stroke', '#2fa34a');
  leaf.setAttribute('stroke-width', 1);
  leaf.setAttribute('filter','url(#shadow)');
  leaf.setAttribute('opacity', 0.95);
  g.appendChild(leaf);

  // inner white card
  const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  rect.setAttribute('x', 8);
  rect.setAttribute('y', 6);
  rect.setAttribute('rx', 14);
  rect.setAttribute('ry', 14);
  rect.setAttribute('width', NODE_W - 16);
  rect.setAttribute('height', NODE_H - 12);
  rect.setAttribute('fill', '#ffffff');
  rect.setAttribute('stroke', 'rgba(47,163,74,0.06)');
  rect.setAttribute('stroke-width', 1.2);
  g.appendChild(rect);

  // text
  const text = document.createElementNS('http://www.w3.org/2000/svg','text');
  text.setAttribute('x', NODE_W/2);
  text.setAttribute('y', NODE_H/2 + 4);
  text.setAttribute('text-anchor','middle');
  text.setAttribute('font-size','14');
  text.setAttribute('font-weight','700');
  text.setAttribute('fill','#14472a');
  text.textContent = node.name;
  text.style.cursor = 'pointer';
  // edit name on click
  text.addEventListener('click', (e)=>{
    e.stopPropagation();
    openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…', node.name, (val)=>{
      if(val !== null){
        node.name = val || node.name;
        render();
      }
    });
  });
  g.appendChild(text);

  // add + button (small circle at right)
  const btnGroup = document.createElementNS('http://www.w3.org/2000/svg','g');
  btnGroup.setAttribute('transform', `translate(${NODE_W - 12}, ${-10})`);
  btnGroup.style.cursor = 'pointer';
  const btnCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  btnCircle.setAttribute('r', 12);
  btnCircle.setAttribute('cx', 0);
  btnCircle.setAttribute('cy', 0);
  btnCircle.setAttribute('fill', '#fff');
  btnCircle.setAttribute('stroke', '#2fa34a');
  btnCircle.setAttribute('stroke-width', 1.5);
  btnGroup.appendChild(btnCircle);
  const plus = document.createElementNS('http://www.w3.org/2000/svg','text');
  plus.setAttribute('x', 0);
  plus.setAttribute('y', 4);
  plus.setAttribute('text-anchor','middle');
  plus.setAttribute('font-size','14');
  plus.setAttribute('font-weight','700');
  plus.setAttribute('fill','#2fa34a');
  plus.textContent = '+';
  btnGroup.appendChild(plus);
  btnGroup.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    openModal('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', '', (val)=>{
      if(val){
        node.children = node.children || [];
        node.children.push(makeNode(val));
        render();
        // optional: center on new node after a short delay (no auto)
      }
    });
  });
  g.appendChild(btnGroup);

  // delete on right-click
  g.addEventListener('contextmenu', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    if(node === root){
      if(confirm('Ø­Ø°Ù Ø§Ù„Ø¬Ø°Ø± Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØ§Ù…Ù„Ø©. ØªØ£ÙƒØ¯ØŸ')){ root = null; render(); }
      return;
    }
    if(node.children && node.children.length){
      if(!confirm('Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‚Ø¯Ø© Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ø¨Ù†Ø§Ø¡. Ø­Ø°ÙÙ‡Ø§ Ø³ÙŠØ­Ø°Ù ÙƒÙ„ Ø£Ø¨Ù†Ø§Ø¡Ù‡Ø§. Ù…ÙˆØ§ÙÙ‚ØŸ')) return;
    }
    removeNode(root, node.id);
    render();
  });

  panzoom.appendChild(g);
}

// remove node by id (recursively)
function removeNode(parent, id){
  if(!parent || !parent.children) return false;
  for(let i=0;i<parent.children.length;i++){
    if(parent.children[i].id === id){
      parent.children.splice(i,1);
      return true;
    } else {
      if(removeNode(parent.children[i], id)) return true;
    }
  }
  return false;
}

// modal functions
function openModal(title, defaultVal, cb){
  modalTitle.textContent = title || 'Ø£Ø¯Ø®Ù„ Ù†Øµ';
  modalInput.value = defaultVal || '';
  modal.style.display = 'flex';
  modalInput.focus();
  modalCallback = cb;
}
document.getElementById('modalOk').addEventListener('click', ()=>{
  modal.style.display = 'none';
  if(modalCallback) modalCallback(modalInput.value.trim());
  modalCallback = null;
});
document.getElementById('modalCancel').addEventListener('click', ()=>{
  modal.style.display = 'none';
  if(modalCallback) modalCallback(null);
  modalCallback = null;
});
modal.addEventListener('click', (e)=>{ if(e.target === modal){ modal.style.display='none'; if(modalCallback) modalCallback(null); modalCallback=null;} });

// pan & zoom
let isPanning = false, startX=0, startY=0, curX=0, curY=0, scale=1;
const panGroup = panzoom;
function updateTransform(){ panGroup.setAttribute('transform', `translate(${curX},${curY}) scale(${scale})`); }
canvasArea.addEventListener('pointerdown', (e)=>{
  isPanning = true; startX = e.clientX; startY = e.clientY; canvasArea.classList.add('grabbing'); canvasArea.setPointerCapture(e.pointerId);
});
window.addEventListener('pointermove', (e)=>{
  if(!isPanning) return;
  const dx = e.clientX - startX, dy = e.clientY - startY;
  startX = e.clientX; startY = e.clientY;
  curX += dx; curY += dy;
  updateTransform();
});
window.addEventListener('pointerup', (e)=>{ isPanning = false; canvasArea.classList.remove('grabbing'); });

// wheel zoom
canvasArea.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const rect = svg.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const delta = -e.deltaY * 0.0015;
  const newScale = Math.max(0.25, Math.min(2.8, scale * (1 + delta)));
  // zoom around mouse
  const ratio = newScale / scale;
  curX = (curX - mx) * ratio + mx;
  curY = (curY - my) * ratio + my;
  scale = newScale;
  updateTransform();
}, {passive:false});

// toolbar buttons
document.getElementById('zoomIn').addEventListener('click', ()=>{ scale = Math.min(2.8, scale + 0.12); updateTransform(); });
document.getElementById('zoomOut').addEventListener('click', ()=>{ scale = Math.max(0.25, scale - 0.12); updateTransform(); });
document.getElementById('reset').addEventListener('click', ()=>{ curX = 0; curY = 0; scale = 1; updateTransform(); fitToView(); });

// helpers: find and remove node by id given root is available (already implemented removeNode)

// export PNG (render SVG to canvas)
document.getElementById('export').addEventListener('click', async ()=>{
  try{
    const serializer = new XMLSerializer();
    // clone svg and inline current transform
    const clone = svg.cloneNode(true);
    // set width/height attributes explicitly to client sizes
    const w = svg.clientWidth || 1200;
    const h = svg.clientHeight || 800;
    clone.setAttribute('width', w);
    clone.setAttribute('height', h);
    // embed css for fonts to improve rendering
    const svgStr = serializer.serializeToString(clone);
    const blob = new Blob([svgStr], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(800, img.width);
      canvas.height = Math.max(600, img.height);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);
      canvas.toBlob((b)=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'family-tree.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
    };
    img.onerror = ()=>{ alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© â€” Ø­Ø§ÙˆÙ„ ØªÙ‚Ù„ÙŠÙ„ ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø¬Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±.'); URL.revokeObjectURL(url); };
    img.src = url;
  }catch(err){ console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (err.message||err)); }
});

// add / clear / generate buttons
document.getElementById('createRoot').addEventListener('click', ()=>{
  const name = document.getElementById('rootName').value.trim() || 'Ø§Ù„Ø¬Ø¯';
  createRoot(name);
});
document.getElementById('clear').addEventListener('click', ()=>{ if(confirm('Ù…Ø³Ø­ ÙƒØ§Ù…Ù„ Ù„Ù„Ø´Ø¬Ø±Ø©ØŸ')){ root = null; render(); }});
document.getElementById('generate').addEventListener('click', ()=>{
  const rootName = (document.getElementById('rootName').value || 'Ø§Ù„Ø¬Ø¯').trim();
  const c1 = Math.max(0, parseInt(document.getElementById('lvl1count').value||0));
  const c2 = Math.max(0, parseInt(document.getElementById('lvl2count').value||0));
  root = makeNode(rootName);
  for(let i=1;i<=c1;i++){
    const child = makeNode('Ø§Ø¨Ù† ' + i);
    for(let j=1;j<=c2;j++) child.children.push(makeNode('Ø­ÙÙŠØ¯ ' + i + '.' + j));
    root.children.push(child);
  }
  render();
  fitToView();
});

// initial sample root
createRoot(document.getElementById('rootName').value || 'Ø§Ù„Ø¬Ø¯');

// fit to view (attempts to center top)
function fitToView(){
  // simple centering: compute bounding box of content then translate
  // we approximate by using root bounds.
  if(!root) return;
  // place root near top center
  const vb = svg.getAttribute('viewBox')?.split(' ').map(Number) || [0,0,1000,800];
  const vbW = vb[2], vbH = vb[3];
  // center root horizontally
  const targetX = (vbW/2) - root._x;
  const targetY = 20 - root._y;
  curX = targetX;
  curY = targetY;
  scale = 1;
  updateTransform();
}

// double-tap or double-click behavior: already handled click on name to edit

// Make svg responsive to resize
window.addEventListener('resize', ()=>{ render(); updateTransform(); });

// Accessibility: keyboard: +/- to zoom
window.addEventListener('keydown', (e)=>{
  if(e.key === '+' || e.key === '='){ scale = Math.min(2.8, scale+0.12); updateTransform(); }
  if(e.key === '-' ){ scale = Math.max(0.25, scale-0.12); updateTransform(); }
});

// small touch improvement: tap area for add handled by event listeners on svg elements
</script>
</body>
</html>