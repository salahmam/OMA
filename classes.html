<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ</title>
<style>
body{font-family:'Cairo',sans-serif;margin:0;padding:20px;background:#f5f9ff;color:#102027;visibility:hidden;}
header{background:#004aad;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:15px;}
header img{height:50px;}
.wrap{max-width:1200px;margin:auto;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.schedule-grid{display:flex;gap:10px;flex-wrap:wrap;}
.day-column{flex:1;min-width:150px;}
.day-column h3{text-align:center;background:#004aad;color:#fff;padding:6px;border-radius:6px;}
.lesson-box{border-radius:6px;color:#fff;padding:8px;margin:6px 0;}
@media print{
  body{background:white;}
  header, .card, .btn, .filters{display:none !important;}
  .day-column h3{background:#004aad !important;color:#fff !important;}
}
</style>
</head>
<body>
<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
</header>

<div class="wrap">
  <div class="card filters">
    <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­ØµØµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</strong>
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="filterSubject"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="filterGroup"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
    <select id="filterRoom"><option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="Ù‚Ø§Ø¹Ø© 1">Ù‚Ø§Ø¹Ø© 1</option>
      <option value="Ù‚Ø§Ø¹Ø© 2">Ù‚Ø§Ø¹Ø© 2</option>
      <option value="Ù‚Ø§Ø¹Ø© 3">Ù‚Ø§Ø¹Ø© 3</option>
      <option value="Ù‚Ø§Ø¹Ø© 4">Ù‚Ø§Ø¹Ø© 4</option>
      <option value="Ù‚Ø§Ø¹Ø© 5">Ù‚Ø§Ø¹Ø© 5</option>
      <option value="Ù‚Ø§Ø¹Ø© 6">Ù‚Ø§Ø¹Ø© 6</option>
      <option value="Ù‚Ø§Ø¹Ø© 7">Ù‚Ø§Ø¹Ø© 7</option>
      <option value="Ù‚Ø§Ø¹Ø© 8">Ù‚Ø§Ø¹Ø© 8</option>
      <option value="Ù‚Ø§Ø¹Ø© 9">Ù‚Ø§Ø¹Ø© 9</option>
      <option value="Ù‚Ø§Ø¹Ø© 10">Ù‚Ø§Ø¹Ø© 10</option>
    </select>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="filterDay"><option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
      <option value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
    <button id="printBtn" class="btn" style="margin-top:8px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
  </div>

  <div id="printArea" class="schedule-grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterRoom = document.getElementById("filterRoom");
const filterDay = document.getElementById("filterDay");
const printBtn = document.getElementById("printBtn");
const printArea = document.getElementById("printArea");

let subjectsList=[], teachersList=[], groupsList=[], classesData=[], settings={colors:{}};

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }
  document.body.style.visibility="visible";
  await loadSettings();
  await loadSubjectsTeachersGroups();
  await loadClasses();
});

// Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ (Ø§Ù„Ø´Ø¹Ø§Ø±ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­ØµØµ)
async function loadSettings(){
  const docSnap = await getDocs(collection(db,"settings"));
  docSnap.forEach(doc=>{
    const data = doc.data();
    settings.name = data.name || "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    settings.logo = data.logo || "";
    settings.colors = data.colors || {};
  });
  document.getElementById("instituteLogo").src = settings.logo;
  document.getElementById("instituteName").textContent = settings.name;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©ØŒ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
async function loadSubjectsTeachersGroups(){
  subjectsList = [];
  teachersList = [];
  groupsList = [];
  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet = new Set(), groupsSet = new Set();
  studentsSnap.forEach(s=>{
    s.data().subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(s.data().group) groupsSet.add(s.data().group);
  });
  subjectsList=[...subjectsSet];
  groupsList=[...groupsSet];

  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersSnap.forEach(t=>teachersList.push({id:t.id,...t.data()}));

  // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ„Ø§ØªØ±
  filterSubject.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  subjectsList.forEach(s=>filterSubject.innerHTML+=`<option value="${s}">${s}</option>`);
  filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersList.forEach(t=>filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
  filterGroup.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  groupsList.forEach(g=>filterGroup.innerHTML+=`<option value="${g}">${g}</option>`);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
async function loadClasses(){
  const snapshot = await getDocs(collection(db,"classes"));
  classesData = [];
  snapshot.forEach(docSnap=>{
    const cls = {id: docSnap.id, ...docSnap.data()};
    classesData.push(cls);
  });
  renderSchedule();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±
function renderSchedule(){
  const days = ["Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©"];
  printArea.innerHTML = "";
  const filtered = classesData.filter(cls=>{
    return (!filterSubject.value || cls.subject===filterSubject.value) &&
           (!filterTeacher.value || cls.teacherId===filterTeacher.value) &&
           (!filterGroup.value || cls.group===filterGroup.value) &&
           (!filterRoom.value || cls.room===filterRoom.value) &&
           (!filterDay.value || cls.day===filterDay.value);
  });

  days.forEach(day=>{
    const col = document.createElement("div");
    col.className="day-column";
    col.innerHTML=`<h3>${day}</h3>`;
    const dayClasses = filtered.filter(c=>c.day===day).sort((a,b)=>{
      return a.startTime.localeCompare(b.startTime);
    });
    dayClasses.forEach(c=>{
      const teacherName = (teachersList.find(t=>t.id===c.teacherId)||{}).name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const color = settings.colors[c.subject] || "#004aad";
      const box = document.createElement("div");
      box.className="lesson-box";
      box.style.backgroundColor=color;
      box.innerHTML = `<strong>${c.subject}</strong>
        <p>Ø§Ù„Ø£Ø³ØªØ§Ø°: ${teacherName}</p>
        <p>Ø§Ù„ÙƒØ±ÙˆØ¨: ${c.group}</p>
        <p>Ø§Ù„Ù‚Ø§Ø¹Ø©: ${c.room}</p>
        <p>Ø§Ù„ÙˆÙ‚Øª: ${c.startTime} - ${c.endTime}</p>`;
      col.appendChild(box);
    });
    printArea.appendChild(col);
  });
}

// Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click", ()=>{ renderSchedule(); window.print(); });
</script>
</body>
</html>