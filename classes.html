<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø­ØµØµ</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family: 'Cairo',sans-serif;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;padding:18px 16px;text-align:center;font-size:20px;font-weight:700;
  box-shadow:0 3px 12px rgba(2,20,40,0.08);
}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
.three{width:calc(33.333% - 8px)}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.warn{background:#ff7043}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.actions button{margin:0 6px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
@media (max-width:900px){.two,.three{width:100%}}
@media print{
  body{background:white;padding:0}
  header, .card form, .actions, .filters, .modal { display:none !important; }
  .print-page{box-shadow:none;margin:0;padding:0}
}
.modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999;}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto}
.flex{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø­ØµØµ</header>
<div class="wrap">

<div class="card">
  <strong>Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</strong>
  <form id="lessonForm" style="margin-top:12px">
    <div class="form-grid">
      <div class="two">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³</label>
        <input id="lessonName" type="text" required />
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <select id="lessonTeacher" required></select>
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
        <select id="lessonStage" required></select>
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
        <select id="lessonGroup" required></select>
      </div>
      <div class="two">
        <label>Ø§Ù„ÙŠÙˆÙ…</label>
        <select id="lessonDay" required>
          <option>Ø§Ù„Ø³Ø¨Øª</option>
          <option>Ø§Ù„Ø£Ø­Ø¯</option>
          <option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
          <option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
          <option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
          <option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
        </select>
      </div>
      <div class="two">
        <label>Ø§Ù„ÙˆÙ‚Øª</label>
        <input type="time" id="lessonTime" required />
      </div>
      <div style="width:100%;display:flex;justify-content:flex-end">
        <button class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³</button>
        <button type="button" class="btn ghost" id="clearLessonForm">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>
  </form>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</strong> <span id="lessonCount" class="badge">0</span></div>
  </div>
  <table id="lessonsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø¯Ø±Ø³</th>
        <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
        <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
        <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lessonForm = document.getElementById("lessonForm");
const lessonsTableBody = document.querySelector("#lessonsTable tbody");
const lessonTeacher = document.getElementById("lessonTeacher");
const lessonStage = document.getElementById("lessonStage");
const lessonGroup = document.getElementById("lessonGroup");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø±Ø¨Ø·
let teachersData = [];
let studentsData = [];

async function loadTeachers(){
  const snapshot = await getDocs(collection(db,"teachers"));
  lessonTeacher.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…</option>';
  teachersData=[];
  snapshot.forEach(docSnap=>{
    const t = {...docSnap.data(),id:docSnap.id};
    teachersData.push(t);
    lessonTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });
}

async function loadStudents(){
  const snapshot = await getDocs(collection(db,"students"));
  studentsData=[];
  let stagesSet = new Set();
  let groupsSet = new Set();
  snapshot.forEach(docSnap=>{
    const s = {...docSnap.data(),id:docSnap.id};
    studentsData.push(s);
    if(s.stage) stagesSet.add(s.stage);
    if(s.group) groupsSet.add(s.group);
  });
  lessonStage.innerHTML='<option value="">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>'+[...stagesSet].map(s=>`<option value="${s}">${s}</option>`).join("");
  lessonGroup.innerHTML='<option value="">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>'+[...groupsSet].map(g=>`<option value="${g}">${g}</option>`).join("");
}

// Ø­ÙØ¸ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
lessonForm.addEventListener("submit",async(e)=>{
  e.preventDefault();
  const name=document.getElementById("lessonName").value.trim();
  const teacherId=lessonTeacher.value;
  const stage=lessonStage.value;
  const group=lessonGroup.value;
  const day=document.getElementById("lessonDay").value;
  const time=document.getElementById("lessonTime").value;

  if(!name || !teacherId || !stage || !group || !day || !time){alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");return;}

  try{
    await addDoc(collection(db,"lessons"),{name,teacherId,stage,group,day,time,attendance:[],createdAt:new Date()});
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
    lessonForm.reset();
    loadLessons();
  }catch(err){console.error(err);alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³
async function loadLessons(){
  const snapshot = await getDocs(collection(db,"lessons"));
  lessonsTableBody.innerHTML="";
  let count=0;
  snapshot.forEach(docSnap=>{
    const l = {...docSnap.data(),id:docSnap.id};
    count++;
    const teacher = teachersData.find(t=>t.id===l.teacherId)?.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${l.name}</td>
      <td>${teacher}</td>
      <td>${l.stage}</td>
      <td>${l.group}</td>
      <td>${l.day}</td>
      <td>${l.time}</td>
      <td><button class="btn small" onclick="manageAttendance('${l.id}')">ğŸ“ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨</button></td>
      <td class="actions">
        <button class="btn small" onclick="showLesson('${l.id}')">ğŸ” Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
      </td>
    `;
    lessonsTableBody.appendChild(tr);
  });
  document.getElementById("lessonCount").innerText=count;
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
window.manageAttendance = async function(lessonId){
  const lessonSnap = await getDocs(collection(db,"lessons"));
  const lessonDoc = lessonSnap.docs.find(d=>d.id===lessonId);
  const lessonData = {...lessonDoc.data(),id:lessonDoc.id};

  const studentsInGroup = studentsData.filter(s=>s.stage===lessonData.stage && s.group===lessonData.group);

  const attendance = lessonData.attendance || [];
  const result = studentsInGroup.map(s=>{
    const present = attendance.includes(s.id)? "Ø­Ø§Ø¶Ø±" : "ØºØ§Ø¦Ø¨";
    return `${s.name} - ${present} - (Ø§Ù†Ù‚Ø± Ù„ØªØ¨Ø¯ÙŠÙ„)`; 
  }).join("\n");
  alert(result); // Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ù…Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø£ÙƒØ«Ø± ØªÙØ§Ø¹Ù„ÙŠØ©
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³
window.showLesson = function(id){
  const modal = document.getElementById("modal");
  const body = document.getElementById("modalBody");
  const lesson = lessonsTableBody.querySelector(`tr button[onclick="showLesson('${id}')"]`).closest("tr");
  body.innerHTML=`<pre>${lesson.innerText}</pre>`;
  modal.classList.add("open");
}

document.getElementById("closeModal").addEventListener("click",()=>{document.getElementById("modal").classList.remove("open")});

// Ø§Ù„Ù…Ø³Ø­
document.getElementById("clearLessonForm").addEventListener("click",()=>lessonForm.reset());

await loadTeachers();
await loadStudents();
await loadLessons();
</script>
</body>
</html>
