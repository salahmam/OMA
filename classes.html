<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ</title>
<style>
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;visibility:hidden;}
header{background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:space-between;}
header img{height:40px;}
.wrap{max-width:1400px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-top:6px;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.day-column{vertical-align:top;width:14%;min-width:150px;}
.lesson-box{border-radius:8px;padding:8px;margin-bottom:8px;color:#fff;}
@media print{
  body{background:white;}
  header,.filters,.actions,.card button,.card form{display:none !important;}
  .wrap{padding:0;}
}
</style>
</head>
<body>
<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
  <button onclick="window.print()" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
</header>
<div class="wrap">

<div class="card">
  <strong>Ø£Ø¶Ù Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</strong>
  <form id="classForm">
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="subjectSelect" required></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="teacherSelect" required></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="groupSelect" required></select>
    <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
    <select id="roomSelect" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø©</option>
      <option value="Ù‚Ø§Ø¹Ø© 1">Ù‚Ø§Ø¹Ø© 1</option>
      <option value="Ù‚Ø§Ø¹Ø© 2">Ù‚Ø§Ø¹Ø© 2</option>
      <option value="Ù‚Ø§Ø¹Ø© 3">Ù‚Ø§Ø¹Ø© 3</option>
      <option value="Ù‚Ø§Ø¹Ø© 4">Ù‚Ø§Ø¹Ø© 4</option>
      <option value="Ù‚Ø§Ø¹Ø© 5">Ù‚Ø§Ø¹Ø© 5</option>
      <option value="Ù‚Ø§Ø¹Ø© 6">Ù‚Ø§Ø¹Ø© 6</option>
      <option value="Ù‚Ø§Ø¹Ø© 7">Ù‚Ø§Ø¹Ø© 7</option>
      <option value="Ù‚Ø§Ø¹Ø© 8">Ù‚Ø§Ø¹Ø© 8</option>
      <option value="Ù‚Ø§Ø¹Ø© 9">Ù‚Ø§Ø¹Ø© 9</option>
      <option value="Ù‚Ø§Ø¹Ø© 10">Ù‚Ø§Ø¹Ø© 10</option>
    </select>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="daySelect" required>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
    <label>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</label>
    <input id="startTime" type="time" required>
    <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
    <input id="endTime" type="time" required>
    <button type="submit" class="btn">âœ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
  </form>
</div>

<div class="card">
  <strong>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</strong>
  <div id="timetable" style="display:flex;justify-content:space-between;"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const classForm = document.getElementById("classForm");
const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const groupSelect = document.getElementById("groupSelect");
const roomSelect = document.getElementById("roomSelect");
const startTime = document.getElementById("startTime");
const endTime = document.getElementById("endTime");
const daySelect = document.getElementById("daySelect");
const timetableDiv = document.getElementById("timetable");

let subjectsList=[], teachersList=[], groupsList=[], classesData=[], colorsMap={};
let instituteNameElem = document.getElementById("instituteName");
let instituteLogoElem = document.getElementById("instituteLogo");

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async (user)=>{
  if(!user) { window.location.href="login.html"; return; }
  document.body.style.visibility="visible";
  await loadInstituteSettings();
  await loadSubjectsTeachersGroups();
  await loadClasses();
});

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
async function loadInstituteSettings(){
  const settingsSnap = await getDocs(collection(db,"settings"));
  settingsSnap.forEach(docSnap=>{
    const data = docSnap.data();
    if(data.name) instituteNameElem.textContent = data.name;
    if(data.logo) instituteLogoElem.src = data.logo;
    if(data.colors) colorsMap = data.colors; // { "Ø±ÙŠØ§Ø¶ÙŠØ§Øª": "#ff0000", "ÙÙŠØ²ÙŠØ§Ø¡": "#00ff00", ...}
  });
}

// Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©ØŒ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
async function loadSubjectsTeachersGroups(){
  subjectsList = [];
  teachersList = [];
  groupsList = [];

  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet = new Set();
  const groupsSet = new Set();
  studentsSnap.forEach(s=>{
    s.data().subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(s.data().group) groupsSet.add(s.data().group);
  });
  subjectsList = [...subjectsSet];
  groupsList = [...groupsSet];

  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersSnap.forEach(t=>{teachersList.push({id:t.id,...t.data()});});

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  subjectSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>";
  subjectsList.forEach(s=>subjectSelect.innerHTML+=`<option value="${s}">${s}</option>`);

  teacherSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  teachersList.forEach(t=>teacherSelect.innerHTML+=`<option value="${t.id}">${t.name}</option>`);

  groupSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>";
  groupsList.forEach(g=>groupSelect.innerHTML+=`<option value="${g}">${g}</option>`);
}

// Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ø±Ø¶
classForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const newClass = {
    subject: subjectSelect.value,
    teacherId: teacherSelect.value,
    group: groupSelect.value,
    room: roomSelect.value,
    day: daySelect.value,
    startTime: startTime.value,
    endTime: endTime.value
  };

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ø±Ø¶
  const conflict = classesData.find(c=>c.day===newClass.day && (
    (c.teacherId===newClass.teacherId) || 
    (c.group===newClass.group) || 
    (c.room===newClass.room)
  ) && ((newClass.startTime < c.endTime) && (newClass.endTime > c.startTime)) );
  
  if(conflict){
    alert("âŒ Ù‡Ù†Ø§Ùƒ ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø­ØµØ© Ù…ÙˆØ¬ÙˆØ¯Ø©");
    return;
  }

  await addDoc(collection(db,"classes"), newClass);
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©");
  classForm.reset();
  await loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
async function loadClasses(){
  const snapshot = await getDocs(collection(db,"classes"));
  classesData = [];
  snapshot.forEach(docSnap=>classesData.push({id:docSnap.id,...docSnap.data()}));
  renderTimetable();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function renderTimetable(){
  timetableDiv.innerHTML="";
  const days = ["Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©"];
  days.forEach(day=>{
    const dayDiv = document.createElement("div");
    dayDiv.classList.add("day-column");
    dayDiv.innerHTML=`<strong>${day}</strong>`;
    const dayClasses = classesData.filter(c=>c.day===day).sort((a,b)=>a.startTime.localeCompare(b.startTime));
    dayClasses.forEach(c=>{
      const teacherName = (teachersList.find(t=>t.id===c.teacherId)||{}).name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const color = colorsMap[c.subject] || "#004aad";
      const box = document.createElement("div");
      box.classList.add("lesson-box");
      box.style.background=color;
      box.innerHTML=`
        <strong>${c.subject}</strong><br>
        ${teacherName}<br>
        ${c.group}<br>
        ${c.room}<br>
        ${c.startTime} - ${c.endTime}
      `;
      dayDiv.appendChild(box);
    });
    timetableDiv.appendChild(dayDiv);
  });
}
</script>
</body>
</html>