<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body{font-family:'Cairo',sans-serif; margin:0; padding:0; background:#f5f9ff; color:#102027; visibility:hidden;}
header{display:flex; align-items:center; gap:10px; padding:12px 20px; background:#004aad; color:#fff;}
header img{height:50px;}
.wrap{max-width:1200px; margin:20px auto; padding:10px;}
.card{background:#fff; border-radius:10px; padding:15px; margin-bottom:20px; box-shadow:0 6px 18px rgba(0,0,0,0.05);}
label{display:block; margin:6px 0 2px;}
input, select{padding:8px; width:100%; border:1px solid #ccc; border-radius:6px; margin-bottom:8px;}
.btn{padding:8px 14px; background:#004aad; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
.btn.warn{background:#ff7043;}
table{width:100%; border-collapse:collapse; margin-top:10px;}
th,td{border:1px solid #ddd; padding:6px; text-align:center; font-size:14px;}
th{background:#004aad; color:#fff;}
.timetable{display:grid; grid-template-columns:repeat(8,1fr); gap:2px;}
.timetable .cell{border:1px solid #ccc; min-height:50px; padding:4px; font-size:13px; position:relative;}
.timetable .lesson{position:absolute; top:2px; left:2px; right:2px; bottom:2px; padding:2px; border-radius:6px; color:#fff; font-size:12px; display:flex; flex-direction:column; justify-content:center;}
@media print{
  body{background:white;}
  .card, .btn{display:none !important;}
  header{display:flex !important;}
}
</style>
</head>
<body>
<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <h2 id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</h2>
</header>

<div class="wrap">

<div class="card">
  <strong>Ø£Ø¶Ù Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</strong>
  <form id="classForm">
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="subjectSelect" required></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="teacherSelect" required></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="groupSelect" required></select>
    <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
    <select id="roomSelect" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø©</option>
      <option value="Ù‚Ø§Ø¹Ø© 1">Ù‚Ø§Ø¹Ø© 1</option>
      <option value="Ù‚Ø§Ø¹Ø© 2">Ù‚Ø§Ø¹Ø© 2</option>
      <option value="Ù‚Ø§Ø¹Ø© 3">Ù‚Ø§Ø¹Ø© 3</option>
      <option value="Ù‚Ø§Ø¹Ø© 4">Ù‚Ø§Ø¹Ø© 4</option>
      <option value="Ù‚Ø§Ø¹Ø© 5">Ù‚Ø§Ø¹Ø© 5</option>
      <option value="Ù‚Ø§Ø¹Ø© 6">Ù‚Ø§Ø¹Ø© 6</option>
      <option value="Ù‚Ø§Ø¹Ø© 7">Ù‚Ø§Ø¹Ø© 7</option>
      <option value="Ù‚Ø§Ø¹Ø© 8">Ù‚Ø§Ø¹Ø© 8</option>
      <option value="Ù‚Ø§Ø¹Ø© 9">Ù‚Ø§Ø¹Ø© 9</option>
      <option value="Ù‚Ø§Ø¹Ø© 10">Ù‚Ø§Ø¹Ø© 10</option>
    </select>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="daySelect" required>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
    </select>
    <label>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
    <input type="time" id="startTime" required>
    <label>ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
    <input type="time" id="endTime" required>
    <button type="submit" class="btn">âœ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
  </form>
</div>

<div class="card filters">
  <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</strong>
  <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><select id="filterSubject"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label><select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="filterGroup"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label><select id="filterRoom"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <button id="filterBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
  <button id="printBtn" class="btn" style="margin-top:5px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
</div>

<div class="card">
  <strong>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ</strong>
  <div id="timetable" class="timetable"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const groupSelect = document.getElementById("groupSelect");
const roomSelect = document.getElementById("roomSelect");
const daySelect = document.getElementById("daySelect");
const startTime = document.getElementById("startTime");
const endTime = document.getElementById("endTime");
const classForm = document.getElementById("classForm");

const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterRoom = document.getElementById("filterRoom");
const filterBtn = document.getElementById("filterBtn");
const printBtn = document.getElementById("printBtn");
const timetableDiv = document.getElementById("timetable");

let subjectsList=[], teachersList=[], groupsList=[], classesData=[], institute={};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="login.html"; return; }
  document.body.style.visibility="visible";
  await loadInstituteSettings();
  await loadSubjectsTeachersGroups();
  await loadClasses();
});

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadInstituteSettings(){
  const snap = await getDocs(collection(db,"settings"));
  snap.forEach(doc=>{
    institute = doc.data();
  });
  document.getElementById("instituteName").textContent = institute.instituteName || "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯";
  document.getElementById("instituteLogo").src = institute.instituteLogo || "";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
async function loadSubjectsTeachersGroups(){
  subjectsList=[], teachersList=[], groupsList=[];
  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet=new Set(), groupsSet=new Set();
  studentsSnap.forEach(s=>{
    s.data().subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(s.data().group) groupsSet.add(s.data().group);
  });
  subjectsList=[...subjectsSet]; groupsList=[...groupsSet];

  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersSnap.forEach(t=>teachersList.push({id:t.id, name:t.data().name}));

  subjectSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>"; filterSubject.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  subjectsList.forEach(sub=>{ subjectSelect.innerHTML+=`<option value='${sub}'>${sub}</option>`; filterSubject.innerHTML+=`<option value='${sub}'>${sub}</option>`; });
  teacherSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>"; filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersList.forEach(t=>{ teacherSelect.innerHTML+=`<option value='${t.id}'>${t.name}</option>`; filterTeacher.innerHTML+=`<option value='${t.id}'>${t.name}</option>`; });
  groupSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>"; filterGroup.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  groupsList.forEach(g=>{ groupSelect.innerHTML+=`<option value='${g}'>${g}</option>`; filterGroup.innerHTML+=`<option value='${g}'>${g}</option>`; });
  filterRoom.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>"; for(let i=1;i<=10;i++){ filterRoom.innerHTML+=`<option value='Ù‚Ø§Ø¹Ø© ${i}'>Ù‚Ø§Ø¹Ø© ${i}</option>`; }
}

// Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶
classForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const data={
    subject: subjectSelect.value,
    teacherId: teacherSelect.value,
    group: groupSelect.value,
    day: daySelect.value,
    room: roomSelect.value,
    startTime: startTime.value,
    endTime: endTime.value,
    color: institute.primaryColor || "#004aad"
  };

  // ØªØ­Ù‚Ù‚ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
  for(let cls of classesData){
    if(cls.day===data.day){
      const overlap = (data.startTime<cls.endTime && data.endTime>cls.startTime);
      if(overlap && (cls.room===data.room || cls.teacherId===data.teacherId || cls.group===data.group)){
        alert("âš ï¸ ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø­ØµØ© Ù…ÙˆØ¬ÙˆØ¯Ø©!");
        return;
      }
    }
  }

  await addDoc(collection(db,"classes"), data);
  classForm.reset();
  loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ ÙˆØ±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
async function loadClasses(filter={}){
  const snapshot = await getDocs(collection(db,"classes"));
  classesData=[];
  snapshot.forEach(docSnap=>classesData.push({id:docSnap.id, ...docSnap.data()}));

  // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
  renderTimetable(classesData.filter(c=>{
    return (!filter.subject || c.subject===filter.subject) &&
           (!filter.teacher || c.teacherId===filter.teacher) &&
           (!filter.group || c.group===filter.group) &&
           (!filter.room || c.room===filter.room);
  }));
}

// Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø§Ù„Ø­ØµØµ
function renderTimetable(data){
  const days=["Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯"];
  timetableDiv.innerHTML="";
  // Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„ÙˆÙ‚Øª 08:00-20:00
  timetableDiv.style.gridTemplateColumns=`repeat(${days.length+1},1fr)`;
  // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  timetableDiv.innerHTML="<div class='cell'>Ø§Ù„ÙˆÙ‚Øª\\Ø§Ù„ÙŠÙˆÙ…</div>"+days.map(d=>`<div class='cell'>${d}</div>`).join("");

  for(let h=8; h<20; h++){
    const rowTime = h.toString().padStart(2,'0')+":00";
    timetableDiv.innerHTML+=`<div class='cell'>${rowTime}</div>`+days.map(day=>{
      const cellData = data.find(c=>{
        return c.day===day && c.startTime<=rowTime && c.endTime>rowTime;
      });
      if(cellData){
        const teacherName = (teachersList.find(t=>t.id===cellData.teacherId)||{}).name||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        return `<div class='cell'><div class='lesson' style='background:${cellData.color}'>
          ${cellData.subject}<br>${teacherName}<br>${cellData.room}<br>${cellData.startTime}-${cellData.endTime}
        </div></div>`;
      }else return "<div class='cell'></div>";
    }).join("");
  }
}

// Ø§Ù„ÙÙ„ØªØ±Ø©
filterBtn.addEventListener("click", ()=>{
  loadClasses({
    subject: filterSubject.value,
    teacher: filterTeacher.value,
    group: filterGroup.value,
    room: filterRoom.value
  });
});

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click", ()=>{ window.print(); });

</script>
</body>
</html>