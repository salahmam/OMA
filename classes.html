<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body{font-family:'Cairo',sans-serif;margin:0;padding:0;background:#f5f9ff;color:#102027;}
header{display:flex;align-items:center;gap:12px;padding:12px;background:#004aad;color:#fff;}
header img{height:50px;}
.wrap{max-width:1400px;margin:20px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
.days-container{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:20px;}
.day-column{background:#fff;padding:10px;border-radius:8px;min-height:200px;display:flex;flex-direction:column;gap:6px;}
.day-column h3{text-align:center;margin:4px 0;font-size:16px;color:#004aad;}
.lesson-card{padding:8px;border-radius:6px;color:#fff;display:flex;flex-direction:column;font-size:12px;position:relative;}
.lesson-card .delete-btn{position:absolute;top:4px;right:4px;background:#ff7043;color:#fff;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:10px;}
@media print{
  body{background:white;}
  header,.card,.btn,.filters{display:none !important;}
  .days-container{gap:0;}
}
</style>
</head>
<body>
<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <h1 id="instituteName">Ø§Ù„Ù…Ø¹Ù‡Ø¯</h1>
</header>

<div class="wrap">
  <div class="card">
    <strong>Ø£Ø¶Ù Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</strong>
    <form id="classForm">
      <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
      <select id="subjectSelect" required></select>

      <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
      <select id="teacherSelect" required></select>

      <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
      <select id="groupSelect" required></select>

      <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
      <select id="roomSelect" required>
        <option value="Ù‚Ø§Ø¹Ø© 1">Ù‚Ø§Ø¹Ø© 1</option>
        <option value="Ù‚Ø§Ø¹Ø© 2">Ù‚Ø§Ø¹Ø© 2</option>
        <option value="Ù‚Ø§Ø¹Ø© 3">Ù‚Ø§Ø¹Ø© 3</option>
        <option value="Ù‚Ø§Ø¹Ø© 4">Ù‚Ø§Ø¹Ø© 4</option>
        <option value="Ù‚Ø§Ø¹Ø© 5">Ù‚Ø§Ø¹Ø© 5</option>
        <option value="Ù‚Ø§Ø¹Ø© 6">Ù‚Ø§Ø¹Ø© 6</option>
        <option value="Ù‚Ø§Ø¹Ø© 7">Ù‚Ø§Ø¹Ø© 7</option>
        <option value="Ù‚Ø§Ø¹Ø© 8">Ù‚Ø§Ø¹Ø© 8</option>
        <option value="Ù‚Ø§Ø¹Ø© 9">Ù‚Ø§Ø¹Ø© 9</option>
        <option value="Ù‚Ø§Ø¹Ø© 10">Ù‚Ø§Ø¹Ø© 10</option>
      </select>

      <label>Ø§Ù„ÙŠÙˆÙ…</label>
      <select id="daySelect" required>
        <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
        <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
        <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
        <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
        <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
        <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
      </select>

      <label>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
      <input type="time" id="startTime" required>

      <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
      <input type="time" id="endTime" required>

      <button type="submit" class="btn">âœ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
    </form>
  </div>

  <div class="card filters">
    <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­ØµØµ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</strong>
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="filterSubject"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
    <select id="filterGroup"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <button id="filterBtn" class="btn" style="margin-top:8px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
    <button id="printBtn" class="btn" style="margin-top:8px;background:#4caf50;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
  </div>

  <div class="days-container" id="daysContainer">
    <!-- Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const classForm = document.getElementById("classForm");
const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const groupSelect = document.getElementById("groupSelect");
const roomSelect = document.getElementById("roomSelect");
const startTime = document.getElementById("startTime");
const endTime = document.getElementById("endTime");
const daySelect = document.getElementById("daySelect");
const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterBtn = document.getElementById("filterBtn");
const printBtn = document.getElementById("printBtn");
const daysContainer = document.getElementById("daysContainer");
const instituteLogo = document.getElementById("instituteLogo");
const instituteName = document.getElementById("instituteName");

let teachersList=[], subjectsList=[], groupsList=[], colorsList={}, classesData=[];

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="login.html"; return; }
  document.body.style.visibility="visible";
  await loadInstituteSettings();
  await loadTeachersSubjectsGroups();
  await loadClasses();
});

// Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
async function loadInstituteSettings(){
  const settingsDoc = await getDoc(doc(db,"settings","institute"));
  if(settingsDoc.exists()){
    const data = settingsDoc.data();
    instituteName.textContent = data.name || "Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    instituteLogo.src = data.logo || "";
    colorsList = data.colors || {};
  }
}

// Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©ØŒ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadTeachersSubjectsGroups(){
  subjectsList=[]; teachersList=[]; groupsList=[];
  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet=new Set(); const groupsSet=new Set();
  studentsSnap.forEach(s=>{
    const sd=s.data();
    sd.subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(sd.group) groupsSet.add(sd.group);
  });
  subjectsList=[...subjectsSet];
  groupsList=[...groupsSet];

  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersSnap.forEach(t=>teachersList.push({id:t.id,...t.data()}));

  // Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  subjectSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>";
  filterSubject.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  subjectsList.forEach(s=>{
    subjectSelect.innerHTML+=`<option value="${s}">${s}</option>`;
    filterSubject.innerHTML+=`<option value="${s}">${s}</option>`;
  });

  teacherSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersList.forEach(t=>{
    teacherSelect.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
    filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });

  groupSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>";
  filterGroup.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  groupsList.forEach(g=>{
    groupSelect.innerHTML+=`<option value="${g}">${g}</option>`;
    filterGroup.innerHTML+=`<option value="${g}">${g}</option>`;
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶
classForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const subject = subjectSelect.value;
  const teacherId = teacherSelect.value;
  const group = groupSelect.value;
  const room = roomSelect.value;
  const day = daySelect.value;
  const start = startTime.value;
  const end = endTime.value;

  const conflict = classesData.find(c=>c.day===day &&
    (c.room===room || c.teacherId===teacherId || c.group===group) &&
    ((start>=c.startTime && start<c.endTime) || (end>c.startTime && end<=c.endTime))
  );
  if(conflict){ alert("âš ï¸ Ù‡Ù†Ø§Ùƒ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø­ØµØ© Ù…Ø¹ Ø¯Ø±Ø³ Ù…ÙˆØ¬ÙˆØ¯!"); return; }

  await addDoc(collection(db,"classes"),{subject, teacherId, group, room, day, startTime:start, endTime:end});
  classForm.reset();
  await loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­ØµØµ
async function loadClasses(filter={}){
  const snapshot = await getDocs(collection(db,"classes"));
  classesData=[];
  snapshot.forEach(d=>classesData.push({id:d.id,...d.data()}));
  displayClasses(filter);
}

function displayClasses(filter={}){
  daysContainer.innerHTML="";
  const days=["Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯"];
  days.forEach(day=>{
    const dayColumn=document.createElement("div");
    dayColumn.className="day-column";
    dayColumn.innerHTML=`<h3>${day}</h3>`;
    const dayLessons = classesData
      .filter(c=>c.day===day)
      .filter(c=> (!filter.subject||c.subject===filter.subject) &&
                  (!filter.teacher||c.teacherId===filter.teacher) &&
                  (!filter.group||c.group===filter.group))
      .sort((a,b)=>a.startTime.localeCompare(b.startTime));
    dayLessons.forEach(c=>{
      const teacherName=(teachersList.find(t=>t.id===c.teacherId)||{}).name||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const color=colorsList[c.subject]||"#004aad";
      const card=document.createElement("div");
      card.className="lesson-card";
      card.style.background=color;
      card.innerHTML=`
        <strong>${c.subject}</strong>
        <span>Ø§Ù„Ø£Ø³ØªØ§Ø°: ${teacherName}</span>
        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${c.group}</span>
        <span>Ø§Ù„Ù‚Ø§Ø¹Ø©: ${c.room}</span>
        <span>${c.startTime} - ${c.endTime}</span>
        <button class="delete-btn" onclick="deleteClass('${c.id}')">ğŸ—‘ï¸</button>
      `;
      dayColumn.appendChild(card);
    });
    daysContainer.appendChild(dayColumn);
  });
}

// Ø­Ø°Ù Ø§Ù„Ø­ØµØ©
window.deleteClass = async id=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ")){
    await deleteDoc(doc(db,"classes",id));
    await loadClasses();
  }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
filterBtn.addEventListener("click", ()=>displayClasses({
  subject: filterSubject.value,
  teacher: filterTeacher.value,
  group: filterGroup.value
}));

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
printBtn.addEventListener("click", ()=>window.print());

</script>
</body>
</html>