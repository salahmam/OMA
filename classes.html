<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body { font-family:'Cairo',sans-serif; direction:rtl; margin:0; padding:20px; visibility:hidden; background:#f5f9ff; color:#102027; }
header { text-align:center; padding:20px; font-size:22px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:12px; }
header img { height:50px; }
.wrap { max-width:1200px; margin:20px auto; }
.card { background:#fff; border-radius:10px; padding:16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(6,20,30,0.06); }
input, select { padding:10px; border-radius:8px; border:1px solid #d6dde9; font-size:15px; width:100%; margin-bottom:8px; }
label { display:block; margin-bottom:6px; font-size:13px; color:#37474f; }
.btn { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.btn.warn { background:#ff7043; color:#fff; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; font-size:14px; }
th { color:#fff; }
@media print{
  body { background:white; }
  .filters, .actions, .btn, form { display:none !important; }
  table { page-break-inside:avoid; }
  header { justify-content:flex-start; }
}
</style>
</head>
<body>
<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
</header>
<div class="wrap">

<div class="card">
  <strong>Ø£Ø¶Ù Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</strong>
  <form id="classForm">
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="subjectSelect" required></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="teacherSelect" required></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="groupSelect" required></select>
    <label>Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
    <select id="roomSelect" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø©</option>
      <option value="Ù‚Ø§Ø¹Ø© 1">Ù‚Ø§Ø¹Ø© 1</option>
      <option value="Ù‚Ø§Ø¹Ø© 2">Ù‚Ø§Ø¹Ø© 2</option>
      <option value="Ù‚Ø§Ø¹Ø© 3">Ù‚Ø§Ø¹Ø© 3</option>
      <option value="Ù‚Ø§Ø¹Ø© 4">Ù‚Ø§Ø¹Ø© 4</option>
      <option value="Ù‚Ø§Ø¹Ø© 5">Ù‚Ø§Ø¹Ø© 5</option>
      <option value="Ù‚Ø§Ø¹Ø© 6">Ù‚Ø§Ø¹Ø© 6</option>
      <option value="Ù‚Ø§Ø¹Ø© 7">Ù‚Ø§Ø¹Ø© 7</option>
      <option value="Ù‚Ø§Ø¹Ø© 8">Ù‚Ø§Ø¹Ø© 8</option>
      <option value="Ù‚Ø§Ø¹Ø© 9">Ù‚Ø§Ø¹Ø© 9</option>
      <option value="Ù‚Ø§Ø¹Ø© 10">Ù‚Ø§Ø¹Ø© 10</option>
    </select>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="daySelect" required>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
    <label>Ø§Ù„ÙˆÙ‚Øª</label>
    <input id="timeInput" type="time" required>
    <button type="submit" class="btn" id="saveBtn">âœ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
  </form>
</div>

<div class="card filters">
  <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­ØµØµ</strong>
  <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
  <select id="filterSubject"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
  <select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
  <select id="filterGroup"><option value="">Ø§Ù„ÙƒÙ„</option></select>
  <button id="filterBtn" class="btn" style="margin-top:8px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
  <button id="printBtn" class="btn" style="margin-top:8px">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
</div>

<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ØµØµ</strong>
  <table id="classesTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ù‚Ø§Ø¹Ø©</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const classForm = document.getElementById("classForm");
const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const groupSelect = document.getElementById("groupSelect");
const roomSelect = document.getElementById("roomSelect");
const daySelect = document.getElementById("daySelect");
const timeInput = document.getElementById("timeInput");
const classesTableBody = document.querySelector("#classesTable tbody");

const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterBtn = document.getElementById("filterBtn");
const printBtn = document.getElementById("printBtn");

let subjectsList=[], teachersList=[], groupsList=[], classesData=[], instituteSettings={};

// ğŸ”‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "login.html"; return; }

  try {
    document.body.style.visibility = "visible";
    await loadInstituteSettings();
    await loadSubjectsTeachersGroups();
    await loadClasses();
  } catch(err) {
    console.error("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadInstituteSettings(){
  const docSnap = await getDoc(doc(db,"settings","institute"));
  if(docSnap.exists()){
    instituteSettings = docSnap.data();
    document.getElementById("instituteName").textContent = instituteSettings.name || "Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    document.getElementById("instituteLogo").src = instituteSettings.logo || "";
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    if(instituteSettings.colors){
      document.body.style.background = instituteSettings.colors.background || "#f5f9ff";
      document.body.style.color = instituteSettings.colors.text || "#102027";
      document.querySelectorAll(".btn").forEach(b=>b.style.background = instituteSettings.colors.primary || "#004aad");
      document.querySelectorAll("th").forEach(th=>th.style.background = instituteSettings.colors.primary || "#004aad");
    }
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©ØŒ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
async function loadSubjectsTeachersGroups(){
  subjectsList = [];
  teachersList = [];
  groupsList = [];

  const studentsSnap = await getDocs(collection(db, "students"));
  const subjectsSet = new Set();
  const groupsSet = new Set();
  studentsSnap.forEach(s=>{
    s.data().subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(s.data().group) groupsSet.add(s.data().group);
  });
  subjectsList = [...subjectsSet];
  groupsList = [...groupsSet];

  const teachersSnap = await getDocs(collection(db, "teachers"));
  teachersSnap.forEach(t=>{teachersList.push({id:t.id,...t.data()});});

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  subjectSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>";
  filterSubject.innerHTML = "<option value=''>Ø§Ù„ÙƒÙ„</option>";
  subjectsList.forEach(sub=>{
    subjectSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
    filterSubject.innerHTML += `<option value="${sub}">${sub}</option>`;
  });

  teacherSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  filterTeacher.innerHTML = "<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersList.forEach(t=>{
    teacherSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    filterTeacher.innerHTML += `<option value="${t.id}">${t.name}</option>`;
  });

  groupSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>";
  filterGroup.innerHTML = "<option value=''>Ø§Ù„ÙƒÙ„</option>";
  groupsList.forEach(g=>{
    groupSelect.innerHTML += `<option value="${g}">${g}</option>`;
    filterGroup.innerHTML += `<option value="${g}">${g}</option>`;
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
classForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const subject = subjectSelect.value;
  const teacherId = teacherSelect.value;
  const group = groupSelect.value;
  const day = daySelect.value;
  const time = timeInput.value;
  const room = roomSelect.value;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶
  const snapshot = await getDocs(collection(db,"classes"));
  let conflict = false;
  snapshot.forEach(c=>{
    const cls = c.data();
    if(cls.day===day && cls.time===time){
      if(cls.room===room) conflict = true;
      if(cls.teacherId===teacherId) conflict = true;
      if(cls.group===group) conflict = true;
    }
  });
  if(conflict){ alert("âš ï¸ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø©ØŒ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ùˆ Ø§Ù„ÙƒØ±ÙˆØ¨ Ø¨Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª."); return; }

  // Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ø§Ù„ÙƒØ±ÙˆØ¨
  const studentsSnap = await getDocs(collection(db,"students"));
  const groupStudents = [];
  studentsSnap.forEach(s=>{
    const st = s.data();
    if(st.group === group) groupStudents.push({id: s.id, name: st.name});
  });

  await addDoc(collection(db,"classes"),{subject,teacherId,group,day,time,room,students:groupStudents,attendance:[]});
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­");
  classForm.reset();
  loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
async function loadClasses(filter={}){
  const snapshot = await getDocs(collection(db,"classes"));
  classesTableBody.innerHTML = "";
  classesData = [];
  snapshot.forEach(docSnap=>{
    const cls = {id: docSnap.id, ...docSnap.data()};
    if((!filter.subject || cls.subject===filter.subject) &&
       (!filter.teacher || cls.teacherId===filter.teacher) &&
       (!filter.group || cls.group===filter.group)){
      classesData.push(cls);
      const teacherName = (teachersList.find(t=>t.id===cls.teacherId)||{}).name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const tr = document.createElement("tr");
      // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø£Ø®ÙˆØ° Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const bgColor = instituteSettings.colors?.row || "#eef4ff";
      tr.style.background = bgColor;
      tr.innerHTML = `
        <td>${cls.subject}</td>
        <td>${teacherName}</td>
        <td>${cls.group}</td>
        <td>${cls.day}</td>
        <td>${cls.time}</td>
        <td>${cls.room}</td>
        <td><button class="btn warn" onclick="deleteClass('${cls.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
      `;
      classesTableBody.appendChild(tr);
    }
  });
}

// Ø­Ø°Ù Ø§Ù„Ø­ØµØ©
window.deleteClass = async id=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ")){
    await deleteDoc(doc(db,"classes",id));
    loadClasses();
  }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
filterBtn.addEventListener("click", ()=>{
  loadClasses({
    subject: filterSubject.value,
    teacher: filterTeacher.value,
    group: filterGroup.value
  });
});

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click", ()=>{
  window.print();
});
</script>
</body>
</html>