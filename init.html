<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA - SuperAdmin</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
body{
  font-family:'Cairo',sans-serif;
  background:var(--bg);
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
  text-align:center;
  color:#102027;
}
.container{
  background:var(--card);
  padding:25px;
  border-radius:15px;
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  width:90%;
  max-width:500px;
}
h2{color:var(--primary);}
input{
  width:80%;
  padding:10px;
  border:1px solid #ccc;
  border-radius:8px;
  margin:10px 0;
  text-align:center;
  font-size:1em;
}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px 20px;
  font-size:1.1em;
  cursor:pointer;
  transition:0.3s;
}
button:hover{background:var(--accent);color:#102027;}
#status{
  white-space:pre-wrap;
  text-align:left;
  background:#f9f9f9;
  border-radius:10px;
  padding:15px;
  margin-top:20px;
  max-height:300px;
  overflow:auto;
  font-size:0.9em;
  box-shadow:inset 0 0 5px rgba(0,0,0,0.1);
}
.hidden{display:none;}
</style>
</head>
<body>

<div class="container">
  <h2>âš™ï¸ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA</h2>
  <p>Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø®ØµØµØ© ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… (SuperAdmin)</p>
  <input type="password" id="adminKey" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">
  <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>
  <div id="status" class="hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, serverTimestamp, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const startBtn = document.getElementById('startBtn');
const adminKey = document.getElementById('adminKey');
const statusEl = document.getElementById('status');

function log(msg){
  statusEl.classList.remove('hidden');
  statusEl.textContent += msg + "\n";
  statusEl.scrollTop = statusEl.scrollHeight;
}

async function ensureUser(email, uid, type){
  const ref = doc(db,"users",uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{uid,email,type,createdAt:serverTimestamp()});
    log(`âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${email}`);
  }else{
    log(`â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§: ${email}`);
  }
}

async function clearOldData(){
  log("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰...");
  const instSnap = await getDocs(collection(db,"institutes"));
  for(const d of instSnap.docs) await deleteDoc(doc(db,"institutes",d.id));
  const userSnap = await getDocs(collection(db,"users"));
  for(const d of userSnap.docs){
    if(d.data().type!=="superAdmin") await deleteDoc(doc(db,"users",d.id));
  }
  log("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­.\n");
}

async function startSetup(){
  const pass = adminKey.value.trim();
  if(pass !== "AdminSetup2025"){ // ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
    return;
  }

  if(!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©!")){
    return;
  }

  startBtn.disabled = true;
  log("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø©...\n");

  try{
    await clearOldData();

    // Ø¥Ù†Ø´Ø§Ø¡ superAdmin
    const superAdmin = { email:"Salahalkaleefa@gmail.com", password:"123456salah", type:"superAdmin" };
    try{
      const cred = await createUserWithEmailAndPassword(auth, superAdmin.email, superAdmin.password);
      await ensureUser(superAdmin.email, cred.user.uid, superAdmin.type);
      log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ SuperAdmin");
    }catch(err){
      if(err.code==="auth/email-already-in-use"){
        log("âš ï¸ Ø­Ø³Ø§Ø¨ SuperAdmin Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
        const cred = await signInWithEmailAndPassword(auth, superAdmin.email, superAdmin.password);
        await ensureUser(superAdmin.email, cred.user.uid, superAdmin.type);
      }else throw err;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù‡Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    const institutes = [
      { name:"Ù…Ø¹Ù‡Ø¯ Ø¨ØºØ¯Ø§Ø¯", email:"admin1@mail.com", password:"Admin1234" },
      { name:"Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¨ØµØ±Ø©", email:"admin2@mail.com", password:"Admin1234" }
    ];

    for(const inst of institutes){
      try{
        const cred = await createUserWithEmailAndPassword(auth, inst.email, inst.password);
        const uid = cred.user.uid;
        await ensureUser(inst.email, uid, "instituteAdmin");
        const instRef = doc(collection(db,"institutes"));
        await setDoc(instRef,{
          name:inst.name,
          adminId:uid,
          adminEmail:inst.email,
          colors:{primary:"#004aad",bg:"#f5f9ff",accent:"#ffcc33",card:"#fff"},
          subscriptionType:"trial",
          createdAt:serverTimestamp()
        });
        log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${inst.name}`);
      }catch(err){
        if(err.code==="auth/email-already-in-use"){
          log(`âš ï¸ ${inst.email} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§`);
          const cred = await signInWithEmailAndPassword(auth, inst.email, inst.password);
          await ensureUser(inst.email, cred.user.uid, "instituteAdmin");
        }else throw err;
      }
      await new Promise(res=>setTimeout(res,1000)); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
    }

    log("\nğŸ‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­!");
  }catch(err){
    log("âŒ Ø®Ø·Ø£: "+err.message);
  }
}
startBtn.addEventListener("click",startSetup);
</script>

</body>
</html>