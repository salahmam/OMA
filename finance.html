<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© â€” Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
:root{--primary:#004aad;--accent:#ffcc33;--bg:#f5f9ff;--card:#fff;}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:#102027;margin:0;padding:20px;direction:rtl;visibility:hidden}
header{display:flex;align-items:center;gap:12px;background:var(--primary);color:#fff;padding:12px;border-radius:10px}
header img{height:48px;object-fit:contain}
.wrap{max-width:1200px;margin:18px auto}
.cards{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
.card {background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(6,20,30,0.06);flex:1;min-width:200px}
.card.small{flex:0 0 200px}
.h{font-weight:800;color:var(--primary);margin-bottom:8px}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
input,select{padding:8px;border:1px solid #e3e9f2;border-radius:8px}
button{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
button.warn{background:#ff7043}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:center;font-size:13px}
th{background:var(--primary);color:#fff}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.charts{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.chart-card{background:var(--card);padding:12px;border-radius:10px;flex:1;min-width:260px}
@media print{
  body{background:white;color:black}
  header, .no-print, button, input, select { display:none !important }
  table{page-break-inside:avoid}
}
.note{font-size:12px;color:#546e7a}
</style>
</head>
<body>

<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø±" />
  <div>
    <div id="instituteName" style="font-weight:900;font-size:18px">Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
    <div class="note">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
  </div>
</header>

<div class="wrap">

  <!-- Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ -->
  <div class="cards">
    <div class="card small"><div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª</div><div id="sumIncome">0</div></div>
    <div class="card small"><div class="h">Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨</div><div id="receivedPayments">0</div></div>
    <div class="card small"><div class="h">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨</div><div id="remainingPayments">0</div></div>
    <div class="card small"><div class="h">Ù…Ø¯ÙÙˆØ¹ Ù„Ù„Ø£Ø³Ø§ØªØ°Ø©</div><div id="teacherPayments">0</div></div>
    <div class="card small"><div class="h">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¹Ø§Ù…Ø©</div><div id="totalExpenses">0</div></div>
    <div class="card small"><div class="h">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div id="netProfit">0</div></div>
  </div>

  <!-- ÙÙ„ØªØ±Ø© ÙˆØªÙØ§ØµÙŠÙ„ -->
  <div class="card">
    <div class="flex-between">
      <div><strong class="h">ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</strong></div>
      <div style="display:flex;gap:8px">
        <button id="exportExcelBtn" class="ghost no-print">â¬‡ï¸ Excel</button>
        <button id="printReportBtn" class="no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>

    <div class="filter-row no-print">
      <input type="date" id="fromDate" />
      <input type="date" id="toDate" />
      <select id="filterStudent"><option value="">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</option></select>
      <select id="filterTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
      <select id="filterSubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
      <button id="applyFilter">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="clearFilter" class="ghost">Ù…Ø³Ø­</button>
    </div>

    <table id="financeTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th>
          <th>Ø§Ù„Ø·Ø§Ù„Ø¨ / Ø§Ù„ÙˆØµÙ</th>
          <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="4">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th id="footerTotal">0</th>
          <th id="footerTeacher">0</th>
          <th id="footerInstitute">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
  <div class="card charts">
    <div class="chart-card">
      <div class="h">Ø§Ù„Ø¯Ø®Ù„ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <canvas id="pieChart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <div class="h">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</div>
      <canvas id="lineChart" height="120"></canvas>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ---------- DOM ---------- */
const instituteNameEl = document.getElementById('instituteName');
const instituteLogoEl = document.getElementById('instituteLogo');
const sumIncomeEl = document.getElementById('sumIncome');
const receivedPaymentsEl = document.getElementById('receivedPayments');
const remainingPaymentsEl = document.getElementById('remainingPayments');
const teacherPaymentsEl = document.getElementById('teacherPayments');
const totalExpensesEl = document.getElementById('totalExpenses');
const netProfitEl = document.getElementById('netProfit');
const financeTableBody = document.querySelector('#financeTable tbody');
const footerTotal = document.getElementById('footerTotal');
const footerTeacher = document.getElementById('footerTeacher');
const footerInstitute = document.getElementById('footerInstitute');

const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
const filterStudent = document.getElementById('filterStudent');
const filterTeacher = document.getElementById('filterTeacher');
const filterSubject = document.getElementById('filterSubject');
const applyFilter = document.getElementById('applyFilter');
const clearFilter = document.getElementById('clearFilter');

const exportExcelBtn = document.getElementById('exportExcelBtn');
const printReportBtn = document.getElementById('printReportBtn');

/* ---------- State ---------- */
let settings = { name:'', logo:'', teacherPercent:60 };
let students=[], payments=[], expenses=[], teachers=[], subjects=new Set();
let pieChart=null, lineChart=null;

/* ---------- Helpers ---------- */
function formatCurrency(x){ return Number(x||0).toLocaleString('en-US',{maximumFractionDigits:2}); }
function parseDateInput(v){ return v?new Date(v+'T00:00:00'):null; }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Auth ---------- */
onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href='login.html'; return; }
  document.body.style.visibility='visible';
  initialLoadAll();
});

/* ---------- Load Data ---------- */
async function loadSettings(){ 
  const snap = await getDocs(collection(db,'settings'));
  snap.forEach(d=>{ const data=d.data(); if(data.name) settings.name=data.name; if(data.logo) settings.logo=data.logo; if(data.teacherPercent) settings.teacherPercent=data.teacherPercent; });
  instituteNameEl.textContent = settings.name;
  instituteLogoEl.src = settings.logo || '';
}

async function loadTeachers(){ teachers=[]; const snap=await getDocs(collection(db,'teachers')); snap.forEach(d=>teachers.push({id:d.id,...d.data()})); renderTeacherFilter(); }
async function loadStudents(){ students=[]; const snap=await getDocs(collection(db,'students')); snap.forEach(d=>students.push({id:d.id,...d.data()})); renderStudentFilter(); }
async function loadPayments(){ payments=[]; const snap=await getDocs(collection(db,'payments')); snap.forEach(d=>payments.push({id:d.id,...d.data()})); renderSubjectFilter(); }
async function loadExpenses(){ expenses=[]; const snap=await getDocs(collection(db,'expenses')); snap.forEach(d=>expenses.push({id:d.id,...d.data()})); }

/* ---------- Render Filters ---------- */
function renderStudentFilter(){ filterStudent.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</option>'; students.forEach(s=>{ const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; filterStudent.appendChild(opt); }); }
function renderTeacherFilter(){ filterTeacher.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>'; teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name; filterTeacher.appendChild(opt); }); }
function renderSubjectFilter(){ subjects=new Set(payments.map(p=>p.subject)); filterSubject.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>'; Array.from(subjects).sort().forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; filterSubject.appendChild(opt); }); }

/* ---------- Calculate & Render ---------- */
function calculateFinance(filter={}){
  const from=parseDateInput(filter.from); const to=parseDateInput(filter.to); if(to) to.setHours(23,59,59,999);

  let received=0, remaining=0, teacherPay=0, totalExp=0, instituteShare=0;
  let tableRows=[];

  payments.forEach(p=>{
    const d=new Date(p.date);
    if((!from || d>=from)&&(!to||d<=to) &&
       (!filter.student || p.studentId===filter.student) &&
       (!filter.teacher || p.teacherId===filter.teacher) &&
       (!filter.subject || p.subject===filter.subject)){
      const tShare=(p.amount||0)*(settings.teacherPercent||0)/100;
      const iShare=(p.amount||0)-tShare;
      received += p.amount||0;
      teacherPay += tShare;
      instituteShare += iShare;
      tableRows.push({type:'Ø¯ÙØ¹Ø©', student:p.studentName, teacher:p.teacherName, subject:p.subject, amount:p.amount, teacherShare:tShare, instituteShare:iShare, date:p.date});
    }
  });

  expenses.forEach(e=>{
    const d=new Date(e.date);
    if((!from || d>=from)&&(!to||d<=to)){
      totalExp += e.amount||0;
      tableRows.push({type:'Ù…ØµØ±ÙˆÙ', student:e.description, teacher:'-', subject:'-', amount:e.amount, teacherShare:0, instituteShare:0, date:e.date});
    }
  });

  students.forEach(s=>{
    const totalDue = s.totalFee||0;
    const paid = payments.filter(p=>p.studentId===s.id).reduce((sum,p)=>sum+(p.amount||0),0);
    const rem = totalDue - paid;
    if(rem>0) remaining += rem;
  });

  const totalIncome=received+remaining;
  const netProfit=instituteShare-totalExp;

  sumIncomeEl.textContent=formatCurrency(totalIncome);
  receivedPaymentsEl.textContent=formatCurrency(received);
  remainingPaymentsEl.textContent=formatCurrency(remaining);
  teacherPaymentsEl.textContent=formatCurrency(teacherPay);
  totalExpensesEl.textContent=formatCurrency(totalExp);
  netProfitEl.textContent=formatCurrency(netProfit);

  financeTableBody.innerHTML='';
  let footerT=0, footerTeacher=0, footerInst=0;
  tableRows.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.type}</td>
      <td>${escapeHtml(r.student)}</td>
      <td>${escapeHtml(r.teacher)}</td>
      <td>${escapeHtml(r.subject)}</td>
      <td>${formatCurrency(r.amount)}</td>
      <td>${formatCurrency(r.teacherShare)}</td>
      <td>${formatCurrency(r.instituteShare)}</td>
      <td>${r.date}</td>
    `;
    financeTableBody.appendChild(tr);
    footerT += r.amount||0;
    footerTeacher += r.teacherShare||0;
    footerInst += r.instituteShare||0;
  });
  footerTotal.textContent=formatCurrency(footerT);
  footerTeacher.textContent=formatCurrency(footerTeacher);
  footerInstitute.textContent=formatCurrency(footerInst);

  // Charts
  updateCharts(totalIncome, totalExp, tableRows);
}

/* ---------- Charts ---------- */
function updateCharts(totalIncome,totalExpenses,tableRows){
  if(pieChart) pieChart.destroy();
  const ctxPie=document.getElementById('pieChart').getContext('2d');
  pieChart=new Chart(ctxPie,{
    type:'pie',
    data:{labels:['Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª','Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ'],datasets:[{data:[totalIncome,totalExpenses],backgroundColor:['#004aad','#ff7043']}]},
    options:{responsive:true}
  });

  if(lineChart) lineChart.destroy();
  const dailyTotals={};
  tableRows.forEach(r=>{ const d=r.date; dailyTotals[d]=(dailyTotals[d]||0) + (r.type==='Ø¯ÙØ¹Ø©'? r.instituteShare : -r.amount); });
  const labels=Object.keys(dailyTotals).sort();
  const data=labels.map(d=>dailyTotals[d]);
  const ctxLine=document.getElementById('lineChart').getContext('2d');
  lineChart=new Chart(ctxLine,{type:'line',data:{labels,datasets:[{label:'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ',data,borderColor:'#004aad',backgroundColor:'rgba(0,74,173,0.2)',fill:true}]}, options:{responsive:true}});
}

/* ---------- Filters ---------- */
applyFilter.addEventListener('click',()=>calculateFinance({from:fromDate.value,to:toDate.value,student:filterStudent.value,teacher:filterTeacher.value,subject:filterSubject.value}));
clearFilter.addEventListener('click',()=>{ fromDate.value=''; toDate.value=''; filterStudent.value=''; filterTeacher.value=''; filterSubject.value=''; calculateFinance({}); });

/* ---------- Excel ---------- */
exportExcelBtn.addEventListener('click',()=>{
  const wb = XLSX.utils.book_new();
  const wsData=[['Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ø·Ø§Ù„Ø¨/Ø§Ù„ÙˆØµÙ','Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„Ù…Ø¨Ù„Øº','Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°','Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯','Ø§Ù„ØªØ§Ø±ÙŠØ®']];
  financeTableBody.querySelectorAll('tr').forEach(tr=>{ wsData.push(Array.from(tr.children).map(td=>td.textContent)); });
  const ws=XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb,ws,'Finance_Report');
  XLSX.writeFile(wb,'Finance_Report.xlsx');
});

/* ---------- Print ---------- */
printReportBtn.addEventListener('click',()=>window.print());

/* ---------- Initial Load ---------- */
async function initialLoadAll(){
  await loadSettings();
  await loadTeachers();
  await loadStudents();
  await loadPayments();
  await loadExpenses();
  calculateFinance({});
}

</script>
</body>
</html>