<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>

<!-- Chart.js (ES module via CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- SheetJS (xlsx) for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --primary:#004aad;
    --accent:#ffcc33;
    --bg:#f5f9ff;
    --card:#fff;
  }
  *{box-sizing:border-box}
  body{font-family:'Cairo',sans-serif;background:var(--bg);color:#102027;margin:0;padding:20px;direction:rtl;visibility:hidden}
  header{display:flex;align-items:center;gap:12px;background:var(--primary);color:#fff;padding:12px;border-radius:10px}
  header img{height:48px;object-fit:contain}
  .wrap{max-width:1200px;margin:18px auto}
  .cards{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .card {background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(6,20,30,0.06);flex:1;min-width:200px}
  .card.small{flex:0 0 200px}
  .h{font-weight:800;color:var(--primary);margin-bottom:8px}
  .filter-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input,select{padding:8px;border:1px solid #e3e9f2;border-radius:8px}
  button{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
  button.warn{background:#ff7043}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:center;font-size:13px}
  th{background:var(--primary);color:#fff}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .charts{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .chart-card{background:var(--card);padding:12px;border-radius:10px;flex:1;min-width:260px}
  @media print{
    body{background:white;color:black}
    header, .no-print, button, input, select { display:none !important }
    .print-title{font-size:18px;margin-bottom:8px}
    table{page-break-inside:avoid}
  }
  .note{font-size:12px;color:#546e7a}
</style>
</head>
<body>

<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø±" />
  <div>
    <div id="instituteName" style="font-weight:900;font-size:18px">Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
    <div id="instituteTag" class="note">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  </div>
</header>

<div class="wrap">

  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù„Ø®Øµ -->
  <div class="cards">
    <div class="card small">
      <div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
      <div id="sumPayments">0</div>
    </div>
    <div class="card small">
      <div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</div>
      <div id="sumTeachers">0</div>
    </div>
    <div class="card small">
      <div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
      <div id="sumInstitute">0</div>
    </div>
    <div class="card small">
      <div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div id="sumExpenses">0</div>
    </div>
    <div class="card small">
      <div class="h">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
      <div id="netProfit">0</div>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div><strong class="h">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Payments)</strong><div class="note">Ø³Ø¬Ù„Ø§Øª Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
      <div style="display:flex;gap:8px">
        <button id="exportExcelBtn" class="ghost no-print">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Excel</button>
        <button id="printReportBtn" class="no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>

    <div class="filter-row no-print" style="margin-top:12px">
      <input type="date" id="payFrom" />
      <input type="date" id="payTo" />
      <select id="payTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
      <select id="paySubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
      <input id="payStudent" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
      <button id="applyPayFilter">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="clearPayFilter" class="ghost">Ù…Ø³Ø­</button>
    </div>

    <table id="paymentsTable">
      <thead>
        <tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="3">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th id="paymentsTotalFooter">0</th>
          <th id="paymentsTeacherFooter">0</th>
          <th id="paymentsInstituteFooter">0</th>
          <th colspan="1"></th>
          <th class="no-print"></th>
        </tr>
      </tfoot>
    </table>

  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
    <div class="card" style="flex:1;min-width:360px">
      <div class="h">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</div>
      <form id="expenseForm">
        <label>Ø§Ù„ÙˆØµÙ</label>
        <input id="expDesc" required />
        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="expAmount" type="number" required />
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="expDate" type="date" required />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
          <button type="button" id="clearExpense" class="ghost">Ù…Ø³Ø­</button>
        </div>
      </form>

      <div style="margin-top:16px">
        <div class="h">ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
        <div class="filter-row no-print">
          <input type="date" id="expFrom" />
          <input type="date" id="expTo" />
          <button id="applyExpFilter">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="clearExpFilter" class="ghost">Ù…Ø³Ø­</button>
        </div>
      </div>

    </div>

    <div class="card" style="flex:2;min-width:420px">
      <div class="h">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <table id="expensesTable">
        <thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th id="expensesTotalFooter">0</th><th colspan="2"></th></tr></tfoot>
      </table>
    </div>
  </div>

  <div class="card charts">
    <div class="chart-card">
      <div class="h">Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø®Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</div>
      <canvas id="lineChart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <div class="h">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <canvas id="pieChart" height="120"></canvas>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ---------- DOM Elements ---------- */
const instituteNameEl = document.getElementById('instituteName');
const instituteLogoEl = document.getElementById('instituteLogo');

const paymentsTableBody = document.querySelector('#paymentsTable tbody');
const paymentsTotalFooter = document.getElementById('paymentsTotalFooter');
const paymentsTeacherFooter = document.getElementById('paymentsTeacherFooter');
const paymentsInstituteFooter = document.getElementById('paymentsInstituteFooter');

const expensesTableBody = document.querySelector('#expensesTable tbody');
const expensesTotalFooter = document.getElementById('expensesTotalFooter');

const sumPaymentsEl = document.getElementById('sumPayments');
const sumTeachersEl = document.getElementById('sumTeachers');
const sumInstituteEl = document.getElementById('sumInstitute');
const sumExpensesEl = document.getElementById('sumExpenses');
const netProfitEl = document.getElementById('netProfit');

const payFrom = document.getElementById('payFrom');
const payTo = document.getElementById('payTo');
const payTeacher = document.getElementById('payTeacher');
const paySubject = document.getElementById('paySubject');
const payStudent = document.getElementById('payStudent');
const applyPayFilter = document.getElementById('applyPayFilter');
const clearPayFilter = document.getElementById('clearPayFilter');

const expDesc = document.getElementById('expDesc');
const expAmount = document.getElementById('expAmount');
const expDate = document.getElementById('expDate');
const expenseForm = document.getElementById('expenseForm');
const expFrom = document.getElementById('expFrom');
const expTo = document.getElementById('expTo');
const applyExpFilter = document.getElementById('applyExpFilter');
const clearExpFilter = document.getElementById('clearExpFilter');

const exportExcelBtn = document.getElementById('exportExcelBtn');
const printReportBtn = document.getElementById('printReportBtn');

/* ---------- State ---------- */
let settings = { name:'', logo:'', teacherPercent:60 };
let payments = [];
let expenses = [];
let teachers = [];
let subjects = new Set();

let lineChart=null, pieChart=null;

function formatCurrency(x){ return Number(x||0).toLocaleString('en-US',{maximumFractionDigits:2}); }
function parseDateInput(v){ return v ? new Date(v+'T00:00:00') : null; }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Auth ---------- */
onAuthStateChanged(auth,user=>{
  if(!user) { window.location.href='login.html'; return; }
  document.body.style.visibility='visible';
  initialLoadAll();
});

/* ---------- Load Functions ---------- */
async function loadSettings(){
  try{
    const snap = await getDocs(collection(db,'settings'));
    snap.forEach(d=>{
      const data = d.data();
      if(data.name) settings.name = data.name;
      if(data.logo) settings.logo = data.logo;
      if(data.teacherPercent) settings.teacherPercent = data.teacherPercent;
    });
    instituteNameEl.textContent = settings.name || 'Ø§Ù„Ù…Ø¹Ù‡Ø¯';
    instituteLogoEl.src = settings.logo || '';
  }catch(e){ console.warn(e); }
}

async function loadTeachersAndSubjects(){
  teachers=[]; subjects=new Set();
  try{
    const tSnap = await getDocs(collection(db,'teachers'));
    tSnap.forEach(d=>teachers.push({id:d.id,...d.data()}));
    const pSnap = await getDocs(collection(db,'payments'));
    pSnap.forEach(d=>{ if(d.data().subject) subjects.add(d.data().subject); });
  }catch(e){ console.warn(e); }
  renderFilters();
}

async function loadPayments(){
  payments=[];
  try{
    const snap = await getDocs(collection(db,'payments'));
    snap.forEach(d=>payments.push({id:d.id,...d.data()}));
  }catch(e){ console.error(e); }
  renderPaymentsTable();
}

async function loadExpenses(){
  expenses=[];
  try{
    const snap = await getDocs(collection(db,'expenses'));
    snap.forEach(d=>expenses.push({id:d.id,...d.data()}));
  }catch(e){ console.error(e); }
  renderExpensesTable();
}

function renderFilters(){
  payTeacher.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>';
  teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name||t.id; payTeacher.appendChild(opt); });
  paySubject.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
  Array.from(subjects).sort().forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; paySubject.appendChild(opt); });
}

/* ---------- Table Render ---------- */
function renderPaymentsTable(filter=getPayFilterValues()){
  let list = payments.slice();
  if(filter.from){ const from=parseDateInput(filter.from); list=list.filter(p=>new Date(p.date)>=from);}
  if(filter.to){ const to=parseDateInput(filter.to); to.setHours(23,59,59,999); list=list.filter(p=>new Date(p.date)<=to);}
  if(filter.teacherId) list=list.filter(p=>p.teacherId===filter.teacherId);
  if(filter.subject) list=list.filter(p=>p.subject===filter.subject);
  if(filter.student?.trim()){ const q=filter.student.trim().toLowerCase(); list=list.filter(p=>(p.studentName||'').toLowerCase().includes(q)); }

  paymentsTableBody.innerHTML='';
  let total=0, totalTeacher=0, totalInstitute=0;
  const teacherPct=settings.teacherPercent||0;
  list.forEach(p=>{
    const teacherShare=(p.amount||0)*teacherPct/100;
    const instituteShare=(p.amount||0)-teacherShare;
    total+=p.amount||0; totalTeacher+=teacherShare; totalInstitute+=instituteShare;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHtml(p.studentName||'-')}</td>
      <td>${escapeHtml(p.subject||'-')}</td>
      <td>${escapeHtml(p.teacherName||p.teacherId||'-')}</td>
      <td>${formatCurrency(p.amount||0)}</td>
      <td>${formatCurrency(teacherShare)}</td>
      <td>${formatCurrency(instituteShare)}</td>
      <td>${escapeHtml(p.date||'-')}</td>
      <td class="no-print"><button class="warn" data-id="${p.id}">ğŸ—‘ï¸</button></td>
    `;
    paymentsTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click',async e=>{
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) return;
      await deleteDoc(doc(db,'payments',e.currentTarget.dataset.id)); await loadPayments();
    });
  });
  paymentsTotalFooter.textContent=formatCurrency(total);
  paymentsTeacherFooter.textContent=formatCurrency(totalTeacher);
  paymentsInstituteFooter.textContent=formatCurrency(totalInstitute);
  sumPaymentsEl.textContent=formatCurrency(total);
  sumTeachersEl.textContent=formatCurrency(totalTeacher);
  sumInstituteEl.textContent=formatCurrency(totalInstitute);
  updateSummaryAndCharts();
}

function renderExpensesTable(filter=getExpFilterValues()){
  let list=expenses.slice();
  if(filter.from){ const from=parseDateInput(filter.from); list=list.filter(e=>new Date(e.date)>=from);}
  if(filter.to){ const to=parseDateInput(filter.to); to.setHours(23,59,59,999); list=list.filter(e=>new Date(e.date)<=to);}
  expensesTableBody.innerHTML='';
  let total=0;
  list.forEach(e=>{
    total+=e.amount||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHtml(e.description||'-')}</td>
      <td>${formatCurrency(e.amount||0)}</td>
      <td>${escapeHtml(e.date||'-')}</td>
      <td class="no-print"><button class="warn" data-id="${e.id}">ğŸ—‘ï¸</button></td>
    `;
        expensesTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click', async e=>{
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
      await deleteDoc(doc(db,'expenses',e.currentTarget.dataset.id));
      await loadExpenses();
    });
  });
  expensesTotalFooter.textContent=formatCurrency(total);
  sumExpensesEl.textContent=formatCurrency(total);
  updateSummaryAndCharts();
}

/* ---------- Form Actions ---------- */
expenseForm.addEventListener('submit', async e=>{
  e.preventDefault();
  try{
    await addDoc(collection(db,'expenses'),{
      description: expDesc.value,
      amount: Number(expAmount.value),
      date: expDate.value
    });
    expDesc.value=''; expAmount.value=''; expDate.value='';
    await loadExpenses();
  }catch(err){ console.error(err); alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ'); }
});
document.getElementById('clearExpense').addEventListener('click',()=>{
  expDesc.value=''; expAmount.value=''; expDate.value='';
});

/* ---------- Filters ---------- */
function getPayFilterValues(){
  return {
    from: payFrom.value,
    to: payTo.value,
    teacherId: payTeacher.value,
    subject: paySubject.value,
    student: payStudent.value
  };
}
applyPayFilter.addEventListener('click',()=>renderPaymentsTable(getPayFilterValues()));
clearPayFilter.addEventListener('click',()=>{
  payFrom.value=''; payTo.value=''; payTeacher.value=''; paySubject.value=''; payStudent.value='';
  renderPaymentsTable();
});

function getExpFilterValues(){
  return { from: expFrom.value, to: expTo.value };
}
applyExpFilter.addEventListener('click',()=>renderExpensesTable(getExpFilterValues()));
clearExpFilter.addEventListener('click',()=>{
  expFrom.value=''; expTo.value='';
  renderExpensesTable();
});

/* ---------- Charts ---------- */
function updateSummaryAndCharts(){
  const totalIncome = Number(sumPaymentsEl.textContent.replace(/,/g,'')) || 0;
  const totalExpense = Number(sumExpensesEl.textContent.replace(/,/g,'')) || 0;
  netProfitEl.textContent = formatCurrency(totalIncome - totalExpense);

  // Line chart: income over time (daily)
  const dailyTotals = {};
  payments.forEach(p=>{
    const d = p.date || ''; if(!d) return;
    if(!dailyTotals[d]) dailyTotals[d]=0;
    dailyTotals[d]+=p.amount||0;
  });
  const lineLabels = Object.keys(dailyTotals).sort();
  const lineData = lineLabels.map(d=>dailyTotals[d]);

  if(lineChart) lineChart.destroy();
  const ctxLine=document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(ctxLine,{
    type:'line',
    data:{ labels: lineLabels, datasets:[{label:'Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ',data:lineData, borderColor:'#004aad', backgroundColor:'rgba(0,74,173,0.2)', fill:true}]},
    options:{ responsive:true, plugins:{legend:{display:false}} }
  });

  // Pie chart: income vs expenses
  if(pieChart) pieChart.destroy();
  const ctxPie=document.getElementById('pieChart').getContext('2d');
  pieChart=new Chart(ctxPie,{
    type:'pie',
    data:{labels:['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„','Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ'], datasets:[{data:[totalIncome,totalExpense],backgroundColor:['#004aad','#ff7043']}]},
    options:{responsive:true}
  });
}

/* ---------- Export Excel ---------- */
exportExcelBtn.addEventListener('click',()=>{
  const wb = XLSX.utils.book_new();
  const payData=[['Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ù„Ù…Ø¨Ù„Øº','Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°','Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯','Ø§Ù„ØªØ§Ø±ÙŠØ®']];
  payments.forEach(p=>{
    const teacherShare=(p.amount||0)*(settings.teacherPercent||0)/100;
    const instituteShare=(p.amount||0)-teacherShare;
    payData.push([p.studentName,p.subject,p.teacherName||p.teacherId,p.amount,teacherShare,instituteShare,p.date]);
  });
  const ws1 = XLSX.utils.aoa_to_sheet(payData);
  XLSX.utils.book_append_sheet(wb,ws1,'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');

  const expData=[['Ø§Ù„ÙˆØµÙ','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ØªØ§Ø±ÙŠØ®']];
  expenses.forEach(e=>{ expData.push([e.description,e.amount,e.date]); });
  const ws2=XLSX.utils.aoa_to_sheet(expData);
  XLSX.utils.book_append_sheet(wb,ws2,'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ');

  XLSX.writeFile(wb,'Financial_Report.xlsx');
});

/* ---------- Print ---------- */
printReportBtn.addEventListener('click',()=>window.print());

/* ---------- Initial Load ---------- */
async function initialLoadAll(){
  await loadSettings();
  await loadTeachersAndSubjects();
  await loadPayments();
  await loadExpenses();
}

</script>
</body>
</html>