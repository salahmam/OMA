<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body { font-family:'Cairo',sans-serif; background:#f5f9ff; color:#102027; margin:0; padding:20px; }
header { background-color:#004aad; color:#fff; padding:16px; text-align:center; font-size:20px; font-weight:700; }
.wrap { max-width:1200px; margin:auto; }
.card { background:#fff; border-radius:10px; padding:14px; margin-bottom:16px; box-shadow:0 6px 18px rgba(6,20,30,0.06); }
button { padding:10px 16px; border:none; border-radius:8px; background:#004aad; color:#fff; cursor:pointer; font-weight:bold; margin-bottom:8px; }
button:hover { background:#003a8c; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:10px; border-bottom:1px solid #eee; text-align:center; font-size:14px; }
th { background:#004aad; color:#fff; }
.hidden { display:none; }
@media print {
  body { background:white; }
  .btn, .toggleBtn, header { display:none; }
  table { page-break-inside:avoid; }
}
</style>
</head>
<body>

<header id="instituteHeader">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</header>
<div class="wrap">

<!-- Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ -->
<div class="card">
  <button class="toggleBtn" data-target="studentsSection">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  <div id="studentsSection" class="hidden">
    <h3>Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
    <table id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="printSection('studentsSection')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<!-- Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
<div class="card">
  <button class="toggleBtn" data-target="expensesSection">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
  <div id="expensesSection" class="hidden">
    <h3>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
    <table id="expensesTable">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="printSection('expensesSection')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<!-- Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
<div class="card">
  <button class="toggleBtn" data-target="teachersSection">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</button>
  <div id="teachersSection" class="hidden">
    <h3>Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h3>
    <table id="teachersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
          <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="printSection('teachersSection')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const instituteHeader = document.getElementById("instituteHeader");

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async user => {
  if(!user) {
    window.location.href="login.html";
    return;
  }
  // Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
  const settingsDoc = await getDoc(doc(db,"settings","institute"));
  if(settingsDoc.exists()) {
    const data = settingsDoc.data();
    instituteHeader.textContent = data.name || "Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    document.body.style.background = data.bgColor || "#f5f9ff";
  }
  // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  await loadStudentsPayments();
  await loadExpenses();
  await loadTeachersPayments();
});

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
document.querySelectorAll(".toggleBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = document.getElementById(btn.dataset.target);
    target.classList.toggle("hidden");
  });
});

// ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudentsPayments(){
  const snapshot = await getDocs(collection(db,"students"));
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const st = docSnap.data();
    const row = document.createElement("tr");
    const total = st.totalFee || 0;
    const paid = st.totalPaid || 0;
    const remaining = total - paid;
    row.innerHTML = `<td>${st.name}</td>
                     <td>${(st.subjects||[]).map(s=>s.name).join(", ")}</td>
                     <td>${total}</td>
                     <td>${paid}</td>
                     <td>${remaining}</td>`;
    tbody.appendChild(row);
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
async function loadExpenses(){
  const snapshot = await getDocs(collection(db,"expenses"));
  const tbody = document.querySelector("#expensesTable tbody");
  tbody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const exp = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `<td>${exp.description}</td><td>${exp.date}</td><td>${exp.amount}</td>`;
    tbody.appendChild(row);
  });
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadTeachersPayments(){
  const snapshot = await getDocs(collection(db,"teachers"));
  const tbody = document.querySelector("#teachersTable tbody");
  tbody.innerHTML="";
  const settingsDoc = await getDoc(doc(db,"settings","institute"));
  let percent = 0;
  if(settingsDoc.exists()) percent = settingsDoc.data().teacherPercent || 0;

  snapshot.forEach(docSnap=>{
    const t = docSnap.data();
    const totalIncome = t.totalIncome || 0;
    const paid = t.totalPaid || 0;
    const remaining = totalIncome*percent/100 - paid;
    const row = document.createElement("tr");
    row.innerHTML = `<td>${t.name}</td><td>${totalIncome}</td><td>${percent}%</td><td>${paid}</td><td>${remaining}</td>`;
    tbody.appendChild(row);
  });
}

// Ø·Ø¨Ø§Ø¹Ø© Ø£ÙŠ Ù‚Ø³Ù…
function printSection(id){
  const section = document.getElementById(id);
  const original = document.body.innerHTML;
  document.body.innerHTML = section.innerHTML;
  window.print();
  document.body.innerHTML = original;
  window.location.reload();
}
</script>

</body>
</html>