<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body { font-family:'Cairo',sans-serif; background:#f5f9ff; margin:0; padding:20px; color:#102027; visibility:hidden; }
header { display:flex; align-items:center; background:#004aad; color:#fff; padding:12px 20px; font-size:20px; font-weight:700; border-radius:10px; margin-bottom:20px; }
header img { height:40px; margin-left:12px; }
.card { background:#fff; border-radius:10px; padding:16px; margin-bottom:20px; box-shadow:0 6px 18px rgba(6,20,30,0.06); }
input, select { padding:10px; border:1px solid #d6dde9; border-radius:8px; font-size:15px; width:100%; margin-bottom:10px; }
label { display:block; margin-bottom:6px; font-size:13px; color:#37474f; }
button { padding:10px 16px; border:none; border-radius:8px; background:#004aad; color:#fff; cursor:pointer; font-weight:bold; margin-top:8px; }
button:hover { background:#003a8c; }
button.warn { background:#ff7043; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; font-size:14px; }
th { background:#004aad; color:#fff; }
.filter-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
.filter-row input { flex:1; }
@media print{
  body{background:white;}
  header, .card button, .filter-row {display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>

<header>
  <span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
</header>

<div class="card">
  <strong>ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</strong>
  <div class="filter-row">
    <input type="date" id="paymentFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
    <input type="date" id="paymentTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
    <button id="filterPaymentsBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
  </div>
  <table id="paymentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ù„Ù„Ù…Ø¹Ù‡Ø¯</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th colspan="1">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
        <th id="totalPayment">0</th>
        <th id="totalTeacher">0</th>
        <th id="totalInstitute">0</th>
        <th colspan="2"></th>
      </tr>
    </tfoot>
  </table>
</div>

<div class="card">
  <strong>ğŸ“‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</strong>
  <form id="expenseForm">
    <label>Ø§Ù„ÙˆØµÙ</label>
    <input type="text" id="expenseDesc" required>
    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input type="number" id="expenseAmount" required>
    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
    <input type="date" id="expenseDate" required>
    <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
  </form>
  <div class="filter-row">
    <input type="date" id="expenseFrom">
    <input type="date" id="expenseTo">
    <button id="filterExpensesBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
  </div>
  <table id="expensesTable">
    <thead>
      <tr>
        <th>Ø§Ù„ÙˆØµÙ</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th>
        <th id="totalExpenses">0</th>
        <th colspan="2"></th>
      </tr>
    </tfoot>
  </table>
</div>

<div class="card">
  <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const instituteName = document.getElementById("instituteName");
const instituteLogo = document.getElementById("instituteLogo");

const paymentsTableBody = document.querySelector("#paymentsTable tbody");
const expensesTableBody = document.querySelector("#expensesTable tbody");

const totalPayment = document.getElementById("totalPayment");
const totalTeacher = document.getElementById("totalTeacher");
const totalInstitute = document.getElementById("totalInstitute");
const totalExpenses = document.getElementById("totalExpenses");

const paymentFrom = document.getElementById("paymentFrom");
const paymentTo = document.getElementById("paymentTo");
const filterPaymentsBtn = document.getElementById("filterPaymentsBtn");

const expenseForm = document.getElementById("expenseForm");
const expenseDesc = document.getElementById("expenseDesc");
const expenseAmount = document.getElementById("expenseAmount");
const expenseDate = document.getElementById("expenseDate");
const expenseFrom = document.getElementById("expenseFrom");
const expenseTo = document.getElementById("expenseTo");
const filterExpensesBtn = document.getElementById("filterExpensesBtn");

let paymentsData = [], expensesData = [], settingsData = {};

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="login.html"; return; }

  document.body.style.visibility = "visible";

  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯
  const settingsSnap = await getDocs(collection(db,"settings"));
  settingsSnap.forEach(s=>{
    settingsData = s.data();
    instituteName.textContent = settingsData.name || "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    instituteLogo.src = settingsData.logo || "";
  });

  await loadPayments();
  await loadExpenses();
});

// ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
async function loadPayments(filter={}){
  const snapshot = await getDocs(collection(db,"payments"));
  paymentsTableBody.innerHTML = "";
  paymentsData = [];
  let totalP=0, totalT=0, totalI=0;

  snapshot.forEach(docSnap=>{
    const p = {id: docSnap.id, ...docSnap.data()};
    const paymentDate = new Date(p.date);
    if((!filter.from || paymentDate >= new Date(filter.from)) &&
       (!filter.to || paymentDate <= new Date(filter.to))){
      paymentsData.push(p);
      const tr = document.createElement("tr");
      const teacherShare = p.amount * (settingsData.teacherPercent || 0)/100;
      const instituteShare = p.amount - teacherShare;
      totalP += p.amount;
      totalT += teacherShare;
      totalI += instituteShare;
      tr.innerHTML = `
        <td>${p.studentName}</td>
        <td>${p.amount}</td>
        <td>${teacherShare.toFixed(2)}</td>
        <td>${instituteShare.toFixed(2)}</td>
        <td>${p.date}</td>
        <td><button class="warn" onclick="deletePayment('${p.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
      `;
      paymentsTableBody.appendChild(tr);
    }
  });
  totalPayment.textContent = totalP.toFixed(2);
  totalTeacher.textContent = totalT.toFixed(2);
  totalInstitute.textContent = totalI.toFixed(2);
}

window.deletePayment = async id=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ")){
    await deleteDoc(doc(db,"payments",id));
    loadPayments();
  }
}

filterPaymentsBtn.addEventListener("click", ()=>{
  loadPayments({from: paymentFrom.value, to: paymentTo.value});
});

// ğŸ“‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
expenseForm.addEventListener("submit", async e=>{
  e.preventDefault();
  await addDoc(collection(db,"expenses"),{
    description: expenseDesc.value,
    amount: parseFloat(expenseAmount.value),
    date: expenseDate.value,
    createdAt: new Date().toISOString()
  });
  expenseForm.reset();
  loadExpenses();
});

async function loadExpenses(filter={}){
  const snapshot = await getDocs(collection(db,"expenses"));
  expensesTableBody.innerHTML = "";
  expensesData = [];
  let totalExp = 0;

  snapshot.forEach(docSnap=>{
    const exp = {id: docSnap.id, ...docSnap.data()};
    const expDate = new Date(exp.date);
    if((!filter.from || expDate >= new Date(filter.from)) &&
       (!filter.to || expDate <= new Date(filter.to))){
      expensesData.push(exp);
      const tr = document.createElement("tr");
      totalExp += exp.amount;
      tr.innerHTML = `
        <td>${exp.description}</td>
        <td>${exp.amount}</td>
        <td>${exp.date}</td>
        <td><button class="warn" onclick="deleteExpense('${exp.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
      `;
      expensesTableBody.appendChild(tr);
    }
  });
  totalExpenses.textContent = totalExp.toFixed(2);
}

window.deleteExpense = async id=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){
    await deleteDoc(doc(db,"expenses",id));
    loadExpenses();
  }
}

filterExpensesBtn.addEventListener("click", ()=>{
  loadExpenses({from: expenseFrom.value, to: expenseTo.value});
});
</script>
</body>
</html>