<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ù†Ø¸Ø§Ù… OMA</title>
<style>
body {font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;}
header {background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap {max-width:1200px;margin:22px auto;padding:12px;}
.card {background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select {padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label {display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn {background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-bottom:8px;}
.btn.warn {background:#ff7043;}
table {width:100%;border-collapse:collapse;margin-top:12px;}
th,td {padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th {background:#004aad;color:#fff;}
@media print{
  body{background:white;}
  header,.filters,.actions,.modal,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>
<header>ğŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ù†Ø¸Ø§Ù… OMA</header>
<div class="wrap">

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ / Ù…Ø³ØªØ­Ù‚ -->
<div class="card">
  <strong>Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ù…Ø³ØªØ­Ù‚</strong>
  <form id="financeForm">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
    <select id="financeType" required>
      <option value="expense">Ù…ØµØ±ÙˆÙ</option>
      <option value="due">Ù…Ø³ØªØ­Ù‚</option>
      <option value="payment">Ø¯ÙØ¹Ø© Ù…Ø³ØªÙ„Ù…Ø©</option>
    </select>

    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input type="number" id="amountInput" required />

    <label>Ø§Ù„Ù…Ø³ØªÙ„Ù… / Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label>
    <input type="text" id="recipientInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©" />

    <label>Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <select id="subjectSelect">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>
    </select>

    <label>Ø§Ù„Ø£Ø³ØªØ§Ø° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <select id="teacherSelect">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° --</option>
    </select>

    <label>Ø§Ù„ÙƒØ±ÙˆØ¨ / Ø§Ù„Ù‚Ø§Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input type="text" id="groupInput" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" />

    <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯: <span id="instituteShare">0</span>% | Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°: <span id="teacherShare">0</span>%</p>
    <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø¨Ø©: <span id="netAmount">0</span></p>

    <button type="submit" class="btn">âœ… Ø­ÙØ¸</button>
  </form>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
<div class="card">
  <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</strong>
  <table id="financeTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù†ÙˆØ¹</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„Ù…Ø³ØªÙ„Ù… / Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø¨</th>
        <th>ØªØ§Ø±ÙŠØ®</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<button onclick="window.print()" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.appspot.com",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => { if(!user){ window.location.href="login.html"; } });

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
const financeForm = document.getElementById("financeForm");
const amountInput = document.getElementById("amountInput");
const recipientInput = document.getElementById("recipientInput");
const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const groupInput = document.getElementById("groupInput");
const netAmountSpan = document.getElementById("netAmount");
const instituteShareSpan = document.getElementById("instituteShare");
const teacherShareSpan = document.getElementById("teacherShare");
const financeTableBody = document.querySelector("#financeTable tbody");

let settings = {instituteShare:0, teacherShare:0};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨ Ù…Ù† settings
async function loadSettings(){
  const snap = await getDocs(collection(db,"settings"));
  if(!snap.empty){
    const data = snap.docs[snap.docs.length-1].data();
    settings = data;
    instituteShareSpan.innerText = settings.instituteShare || 0;
    teacherShareSpan.innerText = settings.teacherShare || 0;
  }
}
loadSettings();

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø¨
amountInput.addEventListener("input",()=>{calculateNetAmount();});
function calculateNetAmount(){
  const amount = parseFloat(amountInput.value) || 0;
  const net = amount*(settings.instituteShare+settings.teacherShare>0? (settings.instituteShare+settings.teacherShare)/100 : 0);
  netAmountSpan.innerText = net.toFixed(2);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadSubjectsAndTeachers(){
  // Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet = new Set();
  studentsSnap.forEach(snap=>{
    snap.data().subjects.forEach(sub=>{ subjectsSet.add(sub.name); });
  });
  subjectSelect.innerHTML="<option value=''>-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>";
  subjectsSet.forEach(sub=>{subjectSelect.innerHTML+=`<option value="${sub}">${sub}</option>`;});

  // Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
  const teachersSnap = await getDocs(collection(db,"teachers"));
  teacherSelect.innerHTML="<option value=''>-- Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° --</option>";
  teachersSnap.forEach(snap=>{
    const t = snap.data();
    teacherSelect.innerHTML+=`<option value="${snap.id}">${t.name}</option>`;
  });
}
loadSubjectsAndTeachers();

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
financeForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const type = document.getElementById("financeType").value;
  const amount = parseFloat(amountInput.value)||0;
  const recipient = recipientInput.value.trim();
  const subject = subjectSelect.value;
  const teacher = teacherSelect.value;
  const group = groupInput.value.trim();
  const netAmount = parseFloat(netAmountSpan.innerText)||0;

  await addDoc(collection(db,"finance"),{
    type, amount, recipient, subject, teacher, group, netAmount, createdAt:new Date()
  });
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
  financeForm.reset();
  netAmountSpan.innerText = "0";
  loadFinance();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
async function loadFinance(){
  const snap = await getDocs(collection(db,"finance"));
  financeTableBody.innerHTML="";
  snap.forEach(docSnap=>{
    const f = {...docSnap.data(),id:docSnap.id};
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${f.type}</td>
      <td>${f.amount}</td>
      <td>${f.recipient}</td>
      <td>${f.subject||'-'}</td>
      <td>${f.teacher||'-'}</td>
      <td>${f.group||'-'}</td>
      <td>${f.netAmount}</td>
      <td>${f.createdAt.toDate ? f.createdAt.toDate().toLocaleString() : new Date(f.createdAt).toLocaleString()}</td>
      <td>
        <button class="btn warn" onclick="deleteFinance('${f.id}')">âŒ Ø­Ø°Ù</button>
      </td>
    `;
    financeTableBody.appendChild(tr);
  });
}
loadFinance();

// Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
window.deleteFinance = async(id)=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")){
    await deleteDoc(doc(db,"finance",id));
    loadFinance();
  }
}
</script>
</body>
</html>
