<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{--primary:#004aad;--accent:#ffcc33;--bg:#f5f9ff;--card:#fff;}
  *{box-sizing:border-box}
  body{font-family:'Cairo',sans-serif;background:var(--bg);color:#102027;margin:0;padding:20px;direction:rtl;visibility:hidden}
  header{display:flex;align-items:center;gap:12px;background:var(--primary);color:#fff;padding:12px;border-radius:10px}
  header img{height:48px;object-fit:contain}
  .wrap{max-width:1200px;margin:18px auto}
  .cards{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .card {background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(6,20,30,0.06);flex:1;min-width:200px}
  .card.small{flex:0 0 200px}
  .h{font-weight:800;color:var(--primary);margin-bottom:8px}
  .filter-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input,select{padding:8px;border:1px solid #e3e9f2;border-radius:8px}
  button{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
  button.warn{background:#ff7043}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:center;font-size:13px}
  th{background:var(--primary);color:#fff}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .charts{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .chart-card{background:var(--card);padding:12px;border-radius:10px;flex:1;min-width:260px}
  @media print{
    body{background:white;color:black}
    header, .no-print, button, input, select { display:none !important }
    .print-title{font-size:18px;margin-bottom:8px}
    table{page-break-inside:avoid}
  }
  .note{font-size:12px;color:#546e7a}
</style>
</head>
<body>

<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø±" />
  <div>
    <div id="instituteName" style="font-weight:900;font-size:18px">Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
    <div class="note">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  </div>
</header>

<div class="wrap">

  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù„Ø®Øµ -->
  <div class="cards">
    <div class="card small"><div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div><div id="sumReceived">0</div></div>
    <div class="card small"><div class="h">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨</div><div id="sumDue">0</div></div>
    <div class="card small"><div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</div><div id="sumTeachers">0</div></div>
    <div class="card small"><div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</div><div id="sumInstitute">0</div></div>
    <div class="card small"><div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div><div id="sumExpenses">0</div></div>
    <div class="card small"><div class="h">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div id="netProfit">0</div></div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª -->
  <div class="card">
    <div class="flex-between">
      <div><strong class="h">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</strong><div class="note">Ø³Ø¬Ù„Ø§Øª Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
      <div style="display:flex;gap:8px">
        <button id="exportExcelBtn" class="ghost no-print">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Excel</button>
        <button id="printReportBtn" class="no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>

    <div class="filter-row no-print" style="margin-top:12px">
      <input type="date" id="payFrom" />
      <input type="date" id="payTo" />
      <select id="payBranch"><option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option></select>
      <select id="payTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
      <select id="paySubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
      <input id="payStudent" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
      <button id="applyPayFilter">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="clearPayFilter" class="ghost">Ù…Ø³Ø­</button>
    </div>

    <table id="paymentsTable">
      <thead>
        <tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Ù…ØµØ§Ø±ÙŠÙ -->
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
    <div class="card" style="flex:1;min-width:360px">
      <div class="h">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</div>
      <form id="expenseForm">
        <label>Ø§Ù„ÙˆØµÙ</label><input id="expDesc" required />
        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="expAmount" type="number" required />
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="expDate" type="date" required />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
          <button type="button" id="clearExpense" class="ghost">Ù…Ø³Ø­</button>
        </div>
      </form>
    </div>

    <div class="card" style="flex:2;min-width:420px">
      <div class="h">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <table id="expensesTable">
        <thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
  <div class="card charts">
    <div class="chart-card">
      <div class="h">Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</div>
      <canvas id="lineChart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <div class="h">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <canvas id="pieChart" height="120"></canvas>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const instituteNameEl = document.getElementById('instituteName');
const instituteLogoEl = document.getElementById('instituteLogo');
const paymentsTableBody = document.querySelector('#paymentsTable tbody');
const expensesTableBody = document.querySelector('#expensesTable tbody');

const sumReceivedEl = document.getElementById('sumReceived');
const sumDueEl = document.getElementById('sumDue');
const sumTeachersEl = document.getElementById('sumTeachers');
const sumInstituteEl = document.getElementById('sumInstitute');
const sumExpensesEl = document.getElementById('sumExpenses');
const netProfitEl = document.getElementById('netProfit');

const payFrom = document.getElementById('payFrom');
const payTo = document.getElementById('payTo');
const payBranch = document.getElementById('payBranch');
const payTeacher = document.getElementById('payTeacher');
const paySubject = document.getElementById('paySubject');
const payStudent = document.getElementById('payStudent');
const applyPayFilter = document.getElementById('applyPayFilter');
const clearPayFilter = document.getElementById('clearPayFilter');

const expDesc = document.getElementById('expDesc');
const expAmount = document.getElementById('expAmount');
const expDate = document.getElementById('expDate');
const expenseForm = document.getElementById('expenseForm');
const clearExpenseBtn = document.getElementById('clearExpense');

const exportExcelBtn = document.getElementById('exportExcelBtn');
const printReportBtn = document.getElementById('printReportBtn');

let settings={teacherPercent:60, institutePercent:40};
let payments=[], expenses=[], teachers=[], subjects=new Set(), branches=new Set();

let lineChart=null, pieChart=null;

// --- Auth ---
onAuthStateChanged(auth,user=>{
  if(!user) window.location.href='login.html';
  document.body.style.visibility='visible';
  initialLoadAll();
});

// --- Load Data ---
async function loadSettings(){
  try{
    const snap = await getDocs(collection(db,'settings'));
    snap.forEach(d=>{
      if(d.id==='percentages'){settings.teacherPercent=d.data().teacher||60; settings.institutePercent=d.data().institute||40;}
      if(d.id==='institute'){instituteNameEl.textContent=d.data().name||'Ø§Ù„Ù…Ø¹Ù‡Ø¯'; instituteLogoEl.src=d.data().logo||'';}
      if(d.id==='branches'){branches=new Set(d.data().list||[]);}
    });
    renderBranchFilter();
  }catch(e){console.warn(e);}
}

async function loadTeachersSubjects(){
  teachers=[]; subjects=new Set();
  const tSnap = await getDocs(collection(db,'teachers'));
  tSnap.forEach(d=>teachers.push({id:d.id,...d.data()}));
  const pSnap = await getDocs(collection(db,'payments'));
  pSnap.forEach(d=>{ if(d.data().subject) subjects.add(d.data().subject); });
  renderFilters();
}

async function loadPayments(){
  payments=[];
  const snap = await getDocs(collection(db,'payments'));
  snap.forEach(d=>payments.push({id:d.id,...d.data()}));
  renderPaymentsTable();
}

async function loadExpenses(){
  expenses=[];
  const snap = await getDocs(collection(db,'expenses'));
  snap.forEach(d=>expenses.push({id:d.id,...d.data()}));
  renderExpensesTable();
}

// --- Render Filters ---
function renderFilters(){
  payTeacher.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>'; teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name||t.id; payTeacher.appendChild(opt);});
  paySubject.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>'; Array.from(subjects).sort().forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; paySubject.appendChild(opt);});
}

function renderBranchFilter(){
  payBranch.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>';
  Array.from(branches).sort().forEach(b=>{ const opt=document.createElement('option'); opt.value=b; opt.textContent=b; payBranch.appendChild(opt);});
}

// --- Render Tables ---
function renderPaymentsTable(filter=getPayFilterValues()){
  let list = payments.slice();
  if(filter.from){ const from=new Date(filter.from+'T00:00:00'); list=list.filter(p=>new Date(p.date)>=from);}
  if(filter.to){ const to=new Date(filter.to+'T23:59:59'); list=list.filter(p=>new Date(p.date)<=to);}
  if(filter.teacherId) list=list.filter(p=>p.teacherId===filter.teacherId);
  if(filter.subject) list=list.filter(p=>p.subject===filter.subject);
  if(filter.branch) list=list.filter(p=>p.branch===filter.branch);
  if(filter.student?.trim()){ const q=filter.student.trim().toLowerCase(); list=list.filter(p=>(p.studentName||'').toLowerCase().includes(q));}

  paymentsTableBody.innerHTML='';
  let sumReceived=0, sumTeacher=0, sumInstitute=0, sumDue=0;
  list.forEach(p=>{
    const tShare=p.amount*(settings.teacherPercent/100);
    const iShare=p.amount*(settings.institutePercent/100);
    sumReceived+=p.amount||0;
    sumTeacher+=tShare;
    sumInstitute+=iShare;
    if(p.totalFee) sumDue+=Math.max(0,(p.totalFee-p.amount));

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.studentName||'-'}</td>
      <td>${p.subject||'-'}</td>
      <td>${p.teacherName||p.teacherId||'-'}</td>
      <td>${p.branch||'-'}</td>
      <td>${p.amount||0}</td>
      <td>${tShare.toFixed(2)}</td>
      <td>${iShare.toFixed(2)}</td>
      <td>${p.date||'-'}</td>
      <td class="no-print"><button class="warn" data-id="${p.id}">ğŸ—‘ï¸</button></td>
    `;
    paymentsTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click',async e=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')){ await deleteDoc(doc(db,'payments',p.id)); await loadPayments(); } });
  });
  sumReceivedEl.textContent=sumReceived.toFixed(2);
  sumTeachersEl.textContent=sumTeacher.toFixed(2);
  sumInstituteEl.textContent=sumInstitute.toFixed(2);
  sumDueEl.textContent=sumDue.toFixed(2);
  updateSummaryAndCharts();
}

function renderExpensesTable(filter={from:null,to:null}){
  expensesTableBody.innerHTML='';
  let total=0;
  expenses.forEach(e=>{
    total+=e.amount||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.description||'-'}</td><td>${e.amount||0}</td><td>${e.date||'-'}</td><td class="no-print"><button class="warn" data-id="${e.id}">ğŸ—‘ï¸</button></td>`;
    expensesTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click',async()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')){ await deleteDoc(doc(db,'expenses',e.id)); await loadExpenses(); } });
  });
  sumExpensesEl.textContent=total.toFixed(2);
  updateSummaryAndCharts();
}

// --- Charts ---
let lineChart=null, pieChart=null;
function updateSummaryAndCharts(){
  const totalIncome=Number(sumReceivedEl.textContent);
  const totalExpense=Number(sumExpensesEl.textContent)+Number(sumTeachersEl.textContent);
  netProfitEl.textContent=(totalIncome-totalExpense).toFixed(2);

  // Line chart
  const dailyTotals={}; payments.forEach(p=>{ const d=p.date||''; if(!dailyTotals[d]) dailyTotals[d]={received:0,due:0}; dailyTotals[d].received+=p.amount||0; if(p.totalFee) dailyTotals[d].due+=Math.max(0,(p.totalFee-p.amount)); });
  const labels=Object.keys(dailyTotals).sort();
  const receivedData=labels.map(d=>dailyTotals[d].received);
  const dueData=labels.map(d=>dailyTotals[d].due);
  if(lineChart) lineChart.destroy();
  lineChart=new Chart(document.getElementById('lineChart').getContext('2d'),{
    type:'line',
    data:{labels,datasets:[{label:'Ø§Ù„Ù…Ø³ØªÙ„Ù…',data:receivedData,borderColor:'#004aad',backgroundColor:'rgba(0,74,173,0.2)',fill:true},{label:'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',data:dueData,borderColor:'#ff7043',backgroundColor:'rgba(255,112,67,0.2)',fill:true}]},
    options:{responsive:true}
  });

  // Pie chart
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(document.getElementById('pieChart').getContext('2d'),{
    type:'pie',
    data:{labels:['Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯','Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©','Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ'],datasets:[{data:[Number(sumInstituteEl.textContent),Number(sumTeachersEl.textContent),Number(sumExpensesEl.textContent)],backgroundColor:['#004aad','#ffcc33','#ff7043']}]},
    options:{responsive:true}
  });
}

// --- Helper ---
function getPayFilterValues(){ return {from:payFrom.value,to:payTo.value,branch:payBranch.value,teacherId:payTeacher.value,subject:paySubject.value,student:payStudent.value}; }

// --- Event Listeners ---
applyPayFilter.addEventListener('click',()=>renderPaymentsTable(getPayFilterValues()));
clearPayFilter.addEventListener('click',()=>{
  payFrom.value=''; payTo.value=''; payBranch.value=''; payTeacher.value=''; paySubject.value=''; payStudent.value='';
  renderPaymentsTable();
});

expenseForm.addEventListener('submit',async e=>{
  e.preventDefault();
  if(!expDesc.value || !expAmount.value || !expDate.value) return;
  await addDoc(collection(db,'expenses'),{description:expDesc.value,amount:Number(expAmount.value),date:expDate.value});
  expenseForm.reset();
  loadExpenses();
});
clearExpenseBtn.addEventListener('click',()=>expenseForm.reset());

exportExcelBtn.addEventListener('click',()=>{
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(document.getElementById('paymentsTable'));
  XLSX.utils.book_append_sheet(wb,ws,'Ù…Ø¯ÙÙˆØ¹Ø§Øª');
  XLSX.writeFile(wb,'Payments.xlsx');
});

printReportBtn.addEventListener('click',()=>window.print());

// --- Initial Load ---
async function initialLoadAll(){
  await loadSettings();
  await loadTeachersSubjects();
  await loadPayments();
  await loadExpenses();
}

</script>
</body>
</html>