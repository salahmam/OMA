<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body{font-family:'Cairo',sans-serif;direction:rtl;background:#f5f9ff;color:#102027;padding:20px;}
h2,h3{margin-top:0;}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:20px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;width:100%;margin-bottom:8px;}
button{padding:10px 16px;border:none;border-radius:8px;background:#004aad;color:#fff;cursor:pointer;font-weight:bold;}
button:hover{background:#003a8c;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.toggleBtn{margin-bottom:10px;}
.hidden{display:none;}
@media print{
  body{background:white;}
  button,.toggleBtn{display:none;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>

<h2>ğŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</h2>

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª -->
<div class="card">
  <button class="toggleBtn" data-target="paymentsSection">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</button>
  <div id="paymentsSection" class="hidden">
    <h3>Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
    <form id="paymentForm">
      <label>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</label>
      <select id="studentSelect" required></select>
      <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
      <input type="number" id="paymentAmount" required>
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="paymentDate" required>
      <button type="submit">ğŸ’¾ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
    </form>

    <table id="paymentsTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù„Ù…Ø¹Ù‡Ø¯</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="printSection('paymentsSection')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
<div class="card">
  <button class="toggleBtn" data-target="expensesSection">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
  <div id="expensesSection" class="hidden">
    <h3>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
    <form id="expenseForm">
      <label>Ø§Ù„ÙˆØµÙ</label>
      <input type="text" id="expenseDescription" required>
      <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="expenseAmount" required>
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="expenseDate" required>
      <button type="submit">ğŸ’¾ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
    </form>

    <div style="margin-top:10px;">
      <label>Ù…Ù†</label>
      <input type="date" id="filterFrom">
      <label>Ø¥Ù„Ù‰</label>
      <input type="date" id="filterTo">
      <button id="filterExpensesBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
    </div>

    <table id="expensesTable">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th id="totalExpenses">0</th>
        </tr>
      </tfoot>
    </table>
    <button onclick="printSection('expensesSection')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, user=>{
  if(!user) window.location.href="login.html";
  else document.body.style.visibility="visible";
});

// =================================
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
const studentSelect = document.getElementById("studentSelect");
const paymentForm = document.getElementById("paymentForm");
const paymentsTableBody = document.querySelector("#paymentsTable tbody");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudents(){
  const snap = await getDocs(collection(db,"students"));
  studentSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>";
  snap.forEach(s=>{
    studentSelect.innerHTML += `<option value="${s.id}">${s.data().name}</option>`;
  });
}

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
paymentForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const studentId = studentSelect.value;
  const amount = parseFloat(document.getElementById("paymentAmount").value);
  const date = document.getElementById("paymentDate").value;

  await addDoc(collection(db,"payments"),{studentId, amount, date});
  paymentForm.reset();
  loadPayments();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
async function loadPayments(){
  const snap = await getDocs(collection(db,"payments"));
  paymentsTableBody.innerHTML="";
  snap.forEach(async docSnap=>{
    const data = docSnap.data();
    const studentDoc = await getDocs(collection(db,"students")); // ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
    const studentName = "Ø·Ø§Ù„Ø¨"; // Ù…Ø¤Ù‚Øª
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${studentName}</td>
      <td>â€”</td>
      <td>${data.amount}</td>
      <td>${data.date}</td>
      <td>â€”</td>
      <td>â€”</td>
      <td>â€”</td>
    `;
    paymentsTableBody.appendChild(row);
  });
}

// =================================
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
const expenseForm = document.getElementById("expenseForm");
const expensesTableBody = document.querySelector("#expensesTable tbody");

expenseForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const description = document.getElementById("expenseDescription").value;
  const amount = parseFloat(document.getElementById("expenseAmount").value);
  const date = document.getElementById("expenseDate").value;
  await addDoc(collection(db,"expenses"),{description, amount, date});
  expenseForm.reset();
  loadExpenses();
});

async function loadExpenses(filter={}){
  const snap = await getDocs(collection(db,"expenses"));
  expensesTableBody.innerHTML="";
  let total=0;
  snap.forEach(docSnap=>{
    const exp = docSnap.data();
    if((!filter.from || exp.date>=filter.from)&&(!filter.to||exp.date<=filter.to)){
      const row = document.createElement("tr");
      row.innerHTML=`<td>${exp.description}</td><td>${exp.date}</td><td>${exp.amount}</td>`;
      expensesTableBody.appendChild(row);
      total += parseFloat(exp.amount||0);
    }
  });
  document.getElementById("totalExpenses").textContent = total;
}

document.getElementById("filterExpensesBtn").addEventListener("click", ()=>{
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  loadExpenses({from,to});
});

// =================================
// Ø£Ø²Ø±Ø§Ø± Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
document.querySelectorAll(".toggleBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = document.getElementById(btn.dataset.target);
    target.classList.toggle("hidden");
  });
});

// =================================
// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø³Ù…
window.printSection = function(id){
  const content = document.getElementById(id).innerHTML;
  const original = document.body.innerHTML;
  document.body.innerHTML = content;
  window.print();
  document.body.innerHTML = original;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
loadStudents();
loadPayments();
loadExpenses();
</script>

</body>
</html>