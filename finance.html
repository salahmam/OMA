<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>

<!-- Chart.js (ES module via CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- SheetJS (xlsx) for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --primary:#004aad;
    --accent:#ffcc33;
    --bg:#f5f9ff;
    --card:#fff;
  }
  *{box-sizing:border-box}
  body{font-family:'Cairo',sans-serif;background:var(--bg);color:#102027;margin:0;padding:20px;direction:rtl;visibility:hidden}
  header{display:flex;align-items:center;gap:12px;background:var(--primary);color:#fff;padding:12px;border-radius:10px}
  header img{height:48px;object-fit:contain}
  .wrap{max-width:1200px;margin:18px auto}
  .cards{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .card {background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(6,20,30,0.06);flex:1;min-width:200px}
  .card.small{flex:0 0 200px}
  .h{font-weight:800;color:var(--primary);margin-bottom:8px}
  .filter-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input,select{padding:8px;border:1px solid #e3e9f2;border-radius:8px}
  button{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
  button.warn{background:#ff7043}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:center;font-size:13px}
  th{background:var(--primary);color:#fff}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .charts{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .chart-card{background:var(--card);padding:12px;border-radius:10px;flex:1;min-width:260px}
  @media print{
    body{background:white;color:black}
    header, .no-print, button, input, select { display:none !important }
    .print-title{font-size:18px;margin-bottom:8px}
    table{page-break-inside:avoid}
  }
  .note{font-size:12px;color:#546e7a}
</style>
</head>
<body>

<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø±" />
  <div>
    <div id="instituteName" style="font-weight:900;font-size:18px">Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
    <div id="instituteTag" class="note">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  </div>
</header>

<div class="wrap">

  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù„Ø®Øµ -->
  <div class="cards">
    <div class="card small">
      <div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
      <div id="sumPayments">0</div>
    </div>
    <div class="card small">
      <div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</div>
      <div id="sumTeachers">0</div>
    </div>
    <div class="card small">
      <div class="h">Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
      <div id="sumInstitute">0</div>
    </div>
    <div class="card small">
      <div class="h">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div id="sumExpenses">0</div>
    </div>
    <div class="card small">
      <div class="h">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
      <div id="netProfit">0</div>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div><strong class="h">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Payments)</strong><div class="note">Ø³Ø¬Ù„Ø§Øª Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
      <div style="display:flex;gap:8px">
        <button id="exportExcelBtn" class="ghost no-print">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Excel</button>
        <button id="printReportBtn" class="no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>

    <div class="filter-row no-print" style="margin-top:12px">
      <input type="date" id="payFrom" />
      <input type="date" id="payTo" />
      <select id="payTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
      <select id="paySubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
      <input id="payStudent" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
      <button id="applyPayFilter">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="clearPayFilter" class="ghost">Ù…Ø³Ø­</button>
    </div>

    <table id="paymentsTable">
      <thead>
        <tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="3">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th id="paymentsTotalFooter">0</th>
          <th id="paymentsTeacherFooter">0</th>
          <th id="paymentsInstituteFooter">0</th>
          <th colspan="1"></th>
          <th class="no-print"></th>
        </tr>
      </tfoot>
    </table>

  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
    <div class="card" style="flex:1;min-width:360px">
      <div class="h">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</div>
      <form id="expenseForm">
        <label>Ø§Ù„ÙˆØµÙ</label>
        <input id="expDesc" required />
        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="expAmount" type="number" required />
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="expDate" type="date" required />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
          <button type="button" id="clearExpense" class="ghost">Ù…Ø³Ø­</button>
        </div>
      </form>

      <div style="margin-top:16px">
        <div class="h">ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
        <div class="filter-row no-print">
          <input type="date" id="expFrom" />
          <input type="date" id="expTo" />
          <button id="applyExpFilter">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="clearExpFilter" class="ghost">Ù…Ø³Ø­</button>
        </div>
      </div>

    </div>

    <div class="card" style="flex:2;min-width:420px">
      <div class="h">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <table id="expensesTable">
        <thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th id="expensesTotalFooter">0</th><th colspan="2"></th></tr></tfoot>
      </table>
    </div>
  </div>

  <div class="card charts">
    <div class="chart-card">
      <div class="h">Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø®Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</div>
      <canvas id="lineChart" height="120"></canvas>
    </div>
    <div class="chart-card">
      <div class="h">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <canvas id="pieChart" height="120"></canvas>
    </div>
  </div>

</div>

<!-- -------------- Ø³ÙƒØ±Ø¨Øª -------------- -->
<script type="module">
/* ====== Firebase + Firestore (modular) ====== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

/* ---------- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ---------- Ø¹Ù†Ø§ØµØ± DOM ---------- */
const instituteNameEl = document.getElementById('instituteName');
const instituteLogoEl = document.getElementById('instituteLogo');

const paymentsTableBody = document.querySelector('#paymentsTable tbody');
const paymentsTotalFooter = document.getElementById('paymentsTotalFooter');
const paymentsTeacherFooter = document.getElementById('paymentsTeacherFooter');
const paymentsInstituteFooter = document.getElementById('paymentsInstituteFooter');

const expensesTableBody = document.querySelector('#expensesTable tbody');
const expensesTotalFooter = document.getElementById('expensesTotalFooter');

const sumPaymentsEl = document.getElementById('sumPayments');
const sumTeachersEl = document.getElementById('sumTeachers');
const sumInstituteEl = document.getElementById('sumInstitute');
const sumExpensesEl = document.getElementById('sumExpenses');
const netProfitEl = document.getElementById('netProfit');

const payFrom = document.getElementById('payFrom');
const payTo = document.getElementById('payTo');
const payTeacher = document.getElementById('payTeacher');
const paySubject = document.getElementById('paySubject');
const payStudent = document.getElementById('payStudent');
const applyPayFilter = document.getElementById('applyPayFilter');
const clearPayFilter = document.getElementById('clearPayFilter');

const expDesc = document.getElementById('expDesc');
const expAmount = document.getElementById('expAmount');
const expDate = document.getElementById('expDate');
const expenseForm = document.getElementById('expenseForm');
const expFrom = document.getElementById('expFrom');
const expTo = document.getElementById('expTo');
const applyExpFilter = document.getElementById('applyExpFilter');
const clearExpFilter = document.getElementById('clearExpFilter');

const exportExcelBtn = document.getElementById('exportExcelBtn');
const printReportBtn = document.getElementById('printReportBtn');

/* ---------- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---------- */
let settings = {
  name: '', logo: '', colors: {}, teacherPercent: 60
};
let payments = []; // loaded payments
let expenses = [];
let teachers = []; // for filter names
let subjects = []; // distinct subjects

/* ---------- Ø±Ø³ÙˆÙ… Chart.js ---------- */
let lineChart = null;
let pieChart = null;

/* ---------- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ---------- */
function formatCurrency(x){ return Number(x||0).toLocaleString('en-US', {maximumFractionDigits:2}); }
function parseDateInput(v){ return v ? new Date(v + 'T00:00:00') : null; }

/* ---------- Ø­Ù…Ø§ÙŠØ© - ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ ---------- */
onAuthStateChanged(auth, async user=>{
  if(!user){
    // ØºÙŠØ± Ù…Ø³Ø¬Ù„ -> Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙˆÙ‚Ø¹ ÙˆØ¬ÙˆØ¯ login.html)
    window.location.href = 'login.html';
    return;
  }
  document.body.style.visibility = 'visible';

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await loadSettings();
  await loadTeachersAndSubjects();
  await loadPayments();
  await loadExpenses();
  renderFilters();
  updateSummaryAndCharts();
});

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Firestore ---------- */
async function loadSettings(){
  try{
    // Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ ÙˆØ«ÙŠÙ‚Ø© settings/info Ø£Ùˆ settings (Ø£Ùˆ Ø£ÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙˆØ§ÙØ±Ø©)
    const snap = await getDocs(collection(db,'settings'));
    snap.forEach(d=>{
      const data = d.data();
      // Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ doc ÙÙŠÙ‡Ø§ ÙƒÙ€ settings Ø¹Ø§Ù…Ø© (Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø³ÙŠØ·)
      if(data.name) settings.name = data.name;
      if(data.logo) settings.logo = data.logo;
      if(data.colors) settings.colors = data.colors;
      if(data.teacherPercent) settings.teacherPercent = data.teacherPercent;
      if(data.percentages && typeof data.percentages.teacher !== 'undefined'){
        settings.teacherPercent = data.percentages.teacher;
      }
    });
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    instituteNameEl.textContent = settings.name || 'Ø§Ù„Ù…Ø¹Ù‡Ø¯';
    instituteLogoEl.src = settings.logo || '';
    if(settings.colors){
      document.documentElement.style.setProperty('--primary', settings.colors.primary || getComputedStyle(document.documentElement).getPropertyValue('--primary'));
      document.documentElement.style.setProperty('--accent', settings.colors.accent || getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      document.documentElement.style.setProperty('--bg', settings.colors.bg || getComputedStyle(document.documentElement).getPropertyValue('--bg'));
      document.documentElement.style.setProperty('--card', settings.colors.card || getComputedStyle(document.documentElement).getPropertyValue('--card'));
    }
  }catch(e){ console.warn('loadSettings', e); }
}

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù…ØªÙˆÙØ±Ø© (Ù„Ù„ÙÙ„ØªØ±) ---------- */
async function loadTeachersAndSubjects(){
  teachers = [];
  subjects = new Set();
  try{
    // teachers collection
    const tSnap = await getDocs(collection(db,'teachers'));
    tSnap.forEach(d=>{ teachers.push({ id: d.id, ...(d.data()) }); });

    // subjects from payments and from students collection (if exists)
    const pSnap = await getDocs(collection(db,'payments'));
    pSnap.forEach(d=>{
      const p = d.data();
      if(p.subject) subjects.add(p.subject);
    });

    // also check students collection for subjects arrays
    try{
      const sSnap = await getDocs(collection(db,'students'));
      sSnap.forEach(d=>{
        (d.data().subjects || []).forEach(sub => {
          if(sub.name) subjects.add(sub.name);
        });
      });
    }catch(_){}
  }catch(e){ console.warn('loadTeachersAndSubjects', e); }
}

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª ---------- */
async function loadPayments(filter = {}){
  payments = [];
  try{
    const snap = await getDocs(collection(db,'payments'));
    snap.forEach(d=>{
      const p = { id: d.id, ...(d.data()) };
      // ensure date normalized
      payments.push(p);
    });
  }catch(e){ console.error('loadPayments', e); }

  renderPaymentsTable(filter);
  updateSummaryAndCharts();
}

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ---------- */
async function loadExpenses(filter = {}){
  expenses = [];
  try{
    const snap = await getDocs(collection(db,'expenses'));
    snap.forEach(d=> expenses.push({ id: d.id, ...(d.data()) }));
  }catch(e){ console.error('loadExpenses', e); }

  renderExpensesTable(filter);
  updateSummaryAndCharts();
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ---------- */
function renderPaymentsTable(filter = {}){
  // ÙÙ„ØªØ±Ø© Ù…Ø­Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø©
  let list = payments.slice();

  // apply filters
  if(filter.from){ const from = parseDateInput(filter.from); list = list.filter(p => new Date(p.date) >= from); }
  if(filter.to){ const to = parseDateInput(filter.to); to.setHours(23,59,59,999); list = list.filter(p => new Date(p.date) <= to); }
  if(filter.teacherId){ list = list.filter(p => p.teacherId === filter.teacherId); }
  if(filter.subject){ list = list.filter(p => p.subject === filter.subject); }
  if(filter.student && filter.student.trim()) { const q = filter.student.trim().toLowerCase(); list = list.filter(p => (p.studentName||'').toLowerCase().includes(q)); }

  paymentsTableBody.innerHTML = '';
  let total = 0, totalTeacher = 0, totalInstitute = 0;
  const teacherPct = Number(settings.teacherPercent || 0);

  list.forEach(p=>{
    const teacherShare = (p.amount || 0) * teacherPct / 100;
    const instituteShare = (p.amount || 0) - teacherShare;
    total += Number(p.amount || 0);
    totalTeacher += teacherShare;
    totalInstitute += instituteShare;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.studentName || '-')}</td>
      <td>${escapeHtml(p.subject || '-')}</td>
      <td>${escapeHtml((p.teacherName) || (p.teacherId || '-'))}</td>
      <td>${formatCurrency(p.amount || 0)}</td>
      <td>${formatCurrency(teacherShare)}</td>
      <td>${formatCurrency(instituteShare)}</td>
      <td>${escapeHtml(p.date || '-')}</td>
      <td class="no-print"><button class="warn" data-id="${p.id}">ğŸ—‘ï¸</button></td>
    `;
    paymentsTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click', async (e)=>{
      const id = e.currentTarget.dataset.id;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) return;
      try{ await deleteDoc(doc(db,'payments',id)); await loadPayments(getPayFilterValues()); }catch(err){ alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù') }
    });
  });

  paymentsTotalFooter.textContent = formatCurrency(total);
  paymentsTeacherFooter.textContent = formatCurrency(totalTeacher);
  paymentsInstituteFooter.textContent = formatCurrency(totalInstitute);

  sumPaymentsEl.textContent = formatCurrency(total);
  sumTeachersEl.textContent = formatCurrency(totalTeacher);
  sumInstituteEl.textContent = formatCurrency(totalInstitute);
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---------- */
function renderExpensesTable(filter = {}){
  let list = expenses.slice();
  if(filter.from){ const from = parseDateInput(filter.from); list = list.filter(e => new Date(e.date) >= from); }
  if(filter.to){ const to = parseDateInput(filter.to); to.setHours(23,59,59,999); list = list.filter(e => new Date(e.date) <= to); }

  expensesTableBody.innerHTML = '';
  let total = 0;
  list.forEach(e=>{
    total += Number(e.amount || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(e.description || '-')}</td>
      <td>${formatCurrency(e.amount || 0)}</td>
      <td>${escapeHtml(e.date || '-')}</td>
      <td class="no-print"><button class="warn" data-id="${e.id}">ğŸ—‘ï¸</button></td>
    `;
    expensesTableBody.appendChild(tr);
    tr.querySelector('button')?.addEventListener('click', async (ev)=>{
      const id = ev.currentTarget.dataset.id;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
      try{ await deleteDoc(doc(db,'expenses',id)); await loadExpenses(getExpFilterValues()); }catch(err){ alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù') }
    });
  });

  expensesTotalFooter.textContent = formatCurrency(total);
  sumExpensesEl.textContent = formatCurrency(total);

  // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Ù‘Øµ ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
  updateSummaryAndCharts();
}

/* ---------- Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… ---------- */
function updateSummaryAndCharts(){
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ø£Ùˆ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
  const paymentsTotal = Number((paymentsTableBody && paymentsTotalFooter.textContent) ? paymentsTotalFooter.textContent.replace(/,/g,'') : 0) || 0;
  const teachersTotal = Number((paymentsTeacherFooter && paymentsTeacherFooter.textContent) ? paymentsTeacherFooter.textContent.replace(/,/g,'') : 0) || 0;
  const instituteTotal = Number((paymentsInstituteFooter && paymentsInstituteFooter.textContent) ? paymentsInstituteFooter.textContent.replace(/,/g,'') : 0) || 0;
  const expensesTotal = Number((expensesTotalFooter && expensesTotalFooter.textContent) ? expensesTotalFooter.textContent.replace(/,/g,'') : 0) || 0;

  sumPaymentsEl.textContent = formatCurrency(paymentsTotal);
  sumTeachersEl.textContent = formatCurrency(teachersTotal);
  sumInstituteEl.textContent = formatCurrency(instituteTotal);
  sumExpensesEl.textContent = formatCurrency(expensesTotal);
  const profit = (instituteTotal - expensesTotal);
  netProfitEl.textContent = formatCurrency(profit);

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©: Ù…Ø¨Ù†ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ
  buildCharts();
}

/* ---------- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (Chart.js) ---------- */
function buildCharts(){
  // line chart: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ (Ù…Ù† payments array)
  const grouped = {};
  payments.forEach(p=>{
    const d = new Date(p.date);
    const key = d.toISOString().slice(0,10);
    grouped[key] = (grouped[key] || 0) + Number(p.amount || 0);
  });
  const labels = Object.keys(grouped).sort();
  const data = labels.map(l => grouped[l]);

  // update/create line chart
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙŠÙˆÙ…ÙŠØ©', data, fill:false, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#004aad' }]},
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{title:{display:false}}, y:{beginAtZero:true}} }
  });

  // pie chart: payments total vs expenses total
  const totalPayments = payments.reduce((a,b)=>a + Number(b.amount||0),0);
  const totalExpenses = expenses.reduce((a,b)=>a + Number(b.amount||0),0);
  const teacherPortion = totalPayments * (settings.teacherPercent || 0)/100;
  const institutePortion = totalPayments - teacherPortion;
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, {
    type:'doughnut',
    data:{ labels:['Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©','Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯','Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ'], datasets:[{ data:[teacherPortion,institutePortion,totalExpenses] }]},
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* ---------- ØªÙ†Ø²ÙŠÙ„ Excel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SheetJS ---------- */
exportExcelBtn.addEventListener('click', ()=>{
  // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„
  const paymentsSheet = payments.map(p => ({
    ID: p.id,
    Student: p.studentName || '',
    Subject: p.subject || '',
    Teacher: p.teacherName || p.teacherId || '',
    Amount: p.amount || 0,
    Date: p.date || ''
  }));
  const expensesSheet = expenses.map(e=>({ ID: e.id, Description: e.description || '', Amount: e.amount || 0, Date: e.date || '' }));

  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.json_to_sheet(paymentsSheet);
  const ws2 = XLSX.utils.json_to_sheet(expensesSheet);
  XLSX.utils.book_append_sheet(wb, ws1, 'Payments');
  XLSX.utils.book_append_sheet(wb, ws2, 'Expenses');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (settings.name || 'report') + '_finance.xlsx';
  a.click();
  URL.revokeObjectURL(url);
});

/* ---------- Ø·Ø¨Ø§Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„ØªÙ‚Ø±ÙŠØ± ---------- */
printReportBtn.addEventListener('click', ()=>{
  // Ù†Ø¬Ù…Ø¹ HTML Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ØŒ Ø´Ø¹Ø§Ø±ØŒ Ù…Ù„Ø®Ù‘ØµØŒ Ø¬Ø¯ÙˆÙ„ Ø¯ÙØ¹Ø§Øª ÙˆÙ…ØµØ§Ø±ÙŠÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const payFilter = getPayFilterValues();
  const expFilter = getExpFilterValues();
  const payRows = Array.from(document.querySelectorAll('#paymentsTable tbody tr')).map(tr => {
    const cells = Array.from(tr.querySelectorAll('td')).slice(0,7).map(td => td.innerText);
    return `<tr>${cells.map(c=>`<td style="border:1px solid #333;padding:6px">${escapeHtml(c)}</td>`).join('')}</tr>`;
  }).join('');
  const expRows = Array.from(document.querySelectorAll('#expensesTable tbody tr')).map(tr => {
    const cells = Array.from(tr.querySelectorAll('td')).slice(0,3).map(td => td.innerText);
    return `<tr>${cells.map(c=>`<td style="border:1px solid #333;padding:6px">${escapeHtml(c)}</td>`).join('')}</tr>`;
  }).join('');

  const html = `
  <html lang="ar" dir="rtl">
  <head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ</title>
    <style>
      body{font-family:'Cairo',sans-serif;direction:rtl;color:#102027}
      .header{display:flex;gap:12px;align-items:center}
      .header img{height:60px}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border:1px solid #333;padding:8px;text-align:center}
      th{background:${getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#004aad'};color:#fff}
      .footer{display:flex;justify-content:space-between;margin-top:20px}
      .sign{width:40%;text-align:center;border-top:1px dashed #444;padding-top:8px}
    </style>
  </head><body>
    <div class="header">
      ${settings.logo ? `<img src="${settings.logo}" alt="logo">` : ''}
      <div>
        <h2>${escapeHtml(settings.name || '')}</h2>
        <div>ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ</div>
        <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</div>
      </div>
    </div>

    <h3>Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3>
    <table><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ø¹Ù‡Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
    <tbody>${payRows}</tbody></table>

    <h3>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
    <table><thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>${expRows}</tbody></table>

    <div class="footer">
      <div class="sign">Ø®ØªÙ… Ø§Ù„Ù…Ø¹Ù‡Ø¯</div>
      <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
    </div>
  </body></html>
  `;
  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
});

/* ---------- Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù€ HTML ---------- */
function escapeHtml(s){
  return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ---------- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙÙ„Ø§ØªØ± ---------- */
applyPayFilter.addEventListener('click', ()=> {
  renderPaymentsTable(getPayFilterValues());
  updateSummaryAndCharts();
});
clearPayFilter.addEventListener('click', ()=> {
  payFrom.value = ''; payTo.value = ''; payTeacher.value = ''; paySubject.value = ''; payStudent.value = '';
  renderPaymentsTable({});
  updateSummaryAndCharts();
});
applyExpFilter.addEventListener('click', ()=> {
  renderExpensesTable(getExpFilterValues());
});
clearExpFilter.addEventListener('click', ()=> {
  expFrom.value=''; expTo.value=''; renderExpensesTable({});
});

/* ---------- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ---------- */
function getPayFilterValues(){
  return {
    from: payFrom.value || null,
    to: payTo.value || null,
    teacherId: payTeacher.value || null,
    subject: paySubject.value || null,
    student: payStudent.value || null
  };
}
function getExpFilterValues(){
  return { from: expFrom.value || null, to: expTo.value || null };
}

/* ---------- Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ ---------- */
expenseForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    await addDoc(collection(db,'expenses'), {
      description: expDesc.value,
      amount: Number(expAmount.value),
      date: expDate.value,
      createdAt: new Date().toISOString()
    });
    expenseForm.reset();
    await loadExpenses(getExpFilterValues());
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ');
  }catch(err){ console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
});

/* ---------- Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ„Ø§ØªØ± (Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ§Ù„Ù…ÙˆØ§Ø¯) ---------- */
function renderFilters(){
  // teachers dropdown
  payTeacher.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>';
  teachers.forEach(t => {
    const opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.name || t.id;
    payTeacher.appendChild(opt);
  });

  // subjects
  paySubject.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
  Array.from(subjects).sort().forEach(s=>{
    const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
    paySubject.appendChild(opt);
  });
}

/* ---------- initial data read: get all payments & expenses once ---------- */
async function initialLoadAll(){
  await loadPayments();
  await loadExpenses();
  await loadTeachersAndSubjects();
  renderFilters();
  updateSummaryAndCharts();
}
initialLoadAll();

/* ---------- Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© ---------- */
// small debounce for search
let searchTimer = null;
payStudent.addEventListener('input', ()=> {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{ renderPaymentsTable(getPayFilterValues()); updateSummaryAndCharts(); }, 450);
});

</script>
</body>
</html>