<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ø±ÙˆØ¹ OMA0 Ø§Ù„Ø´Ø§Ù…Ù„</title>
<style>
body { font-family:'Cairo',sans-serif; padding:20px; background:#f5f9ff; color:#102027; }
h2,h3 { margin-top:0; }
input,textarea,select,button { font-family:'Cairo',sans-serif; font-size:14px; margin:4px 0; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
button { background:#004aad; color:#fff; cursor:pointer; border:none; }
button:hover { background:#003a8c; }
fieldset { border:1px solid #ddd; padding:10px; margin-bottom:15px; border-radius:8px; }
legend { font-weight:bold; }
#log { background:#eef4ff; padding:10px; border-radius:8px; overflow-x:auto; white-space:pre-wrap; height:300px; }
.addBtn { background:#ff9800; margin-left:4px; }
</style>
</head>
<body>

<h2>ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ø±ÙˆØ¹ OMA0 Ø§Ù„Ø´Ø§Ù…Ù„</h2>
<p>Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨ÙƒÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>

<fieldset>
<legend>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</legend>
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯: <input type="text" id="instituteName" value="Ù…Ø¹Ù‡Ø¯ OMA"></label><br>
<label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <input type="email" id="instituteEmail"></label><br>
<label>Ø§Ù„Ù‡Ø§ØªÙ: <input type="text" id="institutePhone"></label><br>
<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <input type="text" id="instituteAddress"></label><br>
<label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±: <input type="text" id="instituteLogo"></label>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</legend>
<div id="teachersList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="teacherInput">
    <button type="button" class="addBtn" onclick="addTeacherInput(this)">+</button>
  </div>
</div>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ø·Ù„Ø§Ø¨</legend>
<div id="studentsList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="studentInput">
    <input type="text" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„" class="subjectsInput">
    <input type="text" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨" class="groupInput">
    <button type="button" class="addBtn" onclick="addStudentInput(this)">+</button>
  </div>
</div>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</legend>
<div id="expensesList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" class="expenseInput">
    <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="amountInput">
    <button type="button" class="addBtn" onclick="addExpenseInput(this)">+</button>
  </div>
</div>
</fieldset>

<button id="initBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>
<pre id="log"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const log = document.getElementById("log");
const initBtn = document.getElementById("initBtn");

function addLog(msg){ log.textContent += msg + "\n"; }

// --------- Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ----------
window.addTeacherInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="teacherInput"> <button type="button" class="addBtn" onclick="addTeacherInput(this)">+</button>`;
  btn.parentNode.after(div);
};
window.addStudentInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="studentInput"> <input type="text" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„" class="subjectsInput"> <input type="text" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨" class="groupInput"> <button type="button" class="addBtn" onclick="addStudentInput(this)">+</button>`;
  btn.parentNode.after(div);
};
window.addExpenseInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" class="expenseInput"> <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="amountInput"> <button type="button" class="addBtn" onclick="addExpenseInput(this)">+</button>`;
  btn.parentNode.after(div);
};

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---------
async function createSettings(info){
  const colorsRef = doc(db,"settings","colors");
  const infoRef = doc(db,"settings","info");
  const instituteRef = doc(db,"settings","institute");
  const percentagesRef = doc(db,"settings","percentages");

  const defaults = [
    [colorsRef, { primary:"#004aad", accent:"#ffcc33", bg:"#f5f9ff", card:"#fff" }],
    [infoRef, { name:info.name, logo:info.logo, address:info.address, email:info.email, phone:info.phone }],
    [instituteRef, { name:info.name, logo:info.logo, address:info.address, email:info.email, phone:info.phone }],
    [percentagesRef, { teacher:60, institute:40 }]
  ];

  for(const [ref,data] of defaults){
    if(!(await getDoc(ref)).exists()){
      await setDoc(ref,data);
      addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${ref.path}`);
    } else {
      addLog(`âš ï¸ ${ref.path} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§`);
    }
  }
}

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ---------
async function createTeachers(teachers){
  const col = collection(db,"teachers");
  const teacherDocs=[];
  for(const t of teachers){
    if(t.trim()==="") continue;
    const docRef = doc(col);
    await setDoc(docRef,{name:t});
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø³: ${t}`);
    teacherDocs.push({id:docRef.id, name:t});
  }
  return teacherDocs;
}

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ---------
async function createStudents(students){
  const col = collection(db,"students");
  const studentDocs=[];
  for(const s of students){
    if(s.name.trim()==="") continue;
    const docRef = doc(col);
    await setDoc(docRef,{
      name: s.name,
      group: s.group || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
      subjects: s.subjects.map(sub=>({name:sub.trim()}))
    });
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø§Ù„Ø¨: ${s.name}`);
    studentDocs.push({id:docRef.id, ...s});
  }
  return studentDocs;
}

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ---------
async function createClasses(students, teachers){
  const col = collection(db,"classes");
  const days = ["Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯"];
  const rooms = ["Ù‚Ø§Ø¹Ø© 1","Ù‚Ø§Ø¹Ø© 2","Ù‚Ø§Ø¹Ø© 3","Ù‚Ø§Ø¹Ø© 4"];
  const classDocs=[];

  let teacherIndex=0, roomIndex=0;
  for(const day of days){
    for(const student of students){
      for(const subject of student.subjects){
        const teacher = teachers[teacherIndex % teachers.length];
        const docRef = await addDoc(col,{
          subject: subject.name,
          teacherId: teacher.id,
          group: student.group,
          room: rooms[roomIndex % rooms.length],
          day: day,
          startTime: "08:00",
          endTime: "09:00"
        });
        classDocs.push({id:docRef.id});
        teacherIndex++;
        roomIndex++;
      }
    }
  }
  addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©`);
  return classDocs;
}

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ§Ø±Øº ---------
async function createAttendance(classes){
  const col = collection(db,"attendance");
  for(const c of classes){
    await setDoc(doc(col, c.id), { classId:c.id, students: [], updatedAt:new Date().toISOString() });
  }
  addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ø§Ù„Ø­ØµØµ`);
}

// --------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ---------
async function createExpenses(expenses){
  const col = collection(db,"expenses");
  const today = new Date().toISOString().split('T')[0];
  for(const e of expenses){
    if(e.name.trim()==="") continue;
    const docRef = doc(col);
    await setDoc(docRef,{
      description: e.name,
      amount: Number(e.amount || 0),
      date: today,
      notes:"",
      createdAt: new Date().toISOString()
    });
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµØ±ÙˆÙ: ${e.name}`);
  }
}

// --------- Ø­Ø¯Ø« Ø²Ø± Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---------
initBtn.addEventListener("click", async()=>{
  initBtn.disabled=true;
  initBtn.textContent="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...";

  try{
    const info = {
      name: document.getElementById("instituteName").value,
      email: document.getElementById("instituteEmail").value,
      phone: document.getElementById("institutePhone").value,
      address: document.getElementById("instituteAddress").value,
      logo: document.getElementById("instituteLogo").value
    };

    const teachers = Array.from(document.querySelectorAll(".teacherInput")).map(i=>i.value);
    const students = Array.from(document.querySelectorAll(".studentInput")).map((i,j)=>({
      name:i.value,
      group:document.querySelectorAll(".groupInput")[j].value,
      subjects:document.querySelectorAll(".subjectsInput")[j].value.split(",")
    }));
    const expenses = Array.from(document.querySelectorAll(".expenseInput")).map((i,j)=>({
      name:i.value,
      amount: document.querySelectorAll(".amountInput")[j].value || 0
    }));

    await createSettings(info);
    const teacherDocs = await createTeachers(teachers);
    const studentDocs = await createStudents(students);
    const classDocs = await createClasses(studentDocs, teacherDocs);
    await createAttendance(classDocs);
    await createExpenses(expenses);

    addLog("\nğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­ØµØµØŒ Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†ØŒ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ!");
    initBtn.textContent="ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
  }catch(e){
    addLog("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: "+e.message);
    initBtn.disabled=false;
    initBtn.textContent="Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©";
  }
});
</script>

</body>
</html>