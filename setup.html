<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ø±ÙˆØ¹ OMA â€” Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
<style>
body { font-family:'Cairo',sans-serif; padding:20px; background:#f5f9ff; color:#102027; }
h2,h3 { margin-top:0; }
input,textarea,select,button { font-family:'Cairo',sans-serif; font-size:14px; margin:4px 0; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
button { background:#004aad; color:#fff; cursor:pointer; border:none; }
button:hover { background:#003a8c; }
fieldset { border:1px solid #ddd; padding:10px; margin-bottom:15px; border-radius:8px; }
legend { font-weight:bold; }
#log { background:#eef4ff; padding:10px; border-radius:8px; overflow-x:auto; white-space:pre-wrap; height:250px; }
.addBtn { background:#ff9800; margin-left:4px; }
</style>
</head>
<body>

<h2>ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ø±ÙˆØ¹ OMA â€” Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
<p>Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©.</p>

<fieldset>
<legend>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</legend>
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯: <input type="text" id="instituteName" value="Ù…Ø¹Ù‡Ø¯ OMA"></label><br>
<label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <input type="email" id="instituteEmail"></label><br>
<label>Ø§Ù„Ù‡Ø§ØªÙ: <input type="text" id="institutePhone"></label><br>
<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <input type="text" id="instituteAddress"></label><br>
<label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±: <input type="text" id="instituteLogo"></label>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</legend>
<div id="teachersList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="teacherInput">
    <button type="button" class="addBtn" onclick="addTeacherInput(this)">+</button>
  </div>
</div>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ø·Ù„Ø§Ø¨</legend>
<div id="studentsList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="studentInput">
    <input type="text" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„" class="subjectsInput">
    <button type="button" class="addBtn" onclick="addStudentInput(this)">+</button>
  </div>
</div>
</fieldset>

<fieldset>
<legend>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</legend>
<div id="expensesList">
  <div>
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" class="expenseInput">
    <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="amountInput">
    <button type="button" class="addBtn" onclick="addExpenseInput(this)">+</button>
  </div>
</div>
</fieldset>

<button id="initBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>
<pre id="log"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const log = document.getElementById("log");
const initBtn = document.getElementById("initBtn");

function addLog(msg){ log.textContent += msg + "\n"; }

// --- Ù…Ø¯Ø®Ù„Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ---
window.addTeacherInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="teacherInput"> <button type="button" class="addBtn" onclick="addTeacherInput(this)">+</button>`;
  btn.parentNode.after(div);
};
window.addStudentInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="studentInput"> <input type="text" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„" class="subjectsInput"> <button type="button" class="addBtn" onclick="addStudentInput(this)">+</button>`;
  btn.parentNode.after(div);
};
window.addExpenseInput = function(btn){
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" class="expenseInput"> <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="amountInput"> <button type="button" class="addBtn" onclick="addExpenseInput(this)">+</button>`;
  btn.parentNode.after(div);
};

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
async function createSettings(info){
  const colorsRef = doc(db,"settings","colors");
  const infoRef = doc(db,"settings","info");
  const instituteRef = doc(db,"settings","institute");
  const percentagesRef = doc(db,"settings","percentages");

  const defaults = [
    [colorsRef, { primary:"#004aad", accent:"#ffcc33", bg:"#f5f9ff", card:"#fff" }],
    [infoRef, { name:info.name, logo:info.logo, address:info.address, email:info.email, phone:info.phone }],
    [instituteRef, { name:info.name, logo:info.logo, address:info.address, email:info.email, phone:info.phone }],
    [percentagesRef, { teacher:60, institute:40 }]
  ];

  for(const [ref,data] of defaults){
    if(!(await getDoc(ref)).exists()){
      await setDoc(ref,data);
      addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${ref.path}`);
    } else {
      addLog(`âš ï¸ ${ref.path} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§`);
    }
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ---
async function createTeachers(teachers){
  const col = collection(db,"teachers");
  for(const t of teachers){
    if(t.trim()==="") continue;
    await addDoc(col,{name:t, subjects:[], createdAt: new Date()});
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø³: ${t}`);
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ---
async function createStudents(students){
  const col = collection(db,"students");
  for(const s of students){
    if(!s.name.trim()) continue;
    await addDoc(col,{
      name: s.name,
      subjects: s.subjects.map(sub => ({ name: sub.trim(), fee: Math.floor(Math.random()*500+100), payments: [] })),
      createdAt: new Date()
    });
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø§Ù„Ø¨: ${s.name}`);
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ---
async function createExpenses(expenses){
  const col = collection(db,"expenses");
  const today = new Date().toISOString().split('T')[0];
  for(const e of expenses){
    if(e.name.trim()==="") continue;
    await addDoc(col,{
      description: e.name,
      amount: Number(e.amount || 0),
      date: today,
      notes:"",
      createdAt: new Date().toISOString()
    });
    addLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµØ±ÙˆÙ: ${e.name}`);
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø§Øª Ù…Ø¹ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ ---
async function createSamplePayments(students, teachers){
  const percentagesRef = doc(db,"settings","percentages");
  const percSnap = await getDoc(percentagesRef);
  const perc = percSnap.exists() ? percSnap.data() : { teacher:60, institute:40 };

  const paymentsCol = collection(db,"payments");
  for(const s of students){
    if(!s.name.trim()) continue;
    for(const sub of s.subjects){
      if(!sub.name.trim()) continue;
      const teacherName = teachers[Math.floor(Math.random()*teachers.length)] || "Ù…Ø¯Ø±Ø³ Ø§ÙØªØ±Ø§Ø¶ÙŠ";
      const amount = sub.fee || Math.floor(Math.random()*500+100);
      const teacherShare = amount * (perc.teacher/100);
      const instituteShare = amount * (perc.institute/100);

      await addDoc(paymentsCol,{
        studentName: s.name,
        subject: sub.name,
        teacherName,
        amount,
        teacherShare,
        instituteShare,
        date: new Date().toISOString().slice(0,10)
      });

      addLog(`âœ… Ø¯ÙØ¹Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ${s.name} ÙÙŠ Ù…Ø§Ø¯Ø© ${sub.name} Ù…Ø¹ ${teacherName} â€” Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${amount} (Ø§Ù„Ù…Ø¯Ø±Ø³: ${teacherShare}, Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${instituteShare})`);
    }
  }
}

// --- Ø²Ø± Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---
initBtn.addEventListener("click", async()=>{
  initBtn.disabled = true;
  initBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...";

  try{
    const info = {
      name: document.getElementById("instituteName").value,
      email: document.getElementById("instituteEmail").value,
      phone: document.getElementById("institutePhone").value,
      address: document.getElementById("instituteAddress").value,
      logo: document.getElementById("instituteLogo").value
    };

    const teachers = Array.from(document.querySelectorAll(".teacherInput")).map(i=>i.value);
    const students = Array.from(document.querySelectorAll(".studentInput")).map((i,j)=>({
      name:i.value,
      subjects:(document.querySelectorAll(".subjectsInput")[j].value.split(",").map(s=>s.trim()))
    }));
    const expenses = Array.from(document.querySelectorAll(".expenseInput")).map((i,j)=>({
      name:i.value,
      amount: document.querySelectorAll(".amountInput")[j].value || 0
    }));

    await createSettings(info);
    await createTeachers(teachers);
    await createStudents(students);
    await createExpenses(expenses);
    await createSamplePayments(students, teachers);

    addLog("\nğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
    initBtn.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
  }catch(e){
    addLog("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: "+e.message);
    initBtn.disabled = false;
    initBtn.textContent = "Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©";
  }
});
</script>

</body>
</html>