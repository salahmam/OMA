<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ</title>
<style>
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;}
header{background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
@media print{
  body{background:white;}
  header,.filters,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ØµØµ</header>
<div class="wrap">

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø­ØµØ© -->
<div class="card">
  <strong>Ø£Ø¶Ù Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</strong>
  <form id="classForm">
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="subjectSelect" required></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="teacherSelect" required></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <input id="groupInput" type="text" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" required>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="daySelect" required>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
    <label>Ø§Ù„ÙˆÙ‚Øª</label>
    <input id="timeInput" type="time" required>
    <button type="submit" class="btn">âœ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
  </form>
</div>

<!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div class="card filters">
  <label>ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
  <select id="filterSubject">
    <option value="">Ø§Ù„ÙƒÙ„</option>
  </select>
  <label>ÙÙ„ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
  <select id="filterTeacher">
    <option value="">Ø§Ù„ÙƒÙ„</option>
  </select>
  <label>ÙÙ„ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
  <input id="filterGroup" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØ¨">
  <label>ÙÙ„ØªØ± Ø§Ù„ÙŠÙˆÙ…</label>
  <select id="filterDay">
    <option value="">Ø§Ù„ÙƒÙ„</option>
    <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
    <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
    <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
    <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
    <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
  </select>
  <button class="btn" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ -->
<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ØµØµ</strong>
  <table id="classesTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const classForm = document.getElementById("classForm");
const subjectSelect = document.getElementById("subjectSelect");
const teacherSelect = document.getElementById("teacherSelect");
const classesTableBody = document.querySelector("#classesTable tbody");

const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterDay = document.getElementById("filterDay");
const printBtn = document.getElementById("printBtn");

let classesData = [];
let subjectsMap = new Map();
let teachersMap = new Map();

// ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    window.location.href="login.html";
    return;
  }
  document.body.style.visibility = "visible";
  await loadSubjectsAndTeachers();
  loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadSubjectsAndTeachers(){
  // Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet = new Set();
  studentsSnap.forEach(snap=>{
    snap.data().subjects.forEach(sub=>subjectsSet.add(sub.name));
  });
  subjectSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>";
  filterSubject.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  subjectsSet.forEach(sub=>{
    subjectSelect.innerHTML+=`<option value="${sub}">${sub}</option>`;
    filterSubject.innerHTML+=`<option value="${sub}">${sub}</option>`;
    subjectsMap.set(sub,sub);
  });

  // Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
  const teachersSnap = await getDocs(collection(db,"teachers"));
  teacherSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersSnap.forEach(snap=>{
    const t = snap.data();
    teacherSelect.innerHTML+=`<option value="${snap.id}">${t.name}</option>`;
    filterTeacher.innerHTML+=`<option value="${snap.id}">${t.name}</option>`;
    teachersMap.set(snap.id,t.name);
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©
classForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const subject = subjectSelect.value;
  const teacherId = teacherSelect.value;
  const group = document.getElementById("groupInput").value.trim();
  const day = document.getElementById("daySelect").value;
  const time = document.getElementById("timeInput").value;

  // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙƒØ±ÙˆØ¨
  const studentsSnap = await getDocs(collection(db,"students"));
  const groupStudents = [];
  studentsSnap.forEach(snap=>{
    const s = snap.data();
    if(s.group===group){
      groupStudents.push({id:snap.id,name:s.name});
    }
  });

  await addDoc(collection(db,"classes"),{subject,teacherId,group,day,time,students:groupStudents,attendance:[]});
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­");
  classForm.reset();
  loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
async function loadClasses(){
  const snapshot = await getDocs(collection(db,"classes"));
  classesData = [];
  classesTableBody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const cls = {...docSnap.data(),id:docSnap.id};
    classesData.push(cls);
  });
  renderClassesTable();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ±
function renderClassesTable(){
  classesTableBody.innerHTML="";
  const fSubject = filterSubject.value;
  const fTeacher = filterTeacher.value;
  const fGroup = filterGroup.value.trim();
  const fDay = filterDay.value;

  classesData.forEach(cls=>{
    if(fSubject && cls.subject!==fSubject) return;
    if(fTeacher && cls.teacherId!==fTeacher) return;
    if(fGroup && cls.group!==fGroup) return;
    if(fDay && cls.day!==fDay) return;

    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${cls.subject}</td>
      <td>${teachersMap.get(cls.teacherId)||''}</td>
      <td>${cls.group}</td>
      <td>${cls.day}</td>
      <td>${cls.time}</td>
      <td><button class="btn warn" onclick="deleteClass('${cls.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    `;
    classesTableBody.appendChild(tr);
  });
}

// Ø­Ø°Ù Ø­ØµØ©
window.deleteClass = async(id)=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ")){
    await deleteDoc(doc(db,"classes",id));
    loadClasses();
  }
}

// ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«
[filterSubject,filterTeacher,filterGroup,filterDay].forEach(el=>{
  el.addEventListener("input", renderClassesTable);
});

// Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click",()=>{
  window.print();
});
</script>
</body>
</html>