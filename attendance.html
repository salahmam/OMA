<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</title>
<style>
body{font-family:'Cairo',sans-serif;margin:0;background:#f5f9ff;color:#102027;direction:rtl;visibility:hidden;}
header{background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
@media print{
  body{background:white;}
  header,.filters,.actions,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</header>
<div class="wrap">

<!-- ÙÙ„Ø§ØªØ± -->
<div class="card filters">
  <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</strong>
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px">
    <select id="filterSubject"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option></select>
    <select id="filterTeacher"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option></select>
    <input id="filterGroup" type="text" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨">
    <select id="filterDay">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</option>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
    <button id="printBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</strong>
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.appspot.com",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href="login.html"; }
  else{ document.body.style.visibility="visible"; loadFilters(); loadAttendance(); }
});

const filterSubject=document.getElementById("filterSubject");
const filterTeacher=document.getElementById("filterTeacher");
const filterGroup=document.getElementById("filterGroup");
const filterDay=document.getElementById("filterDay");
const printBtn=document.getElementById("printBtn");
const attendanceTable=document.querySelector("#attendanceTable tbody");

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
async function loadFilters(){
  const subjectsSet=new Set();
  const teachersSnap=await getDocs(collection(db,"teachers"));
  filterTeacher.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>";
  teachersSnap.forEach(tSnap=>{
    const t=tSnap.data();
    filterTeacher.innerHTML+=`<option value="${tSnap.id}">${t.name}</option>`;
    t.subjects.forEach(s=>subjectsSet.add(s.name));
  });
  filterSubject.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>";
  subjectsSet.forEach(s=>filterSubject.innerHTML+=`<option value="${s}">${s}</option>`);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
async function loadAttendance(){
  const snapshot=await getDocs(collection(db,"classes"));
  attendanceTable.innerHTML="";
  snapshot.forEach(clsSnap=>{
    const cls={...clsSnap.data(),id:clsSnap.id};
    cls.students.forEach(st=>{
      const tr=document.createElement("tr");
      tr.dataset.subject=cls.subjectId;
      tr.dataset.teacher=cls.teacherId;
      tr.dataset.group=cls.group;
      tr.dataset.day=cls.day;
      tr.innerHTML=`
        <td>${cls.subjectId}</td>
        <td>${cls.teacherId}</td>
        <td>${cls.group}</td>
        <td>${cls.day}</td>
        <td>${cls.time}</td>
        <td>${st.name}</td>
        <td>
          <select data-class="${cls.id}" data-student="${st.id}" class="attendanceSelect">
            <option value="Ø­Ø§Ø¶Ø±" ${cls.attendance.find(a=>a.studentId===st.id)?.status==="Ø­Ø§Ø¶Ø±"?"selected":""}>Ø­Ø§Ø¶Ø±</option>
            <option value="ØºØ§Ø¦Ø¨" ${cls.attendance.find(a=>a.studentId===st.id)?.status==="ØºØ§Ø¦Ø¨"?"selected":""}>ØºØ§Ø¦Ø¨</option>
          </select>
        </td>
      `;
      attendanceTable.appendChild(tr);
    });
  });

  document.querySelectorAll(".attendanceSelect").forEach(sel=>{
    sel.addEventListener("change",async(e)=>{
      const clsId=e.target.dataset.class;
      const stId=e.target.dataset.student;
      const clsRef=doc(db,"classes",clsId);
      const clsDoc=await getDocs(collection(db,"classes"));
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const clsSnap=await getDocs(collection(db,"classes"));
      // Ø§Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
      const attendanceRef=clsRef;
      const clsData=(await clsRef.get()).data?.() || {};
      let attendanceArr=clsData.attendance || [];
      const idx=attendanceArr.findIndex(a=>a.studentId===stId);
      if(idx>=0){ attendanceArr[idx].status=e.target.value; }
      else{ attendanceArr.push({studentId:stId,status:e.target.value}); }
      await updateDoc(clsRef,{attendance:attendanceArr});
    });
  });
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
[filterSubject,filterTeacher,filterGroup,filterDay].forEach(el=>{
  el.addEventListener("change",applyFilters);
});
function applyFilters(){
  const s=filterSubject.value, t=filterTeacher.value, g=filterGroup.value.trim(), d=filterDay.value;
  document.querySelectorAll("#attendanceTable tbody tr").forEach(tr=>{
    tr.style.display=( (s&&tr.dataset.subject!==s) ||
                     (t&&tr.dataset.teacher!==t) ||
                     (g&&tr.dataset.group!==g) ||
                     (d&&tr.dataset.day!==d) ) ? "none":"table-row";
  });
}

// Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click",()=>{window.print();});
</script>
</body>
</html>