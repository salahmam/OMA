<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© - OMA</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
body{
  font-family:'Cairo',sans-serif;
  margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:#102027;direction:rtl;
}
header{background:linear-gradient(90deg,var(--primary),#007bff);color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.warn{background:#ff7043}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.checkbox{width:18px;height:18px}
@media print{
  body{background:white;padding:0}
  header, .controls, .actions { display:none !important; }
  .print-page{box-shadow:none;margin:0;padding:0}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</header>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <strong>Ø·Ù„Ø§Ø¨Ùƒ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„ÙƒØ±ÙˆØ¨</strong>
      <button id="printAttendance" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    </div>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
          <th>Ø§Ù„ØºÙŠØ§Ø¨</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const userType = localStorage.getItem("userType");
const userName = localStorage.getItem("userName");

if(userType !== "teacher"){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©"); window.location.href = "index.html"; }

const attendanceTableBody = document.querySelector("#attendanceTable tbody");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† ÙŠØ¯Ø±Ø³Ù‡Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°
async function loadTeacherStudents() {
  const snapshot = await getDocs(collection(db,"students"));
  attendanceTableBody.innerHTML = "";
  snapshot.forEach(docSnap => {
    const student = {...docSnap.data(), id: docSnap.id};
    student.subjects.forEach(sub => {
      if(sub.teacher === userName){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${student.name}</td>
          <td>${student.group}</td>
          <td>${sub.name}</td>
          <td><input type="checkbox" class="present" data-student="${student.id}" data-subject="${sub.name}"></td>
          <td><input type="checkbox" class="absent" data-student="${student.id}" data-subject="${sub.name}"></td>
        `;
        attendanceTableBody.appendChild(tr);

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
        const presentChk = tr.querySelector(".present");
        const absentChk = tr.querySelector(".absent");
        presentChk.addEventListener("change",()=>{if(presentChk.checked) absentChk.checked=false;});
        absentChk.addEventListener("change",()=>{if(absentChk.checked) presentChk.checked=false;});
      }
    });
  });
}

loadTeacherStudents();

// Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨
async function saveAttendance() {
  const rows = attendanceTableBody.querySelectorAll("tr");
  for(const row of rows){
    const studentId = row.querySelector(".present").dataset.student;
    const subjectName = row.querySelector(".present").dataset.subject;
    const present = row.querySelector(".present").checked;
    const absent = row.querySelector(".absent").checked;

    const studentRef = doc(db,"students",studentId);
    const studentSnap = await getDocs(collection(db,"students"));
    const studentDoc = await getDocs(doc(db,"students",studentId));
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¶ÙˆØ±)
    await updateDoc(studentRef, {
      subjects: firebase.firestore.FieldValue.arrayUnion({
        name: subjectName,
        attendance: present ? "Ø­Ø§Ø¶Ø±" : absent ? "ØºØ§Ø¦Ø¨" : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
      })
    });
  }
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
}

// Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
document.getElementById("printAttendance").addEventListener("click",()=>{
  window.print();
});
</script>
</body>
</html>
