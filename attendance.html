<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ - Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
body { font-family:'Cairo',sans-serif; margin:0; padding:20px; background:#f5f9ff; color:#102027; visibility:hidden; }
header { padding:20px; text-align:center; font-size:20px; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:12px; }
header img { height:50px; }
.wrap{max-width:1200px;margin:20px auto;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
label{display:block;margin:6px 0 4px;font-size:13px;color:#37474f;}
select, input[type=date]{width:100%;padding:10px;border:1px solid #d6dde9;border-radius:8px;margin-bottom:8px;font-size:15px;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.btn{background:#004aad;color:#fff;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
@media print{
  body{background:white;}
  header,.filters,.actions,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
.status-select{padding:6px;border-radius:6px;border:1px solid #ccc;}
</style>
</head>
<body>

<header>
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
</header>

<div class="wrap">

  <div class="card filters">
    <strong>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­ØµØµ</strong>
    <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="filterSubject"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="filterTeacher"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
    <select id="filterGroup"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="filterDay">
      <option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
      <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
    </select>
    <button id="filterBtn" class="btn" style="margin-top:8px;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
    <button id="printBtn" class="btn" style="margin-top:8px;">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  </div>

  <div class="card">
    <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ØµØµ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</strong>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„ÙŠÙˆÙ…</th>
          <th>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
          <th>ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
          <th>Ø§Ù„Ø·Ù„Ø§Ø¨</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const filterSubject = document.getElementById("filterSubject");
const filterTeacher = document.getElementById("filterTeacher");
const filterGroup = document.getElementById("filterGroup");
const filterDay = document.getElementById("filterDay");
const filterBtn = document.getElementById("filterBtn");
const printBtn = document.getElementById("printBtn");
const tableBody = document.querySelector("#attendanceTable tbody");

let subjectsList=[], teachersList=[], groupsList=[], classesData=[], instituteData={};

// ğŸ”‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  document.body.style.visibility = "visible";

  await loadInstituteData();
  await loadSubjectsTeachersGroups();
  await loadClasses();
});

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadInstituteData(){
  const settingsSnap = await getDocs(collection(db,"settings"));
  settingsSnap.forEach(docSnap=>{
    instituteData = docSnap.data();
    document.getElementById("instituteName").textContent = instituteData.name || "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯";
    document.getElementById("instituteLogo").src = instituteData.logo || "";
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
async function loadSubjectsTeachersGroups(){
  subjectsList = [];
  teachersList = [];
  groupsList = [];

  const studentsSnap = await getDocs(collection(db,"students"));
  const subjectsSet = new Set();
  const groupsSet = new Set();
  studentsSnap.forEach(s=>{
    s.data().subjects?.forEach(sub=>subjectsSet.add(sub.name));
    if(s.data().group) groupsSet.add(s.data().group);
  });
  subjectsList = [...subjectsSet];
  groupsList = [...groupsSet];

  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersSnap.forEach(t=>{teachersList.push({id:t.id,...t.data()});});

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  subjectsList.forEach(sub=>{filterSubject.innerHTML += `<option value="${sub}">${sub}</option>`;});
  teachersList.forEach(t=>{filterTeacher.innerHTML += `<option value="${t.id}">${t.name}</option>`;});
  groupsList.forEach(g=>{filterGroup.innerHTML += `<option value="${g}">${g}</option>`;});
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
async function loadClasses(filter={}){
  const snapshot = await getDocs(collection(db,"classes"));
  tableBody.innerHTML = "";
  classesData = [];

  snapshot.forEach(docSnap=>{
    const cls = {id: docSnap.id, ...docSnap.data()};
    if((!filter.subject || cls.subject===filter.subject) &&
       (!filter.teacher || cls.teacherId===filter.teacher) &&
       (!filter.group || cls.group===filter.group) &&
       (!filter.day || cls.day===filter.day)){
      classesData.push(cls);
    }
  });

  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª
  const daysOrder = ["Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯"];
  classesData.sort((a,b)=>{
    const dayDiff = daysOrder.indexOf(a.day) - daysOrder.indexOf(b.day);
    if(dayDiff!==0) return dayDiff;
    return a.startTime.localeCompare(b.startTime);
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø­ØµØµ
  classesData.forEach(cls=>{
    const teacherName = (teachersList.find(t=>t.id===cls.teacherId)||{}).name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const studentCells = cls.students.map(st=>{
      const status = cls.attendance.find(a=>a.id===st.id)?.status || "";
      return `<div>
        ${st.name}
        <select class="status-select" data-class="${cls.id}" data-student="${st.id}">
          <option value="">-</option>
          <option value="Ø­Ø§Ø¶Ø±" ${status==="Ø­Ø§Ø¶Ø±"?"selected":""}>Ø­Ø§Ø¶Ø±</option>
          <option value="ØºØ§Ø¦Ø¨" ${status==="ØºØ§Ø¦Ø¨"?"selected":""}>ØºØ§Ø¦Ø¨</option>
          <option value="Ù…ØªØ£Ø®Ø±" ${status==="Ù…ØªØ£Ø®Ø±"?"selected":""}>Ù…ØªØ£Ø®Ø±</option>
        </select>
      </div>`;
    }).join("");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="background:${instituteData.colors?.subjectColor||'#eef4ff'}">${cls.subject}</td>
      <td>${teacherName}</td>
      <td>${cls.group}</td>
      <td>${cls.day}</td>
      <td>${cls.startTime}</td>
      <td>${cls.endTime}</td>
      <td>${studentCells}</td>
    `;
    tableBody.appendChild(tr);
  });

  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨
  document.querySelectorAll(".status-select").forEach(sel=>{
    sel.addEventListener("change", async e=>{
      const classId = sel.dataset.class;
      const studentId = sel.dataset.student;
      const value = sel.value;

      const clsRef = doc(db,"classes",classId);
      const clsData = classesData.find(c=>c.id===classId);
      const attendance = clsData.attendance.filter(a=>a.id!==studentId);
      if(value) attendance.push({id: studentId, status:value});
      await updateDoc(clsRef,{attendance});
      clsData.attendance = attendance;
    });
  });
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
filterBtn.addEventListener("click", ()=>{ 
  loadClasses({
    subject: filterSubject.value,
    teacher: filterTeacher.value,
    group: filterGroup.value,
    day: filterDay.value
  });
});

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
printBtn.addEventListener("click", ()=>{
  window.print();
});

</script>
</body>
</html>