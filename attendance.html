<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</title>
<style>
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;}
header{background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
@media print{
  body{background:white;}
  header,.filters,.btn{display:none !important;}
  table{page-break-inside:avoid;}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</header>
<div class="wrap">

<!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
<div class="card filters" style="display:flex;gap:12px;flex-wrap:wrap;">
  <div style="flex:1;min-width:150px;">
    <label>Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</label>
    <select id="filterGroup">
      <option value="">Ø§Ù„ÙƒÙ„</option>
    </select>
  </div>
  <div style="flex:1;min-width:150px;">
    <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
    <select id="filterTeacher">
      <option value="">Ø§Ù„ÙƒÙ„</option>
    </select>
  </div>
  <div style="flex:1;min-width:150px;align-self:flex-end;">
    <button id="filterBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
  </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<button id="printBtn" class="btn" style="margin-bottom:10px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
<div class="card">
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
        <th>Ø§Ù„Ø­Ø¶ÙˆØ± / Ø§Ù„ØºÙŠØ§Ø¨</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth,(user)=>{
  if(!user) window.location.href="login.html";
  else loadFiltersAndAttendance();
});

const attendanceTableBody = document.querySelector("#attendanceTable tbody");
const filterGroup = document.getElementById("filterGroup");
const filterTeacher = document.getElementById("filterTeacher");
const filterBtn = document.getElementById("filterBtn");
const printBtn = document.getElementById("printBtn");

let studentsData=[], teachersData=[], classesData=[];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
async function loadFiltersAndAttendance(){
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
  const teachersSnap = await getDocs(collection(db,"teachers"));
  teachersData = [];
  filterTeacher.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  teachersSnap.forEach(snap=>{
    const t = {...snap.data(),id:snap.id};
    teachersData.push(t);
    filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
  const studentsSnap = await getDocs(collection(db,"students"));
  studentsData = [];
  const groupsSet = new Set();
  studentsSnap.forEach(snap=>{
    const s = {...snap.data(),id:snap.id};
    studentsData.push(s);
    if(s.group) groupsSet.add(s.group);
  });
  filterGroup.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
  groupsSet.forEach(g=>{filterGroup.innerHTML+=`<option value="${g}">${g}</option>`;});

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ
  const classesSnap = await getDocs(collection(db,"classes"));
  classesData = [];
  classesSnap.forEach(snap=>{
    const c = {...snap.data(),id:snap.id};
    classesData.push(c);
  });

  renderAttendance();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function renderAttendance(groupFilter="", teacherFilter=""){
  attendanceTableBody.innerHTML="";
  classesData.forEach(cls=>{
    if(groupFilter && cls.group !== groupFilter) return;
    if(teacherFilter && cls.teacherId !== teacherFilter) return;
    cls.students.forEach(s=>{
      const teacher = teachersData.find(t=>t.id===cls.teacherId);
      const teacherName = teacher ? teacher.name : "-";
      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${s.name}</td>
        <td>${cls.subject}</td>
        <td>${teacherName}</td>
        <td>${cls.group}</td>
        <td>${s.attendance?"Ø­Ø§Ø¶Ø±":"ØºØ§Ø¦Ø¨"}</td>
      `;
      attendanceTableBody.appendChild(tr);
    });
  });
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
filterBtn.addEventListener("click", ()=>{
  renderAttendance(filterGroup.value, filterTeacher.value);
});

// Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printBtn.addEventListener("click", ()=>window.print());
</script>
</body>
</html>