<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</title>
<style>
:root{--primary:#004aad;--accent:#ffcc33;}
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;}
header{display:flex;align-items:center;gap:12px;background:var(--primary);color:#fff;padding:12px 18px;font-size:20px;font-weight:700;cursor:pointer;}
header img{height:40px;border-radius:5px;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-bottom:8px;}
.btn.warn{background:#ff7043;}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary);}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.filters input, .filters select{flex:1;}
.social-icons{display:flex;gap:10px;margin-top:8px;}
.social-icons a img{height:28px;}
.color-input{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
</style>
</head>
<body>

<header id="header">
  <img id="instituteLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
  <span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span>
</header>

<div class="wrap">

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ -->
<div class="card">
  <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label>
  <input type="text" id="instituteNameInput" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹Ù‡Ø¯ X">
  <label>Ø§Ù„Ø´Ø¹Ø§Ø± (Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©)</label>
  <input type="text" id="instituteLogoInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±">
  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
  <input type="text" id="instituteAddress" placeholder="Ù…Ø«Ø§Ù„: Ø¨ØºØ¯Ø§Ø¯ - Ø§Ù„Ø¹Ø±Ø§Ù‚">
  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
  <input type="text" id="institutePhone" placeholder="Ù…Ø«Ø§Ù„: 07701234567">
  <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
  <input type="email" id="instituteEmail" placeholder="Ù…Ø«Ø§Ù„: info@x.com">
  <button class="btn" id="saveInstituteInfoBtn">ğŸ’¾ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
</div>

<!-- ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ -->
<div class="card">
  <strong>ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</strong>
  <div id="socialInputs">
    <label>ÙÙŠØ³Ø¨ÙˆÙƒ</label><input type="text" id="facebookLink" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ">
    <label>Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</label><input type="text" id="instagramLink" placeholder="Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù…">
    <label>ØªÙŠÙƒ ØªÙˆÙƒ</label><input type="text" id="tiktokLink" placeholder="Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ">
    <label>ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label><input type="text" id="telegramLink" placeholder="Ø±Ø§Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù…">
  </div>
  <div class="social-icons" id="socialDisplay"></div>
  <button class="btn" id="saveSocialBtn">ğŸ’¾ Ø­ÙØ¸ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</button>
</div>

<!-- ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
<div class="card">
  <strong>ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <div class="color-input">
    <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</label>
    <input type="color" id="primaryColor">
  </div>
  <div class="color-input">
    <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ:</label>
    <input type="color" id="accentColor">
  </div>
  <button class="btn" id="saveColorsBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</button>
</div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø¨ -->
<div class="card">
  <strong>Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° (%)</label>
  <input type="number" id="teacherPercent" min="0" max="100" placeholder="Ù…Ø«Ø§Ù„: 60">
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ (%)</label>
  <input type="number" id="institutePercent" min="0" max="100" placeholder="Ù…Ø«Ø§Ù„: 40">
  <button class="btn" id="savePercentBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨</button>
</div>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ -->
<div class="card">
  <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</strong>
  <label>Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯</label>
  <input type="text" id="newBranch" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹">
  <button class="btn" id="addBranchBtn">â• Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
  <div class="table-container">
    <table id="branchesTable">
      <thead><tr><th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="card">
  <strong>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</strong>
  <form id="userForm">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <select id="userType">
      <option value="student">Ø·Ø§Ù„Ø¨</option>
      <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
    </select>
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <input type="text" id="userName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="userEmail" required>
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="password" id="userPassword" required>
    <button type="submit" class="btn">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
  </form>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</strong>
  <div class="filters">
    <input type="text" id="searchUser" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
    <select id="filterType"><option value="">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</option><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ø£Ø³ØªØ§Ø°</option></select>
  </div>
  <div class="table-container">
    <table id="usersTable">
      <thead>
        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
// ğŸ”¹ Firebase Ø¥Ø¹Ø¯Ø§Ø¯
import { db, auth } from "./firebase-config.js";
import { onAuthStateChanged, createUserWithEmailAndPassword, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { setDoc, doc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ----- ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -----
onAuthStateChanged(auth, user=>{
  if(!user){
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
    window.location.href="login.html";
  }else{
    initPage();
  }
});

// ----- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© -----
const header = document.getElementById("header");
const instituteLogoImg = document.getElementById("instituteLogo");
const instituteNameSpan = document.getElementById("instituteName");

// Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯
const nameInput = document.getElementById("instituteNameInput");
const logoInput = document.getElementById("instituteLogoInput");
const addressInput = document.getElementById("instituteAddress");
const phoneInput = document.getElementById("institutePhone");
const emailInput = document.getElementById("instituteEmail");
const saveInstituteBtn = document.getElementById("saveInstituteInfoBtn");

// ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„
const socialInputs = {
  facebook: document.getElementById("facebookLink"),
  instagram: document.getElementById("instagramLink"),
  tiktok: document.getElementById("tiktokLink"),
  telegram: document.getElementById("telegramLink")
};
const socialDisplay = document.getElementById("socialDisplay");
const saveSocialBtn = document.getElementById("saveSocialBtn");

// Ø§Ù„Ø£Ù„ÙˆØ§Ù†
const primaryColorInput = document.getElementById("primaryColor");
const accentColorInput = document.getElementById("accentColor");
const saveColorsBtn = document.getElementById("saveColorsBtn");

// Ø§Ù„Ù†Ø³Ø¨
const teacherPercentInput = document.getElementById("teacherPercent");
const institutePercentInput = document.getElementById("institutePercent");
const savePercentBtn = document.getElementById("savePercentBtn");

// Ø§Ù„ÙØ±ÙˆØ¹
const newBranchInput = document.getElementById("newBranch");
const addBranchBtn = document.getElementById("addBranchBtn");
const branchesTableBody = document.querySelector("#branchesTable tbody");
let branchesData = [];

// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†
const userForm = document.getElementById("userForm");
const userTypeSelect = document.getElementById("userType");
const userNameInput = document.getElementById("userName");
const userEmailInput = document.getElementById("userEmail");
const userPasswordInput = document.getElementById("userPassword");
const usersTableBody = document.querySelector("#usersTable tbody");
const searchUserInput = document.getElementById("searchUser");
const filterTypeSelect = document.getElementById("filterType");
let usersData = [];

// ----- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙØ­Ø© -----
async function initPage(){
  await loadUsers();
  await loadBranches();
  applyColors();
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
function applyColors(){
  document.documentElement.style.setProperty("--primary",primaryColorInput.value);
  document.documentElement.style.setProperty("--accent",accentColorInput.value);
}
primaryColorInput.addEventListener("input",applyColors);
accentColorInput.addEventListener("input",applyColors);

// ----- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -----
// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
userForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const type = userTypeSelect.value;
  const name = userNameInput.value.trim();
  const email = userEmailInput.value.trim();
  const password = userPasswordInput.value.trim();
  if(!name || !email || !password){alert("Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return;}
  try{
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    const uid = userCred.user.uid;
    await setDoc(doc(db, type==="student"?"students":"teachers", uid), {name,email,createdAt:new Date().toISOString()});
    usersData.push({id:uid,type,name,email});
    renderUsers();
    userForm.reset();
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!");
  }catch(err){console.error(err);alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message);}
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers(){
  const studentsSnap = await getDocs(collection(db,"students"));
  const teachersSnap = await getDocs(collection(db,"teachers"));
  usersData = [];
  studentsSnap.forEach(s=>usersData.push({id:s.id,type:"student",name:s.data().name,email:s.data().email||""}));
  teachersSnap.forEach(t=>usersData.push({id:t.id,type:"teacher",name:t.data().name,email:t.data().email||""}));
  renderUsers();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function renderUsers(){
  const search = searchUserInput.value.toLowerCase();
  const filter = filterTypeSelect.value;
  usersTableBody.innerHTML="";
  usersData.filter(u=>(!filter||u.type===filter)&&(!search||u.name.toLowerCase().includes(search)))
  .forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${u.name}</td><td>${u.type}</td><td>${u.email}</td>
      <td>
        <button class="btn" onclick="editUser('${u.id}','${u.type}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn" onclick="deleteUser('${u.id}','${u.type}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>`;
    usersTableBody.appendChild(tr);
  });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
window.editUser = async function(id,type){
  const user = usersData.find(u=>u.id===id);
  if(!user) return;
  const newEmail = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯:",user.email);
  if(!newEmail) return;
  const newPassword = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ø¥Ø°Ø§ Ù„Ù… ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ±Ù‡):","");
  try{
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Firestore
    await setDoc(doc(db,type==="student"?"students":"teachers",id),{...user,email:newEmail},{merge:true});
    user.email = newEmail;
    renderUsers();
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Firebase Auth Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø©
    if(newPassword){
      const userAuth = auth.currentUser;
      await updatePassword(userAuth,newPassword);
      alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!");
    }
  }catch(err){console.error(err);alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message);}
}

// Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
window.deleteUser = async function(id,type){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")){
    if(type==="student") await deleteDoc(doc(db,"students",id));
    else await deleteDoc(doc(db,"teachers",id));
    usersData = usersData.filter(u=>u.id!==id);
    renderUsers();
  }
}

// Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
searchUserInput.addEventListener("input", renderUsers);
filterTypeSelect.addEventListener("change", renderUsers);

// ----- Ø§Ù„ÙØ±ÙˆØ¹ -----
async function loadBranches(){
  try{
    const docRef = doc(db,"settings","branches");
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ branchesData Ù…Ù† Firestore
  }catch(err){console.warn(err);}
}
function renderBranches(){
  branchesTableBody.innerHTML="";
  branchesData.forEach((b,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${b}</td><td><button class="btn warn" onclick="deleteBranch(${i})">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>`;
    branchesTableBody.appendChild(tr);
  });
}
addBranchBtn.addEventListener("click",async()=>{
  if(!newBranchInput.value) return;
  branchesData.push(newBranchInput.value);
  await setDoc(doc(db,"settings","branches"),{list:branchesData});
  renderBranches();
  newBranchInput.value="";
});
window.deleteBranch = async function(i){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ØŸ")){
    branchesData.splice(i,1);
    await setDoc(doc(db,"settings","branches"),{list:branchesData});
    renderBranches();
  }
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³
header.addEventListener("click",()=>{window.location.href="dashboard.html";});

</script>
</body>
</html>