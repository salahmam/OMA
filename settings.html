<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</title>
<style>
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:#f5f9ff;color:#102027;}
header{background:#004aad;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700;}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
input, select{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:#004aad;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-bottom:8px;}
.btn.warn{background:#ff7043;}
.btn.ghost{background:transparent;color:#004aad;border:1px solid #004aad;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:#004aad;color:#fff;}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.filters select{flex:1;}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</header>
<div class="wrap">

<!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø¨ -->
<div class="card">
  <strong>Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° (%)</label>
  <input type="number" id="teacherPercent" min="0" max="100" placeholder="Ù…Ø«Ø§Ù„: 60">
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ (%)</label>
  <input type="number" id="institutePercent" min="0" max="100" placeholder="Ù…Ø«Ø§Ù„: 40">
  <button class="btn" id="savePercentBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨</button>
</div>

<!-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="card">
  <strong>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</strong>
  <form id="userForm">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <select id="userType">
      <option value="student">Ø·Ø§Ù„Ø¨</option>
      <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
    </select>
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <select id="userName"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option></select>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="userEmail" required>
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="password" id="userPassword" required>
    <button type="submit" class="btn">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
  </form>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</strong>
  <div class="filters">
    <select id="filterType"><option value="">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</option><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ø£Ø³ØªØ§Ø°</option></select>
  </div>
  <div class="table-container">
    <table id="usersTable">
      <thead>
        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
// ğŸ”¹ Firebase Ø¥Ø¹Ø¯Ø§Ø¯
import { db, auth } from "./firebase-config.js";
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { setDoc, doc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ----- ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù…Ù† Firestore -----
async function fetchNames() {
  const studentsSnapshot = await getDocs(collection(db,"students"));
  const teachersSnapshot = await getDocs(collection(db,"teachers"));
  return {
    students: studentsSnapshot.docs.map(d=>d.data().name),
    teachers: teachersSnapshot.docs.map(d=>d.data().name)
  };
}

let allNames = {students:[], teachers:[]};
async function updateNames(){
  const type = userTypeSelect.value;
  userNameSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option>";
  let names = type==="student"?allNames.students:allNames.teachers;
  names.forEach(n=>userNameSelect.innerHTML += `<option value="${n}">${n}</option>`);
}

// ----- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© -----
const userTypeSelect = document.getElementById("userType");
const userNameSelect = document.getElementById("userName");
const usersTableBody = document.querySelector("#usersTable tbody");

// ----- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -----
async function init() {
  allNames = await fetchNames();
  updateNames();
}
init();
userTypeSelect.addEventListener("change", updateNames);

// ----- ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø¹Ø±Ø¶Ù‡Ù… -----
let usersData = [];

// ----- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -----
document.getElementById("userForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const type = userTypeSelect.value;
  const name = userNameSelect.value;
  const email = document.getElementById("userEmail").value.trim();
  const password = document.getElementById("userPassword").value.trim();
  if(!type || !name || !email || !password){alert("Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return;}

  try{
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    const uid = userCred.user.uid;
    await setDoc(doc(db,"users",uid), {name,type,email,teacherPercent:0,createdAt:new Date().toISOString()});
    usersData.push({id:uid,type,name,email});
    renderUsers();
    e.target.reset();
    updateNames();
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!");
  }catch(err){console.error(err);alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message);}
});

// ----- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -----
function renderUsers(){
  const filter = document.getElementById("filterType").value;
  usersTableBody.innerHTML="";
  usersData.filter(u=>!filter||u.type===filter).forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.name}</td><td>${u.type}</td><td>${u.email}</td>
    <td>
      <button class="btn small" onclick="editUser('${u.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn warn small" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </td>`;
    usersTableBody.appendChild(tr);
  });
}

// ----- Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… -----
function deleteUser(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")){
    usersData = usersData.filter(u=>u.id!==id);
    renderUsers();
  }
}

// ----- ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… -----
function editUser(id){
  const user = usersData.find(u=>u.id===id);
  if(!user) return;
  userTypeSelect.value = user.type;
  updateNames();
  userNameSelect.value = user.name;
  document.getElementById("userEmail").value = user.email;
  usersData = usersData.filter(u=>u.id!==id);
}

// ----- Ø­ÙØ¸ Ù†Ø³Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ù…Ø¹Ù‡Ø¯ -----
document.getElementById("savePercentBtn").addEventListener("click", async ()=>{
  const tPercent = parseFloat(document.getElementById("teacherPercent").value) || 0;
  const iPercent = parseFloat(document.getElementById("institutePercent").value) || 0;
  if(tPercent + iPercent !== 100){ alert("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 100%"); return; }

  await setDoc(doc(db,"settings","percentages"), {teacher:tPercent,institute:iPercent});
  alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨: Ø§Ù„Ø£Ø³ØªØ§Ø° ${tPercent}% - Ø§Ù„Ù…Ø¹Ù‡Ø¯ ${iPercent}%`);
});
</script>
</body>
</html>