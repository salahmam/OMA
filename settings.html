<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Firebase</title>
<style>
:root{--primary:#004aad;--accent:#ffcc33;}
body { font-family: 'Cairo', sans-serif; background: #f5f9ff; color: #102027; padding: 20px; direction: rtl; }
.card { background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
input, select, button { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 15px; width: 100%; }
input[readonly]{ background:#e6e6e6; cursor: not-allowed; }
button { background: var(--primary); color: #fff; border: none; font-weight: bold; cursor: pointer; }
button:hover { background: #003a8c; }
label { font-size: 14px; display:block; margin-bottom:5px; }
.social-icons img { height:28px; margin-left:5px; cursor:pointer; }
ul { padding:0; list-style:none; }
ul li { margin-bottom:5px; }
ul li button { display:inline-block; padding:2px 6px; font-size:12px; margin-left:5px; }
.small { font-size:12px; padding:4px 6px; }
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.filters select, .filters input{flex:1;}
</style>
</head>
<body>

<h2>ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</h2>

<div class="card">
  <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</strong>
  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</label><input type="text" id="instituteName" readonly>
  <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¹Ù‡Ø¯</label><input type="email" id="instituteEmail" readonly>
  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="instituteAddress">
  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="institutePhone">
  <label>Ø§Ù„Ø´Ø¹Ø§Ø± (Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©)</label><input type="text" id="instituteLogo">
  <button id="saveInstituteBtn">ğŸ’¾ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
</div>

<div class="card">
  <strong>ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</strong>
  <label>ÙÙŠØ³Ø¨ÙˆÙƒ</label><input type="text" id="facebookLink">
  <label>Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</label><input type="text" id="instagramLink">
  <label>ØªÙŠÙƒ ØªÙˆÙƒ</label><input type="text" id="tiktokLink">
  <label>ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label><input type="text" id="telegramLink">
  <button id="saveSocialBtn">ğŸ’¾ Ø­ÙØ¸ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</button>
</div>

<div class="card">
  <strong>ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label><input type="color" id="primaryColor">
  <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</label><input type="color" id="accentColor">
  <button id="saveColorsBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</button>
</div>

<div class="card">
  <strong>Ù†Ø³Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ù…Ø¹Ù‡Ø¯</strong>
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° (%)</label><input type="number" id="teacherPercent" min="0" max="100">
  <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ù‡Ø¯ (%)</label><input type="number" id="institutePercent" min="0" max="100">
  <button id="savePercentBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨</button>
</div>

<div class="card">
  <strong>Ø§Ù„ÙØ±ÙˆØ¹</strong>
  <label>Ø£Ø¶Ù ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯</label><input type="text" id="newBranch">
  <button id="addBranchBtn">â• Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
  <ul id="branchesList"></ul>
</div>

<div class="card">
  <strong>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</strong>
  <form id="userForm">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <select id="userType">
      <option value="student">Ø·Ø§Ù„Ø¨</option>
      <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
    </select>
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <select id="userName"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option></select>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="userEmail" required>
    <button type="submit">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
  </form>
</div>

<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</strong>
  <div class="filters">
    <input type="text" id="searchUser" placeholder="Ø¨Ø­Ø«...">
    <select id="filterType"><option value="">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</option><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ø£Ø³ØªØ§Ø°</option></select>
  </div>
  <div class="table-container">
    <table id="usersTable">
      <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth(app);

// ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth,user=>{
  if(!user){ alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); window.location.href="login.html";}
});

// --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ---
const instituteName = document.getElementById("instituteName");
const instituteEmail = document.getElementById("instituteEmail");
const instituteAddress = document.getElementById("instituteAddress");
const institutePhone = document.getElementById("institutePhone");
const instituteLogo = document.getElementById("instituteLogo");

const facebookLink = document.getElementById("facebookLink");
const instagramLink = document.getElementById("instagramLink");
const tiktokLink = document.getElementById("tiktokLink");
const telegramLink = document.getElementById("telegramLink");

const primaryColor = document.getElementById("primaryColor");
const accentColor = document.getElementById("accentColor");

const teacherPercent = document.getElementById("teacherPercent");
const institutePercent = document.getElementById("institutePercent");

const newBranch = document.getElementById("newBranch");
const branchesList = document.getElementById("branchesList");

const userTypeSelect = document.getElementById("userType");
const userNameSelect = document.getElementById("userName");
const userForm = document.getElementById("userForm");

const usersTableBody = document.querySelector("#usersTable tbody");
const filterType = document.getElementById("filterType");
const searchUser = document.getElementById("searchUser");

let usersData = [];
let allNames = {students:[], teachers:[]};

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­ÙØ¸ ---
document.getElementById("saveInstituteBtn").addEventListener("click", async()=>{
  await setDoc(doc(db,"settings","institute"),{
    address: instituteAddress.value,
    phone: institutePhone.value,
    logo: instituteLogo.value
  }, { merge:true });
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯");
});

document.getElementById("saveSocialBtn").addEventListener("click", async()=>{
  await setDoc(doc(db,"settings","social"),{
    facebook: facebookLink.value,
    instagram: instagramLink.value,
    tiktok: tiktokLink.value,
    telegram: telegramLink.value
  });
  alert("âœ… ØªÙ… Ø­ÙØ¸ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„");
});

document.getElementById("saveColorsBtn").addEventListener("click", async()=>{
  await setDoc(doc(db,"settings","colors"),{
    primary: primaryColor.value,
    accent: accentColor.value
  }, { merge:true });
  document.documentElement.style.setProperty("--primary",primaryColor.value);
  document.documentElement.style.setProperty("--accent",accentColor.value);
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ù„ÙˆØ§Ù†");
});

document.getElementById("savePercentBtn").addEventListener("click", async()=>{
  const t = parseFloat(teacherPercent.value) || 0;
  const i = parseFloat(institutePercent.value) || 0;
  if(t+i!==100){ alert("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 100%"); return; }
  await setDoc(doc(db,"settings","percentages"),{teacher:t,institute:i});
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨");
});

// --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ ---
async function loadBranches(){
  branchesList.innerHTML="";
  const docSnap = await getDoc(doc(db,"settings","branches"));
  if(docSnap.exists() && docSnap.data().list){
    docSnap.data().list.forEach(b=>{
      const li = document.createElement("li");
      li.textContent = b;
      const btn = document.createElement("button");
      btn.textContent="ğŸ—‘ï¸";
      btn.onclick = async()=>{
        await updateDoc(doc(db,"settings","branches"),{list:arrayRemove(b)});
        loadBranches();
      };
      li.appendChild(btn);
      branchesList.appendChild(li);
    });
  }
}
document.getElementById("addBranchBtn").addEventListener("click", async()=>{
  const name = newBranch.value.trim();
  if(!name) return;
  await updateDoc(doc(db,"settings","branches"),{list:arrayUnion(name)}).catch(async()=>{
    await setDoc(doc(db,"settings","branches"),{list:[name]});
  });
  newBranch.value="";
  loadBranches();
});

// --- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ---
async function fetchNames(){
  const studentsSnapshot = await getDocs(collection(db,"students"));
  const teachersSnapshot = await getDocs(collection(db,"teachers"));
  allNames.students = studentsSnapshot.docs.map(d=>d.data().name);
  allNames.teachers = teachersSnapshot.docs.map(d=>d.data().name);
  updateNames();
}
function updateNames(){
  const type = userTypeSelect.value;
  userNameSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option>";
  let names = type==="student"?allNames.students:allNames.teachers;
  names.forEach(n=> userNameSelect.innerHTML+=`<option value="${n}">${n}</option>`);
}
userTypeSelect.addEventListener("change", updateNames);

userForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const type = userTypeSelect.value;
  const name = userNameSelect.value;
  const email = document.getElementById("userEmail").value.trim();
  if(!type || !name || !email){alert("Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return;}
  try{
    const userCred = await createUserWithEmailAndPassword(auth,email,"temporary123"); // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©
    const uid = userCred.user.uid;
    await setDoc(doc(db,"users",uid), {name,type,email,createdAt:new Date().toISOString()});
    usersData.push({id:uid,type,name,email});
    renderUsers();
    userForm.reset();
    updateNames();
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!");
  }catch(err){console.error(err); alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message);}
});

// --- Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
function renderUsers(){
  const filter = filterType.value;
  const search = searchUser.value.toLowerCase();
  usersTableBody.innerHTML="";
  usersData.filter(u=>(!filter||u.type===filter) && (!search||u.name.toLowerCase().includes(search)||u.email.toLowerCase().includes(search)))
  .forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.name}</td><td>${u.type}</td><td>${u.email}</td>
    <td>
      <button class="small" onclick="editUser('${u.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="small" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </td>`;
    usersTableBody.appendChild(tr);
  });
}

window.editUser = function(id){
  const user = usersData.find(u=>u.id===id);
  if(!user) return;
  userTypeSelect.value = user.type;
  updateNames();
  userNameSelect.value = user.name;
  document.getElementById("userEmail").value = user.email;
};

window.deleteUser = async function(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")){
    await doc(db,"users",id);
    usersData = usersData.filter(u=>u.id!==id);
    renderUsers();
  }
};

const defaultUserFormSubmit = userForm.onsubmit;

// --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
async function loadSettings(){
  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù…Ù† ØµÙØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
  const instDoc = await getDoc(doc(db,"institutes","INSTITUTE_ID")); // Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø£Ùˆ Ø§Ø¬Ù„Ø¨Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
  if(instDoc.exists()){
    instituteName.value = instDoc.data().name;
    instituteEmail.value = instDoc.data().adminEmail;
    primaryColor.value = (instDoc.data().colors && instDoc.data().colors.primary) || "#004aad";
    accentColor.value = (instDoc.data().colors && instDoc.data().colors.accent) || "#ffcc33";
    document.documentElement.style.setProperty("--primary",primaryColor.value);
    document.documentElement.style.setProperty("--accent",accentColor.value);
  }

  // Ø¬Ù„Ø¨ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† settings
  const inst = await getDoc(doc(db,"settings","institute"));
  if(inst.exists()){ 
    instituteAddress.value=inst.data().address; 
    institutePhone.value=inst.data().phone; 
    instituteLogo.value=inst.data().logo;
  }
  const social = await getDoc(doc(db,"settings","social"));
  if(social.exists()){ 
    facebookLink.value=social.data().facebook; 
    instagramLink.value=social.data().instagram; 
    tiktokLink.value=social.data().tiktok; 
    telegramLink.value=social.data().telegram; 
  }
  const perc = await getDoc(doc(db,"settings","percentages"));
  if(perc.exists()){ 
    teacherPercent.value=perc.data().teacher; 
    institutePercent.value=perc.data().institute; 
  }
  loadBranches();
  fetchNames();
  const usersSnap = await getDocs(collection(db,"users"));
  usersData = usersSnap.docs.map(d=>({id:d.id, ...d.data()}));
  renderUsers();
}

filterType.addEventListener("change", renderUsers);
searchUser.addEventListener("input", renderUsers);

loadSettings();
</script>

</body>
</html>