<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getAuth, 
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const errorMsg = document.getElementById("errorMsg");

// تحقق إذا المستخدم مسجل دخول مسبقاً
onAuthStateChanged(auth, async (user) => {
  if (user) {
    redirectByRole(user.uid);
  }
});

// تسجيل الدخول
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  if (!email || !password) {
    errorMsg.textContent = "الرجاء إدخال البريد الإلكتروني وكلمة المرور.";
    return;
  }

  errorMsg.textContent = "";
  loginBtn.disabled = true;
  loginBtn.textContent = "جاري التحقق...";

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const uid = userCred.user.uid;
    redirectByRole(uid);
  } catch (error) {
    loginBtn.disabled = false;
    loginBtn.textContent = "دخول";
    errorMsg.style.color = "red";
    if (error.code === "auth/user-not-found") {
      errorMsg.textContent = "المستخدم غير موجود.";
    } else if (error.code === "auth/wrong-password") {
      errorMsg.textContent = "كلمة المرور غير صحيحة.";
    } else {
      errorMsg.textContent = "حدث خطأ أثناء تسجيل الدخول.";
    }
  }
});

// دالة لإعادة التوجيه حسب نوع المستخدم
async function redirectByRole(uid) {
  try {
    const userDoc = await getDoc(doc(db, "users", uid));
    if (!userDoc.exists()) throw new Error("المستخدم غير موجود في قاعدة البيانات");

    const userData = userDoc.data();
    const role = userData.type;

    if (role === "admin") {
      window.location.href = "dashboard.html";
    } else if (role === "teacher") {
      window.location.href = "teacher-dashboard.html";
    } else if (role === "student") {
      window.location.href = "student-dashboard.html";
    } else {
      throw new Error("نوع المستخدم غير معروف");
    }
  } catch (err) {
    console.error(err);
    errorMsg.style.color = "red";
    errorMsg.textContent = "تعذّر تحديد نوع المستخدم.";
  }
}
</script>