<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root {
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box;}
body{
  font-family:'Cairo',sans-serif;
  margin:0;background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;direction:rtl;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700;
  display:flex;justify-content:space-between;align-items:center;
}
header button {
  background:#ff5555;
  border:none;
  color:white;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  transition:0.3s;
}
header button:hover { background:#d63030; }

.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);flex:1;}
input, select, textarea {
  padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;
}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f;}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.btn.warn{background:#ff7043;}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12);}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.modal {
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;
}
.modal.open{display:flex;}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto;}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700;}
@media (max-width:900px){
  .controls{flex-direction:column;align-items:stretch;}
}
</style>
</head>
<body>

<header>
  <div>ğŸ“š Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</div>
  <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="wrap">

  <!-- ğŸ”¹ Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
  <div class="controls">
    <div style="flex:1" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
          <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
        </div>
        <div class="right">
          <input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." style="padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
          <button id="refreshBtn" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <form id="studentForm" style="margin-top:12px">
        <div class="form-grid">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" type="text" required />

          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="phone" type="tel" required />

          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="address" type="text" />

          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="school" type="text" />

          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <input id="stage" type="text" />

          <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <input id="group" type="text" />

          <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
          <div id="subjectsContainer" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <button id="addSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>

          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
          <input id="totalFees" type="number" min="0" />

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="note" type="text" />

          <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ğŸ”¹ Ù‚Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
    </div>

    <table id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
          <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ğŸ”¹ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
// âœ… Firebase & Auth
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.firebasestorage.app",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0",
  measurementId: "G-QHPZG4JLB8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});

// ğŸ” Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Firestore
const studentsTableBody = document.querySelector("#studentsTable tbody");
async function loadStudents(){
  const snapshot = await getDocs(collection(db,"students"));
  studentsTableBody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const student = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${student.name}</td>
      <td>${student.phone}</td>
      <td>${student.stage}</td>
      <td>${student.group}</td>
      <td>${student.subjects ? student.subjects.map(s=>s.name).join(", ") : ""}</td>
      <td>
        <button class="btn small warn" onclick="deleteStudent('${docSnap.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>
    `;
    studentsTableBody.appendChild(tr);
  });
}
loadStudents();

// ğŸ”¹ Ø­ÙØ¸ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
const studentForm = document.getElementById("studentForm");
studentForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const stage = document.getElementById("stage").value;
  const group = document.getElementById("group").value;

  await addDoc(collection(db, "students"), { name, phone, stage, group, createdAt:new Date() });
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
  studentForm.reset();
  loadStudents();
});

// ğŸ”¹ Ø­Ø°Ù Ø·Ø§Ù„Ø¨
window.deleteStudent = async (id) => {
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
    await deleteDoc(doc(db, "students", id));
    loadStudents();
  }
};
</script>
</body>
</html>