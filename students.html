<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family: 'Cairo',sans-serif;
  margin:0;background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;direction:rtl;visibility:hidden;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;padding:18px 16px;text-align:center;font-size:20px;font-weight:700;
  box-shadow:0 3px 12px rgba(2,20,40,0.08);
}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);flex:1}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input[type="text"], input[type="tel"], input[type="number"], select, textarea, .subject-field {
  padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;
}
.two{width:calc(50% - 6px)}
label{display:block;margin-bottom:6px;font-size:13px;color:#37474f}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.warn{background:#ff7043}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.add-subj{display:inline-block;margin-top:6px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.actions button{margin:0 4px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999;}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto}
.flex{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…ØªØ·ÙˆØ±)</header>
<div class="wrap">

<div class="controls">
  <div style="flex:1" class="card">
    <div>
      <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
      <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
    </div>
    <form id="studentForm" style="margin-top:12px">
      <div class="form-grid">
        <div class="two">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" type="text" required />
        </div>
        <div class="two">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="phone" type="tel" required />
        </div>
        <div class="two">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="address" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="school" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <input id="stage" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
          <input id="group" type="text" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" />
        </div>
        <div style="width:100%">
          <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
          <div id="subjectsContainer" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div style="margin-top:8px">
            <button id="addSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>
        </div>
        <div class="two">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="totalFees" type="number" min="0" />
        </div>
        <div class="two">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="note" type="text" />
        </div>
        <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
          <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
  </div>
  <table id="studentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</th>
        <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="printStudentBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const studentForm = document.getElementById("studentForm");
const studentsTableBody = document.querySelector("#studentsTable tbody");
const subjectsContainer = document.getElementById("subjectsContainer");
const addSubjectBtn = document.getElementById("addSubjectBtn");
let studentsData = [];

addSubjectBtn.addEventListener("click",()=>{
  const div = document.createElement("div");
  div.classList.add("subject-field");
  div.style.display="flex"; div.style.gap="6px"; div.style.alignItems="center";
  div.innerHTML = `
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subjName" required />
    <input type="number" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·" class="subjFee" min="0" />
    <input type="number" placeholder="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" class="subjRemaining" min="0" />
    <button type="button" class="btn small addPaymentBtn">ğŸ’° Ø¯ÙØ¹</button>
    <button type="button" class="btn warn small removeSubjBtn">âŒ</button>
  `;
  subjectsContainer.appendChild(div);
  div.querySelector(".removeSubjBtn").addEventListener("click",()=>subjectsContainer.removeChild(div));
  div.querySelector(".addPaymentBtn").addEventListener("click",()=>{
    const payment = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:");
    if(payment && !isNaN(payment)){
      const date = new Date().toLocaleDateString();
      const remainingInput = div.querySelector(".subjRemaining");
      const currentRemaining = parseFloat(remainingInput.value)||0;
      const newRemaining = currentRemaining - parseFloat(payment);
      remainingInput.value = newRemaining>=0?newRemaining:0;
      if(!div.payments) div.payments=[];
      div.payments.push({amount:parseFloat(payment),date});
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©: "+payment+" Ø¨ØªØ§Ø±ÙŠØ® "+date);
    }
  });
});

studentForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  const school = document.getElementById("school").value.trim();
  const stage = document.getElementById("stage").value.trim();
  const group = document.getElementById("group").value.trim();
  const totalFees = parseFloat(document.getElementById("totalFees").value)||0;
  const note = document.getElementById("note").value.trim();

  const subjects = [];
  document.querySelectorAll(".subject-field").forEach(sub=>{
    const subjName = sub.querySelector(".subjName").value.trim();
    const subjFee = parseFloat(sub.querySelector(".subjFee").value)||0;
    const subjRemaining = parseFloat(sub.querySelector(".subjRemaining").value)||0;
    const payments = sub.payments || [];
    if(subjName) subjects.push({name:subjName,fee:subjFee,remaining:subjRemaining,payments});
  });

  if(subjects.length===0){ alert("Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}

  try{
    await addDoc(collection(db,"students"),{name,phone,address,school,stage,group,totalFees,note,subjects,createdAt:new Date()});
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
    studentForm.reset();
    subjectsContainer.innerHTML="";
    loadStudents();
  }catch(err){console.error(err);alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
});

async function loadStudents(){
  const snapshot = await getDocs(collection(db,"students"));
  studentsTableBody.innerHTML="";
  studentsData = [];
  snapshot.forEach(docSnap=>{
    const student = {...docSnap.data(),id:docSnap.id};
    studentsData.push(student);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${student.name}</td>
      <td>${student.phone}</td>
      <td>${student.stage}</td>
      <td>${student.group}</td>
      <td>${student.subjects.map(s=>"Ø§Ù„Ù…Ø§Ø¯Ø©:"+s.name+" / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:"+s.remaining).join("<br>")}</td>
      <td class="actions">
        <button class="btn small" onclick="showStudent('${student.id}')">ğŸ” Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
        <button class="btn warn small" onclick="deleteStudent('${student.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>
    `;
    studentsTableBody.appendChild(tr);
  });
  document.getElementById("totalCount").innerText=studentsData.length;
  document.body.style.visibility="visible";
}

window.deleteStudent = async function(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")){
    await deleteDoc(doc(db,"students",id));
    loadStudents();
  }
}

window.showStudent = function(id){
  const student = studentsData.find(s=>s.id===id);
  if(!student) return;
  const modal = document.getElementById("modal");
  const body = document.getElementById("modalBody");
  body.innerHTML=`<h3>${student.name}</h3>
    <p>Ø§Ù„Ù‡Ø§ØªÙ: ${student.phone}</p>
    <p>Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${student.stage}</p>
    <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${student.group}</p>
    <p>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${student.address}</p>
    <p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${student.note}</p>
    <h4>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø·:</h4>
    ${student.subjects.map(s=>{
      return `<b>${s.name}</b> - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·: ${s.fee} - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${s.remaining}<br>
      Ø§Ù„Ø¯ÙØ¹Ø§Øª:<br>${s.payments.map(p=>p.amount+" Ø¨ØªØ§Ø±ÙŠØ® "+p.date).join("<br>")}`;
    }).join("<hr>")}`;
  modal.classList.add("open");
}

document.getElementById("closeModal").addEventListener("click",()=>{document.getElementById("modal").classList.remove("open")});

</script>
</body>
</html>