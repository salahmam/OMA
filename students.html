<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad; --accent:#ffcc33; --bg:#f5f9ff; --card:#fff;
}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:#102027;direction:rtl;visibility:hidden;}
header{background:linear-gradient(90deg,var(--primary),#007bff);color:#fff;padding:16px;text-align:center;font-weight:700;}
.wrap{max-width:1200px;margin:20px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:14px;}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input,select,textarea{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.warn{background:#ff7043}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.subject-row > *{flex:1}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
  .print-page{box-shadow:none;margin:0;padding:0}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</header>
<div class="wrap">

  <!-- Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
        <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center" class="no-print">
        <select id="stageSelect" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
        </select>
        <select id="groupSelectTop" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>
        </select>
        <button id="printListBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

    <form id="studentForm" style="margin-top:12px">
      <div class="form-grid">
        <div class="two">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" type="text" required />
        </div>
        <div class="two">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="phone" type="tel" required />
        </div>
        <div class="two">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="address" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="school" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <select id="stageSelectForm"></select>
        </div>
        <div class="two">
          <label>Ø§Ù„ÙƒØ±ÙˆØ¨</label>
          <select id="groupSelectForm"></select>
        </div>

        <div style="width:100%">
          <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ø®ØªÙØ± Ù…Ø§Ø¯Ø© Ø«Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø«Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·)</label>
          <div id="subjectsContainer"></div>
          <div style="margin-top:8px">
            <button id="addSubjectBtn" type="button" class="btn ghost small">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>
        </div>

        <div class="two">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø­ÙØ³Ø¨ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£Ùˆ Ø£ÙØ¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹)</label>
          <input id="totalFees" type="number" min="0" />
        </div>
        <div class="two">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="note" type="text" />
        </div>

        <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
          <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
      <div style="display:flex;gap:8px;align-items:center" class="no-print">
        <select id="filterSubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
        <select id="filterTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
        <select id="filterGroup"><option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option></select>
        <button id="applyFiltersBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
    </div>

    <table class="table" id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯ / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <div>
        <button id="printStudentBtn" class="btn no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
        <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
/* ======================
  Students page â€” full code
  - Requires Firestore collections: students, teachers, settings(optional: logo)
  - Protects page with Firebase Auth
  - Add / edit students, payments, print
====================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  deleteDoc,
  getDoc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* --------- Configure Firebase (Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§) --------- */
const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.appspot.com",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0",
  measurementId: "G-QHPZG4JLB8"
};
/* ---------------------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* --- Elements --- */
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const studentForm = document.getElementById('studentForm');
const studentsTableBody = document.querySelector('#studentsTable tbody');
const totalCount = document.getElementById('totalCount');
const clearFormBtn = document.getElementById('clearFormBtn');

const filterSubject = document.getElementById('filterSubject');
const filterTeacher = document.getElementById('filterTeacher');
const filterGroup = document.getElementById('filterGroup');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const printListBtn = document.getElementById('printListBtn');

const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const printStudentBtn = document.getElementById('printStudentBtn');

const stageSelect = document.getElementById('stageSelect');
const stageSelectForm = document.getElementById('stageSelectForm');
const groupSelectTop = document.getElementById('groupSelectTop');
const groupSelectForm = document.getElementById('groupSelectForm');

/* --- State --- */
let teachers = []; // loaded from teachers collection
let studentsCache = []; // loaded students
const STAGES = [
  "Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø¹Ù„Ù…ÙŠ",
  "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ø¯Ø¨ÙŠ"
];
const GROUPS = ["A","B","C","D","E","F","G","H"];

/* ---------- Auth guard: show page only to logged-in users ---------- */
onAuthStateChanged(auth, user => {
  if (!user) {
    // ØºÙŠØ± Ù…Ø³Ø¬Ù„ -> Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    window.location.href = 'login.html';
  } else {
    // Ù…ÙØ³Ø¬Ù„ -> Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.body.style.visibility = 'visible';
    initPage();
  }
});

/* ----------------- Initialization ----------------- */
async function initPage(){
  // Ù…Ù„Ø¡ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„ÙƒØ±ÙˆØ¨ Ù…Ø³Ø¨Ù‚Ù‹Ø§
  STAGES.forEach(s=>{
    stageSelect.innerHTML += `<option value="${s}">${s}</option>`;
    stageSelectForm.innerHTML += `<option value="${s}">${s}</option>`;
  });
  GROUPS.forEach(g=>{
    groupSelectTop.innerHTML += `<option value="${g}">${g}</option>`;
    groupSelectForm.innerHTML += `<option value="${g}">${g}</option>`;
  });

  await loadTeachers();
  await loadStudents();
  populateFilters();
}

/* ----------------- Load teachers (for subject -> teacher select) ----------------- */
async function loadTeachers(){
  teachers = [];
  try {
    const snap = await getDocs(collection(db,'teachers'));
    snap.forEach(d=>{
      teachers.push({ id: d.id, ...(d.data()) });
    });
  } catch(e){ console.error('loadTeachers', e); }
}

/* ----------------- Add subject row (DOM only, not saved yet) ----------------- */
function createSubjectRow(data = {}) {
  // data: { name, teacherId, fee, remaining, payments: [{amount,date}, ...] }
  const wrapper = document.createElement('div');
  wrapper.className = 'subject-row';

  // subject name input (allow typing new or choose from teacher subjects later)
  const subjInp = document.createElement('input');
  subjInp.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©';
  subjInp.value = data.name || '';

  // teacher select
  const teacherSel = document.createElement('select');
  teacherSel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`;
  teachers.forEach(t => teacherSel.innerHTML += `<option value="${t.id}" ${t.id===data.teacherId?'selected':''}>${t.name}</option>`);

  // fee input
  const feeInp = document.createElement('input');
  feeInp.type = 'number';
  feeInp.placeholder = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·';
  feeInp.min = 0;
  feeInp.value = data.fee ?? '';

  // remaining input
  const remInp = document.createElement('input');
  remInp.type = 'number';
  remInp.placeholder = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ';
  remInp.min = 0;
  remInp.value = data.remaining ?? '';

  // add payment button
  const payBtn = document.createElement('button');
  payBtn.type = 'button';
  payBtn.className = 'btn small';
  payBtn.textContent = 'ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';

  // remove subject
  const remSubBtn = document.createElement('button');
  remSubBtn.type = 'button';
  remSubBtn.className = 'btn warn small';
  remSubBtn.textContent = 'âŒ';

  // store payments array on wrapper
  wrapper.payments = Array.isArray(data.payments) ? [...data.payments] : [];

  payBtn.addEventListener('click', ()=>{
    const amountStr = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:');
    if(!amountStr) return;
    const amount = parseFloat(amountStr);
    if(isNaN(amount) || amount <= 0){ alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
    const date = new Date().toLocaleDateString();
    wrapper.payments.push({ amount, date });
    // subtract from remaining input if present
    const curRem = parseFloat(remInp.value)||0;
    remInp.value = Math.max(0, curRem - amount);
    alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${amount} Ø¨ØªØ§Ø±ÙŠØ® ${date}`);
  });

  remSubBtn.addEventListener('click', ()=> wrapper.remove());

  wrapper.appendChild(subjInp);
  wrapper.appendChild(teacherSel);
  wrapper.appendChild(feeInp);
  wrapper.appendChild(remInp);
  wrapper.appendChild(payBtn);
  wrapper.appendChild(remSubBtn);

  subjectsContainer.appendChild(wrapper);
  return wrapper;
}

/* Add subject button handler */
addSubjectBtn.addEventListener('click', ()=>{
  if(teachers.length === 0){
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø© Ù…Ø³Ø¬Ù„ÙŠÙ† â€” Ø£Ø¶Ù Ø£Ø³Ø§ØªØ°Ø© Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©');
  }
  createSubjectRow();
});

/* ----------------- Save student ----------------- */
studentForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const school = document.getElementById('school').value.trim();
  const stage = document.getElementById('stageSelectForm').value;
  const group = document.getElementById('groupSelectForm').value;
  const totalFees = parseFloat(document.getElementById('totalFees').value) || 0;
  const note = document.getElementById('note').value.trim();

  // collect subjects
  const subRows = Array.from(subjectsContainer.querySelectorAll('.subject-row'));
  const subjects = subRows.map(r => {
    const inputs = r.querySelectorAll('input,select');
    const name = inputs[0].value.trim();
    const teacherId = r.querySelector('select').value || '';
    const fee = parseFloat(inputs[2].value) || 0;
    const remaining = parseFloat(inputs[3].value) || 0;
    const payments = r.payments || [];
    return { name, teacherId, fee, remaining, payments };
  }).filter(s => s.name);

  if(!name || !phone){ alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'); return; }
  if(subjects.length === 0){ alert('Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

  // if totalFees empty, compute sum of fees
  const computedTotal = subjects.reduce((sum,s)=>sum + (s.fee||0), 0);
  const finalTotal = totalFees > 0 ? totalFees : computedTotal;

  // save to firestore
  try {
    await addDoc(collection(db,'students'), {
      name, phone, address, school, stage, group,
      totalFees: finalTotal, note, subjects, createdAt: new Date()
    });
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    studentForm.reset();
    subjectsContainer.innerHTML = '';
    loadStudents(); // refresh list
  } catch (e) {
    console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
  }
});

/* ----------------- Load students ----------------- */
async function loadStudents(filter = {}) {
  try{
    const q = query(collection(db,'students'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    studentsCache = [];
    studentsTableBody.innerHTML = '';
    const subjectSet = new Set();
    const teacherSet = new Set();
    const groupSet = new Set();

    snap.forEach(d=>{
      const s = { id: d.id, ...(d.data()) };
      studentsCache.push(s);
      // collect filters source
      (s.subjects||[]).forEach(sub => {
        if(sub.name) subjectSet.add(sub.name);
        if(sub.teacherId) teacherSet.add(sub.teacherId);
      });
      if(s.group) groupSet.add(s.group);
    });

    // populate filters dropdowns
    populateFilterSelects(subjectSet, teacherSet, groupSet);

    // apply local filter
    let filtered = studentsCache;
    if(filter.subject) filtered = filtered.filter(st=> (st.subjects||[]).some(sub=>sub.name === filter.subject));
    if(filter.teacher) filtered = filtered.filter(st=> (st.subjects||[]).some(sub=>sub.teacherId === filter.teacher));
    if(filter.group) filtered = filtered.filter(st=> st.group === filter.group);

    // render rows
    filtered.forEach(s => {
      const tr = document.createElement('tr');

      const subjectsHtml = (s.subjects||[]).map(sub=>{
        const paid = (sub.payments||[]).reduce((a,p)=> a + (p.amount||0), 0);
        const remaining = sub.remaining ?? Math.max(0, (sub.fee||0) - paid);
        // teacher name resolution
        const teacherName = (teachers.find(t=>t.id === sub.teacherId) || {}).name || '-';
        return `${sub.name} â€” ${teacherName} <br> Ø¥Ø¬Ù…Ø§Ù„ÙŠ:${sub.fee || 0} - Ù…Ø¯ÙÙˆØ¹:${paid} - Ù…ØªØ¨Ù‚ÙŠ:${remaining}`;
      }).join('<hr style="border:none;border-top:1px dashed #ddd;margin:8px 0">');

      tr.innerHTML = `
        <td style="text-align:right">${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.phone)}</td>
        <td>${escapeHtml(s.stage||'-')}</td>
        <td>${escapeHtml(s.group||'-')}</td>
        <td style="text-align:right">${subjectsHtml}</td>
        <td class="actions">
          <button class="btn small" data-id="${s.id}" data-action="view">ğŸ” Ø¹Ø±Ø¶</button>
          <button class="btn small" data-id="${s.id}" data-action="pay">ğŸ’° Ø¯ÙØ¹Ø§Øª</button>
          <button class="btn" data-id="${s.id}" data-action="print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn warn small" data-id="${s.id}" data-action="delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      `;
      studentsTableBody.appendChild(tr);
    });

    totalCount.innerText = (filtered||[]).length;

    // attach handlers (event delegation)
    studentsTableBody.querySelectorAll('button').forEach(btn=>{
      btn.removeEventListener('click', handleRowAction);
      btn.addEventListener('click', handleRowAction);
    });

  } catch(e){ console.error('loadStudents', e); }
}

/* populate filters selects */
function populateFilterSelects(subjectSet, teacherSet, groupSet){
  // subject
  filterSubject.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>`;
  subjectSet.forEach(s => filterSubject.innerHTML += `<option value="${s}">${s}</option>`);

  // teacher
  filterTeacher.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>`;
  teachers.forEach(t => {
    const selected = teacherSet.has(t.id) ? '' : ''; // show all teachers
    filterTeacher.innerHTML += `<option value="${t.id}">${t.name}</option>`;
  });

  // group
  filterGroup.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option>`;
  groupSet.forEach(g => filterGroup.innerHTML += `<option value="${g}">${g}</option>`);
}

/* populate top selects for printing and forms */
function populateFilters(){
  // subject list: use teachers' subjects if available
  filterSubject.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>`;
  // we won't assume a central subjects collection; subjects appear from students or teachers
  // teacher select already filled via loadTeachers
  filterTeacher.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>`;
  teachers.forEach(t => filterTeacher.innerHTML += `<option value="${t.id}">${t.name}</option>`);

  filterGroup.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option>`;
  GROUPS.forEach(g => filterGroup.innerHTML += `<option value="${g}">${g}</option>`);

  groupSelectTop.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>`;
  GROUPS.forEach(g => groupSelectTop.innerHTML += `<option value="${g}">${g}</option>`);

  // also fill subject select in form: allow free typing so leave it empty
}

/* ----------------- Row action handler ----------------- */
async function handleRowAction(e){
  const id = e.currentTarget.dataset.id;
  const action = e.currentTarget.dataset.action;
  if(action === 'view') return showStudent(id);
  if(action === 'pay') return openPaymentPrompt(id);
  if(action === 'print') return printStudentById(id);
  if(action === 'delete') {
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
    await deleteDoc(doc(db,'students',id));
    await loadStudents();
  }
}

/* ----------------- Show student modal ----------------- */
function showStudent(id){
  const student = studentsCache.find(s=>s.id === id);
  if(!student) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ â€” ${student.name}`;
  // build html
  let html = `<div style="display:flex;gap:12px;flex-wrap:wrap">`;
  // left: info
  html += `<div style="flex:1;min-width:260px">
    <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(student.name)}</p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(student.phone)}</p>
    <p><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${escapeHtml(student.stage||'-')}</p>
    <p><strong>Ø§Ù„ÙƒØ±ÙˆØ¨:</strong> ${escapeHtml(student.group||'-')}</p>
    <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${escapeHtml(student.address||'-')}</p>
    <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${escapeHtml(student.note||'-')}</p>
  </div>`;
  // right: financial
  html += `<div style="flex:1;min-width:260px">
    <h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h3>`;
  (student.subjects||[]).forEach((sub,idx)=>{
    const paid = (sub.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
    const remaining = sub.remaining ?? Math.max(0, (sub.fee||0) - paid);
    const teacherName = (teachers.find(t=>t.id === sub.teacherId)||{}).name || '-';
    html += `<div style="padding:8px;border:1px solid #eee;margin-bottom:8px">
      <div><strong>${escapeHtml(sub.name)}</strong> â€” ${escapeHtml(teacherName)}</div>
      <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sub.fee || 0} â€” Ù…Ø¯ÙÙˆØ¹: ${paid} â€” Ù…ØªØ¨Ù‚ÙŠ: ${remaining}</div>
      <div style="margin-top:6px">Ø§Ù„Ø¯ÙØ¹Ø§Øª:<br>${(sub.payments||[]).map(p=>`${p.amount} â€” ${p.date}`).join('<br>') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª'}</div>
      <div style="margin-top:8px">
        <button class="btn small" data-student="${student.id}" data-sub="${idx}" onclick="addPaymentToSubject(this)">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
      </div>
    </div>`;
  });
  html += `</div></div>`;
  modalBody.innerHTML = html;
  modal.classList.add('open');
}

/* add payment button inside modal */
window.addPaymentToSubject = async function(btn){
  const studentId = btn.dataset.student;
  const subIdx = parseInt(btn.dataset.sub);
  const amountStr = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:');
  if(!amountStr) return;
  const amount = parseFloat(amountStr);
  if(isNaN(amount) || amount <= 0) return alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­');
  const date = new Date().toLocaleDateString();

  const ref = doc(db,'students',studentId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©');

  const data = snap.data();
  const subjects = data.subjects || [];
  if(!subjects[subIdx]) return alert('Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  if(!Array.isArray(subjects[subIdx].payments)) subjects[subIdx].payments = [];
  subjects[subIdx].payments.push({ amount, date });
  // update remaining if present
  if(typeof subjects[subIdx].remaining !== 'undefined') {
    subjects[subIdx].remaining = Math.max(0, (subjects[subIdx].remaining || 0) - amount);
  }

  await updateDoc(ref, { subjects });
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©');
  modal.classList.remove('open');
  await loadStudents();
}

/* ----------------- Open quick payment (from table)  ----------------- */
async function openPaymentPrompt(studentId){
  const amountStr = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¯ÙØ¹Ù‡ Ø§Ù„Ø¢Ù†:');
  if(!amountStr) return;
  const amount = parseFloat(amountStr);
  if(isNaN(amount) || amount <= 0) return alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­');
  const date = new Date().toLocaleDateString();

  // Simple: add one payment to the first subject that still has remaining > 0
  const ref = doc(db,'students',studentId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const data = snap.data();
  const subjects = data.subjects || [];
  let applied = false;
  for(let i=0;i<subjects.length;i++){
    const sub = subjects[i];
    const paid = (sub.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
    const rem = sub.remaining ?? Math.max(0,(sub.fee||0) - paid);
    if(rem > 0){
      if(!sub.payments) sub.payments = [];
      sub.payments.push({ amount, date });
      sub.remaining = Math.max(0, rem - amount);
      applied = true;
      break;
    }
  }
  if(!applied) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…ØªØ¨Ù‚ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨');
  await updateDoc(ref, { subjects });
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
  await loadStudents();
}

/* ----------------- Print student ----------------- */
async function printStudentById(id){
  const ref = doc(db,'students',id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const s = snap.data();

  // try load logo from settings/logo
  let logoUrl = null;
  try{
    const logoDoc = await getDoc(doc(db,'settings','logo'));
    if(logoDoc.exists()) logoUrl = logoDoc.data().url || null;
  }catch(e){ console.warn('logo fetch', e); }

  const rows = (s.subjects||[]).map(sub=>{
    const paid = (sub.payments||[]).reduce((a,p)=> a + (p.amount||0), 0);
    const remaining = sub.remaining ?? Math.max(0, (sub.fee||0) - paid);
    const teacherName = (teachers.find(t=>t.id === sub.teacherId)||{}).name || '-';
    const paymentsHtml = (sub.payments||[]).map(p=>`${p.date} â€” ${p.amount}`).join('<br>') || '-';
    return `<tr>
      <td style="border:1px solid #333;padding:8px">${escapeHtml(sub.name)}</td>
      <td style="border:1px solid #333;padding:8px">${escapeHtml(teacherName)}</td>
      <td style="border:1px solid #333;padding:8px">${sub.fee||0}</td>
      <td style="border:1px solid #333;padding:8px">${paid}</td>
      <td style="border:1px solid #333;padding:8px">${remaining}</td>
      <td style="border:1px solid #333;padding:8px">${paymentsHtml}</td>
    </tr>`;
  }).join('');

  const html = `
  <html lang="ar" dir="rtl"><head>
    <meta charset="utf-8">
    <title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø·Ø§Ù„Ø¨ - ${escapeHtml(s.name)}</title>
    <style>
      @page { size: A4; margin: 18mm; }
      body{font-family:'Cairo',sans-serif;color:#102027;direction:rtl}
      h1{color:#004aad;text-align:center}
      table{width:100%;border-collapse:collapse;margin-top:8px}
      th,td{border:1px solid #333;padding:8px;text-align:center}
      th{background:#004aad;color:#fff}
      .footer{margin-top:24px;text-align:right}
    </style>
  </head><body>
    ${logoUrl? `<div style="text-align:center;margin-bottom:12px"><img src="${logoUrl}" style="max-height:80px;object-fit:contain" /></div>` : ''}
    <h1>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø·Ø§Ù„Ø¨</h1>
    <table>
      <tr><th>Ø§Ù„Ø§Ø³Ù…</th><td>${escapeHtml(s.name)}</td><th>Ø§Ù„Ù‡Ø§ØªÙ</th><td>${escapeHtml(s.phone)}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><td>${escapeHtml(s.stage||'-')}</td><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><td>${escapeHtml(s.group||'-')}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><td>${escapeHtml(s.school||'-')}</td><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th><td>${escapeHtml(s.note||'-')}</td></tr>
    </table>

    <h2 style="color:#004aad">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h2>
    <table>
      <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>

    <div class="footer">
      <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString()}</p>
      <p>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨: ____________</p>
      <p>Ø®ØªÙ… Ø§Ù„Ù…Ø¹Ù‡Ø¯: ____________</p>
    </div>
  </body></html>
  `;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* print list (filtered by selects at top) */
printListBtn.addEventListener('click', async ()=>{
  // build list from current filters
  const fSub = filterSubject.value;
  const fTeach = filterTeacher.value;
  const fGroup = groupSelectTop.value || filterGroup.value;

  await loadStudents({ subject: fSub, teacher: fTeach, group: fGroup });
  // build print HTML
  const rows = Array.from(document.querySelectorAll('#studentsTable tbody tr')).map(tr=>`<tr><td>${tr.cells[0].innerHTML}</td><td>${tr.cells[1].innerHTML}</td><td>${tr.cells[2].innerHTML}</td><td>${tr.cells[3].innerHTML}</td></tr>`).join('');
  const html = `<html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ù‚Ø§Ø¦Ù…Ø© Ø·Ø¨Ø§Ø¹Ø©</title><style>body{font-family:Cairo, sans-serif}table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:8px;text-align:center}th{background:#004aad;color:#fff}</style></head><body><h1 style="text-align:center">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.print();
});

/* ----------------- Filters apply ----------------- */
applyFiltersBtn.addEventListener('click', ()=>{
  const filter = {
    subject: filterSubject.value || null,
    teacher: filterTeacher.value || null,
    group: filterGroup.value || null
  };
  loadStudents(filter);
});

/* ----------------- Helpers ----------------- */
function escapeHtml(s){ return (s===null||s===undefined)?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ----------------- Modal controls ----------------- */
closeModalBtn.addEventListener('click', ()=> modal.classList.remove('open'));

/* ----------------- Initial load of students (no filter) ----------------- */
async function loadStudentsInitial(){ await loadStudents(); }
loadStudentsInitial();

</script>
</body>
</html>