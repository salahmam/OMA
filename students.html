<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… OMA Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root {
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
* { box-sizing: border-box; }
body {
  font-family: 'Cairo', sans-serif;
  margin: 0;
  background: linear-gradient(180deg,var(--bg),#fff);
  color: #102027;
  direction: rtl;
}
header {
  background: linear-gradient(90deg,var(--primary),#007bff);
  color: #fff;
  padding: 18px 16px;
  text-align: center;
  font-size: 20px;
  font-weight: 700;
  position: relative;
  box-shadow: 0 3px 12px rgba(2,20,40,0.08);
}
.logout-btn {
  position: absolute;
  left: 15px;
  top: 15px;
  background: #ff5252;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}
.wrap { max-width: 1200px; margin: 22px auto; padding: 12px; }
.controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
.card {
  background: var(--card);
  border-radius: 10px;
  padding: 14px;
  box-shadow: 0 6px 18px rgba(6,20,30,0.06);
  flex: 1;
}
input[type="text"], input[type="tel"], input[type="number"], select, textarea {
  padding: 10px; border: 1px solid #d6dde9; border-radius: 8px; font-size: 15px; width: 100%;
}
.two { width: calc(50% - 6px); }
label { display: block; margin-bottom: 6px; font-size: 13px; color: #37474f; }
.btn {
  background: var(--primary); color: #fff; padding: 10px 14px; border: none;
  border-radius: 8px; cursor: pointer; font-weight: 700;
}
.btn.warn { background: #ff7043; }
.btn.ghost { background: transparent; color: var(--primary); border: 1px solid rgba(0,74,173,0.12); }
.btn.small { padding: 6px 8px; font-size: 13px; border-radius: 6px; }
.add-subj { display: inline-block; margin-top: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 12px; }
th, td {
  padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px;
}
th { background: var(--primary); color: #fff; }
.badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef6ff; color: var(--primary); font-weight: 700; }
@media (max-width:900px){
  .two { width: 100%; }
  .controls { flex-direction: column; align-items: stretch; }
}
.modal { position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal.open { display: flex; }
.modal .box { background: white; padding: 18px; border-radius: 10px; max-width: 720px; width: 94%; max-height: 90vh; overflow: auto; }
</style>
</head>
<body>
<header>
  Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
  <button id="logoutBtn" class="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="wrap">
  <div class="controls">
    <div style="flex:1" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div>
          <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
          <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." style="padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
          <button id="refreshBtn" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <form id="studentForm" style="margin-top:12px">
        <div class="form-grid" style="display:flex;flex-wrap:wrap;gap:10px;">
          <div class="two">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="name" type="text" required />
          </div>
          <div class="two">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <input id="phone" type="tel" required />
          </div>
          <div class="two">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="address" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
            <input id="school" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
            <input id="stage" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
            <input id="group" type="text" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" />
          </div>

          <div style="width:100%">
            <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
            <div id="subjectsContainer" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            <button id="addSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>

          <div class="two">
            <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
            <input id="totalFees" type="number" min="0" />
          </div>
          <div class="two">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <input id="note" type="text" />
          </div>
          <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
            <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
    </div>

    <table id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯</th><th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="modal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
// Firebase setup
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// Config
const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.firebasestorage.app",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0",
  measurementId: "G-QHPZG4JLB8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

// CRUD Ù„Ù„Ø·Ù„Ø§Ø¨
const studentForm = document.getElementById("studentForm");
const studentsTableBody = document.querySelector("#studentsTable tbody");
const subjectsContainer = document.getElementById("subjectsContainer");
const addSubjectBtn = document.getElementById("addSubjectBtn");

let studentsData = [];

addSubjectBtn.addEventListener("click", () => {
  const div = document.createElement("div");
  div.innerHTML = `
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subjName" required />
    <input type="text" placeholder="Ø§Ù„Ø£Ø³ØªØ§Ø°" class="subjTeacher" required />
    <button type="button" class="btn warn small removeSubjBtn">âŒ</button>
  `;
  subjectsContainer.appendChild(div);
  div.querySelector(".removeSubjBtn").addEventListener("click", () => div.remove());
});

studentForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = name.value.trim();
  const phone = phone.value.trim();
  const stage = stage.value.trim();
  const group = group.value.trim();
  const subjects = [];
  subjectsContainer.querySelectorAll("div").forEach((s) => {
    const subjName = s.querySelector(".subjName").value.trim();
    const subjTeacher = s.querySelector(".subjTeacher").value.trim();
    if (subjName) subjects.push({ subjName, subjTeacher });
  });
  await addDoc(collection(db, "students"), { name, phone, stage, group, subjects });
  loadStudents();
});

async function loadStudents() {
  const snapshot = await getDocs(collection(db, "students"));
  studentsTableBody.innerHTML = "";
  snapshot.forEach((d) => {
    const s = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.phone}</td>
      <td>${s.stage}</td>
      <td>${s.group}</td>
      <td>${(s.subjects||[]).map(x=>x.subjName).join(", ")}</td>
      <td><button class="btn small warn" onclick="deleteStudent('${d.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    `;
    studentsTableBody.appendChild(tr);
  });
}

window.deleteStudent = async (id) => {
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
    await deleteDoc(doc(db, "students", id));
    loadStudents();
  }
};

loadStudents();
</script>
</body>
</html>