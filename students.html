<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
body{
  font-family:'Cairo',sans-serif;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;
  direction:rtl;
  visibility:hidden;
}
header{
  background:var(--primary);
  color:#fff;
  padding:16px;
  text-align:center;
  font-weight:700;
}
.wrap{
  max-width:1200px;
  margin:20px auto;
  padding:12px;
}
.card{
  background:var(--card);
  border-radius:10px;
  padding:14px;
  box-shadow:0 6px 18px rgba(6,20,30,0.06);
  margin-bottom:14px;
}
.form-grid{display:flex;flex-wrap:wrap;gap:10px;}
input,select,textarea{
  padding:10px;
  border:1px solid #d6dde9;
  border-radius:8px;
  font-size:15px;
  width:100%;
}
.two{width:calc(50% - 6px);}
.btn{
  background:var(--primary);
  color:#fff;
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12);}
.btn.warn{background:#ff7043;}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px;}
.table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
th{background:var(--primary);color:#fff;}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700;}
.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:6px;}
.subject-row > *{flex:1;}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;}
.modal.open{display:flex;}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto;}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
  .print-page{box-shadow:none;margin:0;padding:0}
}
</style>
</head>
<body>
<header id="instituteName">â€”</header>
<div class="wrap">

<!-- Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <div>
      <strong>Ø£Ø¶Ù / Ø¹Ø¯Ù„ Ø·Ø§Ù„Ø¨</strong>
      <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center" class="no-print">
      <select id="stageSelectTop"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option></select>
      <select id="groupSelectTop"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option></select>
      <button id="printListBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button id="applyFiltersBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    </div>
  </div>

  <form id="studentForm" style="margin-top:12px">
    <div class="form-grid">
      <div class="two">
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input id="name" type="text" required />
      </div>
      <div class="two">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
        <input id="phone" type="tel" required />
      </div>
      <div class="two">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="address" type="text" />
      </div>
      <div class="two">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
        <input id="school" type="text" />
      </div>
      <div class="two">
        <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
        <select id="stageSelectForm"></select>
      </div>
      <div class="two">
        <label>Ø§Ù„ÙƒØ±ÙˆØ¨</label>
        <select id="groupSelectForm"></select>
      </div>

      <div style="width:100%">
        <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø«Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø«Ù… Ø§Ù„Ù‚Ø³Ø·)</label>
        <div id="subjectsContainer"></div>
        <div style="margin-top:8px">
          <button id="addSubjectBtn" type="button" class="btn ghost small">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
        </div>
      </div>

      <div class="two">
        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£Ùˆ Ø§Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹)</label>
        <input id="totalFees" type="number" min="0" />
      </div>
      <div class="two">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
        <input id="note" type="text" />
      </div>

      <input type="hidden" id="studentId">

      <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>
  </form>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap">
    <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
  </div>

  <table class="table" id="studentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯ / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <div>
        <button id="printStudentBtn" class="btn no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
        <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹ Oma0
const firebaseConfig = {
  apiKey: "AIzaSyEXAMPLE_Oma0",
  authDomain: "oma0-project.firebaseapp.com",
  projectId: "oma0-project",
  storageBucket: "oma0-project.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef123456"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Ø§Ù„Ø¹Ù†Ø§ØµØ±
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const studentForm = document.getElementById('studentForm');
const studentsTableBody = document.querySelector('#studentsTable tbody');
const totalCount = document.getElementById('totalCount');
const clearFormBtn = document.getElementById('clearFormBtn');
const stageSelectTop = document.getElementById('stageSelectTop');
const stageSelectForm = document.getElementById('stageSelectForm');
const groupSelectTop = document.getElementById('groupSelectTop');
const groupSelectForm = document.getElementById('groupSelectForm');
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const printStudentBtn = document.getElementById('printStudentBtn');
const printListBtn = document.getElementById('printListBtn');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const instituteNameHeader = document.getElementById('instituteName');

let studentsCache = [];
let teachers = [];
let instituteSettings = {};
let editingStudentId = null;

// Auth guard
onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href='login.html'; }
  else{
    document.body.style.visibility='visible';
    initPage();
  }
});

async function initPage(){
  await loadInstituteSettings();
  await loadTeachers();
  populateStagesAndGroups();
  await loadStudents();
}

// Load institute info
async function loadInstituteSettings(){
  try{
    const docSnap = await getDoc(doc(db,'settings','info'));
    if(docSnap.exists()){
      instituteSettings = docSnap.data();
      instituteNameHeader.textContent = instituteSettings.name || '';
      document.documentElement.style.setProperty('--primary', instituteSettings.primaryColor || '#004aad');
      document.documentElement.style.setProperty('--accent', instituteSettings.accentColor || '#ffcc33');
    }
  }catch(e){ console.error(e); }
}

// Load teachers
async function loadTeachers(){
  teachers = [];
  try{
    const snap = await getDocs(collection(db,'teachers'));
    snap.forEach(d=>teachers.push({id:d.id, ...d.data()}));
  }catch(e){ console.error(e); }
}

// Populate stages/groups
const STAGES = ["Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø¹Ù„Ù…ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ø¯Ø¨ÙŠ"];
const GROUPS = ["A","B","C","D","E","F","G","H"];
function populateStagesAndGroups(){
  STAGES.forEach(s=>{
    stageSelectTop.innerHTML += `<option value="${s}">${s}</option>`;
    stageSelectForm.innerHTML += `<option value="${s}">${s}</option>`;
  });
  GROUPS.forEach(g=>{
    groupSelectTop.innerHTML += `<option value="${g}">${g}</option>`;
    groupSelectForm.innerHTML += `<option value="${g}">${g}</option>`;
  });
}

// Add subject row
function createSubjectRow(data={}){
  const wrapper = document.createElement('div');
  wrapper.className='subject-row';
  const subjInp=document.createElement('input'); subjInp.placeholder='Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©'; subjInp.value=data.name||'';
  const teacherSel=document.createElement('select'); teacherSel.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`; teachers.forEach(t=>teacherSel.innerHTML+=`<option value="${t.id}" ${t.id===data.teacherId?'selected':''}>${t.name}</option>`);
  const feeInp=document.createElement('input'); feeInp.type='number'; feeInp.min=0; feeInp.placeholder='Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·'; feeInp.value=data.fee||0;
  const remInp=document.createElement('input'); remInp.type='number'; remInp.min=0; remInp.placeholder='Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'; remInp.value=data.remaining||feeInp.value;
  const payBtn=document.createElement('button'); payBtn.type='button'; payBtn.className='btn small'; payBtn.textContent='ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';
  const remSubBtn=document.createElement('button'); remSubBtn.type='button'; remSubBtn.className='btn warn small'; remSubBtn.textContent='âŒ';
  wrapper.payments = data.payments||[];

  payBtn.addEventListener('click',()=>{
    const amountStr=prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:');
    if(!amountStr) return;
    const amount=parseFloat(amountStr);
    if(isNaN(amount)||amount<=0){ alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
    const date=new Date().toLocaleDateString();
    wrapper.payments.push({amount,date});
    remInp.value=Math.max(0,(parseFloat(remInp.value)||0)-amount);
    alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${amount} Ø¨ØªØ§Ø±ÙŠØ® ${date}`);
  });

  remSubBtn.addEventListener('click',()=>wrapper.remove());

  wrapper.appendChild(subjInp);
  wrapper.appendChild(teacherSel);
  wrapper.appendChild(feeInp);
  wrapper.appendChild(remInp);
  wrapper.appendChild(payBtn);
  wrapper.appendChild(remSubBtn);

  subjectsContainer.appendChild(wrapper);
  return wrapper;
}

addSubjectBtn.addEventListener('click',()=>{ createSubjectRow(); });

// Save student (add / edit)
studentForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const school=document.getElementById('school').value.trim();
  const stage=document.getElementById('stageSelectForm').value;
  const group=document.getElementById('groupSelectForm').value;
  const totalFees=parseFloat(document.getElementById('totalFees').value)||0;
  const note=document.getElementById('note').value.trim();

  const subRows=Array.from(subjectsContainer.querySelectorAll('.subject-row'));
  const subjects=subRows.map(r=>{
    const inputs=r.querySelectorAll('input,select');
    const name=inputs[0].value.trim();
    const teacherId=inputs[1].value||'';
    const fee=parseFloat(inputs[2].value)||0;
    const remaining=parseFloat(inputs[3].value)||fee;
    const payments=r.payments||[];
    return {name,teacherId,fee,remaining,payments};
  }).filter(s=>s.name);

  if(!name||!phone){ alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'); return; }
  if(subjects.length===0){ alert('Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

  const computedTotal=subjects.reduce((a,s)=>a+(s.fee||0),0);
  const finalTotal=totalFees>0?totalFees:computedTotal;

  try{
    if(editingStudentId){
      await updateDoc(doc(db,'students',editingStudentId),{name,phone,address,school,stage,group,totalFees:finalTotal,note,subjects});
      alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    }else{
      await addDoc(collection(db,'students'),{name,phone,address,school,stage,group,totalFees:finalTotal,note,subjects,createdAt:new Date()});
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    }
    editingStudentId=null;
    studentForm.reset();
    subjectsContainer.innerHTML='';
    loadStudents();
  }catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
});

// Load students
async function loadStudents(){
  try{
    const q=query(collection(db,'students'),orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    studentsCache=[];
    studentsTableBody.innerHTML='';
    snap.forEach(d=>{
      const s={id:d.id,...d.data()};
      studentsCache.push(s);
      const tr=document.createElement('tr');
      const subjectsHtml=(s.subjects||[]).map(sub=>{
        const paid=(sub.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
        const remaining=sub.remaining??Math.max(0,(sub.fee||0)-paid);
        const teacherName=(teachers.find(t=>t.id===sub.teacherId)||{}).name||'-';
        return `${sub.name} â€” ${teacherName} <br> Ø¥Ø¬Ù…Ø§Ù„ÙŠ:${sub.fee} - Ù…Ø¯ÙÙˆØ¹:${paid} - Ù…ØªØ¨Ù‚ÙŠ:${remaining}`;
      }).join('<hr style="border:none;border-top:1px dashed #ddd;margin:8px 0">');
      tr.innerHTML=`<td>${s.name}</td><td>${s.phone}</td><td>${s.stage||'-'}</td><td>${s.group||'-'}</td><td>${subjectsHtml}</td>
      <td>
        <button class="btn small" data-id="${s.id}" data-action="view">ğŸ” Ø¹Ø±Ø¶</button>
        <button class="btn warn small" data-id="${s.id}" data-action="delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>`;
      studentsTableBody.appendChild(tr);
    });
    totalCount.innerText=studentsCache.length;

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø­Ø°Ù
    studentsTableBody.querySelectorAll('button').forEach(btn=>{
      const id=btn.dataset.id;
      const action=btn.dataset.action;
      if(action==='delete'){
        btn.onclick=async()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')){ await deleteDoc(doc(db,'students',id)); loadStudents(); } };
      } else if(action==='view'){
        const student=studentsCache.find(s=>s.id===id);
        if(student) openModal(student);
      }
    });

  }catch(e){ console.error(e); }
}

// ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function openModal(student){
  modal.classList.add('open');
  modalTitle.textContent = student.name;
  let html=`<div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${student.phone}</div>`;
  html+=`<div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${student.address||'-'}</div>`;
  html+=`<div><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${student.stage||'-'} | <strong>Ø§Ù„ÙƒØ±ÙˆØ¨:</strong> ${student.group||'-'}</div>`;
  html+=`<div><strong>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª:</strong></div>`;
  student.subjects.forEach((sub,i)=>{
    const paid=(sub.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
    const remaining=sub.remaining??Math.max(0,(sub.fee||0)-paid);
    html+=`<div style="margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px">
      <strong>${sub.name}</strong> â€” ${sub.fee} Ø¥Ø¬Ù…Ø§Ù„ÙŠ - ${paid} Ù…Ø¯ÙÙˆØ¹ - ${remaining} Ù…ØªØ¨Ù‚ÙŠ<br>
      <button onclick="addPayment('${student.id}',${i})" class="btn small">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
    </div>`;
  });
  modalBody.innerHTML = html;
}

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
window.addPayment=async(studentId,subIndex)=>{
  const amountStr=prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:');
  if(!amountStr) return;
  const amount=parseFloat(amountStr);
  if(isNaN(amount)||amount<=0){ alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
  const student=studentsCache.find(s=>s.id===studentId);
  if(!student) return;
  student.subjects[subIndex].payments=student.subjects[subIndex].payments||[];
  student.subjects[subIndex].payments.push({amount,date:new Date().toLocaleDateString()});
  student.subjects[subIndex].remaining=Math.max(0,(student.subjects[subIndex].remaining||student.subjects[subIndex].fee)-amount);
  await updateDoc(doc(db,'students',studentId),{subjects:student.subjects});
  loadStudents();
  openModal(student);
};

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
closeModalBtn.addEventListener('click',()=>modal.classList.remove('open'));

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
printStudentBtn.addEventListener('click',()=>{ window.print(); });
printListBtn.addEventListener('click',()=>{ window.print(); });

</script>
</body>
</html>