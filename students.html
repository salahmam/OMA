<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family:'Cairo',sans-serif;margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;direction:rtl;visibility:hidden;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;padding:18px;text-align:center;font-size:20px;
  display:flex;justify-content:space-between;align-items:center;
}
header button{background:#ff5555;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,0.06);}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
label{display:block;margin-bottom:4px;font-size:13px}
.btn{background:var(--primary);color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.btn.small{padding:6px 8px;font-size:13px}
.subject-item{border:1px solid #ccc;padding:8px;border-radius:8px;margin-bottom:8px}
.subject-fields{display:flex;flex-wrap:wrap;gap:8px}
.subject-fields>div{flex:1;min-width:120px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
th{background:var(--primary);color:#fff}
</style>
</head>
<body>
<header>
  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
  <button id="logoutBtn">ğŸ”“ Ø®Ø±ÙˆØ¬</button>
</header>

<div class="wrap">
  <div class="card">
    <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
    <form id="studentForm">
      <div class="form-grid">
        <div class="two">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" required>
        </div>
        <div class="two">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" type="tel" required>
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="school">
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <input id="stage">
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <input id="group">
        </div>
      </div>

      <h4>ğŸ“˜ Ø§Ù„Ù…ÙˆØ§Ø¯</h4>
      <div id="subjectsContainer"></div>
      <button id="addSubjectBtn" type="button" class="btn small">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>

      <div style="margin-top:10px;text-align:end">
        <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
    </form>
  </div>

  <div class="card" style="margin-top:20px">
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
    <table id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
          <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDt2HAOKr3iko8V-u392vh2R2my14km7ag",
  authDomain: "oma2-d36fa.firebaseapp.com",
  projectId: "oma2-d36fa",
  storageBucket: "oma2-d36fa.firebasestorage.app",
  messagingSenderId: "774171603105",
  appId: "1:774171603105:web:91f2a5f44c4dde684080e0",
  measurementId: "G-QHPZG4JLB8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    document.body.style.visibility = "visible";
    loadStudents();
  }
});

// ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
  window.location.href = "login.html";
});

// ğŸ§¾ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let teachersList = [];
async function loadTeachers() {
  const q = query(collection(db, "teachers"));
  const snap = await getDocs(q);
  teachersList = snap.docs.map(doc => doc.data().name);
}

// â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
const addSubjectBtn = document.getElementById("addSubjectBtn");
const subjectsContainer = document.getElementById("subjectsContainer");

addSubjectBtn.addEventListener("click", async () => {
  if (teachersList.length === 0) await loadTeachers();

  const div = document.createElement("div");
  div.classList.add("subject-item");
  div.innerHTML = `
    <div class="subject-fields">
      <div>
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input type="text" class="subject-name" required>
      </div>
      <div>
        <label>Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
        <select class="subject-teacher">
          ${teachersList.map(t => `<option value="${t}">${t}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·</label>
        <input type="number" min="0" class="subject-total" value="0">
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
        <input type="number" min="0" class="subject-paid" value="0">
      </div>
      <div>
        <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
        <input type="number" min="0" class="subject-remaining" value="0" readonly>
      </div>
    </div>
  `;

  const totalInput = div.querySelector(".subject-total");
  const paidInput = div.querySelector(".subject-paid");
  const remainingInput = div.querySelector(".subject-remaining");

  function updateRemaining() {
    const total = parseFloat(totalInput.value) || 0;
    const paid = parseFloat(paidInput.value) || 0;
    remainingInput.value = total - paid;
  }

  totalInput.addEventListener("input", updateRemaining);
  paidInput.addEventListener("input", updateRemaining);

  subjectsContainer.appendChild(div);
});

// ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨
const form = document.getElementById("studentForm");
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const school = document.getElementById("school").value;
  const stage = document.getElementById("stage").value;
  const group = document.getElementById("group").value;

  const subjects = Array.from(subjectsContainer.children).map(div => ({
    name: div.querySelector(".subject-name").value,
    teacher: div.querySelector(".subject-teacher").value,
    total: parseFloat(div.querySelector(".subject-total").value) || 0,
    paid: parseFloat(div.querySelector(".subject-paid").value) || 0,
    remaining: parseFloat(div.querySelector(".subject-remaining").value) || 0
  }));

  await addDoc(collection(db, "students"), {
    name, phone, school, stage, group, subjects
  });

  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
  form.reset();
  subjectsContainer.innerHTML = "";
  loadStudents();
});

// ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudents() {
  const q = query(collection(db, "students"));
  const snap = await getDocs(q);
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  snap.forEach(docSnap => {
    const s = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.phone}</td>
      <td>${s.stage || "-"}</td>
      <td>${s.group || "-"}</td>
      <td>${s.subjects ? s.subjects.length : 0}</td>
      <td><button class="btn small">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></td>
    `;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>