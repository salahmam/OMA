<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - OMA</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:var(--primary);color:#fff;text-align:center;padding:12px 0;font-size:1.4rem;}
.container{padding:15px;max-width:1200px;margin:auto;}
.card{background:var(--card);padding:15px;margin-bottom:15px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input,select,button,textarea{padding:6px 10px;margin:4px 2px;border:1px solid #ccc;border-radius:4px;font-size:0.95rem;}
button{cursor:pointer;background:var(--primary);color:#fff;border:none}
button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
button.warn{background:#ff4444;color:#fff;}
button.small{padding:3px 8px;font-size:0.8rem}
.subject-row{display:flex;gap:6px;margin-bottom:6px;align-items:center;}
#subjectsContainer{margin-top:8px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:0.9rem;}
th{background:var(--primary);color:#fff;}
#modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;}
#modal.open{display:flex;}
#modalContent{background:#fff;padding:15px;width:90%;max-width:700px;border-radius:6px;max-height:90%;overflow:auto;}
.close-btn{float:left;background:#ff4444;padding:2px 6px;border-radius:4px;font-size:0.9rem;}
.print-page{padding:10px;font-size:0.95rem;}
</style>
</head>
<body>
<header><span id="instituteName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯</span> - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</header>
<div class="container">

<div class="card">
  <h3>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h3>
  <form id="studentForm">
    <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required>
    <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
    <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <input type="text" id="school" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    <select id="stageSelectForm"></select>
    <select id="groupSelectForm"></select>
    <textarea id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
    <div id="subjectsContainer"></div>
    <button type="button" id="addSubjectBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
    <input type="number" id="totalFees" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·" readonly>
    <div style="margin-top:8px;">
      <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      <button type="button" id="clearFormBtn" class="ghost">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
    </div>
  </form>
</div>

<div class="card">
  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ <span id="totalCount"></span></h3>
  <div>
    <input type="text" id="searchBox" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…">
    <select id="filterStage"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option></select>
    <select id="filterGroup"><option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option></select>
    <select id="filterTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
    <select id="filterSubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
    <button id="applyFiltersBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    <button id="printListBtn" class="ghost">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
  </div>
  <table id="studentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<!-- Modal -->
<div id="modal">
  <div id="modalContent">
    <span class="close-btn" id="closeModal">âŒ Ø¥ØºÙ„Ø§Ù‚</span>
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
// -------- Firebase imports --------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// -------- Config --------
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// -------- Elements --------
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const studentForm = document.getElementById('studentForm');
const studentsTableBody = document.querySelector('#studentsTable tbody');
const totalCount = document.getElementById('totalCount');
const clearFormBtn = document.getElementById('clearFormBtn');
const filterSubject = document.getElementById('filterSubject');
const filterTeacher = document.getElementById('filterTeacher');
const filterGroup = document.getElementById('filterGroup');
const filterStage = document.getElementById('filterStage');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const printListBtn = document.getElementById('printListBtn');
const searchBox = document.getElementById('searchBox');
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const totalFeesInput = document.getElementById('totalFees');
const stageSelectForm = document.getElementById('stageSelectForm');
const groupSelectForm = document.getElementById('groupSelectForm');
const instituteNameHeader = document.getElementById('instituteName');

// -------- State --------
let teachers = [];
let studentsCache = [];
let settingsData = {};
const STAGES = ["Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø¹Ù„Ù…ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ø¯Ø¨ÙŠ"];
const GROUPS = ["A","B","C","D","E","F","G","H"];

// -------- Auth --------
onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href='login.html'; } 
  else{ document.body.style.visibility='visible'; initPage(); }
});

// -------- Initialization --------
async function initPage(){
  await loadSettings();
  populateStageGroup();
  await loadTeachers();
  await loadStudents();
  populateFilters();
}

// -------- Load settings --------
async function loadSettings(){
  try{
    const snap = await getDoc(doc(db,'settings','info'));
    if(snap.exists()){ settingsData = snap.data(); }
    if(settingsData.name) instituteNameHeader.textContent = settingsData.name;
    if(settingsData.colors){
      document.documentElement.style.setProperty('--primary', settingsData.colors.primary||'#004aad');
      document.documentElement.style.setProperty('--accent', settingsData.colors.accent||'#ffcc33');
      document.documentElement.style.setProperty('--bg', settingsData.colors.bg||'#f5f9ff');
      document.documentElement.style.setProperty('--card', settingsData.colors.card||'#fff');
    }
  }catch(e){ console.error('loadSettings',e); }
}

// -------- Stage/Group --------
function populateStageGroup(){
  STAGES.forEach(s=>{
    stageSelectForm.innerHTML+=`<option value="${s}">${s}</option>`;
    filterStage.innerHTML+=`<option value="${s}">${s}</option>`;
  });
  GROUPS.forEach(g=>{
    groupSelectForm.innerHTML+=`<option value="${g}">${g}</option>`;
    filterGroup.innerHTML+=`<option value="${g}">${g}</option>`;
  });
}

// -------- Load teachers --------
async function loadTeachers(){
  teachers = [];
  try{
    const snap = await getDocs(collection(db,'teachers'));
    snap.forEach(d=>teachers.push({id:d.id,...d.data()}));
    populateTeacherFilters();
  }catch(e){ console.error(e); }
}
function populateTeacherFilters(){
  filterTeacher.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>';
  teachers.forEach(t=>{ filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`; });
}

// -------- Subject row --------
function createSubjectRow(data={}){
  const wrapper = document.createElement('div'); wrapper.className='subject-row';
  const subjInp=document.createElement('input'); subjInp.placeholder='Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©'; subjInp.value=data.name||'';
  const teacherSel=document.createElement('select'); teacherSel.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`;
  teachers.forEach(t=>teacherSel.innerHTML+=`<option value="${t.id}" ${t.id===data.teacherId?'selected':''}>${t.name}</option>`);
  const feeInp=document.createElement('input'); feeInp.type='number'; feeInp.placeholder='Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·'; feeInp.min=0; feeInp.value=data.fee||0;
  const remInp=document.createElement('input'); remInp.type='number'; remInp.placeholder='Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'; remInp.min=0; remInp.value=data.remaining||0;
  const payBtn=document.createElement('button'); payBtn.type='button'; payBtn.className='btn small'; payBtn.textContent='ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';
  const remSubBtn=document.createElement('button'); remSubBtn.type='button'; remSubBtn.className='btn warn small'; remSubBtn.textContent='âŒ';
  wrapper.payments=Array.isArray(data.payments)?[...data.payments]:[];

  payBtn.addEventListener('click',()=>{
    const amountStr=prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:'); if(!amountStr)return;
    const amount=parseFloat(amountStr); if(isNaN(amount)||amount<=0){alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­');return;}
    const date=new Date().toLocaleDateString();
    wrapper.payments.push({amount,date});
    const curRem=parseFloat(remInp.value)||0; remInp.value=Math.max(0,curRem-amount);
    updateTotalFees();
    alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${amount} Ø¨ØªØ§Ø±ÙŠØ® ${date}`);
  });

  remSubBtn.addEventListener('click',()=>{ wrapper.remove(); updateTotalFees(); });

  wrapper.appendChild(subjInp); wrapper.appendChild(teacherSel); wrapper.appendChild(feeInp); wrapper.appendChild(remInp); wrapper.appendChild(payBtn); wrapper.appendChild(remSubBtn);
  [feeInp, remInp].forEach(inp=>inp.addEventListener('input',updateTotalFees));
  subjectsContainer.appendChild(wrapper);
  updateTotalFees();
  return wrapper;
}

addSubjectBtn.addEventListener('click',()=>{ if(teachers.length===0){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø© Ù…Ø³Ø¬Ù„ÙŠÙ†');return;} createSubjectRow(); });

// -------- Total fees --------
function updateTotalFees(){
  const rows=Array.from(subjectsContainer.querySelectorAll('.subject-row'));
  let sum=0; rows.forEach(r=>{ const f=parseFloat(r.querySelectorAll('input')[2].value)||0; sum+=f; }); totalFeesInput.value=sum;
}

// -------- Save student --------
studentForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const school=document.getElementById('school').value.trim();
  const stage=document.getElementById('stageSelectForm').value;
  const group=document.getElementById('groupSelectForm').value;
  const totalFees=parseFloat(totalFeesInput.value)||0;
  const note=document.getElementById('note').value.trim();
  const subRows=Array.from(subjectsContainer.querySelectorAll('.subject-row'));
  const subjects=subRows.map(r=>{
    const inputs=r.querySelectorAll('input,select'); return {
      name:inputs[0].value.trim(),
      teacherId:r.querySelector('select').value||'',
      fee:parseFloat(inputs[2].value)||0,
      remaining:parseFloat(inputs[3].value)||0,
      payments:r.payments||[]
    };
  }).filter(s=>s.name);
  if(!name||!phone){alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');return;}
  if(subjects.length===0){alert('Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return;}
  try{
    await addDoc(collection(db,'students'),{name,phone,address,school,stage,group,totalFees,note,subjects,createdAt:new Date()});
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    studentForm.reset(); subjectsContainer.innerHTML=''; updateTotalFees();
    loadStudents();
  }catch(e){console.error(e);alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');}
});

// -------- Load students --------
async function loadStudents(filter={}){
  try{
    const q=query(collection(db,'students'),orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    studentsCache=[]; studentsTableBody.innerHTML='';
    snap.forEach(d=>{ studentsCache.push({id:d.id,...d.data()}); });
    renderStudentsTable(filter);
  }catch(e){console.error(e);}
}

// -------- Render table --------
function renderStudentsTable(filter){
  studentsTableBody.innerHTML='';
  let filtered=studentsCache;
  if(filter.name) filtered=filtered.filter(s=>s.name.includes(filter.name));
  if(filter.stage) filtered=filtered.filter(s=>s.stage===filter.stage);
  if(filter.group) filtered=filtered.filter(s=>s.group===filter.group);
  if(filter.subjectId) filtered=filtered.filter(s=>s.subjects.some(sub=>sub.name===filter.subjectId));
  if(filter.teacherId) filtered=filtered.filter(s=>s.subjects.some(sub=>sub.teacherId===filter.teacherId));
  filtered.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td>
      <td>${s.phone}</td>
      <td>${s.stage}</td>
      <td>${s.group}</td>
      <td>${s.subjects.map(sub=>`${sub.name} (${sub.remaining})`).join('<br>')}</td>
      <td>
        <button class="btn small" onclick="showStudent('${s.id}')">Ø¹Ø±Ø¶</button>
        <button class="btn small ghost" onclick="editStudent('${s.id}')">âœï¸</button>
        <button class="btn small warn" onclick="deleteStudent('${s.id}')">ğŸ—‘ï¸</button>
      </td>`;
    studentsTableBody.appendChild(tr);
  });
  totalCount.textContent=filtered.length;
}

// -------- Show student modal --------
window.showStudent=async function(id){
  const s=studentsCache.find(st=>st.id===id); if(!s)return;
  modalTitle.textContent=`Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${s.name}`;
  let html=`<div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${s.phone} | <strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${s.stage} | <strong>Ø§Ù„ÙƒØ±ÙˆØ¨:</strong> ${s.group} | <strong>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> ${s.school}</div>`;
  html+=`<hr><div><strong>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª:</strong><br>`;
  s.subjects.forEach((sub,i)=>{
    html+=`<div style="margin-bottom:6px"><strong>${sub.name}</strong> - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${sub.remaining} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sub.fee} <button class="btn small" onclick="addPayment('${id}',${i})">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button></div>`;
  });
  html+=`</div><hr><div><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${s.note||'-'}</div>`;
  modalBody.innerHTML=html; modal.classList.add('open');
};
closeModalBtn.addEventListener('click',()=>modal.classList.remove('open'));

// -------- Add payment inside modal --------
window.addPayment=async function(studentId,subIndex){
  const s=studentsCache.find(st=>st.id===studentId); if(!s)return;
  const amountStr=prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©'); if(!amountStr)return;
  const amount=parseFloat(amountStr); if(isNaN(amount)||amount<=0){alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­');return;}
  const date=new Date().toLocaleDateString();
  s.subjects[subIndex].payments.push({amount,date});
  s.subjects[subIndex].remaining=Math.max(0,s.subjects[subIndex].remaining-amount);
  await updateDoc(doc(db,'students',studentId),{subjects:s.subjects});
  alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©'); loadStudents();
  showStudent(studentId);
};

// -------- Edit student --------
window.editStudent=async function(id){
  const s=studentsCache.find(st=>st.id===id); if(!s)return;
  document.getElementById('name').value=s.name;
  document.getElementById('phone').value=s.phone;
  document.getElementById('address').value=s.address;
  document.getElementById('school').value=s.school;
  stageSelectForm.value=s.stage; groupSelectForm.value=s.group;
  subjectsContainer.innerHTML=''; s.subjects.forEach(sub=>createSubjectRow(sub));
  totalFeesInput.value=s.totalFees;
};

// -------- Delete student --------
window.deleteStudent=async function(id){
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')){ await deleteDoc(doc(db,'students',id)); loadStudents(); }
};

// -------- Filters --------
applyFiltersBtn.addEventListener('click',()=>{
  const filter={name:searchBox.value,stage:filterStage.value,group:filterGroup.value,subjectId:filterSubject.value,teacherId:filterTeacher.value};
  renderStudentsTable(filter);
});

// -------- Print list --------
printListBtn.addEventListener('click',()=>{
  const filter={name:searchBox.value,stage:filterStage.value,group:filterGroup.value,subjectId:filterSubject.value,teacherId:filterTeacher.value};
  const filtered=studentsCache.filter(s=>{
    if(filter.name && !s.name.includes(filter.name)) return false;
    if(filter.stage && s.stage!==filter.stage) return false;
    if(filter.group && s.group!==filter.group) return false;
    if(filter.subjectId && !s.subjects.some(sub=>sub.name===filter.subjectId)) return false;
    if(filter.teacherId && !s.subjects.some(sub=>sub.teacherId===filter.teacherId)) return false;
    return true;
  });
  let html=`<div class="print-page"><h2>${settingsData.name||''} - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2><hr>`;
  filtered.forEach(s=>{ html+=`<div><strong>${s.name}</strong> | ${s.phone} | ${s.stage} | ${s.group}<br>${s.subjects.map(sub=>`${sub.name} (${sub.remaining})`).join(' | ')}</div><hr>`; });
  const w=window.open('','','width=900,height=700'); w.document.write(html); w.print();
});

// -------- Clear form --------
clearFormBtn.addEventListener('click',()=>{ studentForm.reset(); subjectsContainer.innerHTML=''; totalFeesInput.value=0; });

</script>
</body>
</html>