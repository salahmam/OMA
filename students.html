<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family: 'Cairo',sans-serif;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;
  direction:rtl;
  visibility:hidden; /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠ Ù…Ø¤Ù‚ØªÙ‹Ø§ */
}
/* ... Ø¨Ø§Ù‚ÙŠ CSS ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ... */
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…ØªØ·ÙˆØ±)</header>
<div class="wrap">
<!-- Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ -->
</div>

<script type="module">
import { initializeApp } from "./firebase-config.js"; // Ù…Ù„ÙÙƒ
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Firebase
const app = initializeApp;
const auth = getAuth(app);
const db = getFirestore(app);

// ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html"; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  } else {
    document.body.style.visibility = "visible"; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
    initPage(); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© (Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  }
});

function initPage() {
  // âš¡ Ù‡Ù†Ø§ Ø¶Ø¹ ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø¥Ø¶Ø§ÙØ©ØŒ Ø­ÙØ¸ØŒ Ø¹Ø±Ø¶ØŒ Ø­Ø°ÙØŒ Ø·Ø¨Ø§Ø¹Ø© ...
  const studentForm = document.getElementById("studentForm");
  const studentsTableBody = document.querySelector("#studentsTable tbody");
  const subjectsContainer = document.getElementById("subjectsContainer");
  const addSubjectBtn = document.getElementById("addSubjectBtn");

  let studentsData = [];

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
  addSubjectBtn.addEventListener("click",()=>{
    const div = document.createElement("div");
    div.classList.add("subject-field");
    div.style.display="flex"; div.style.gap="6px"; div.style.alignItems="center";
    div.innerHTML = `
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subjName" required />
      <input type="text" placeholder="Ø§Ù„Ø£Ø³ØªØ§Ø°" class="subjTeacher" required />
      <input type="number" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·" class="subjFee" min="0" />
      <input type="number" placeholder="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" class="subjRemaining" min="0" />
      <button type="button" class="btn small addPaymentBtn">ğŸ’° Ø¯ÙØ¹</button>
      <button type="button" class="btn warn small removeSubjBtn">âŒ</button>
    `;
    subjectsContainer.appendChild(div);

    div.querySelector(".removeSubjBtn").addEventListener("click",()=>{subjectsContainer.removeChild(div);});

    div.querySelector(".addPaymentBtn").addEventListener("click",()=>{
      const payment = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:");
      if(payment && !isNaN(payment)){
        const date = new Date().toLocaleDateString();
        const remainingInput = div.querySelector(".subjRemaining");
        const currentRemaining = parseFloat(remainingInput.value)||0;
        const newRemaining = currentRemaining - parseFloat(payment);
        remainingInput.value = newRemaining>=0?newRemaining:0;

        if(!div.payments) div.payments=[];
        div.payments.push({amount:parseFloat(payment),date});
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©: "+payment+" Ø¨ØªØ§Ø±ÙŠØ® "+date);
      }
    });
  });

  // Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨
  studentForm.addEventListener("submit", async(e)=>{
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    const school = document.getElementById("school").value.trim();
    const stage = document.getElementById("stage").value.trim();
    const group = document.getElementById("group").value.trim();
    const totalFees = parseFloat(document.getElementById("totalFees").value)||0;
    const note = document.getElementById("note").value.trim();

    const subjects = [];
    document.querySelectorAll(".subject-field").forEach(sub=>{
      const subjName = sub.querySelector(".subjName").value.trim();
      const subjTeacher = sub.querySelector(".subjTeacher").value.trim();
      const subjFee = parseFloat(sub.querySelector(".subjFee").value)||0;
      const subjRemaining = parseFloat(sub.querySelector(".subjRemaining").value)||0;
      const payments = sub.payments || [];
      if(subjName && subjTeacher){
        subjects.push({name:subjName,teacher:subjTeacher,fee:subjFee,remaining:subjRemaining,payments});
      }
    });

    if(subjects.length===0){ alert("Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}

    try{
      await addDoc(collection(db,"students"),{name,phone,address,school,stage,group,totalFees,note,subjects,createdAt:new Date()});
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      studentForm.reset();
      subjectsContainer.innerHTML="";
      loadStudents();
    }catch(err){console.error(err);alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
  async function loadStudents(){
    const snapshot = await getDocs(collection(db,"students"));
    studentsTableBody.innerHTML="";
    studentsData = [];
    snapshot.forEach(docSnap=>{
      const student = {...docSnap.data(),id:docSnap.id};
      studentsData.push(student);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="checkbox selectStudent" data-id="${student.id}"/></td>
        <td>${student.name}</td>
        <td>${student.phone}</td>
        <td>${student.stage}</td>
        <td>${student.group}</td>
        <td>${student.subjects.map(s=>s.name).join(", ")}</td>
        <td>${student.subjects.map(s=>"Ø¥Ø¬Ù…Ø§Ù„ÙŠ:"+s.fee+" / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:"+s.remaining).join("<br>")}</td>
        <td>${student.subjects.map(s=>"Ø§Ù„Ù…Ø¹Ù„Ù…: "+s.teacher+"<br>"+s.payments.map(p=>p.amount+" Ø¨ØªØ§Ø±ÙŠØ® "+p.date).join("<br>")).join("<hr>")}</td>
        <td class="actions">
          <button class="btn small" onclick="showStudent('${student.id}')">ğŸ” Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
          <button class="btn warn small" onclick="deleteStudent('${student.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      `;
      studentsTableBody.appendChild(tr);
    });
    document.getElementById("totalCount").innerText=studentsData.length;
  }
  loadStudents();

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ø«Ù„ deleteStudentØŒ showStudentØŒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ…Ø§ Ù‡ÙŠ...
}
</script>
</body>
</html>