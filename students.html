<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<style>
:root{
  --primary:#004aad; 
  --accent:#ffcc33; 
  --bg:#f5f9ff; 
  --card:#fff;
}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;background:var(--bg);color:#102027;direction:rtl;visibility:hidden;}
header{background:var(--primary);color:#fff;padding:16px;text-align:center;font-weight:700;}
.wrap{max-width:1200px;margin:20px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);margin-bottom:14px;}
.form-grid{display:flex;flex-wrap:wrap;gap:10px}
input,select,textarea{padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;}
.two{width:calc(50% - 6px)}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
.btn.warn{background:#ff7043}
.btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.subject-row > *{flex:1}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.modal .box{background:white;padding:18px;border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto}
@media print{
  body{background:white}
  header,.controls,.btn,.modal,.no-print{display:none !important}
  .print-page{box-shadow:none;margin:0;padding:0}
}
</style>
</head>
<body>
<header id="headerTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</header>
<div class="wrap">

  <!-- Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
        <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center" class="no-print">
        <select id="stageSelect" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
        </select>
        <select id="groupSelectTop" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØ¨</option>
        </select>
        <button id="printListBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

    <form id="studentForm" style="margin-top:12px">
      <div class="form-grid">
        <div class="two">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="name" type="text" required />
        </div>
        <div class="two">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
          <input id="phone" type="tel" required />
        </div>
        <div class="two">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="address" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="school" type="text" />
        </div>
        <div class="two">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <select id="stageSelectForm"></select>
        </div>
        <div class="two">
          <label>Ø§Ù„ÙƒØ±ÙˆØ¨</label>
          <select id="groupSelectForm"></select>
        </div>

        <div style="width:100%">
          <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø«Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø«Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·)</label>
          <div id="subjectsContainer"></div>
          <div style="margin-top:8px">
            <button id="addSubjectBtn" type="button" class="btn ghost small">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>
        </div>

        <div class="two">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯)</label>
          <input id="totalFees" type="number" min="0" readonly />
        </div>
        <div class="two">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="note" type="text" />
        </div>

        <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
          <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
      <div style="display:flex;gap:8px;align-items:center" class="no-print">
        <input id="searchStudent" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." style="padding:8px;border-radius:8px;border:1px solid #e0e6ef"/>
        <select id="filterSubject"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
        <select id="filterTeacher"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option></select>
        <select id="filterStage"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option></select>
        <select id="filterGroup"><option value="">ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</option></select>
        <button id="applyFiltersBtn" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
    </div>

    <table class="table" id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯ / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <div>
        <button id="printStudentBtn" class="btn no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
        <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy, where 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.appspot.com",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const headerTitle = document.getElementById('headerTitle');
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const studentForm = document.getElementById('studentForm');
const studentsTableBody = document.querySelector('#studentsTable tbody');
const totalCount = document.getElementById('totalCount');
const clearFormBtn = document.getElementById('clearFormBtn');

const filterSubject = document.getElementById('filterSubject');
const filterTeacher = document.getElementById('filterTeacher');
const filterStage = document.getElementById('filterStage');
const filterGroup = document.getElementById('filterGroup');
const applyFiltersBtn = document.getElementById('applyFiltersBtn');
const printListBtn = document.getElementById('printListBtn');
const searchStudent = document.getElementById('searchStudent');

const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const printStudentBtn = document.getElementById('printStudentBtn');

const stageSelect = document.getElementById('stageSelect');
const stageSelectForm = document.getElementById('stageSelectForm');
const groupSelectTop = document.getElementById('groupSelectTop');
const groupSelectForm = document.getElementById('groupSelectForm');

/* State */
let teachers = [];
let studentsCache = [];
let instituteSettings = { name:'', primary:'#004aad', accent:'#ffcc33' };
const STAGES = [
  "Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)","Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø¹Ù„Ù…ÙŠ",
  "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ø¯Ø¨ÙŠ"
];
const GROUPS = ["A","B","C","D","E","F","G","H"];

/* Auth guard */
onAuthStateChanged(auth, user=>{
  if(!user) window.location.href='login.html';
  else {
    document.body.style.visibility='visible';
    initPage();
  }
});

/* Init page */
async function initPage(){
  await loadSettings();
  applySettingsColors();
  STAGES.forEach(s=>{
    stageSelect.innerHTML+=`<option value="${s}">${s}</option>`;
    stageSelectForm.innerHTML+=`<option value="${s}">${s}</option>`;
    filterStage.innerHTML+=`<option value="${s}">${s}</option>`;
  });
  GROUPS.forEach(g=>{
    groupSelectTop.innerHTML+=`<option value="${g}">${g}</option>`;
    groupSelectForm.innerHTML+=`<option value="${g}">${g}</option>`;
    filterGroup.innerHTML+=`<option value="${g}">${g}</option>`;
  });
  await loadTeachers();
  await loadStudents();
  populateFilters();
}

/* Load institute settings */
async function loadSettings(){
  try{
    const docSnap = await getDoc(doc(db,'settings','institute'));
    if(docSnap.exists()) instituteSettings = docSnap.data();
    headerTitle.textContent = instituteSettings.name || 'Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨';
  } catch(e){ console.warn(e); }
}

/* Apply institute colors */
function applySettingsColors(){
  document.documentElement.style.setProperty('--primary', instituteSettings.primary || '#004aad');
  document.documentElement.style.setProperty('--accent', instituteSettings.accent || '#ffcc33');
}

/* Load teachers */
async function loadTeachers(){
  teachers = [];
  try{
    const snap = await getDocs(collection(db,'teachers'));
    snap.forEach(d=>teachers.push({ id:d.id, ...d.data() }));
  }catch(e){ console.error(e); }
}

/* Subject row creation */
function createSubjectRow(data={}){
  const wrapper = document.createElement('div');
  wrapper.className='subject-row';
  const subjInp = document.createElement('input'); subjInp.placeholder='Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©'; subjInp.value=data.name||'';
  const teacherSel = document.createElement('select'); teacherSel.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`;
  teachers.forEach(t=>teacherSel.innerHTML+=`<option value="${t.id}" ${t.id===data.teacherId?'selected':''}>${t.name}</option>`);
  const feeInp = document.createElement('input'); feeInp.type='number'; feeInp.placeholder='Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·'; feeInp.min=0; feeInp.value=data.fee||0;
  const remInp = document.createElement('input'); remInp.type='number'; remInp.placeholder='Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'; remInp.min=0; remInp.value=data.remaining||0; remInp.readOnly=true;
  const payBtn=document.createElement('button'); payBtn.type='button'; payBtn.className='btn small'; payBtn.textContent='ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';
  const remSubBtn=document.createElement('button'); remSubBtn.type='button'; remSubBtn.className='btn warn small'; remSubBtn.textContent='âŒ';
  wrapper.payments=Array.isArray(data.payments)?[...data.payments]:[];
  function updateRemaining(){ const val=parseFloat(feeInp.value)||0; const paid=wrapper.payments.reduce((a,p)=>a+p.amount,0); remInp.value=Math.max(0,val-paid); updateTotalFees(); }
  feeInp.addEventListener('input',updateRemaining);
  payBtn.addEventListener('click',async ()=>{
    const amount=parseFloat(prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:')); if(isNaN(amount)||amount<=0)return alert('Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­');
    wrapper.payments.push({ amount, date:new Date().toLocaleDateString() }); updateRemaining(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©');
  });
  remSubBtn.addEventListener('click',()=>{ wrapper.remove(); updateTotalFees(); });
  wrapper.append(subjInp,teacherSel,feeInp,remInp,payBtn,remSubBtn);
  subjectsContainer.appendChild(wrapper);
  updateRemaining();
  return wrapper;
}
addSubjectBtn.addEventListener('click',()=>{ if(teachers.length===0)return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø©'); createSubjectRow(); });

/* Update total fees */
function updateTotalFees(){
  const rows = Array.from(subjectsContainer.querySelectorAll('.subject-row'));
  const total = rows.reduce((sum,r)=>sum+(parseFloat(r.querySelector('input[type=number]').value)||0),0);
  document.getElementById('totalFees').value=total;
}

/* Save student */
studentForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const school=document.getElementById('school').value.trim();
  const stage=document.getElementById('stageSelectForm').value;
  const group=document.getElementById('groupSelectForm').value;
  const note=document.getElementById('note').value.trim();
  const subjects = Array.from(subjectsContainer.querySelectorAll('.subject-row')).map(r=>{
    const [nameInp, teacherSel, feeInp, remInp]=r.querySelectorAll('input,select'); 
    return { name:nameInp.value, teacherId:teacherSel.value, fee:parseFloat(feeInp.value)||0, remaining:parseFloat(remInp.value)||0, payments:r.payments||[] };
  }).filter(s=>s.name);
  if(!name||!phone) return alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨'); 
  if(subjects.length===0) return alert('Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  try{
    await addDoc(collection(db,'students'),{name,phone,address,school,stage,group,note,subjects,createdAt:new Date()});
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨');
    studentForm.reset(); subjectsContainer.innerHTML=''; updateTotalFees(); loadStudents();
  }catch(e){console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');}
});

/* Load students */
async function loadStudents(filter={}){
  const q = query(collection(db,'students'), orderBy('createdAt','desc'));
  const snap = await getDocs(q);
  studentsCache=[]; studentsTableBody.innerHTML='';
  snap.forEach(d=>studentsCache.push({id:d.id,...d.data()}));
  let filtered=studentsCache;
  if(filter.subject) filtered=filtered.filter(st=>st.subjects.some(s=>s.name===filter.subject));
  if(filter.teacher) filtered=filtered.filter(st=>st.subjects.some(s=>s.teacherId===filter.teacher));
  if(filter.stage) filtered=filtered.filter(st=>st.stage===filter.stage);
  if(filter.group) filtered=filtered.filter(st=>st.group===filter.group);
  if(searchStudent.value) filtered=filtered.filter(st=>st.name.includes(searchStudent.value)||st.phone.includes(searchStudent.value));
  filtered.forEach(st=>{
    const tr=document.createElement('tr');
    const subjHtml = st.subjects.map(s=>`${s.name} (${s.remaining})`).join(' | ');
    tr.innerHTML=`<td>${st.name}</td><td>${st.phone}</td><td>${st.stage}</td><td>${st.group}</td><td>${subjHtml}</td>
    <td>
      <button class="btn small" data-id="${st.id}" data-action="view">Ø¹Ø±Ø¶</button>
      <button class="btn ghost small" data-id="${st.id}" data-action="edit">ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn warn small" data-id="${st.id}" data-action="delete">Ø­Ø°Ù</button>
    </td>`;
    studentsTableBody.appendChild(tr);
  });
  totalCount.textContent=filtered.length;
}

/* Apply filters */
applyFiltersBtn.addEventListener('click',()=>{ loadStudents({
  subject:filterSubject.value,
  teacher:filterTeacher.value,
  stage:filterStage.value,
  group:filterGroup.value
})});
searchStudent.addEventListener('input',()=>loadStudents());

/* Populate filters dropdown */
function populateFilters(){
  teachers.forEach(t=>{
    filterTeacher.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });
  let subjectsSet=new Set();
  studentsCache.forEach(s=>s.subjects.forEach(sub=>subjectsSet.add(sub.name)));
  subjectsSet.forEach(sub=>filterSubject.innerHTML+=`<option value="${sub}">${sub}</option>`);
}

/* Table buttons (view/edit/delete) */
studentsTableBody.addEventListener('click',async e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id; const action=btn.dataset.action;
  if(action==='view'){ openModal(id); }
  else if(action==='delete'){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')){ await deleteDoc(doc(db,'students',id)); loadStudents(); } }
  else if(action==='edit'){ editStudent(id); }
});

/* Clear form */
clearFormBtn.addEventListener('click',()=>{ studentForm.reset(); subjectsContainer.innerHTML=''; updateTotalFees(); });

/* Modal */
closeModalBtn.addEventListener('click',()=>modal.classList.remove('open'));
function openModal(id){
  const st = studentsCache.find(s=>s.id===id);
  if(!st) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  modalTitle.textContent = st.name;
  modalBody.innerHTML = `<div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${st.phone}</div>
  <div><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${st.stage}</div>
  <div><strong>Ø§Ù„ÙƒØ±ÙˆØ¨:</strong> ${st.group}</div>
  <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${st.address}</div>
  <div><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${st.note}</div>
  <hr>
  <div><strong>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª:</strong></div>
  ${st.subjects.map(s=>`<div style="margin-bottom:6px;"><strong>${s.name}</strong> - Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${s.fee-s.remaining} / ${s.fee}<br>Ø§Ù„Ø¯ÙØ¹Ø§Øª: ${s.payments.map(p=>p.amount+'('+p.date+')').join(', ') || 'Ù„Ø§ ØªÙˆØ¬Ø¯'} </div>`).join('')}`;
  modal.classList.add('open');
}
printStudentBtn.addEventListener('click',()=>{ window.print(); });
printListBtn.addEventListener('click',()=>{ window.print(); });

/* Edit student */
async function editStudent(id){
  const st = studentsCache.find(s=>s.id===id); if(!st) return;
  document.getElementById('name').value = st.name;
  document.getElementById('phone').value = st.phone;
  document.getElementById('address').value = st.address;
  document.getElementById('school').value = st.school;
  stageSelectForm.value = st.stage;
  groupSelectForm.value = st.group;
  document.getElementById('note').value = st.note;
  subjectsContainer.innerHTML='';
  st.subjects.forEach(sub=>createSubjectRow(sub));
  updateTotalFees();
  // Update submit to edit
  studentForm.onsubmit=async e=>{
    e.preventDefault();
    const name=document.getElementById('name').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const address=document.getElementById('address').value.trim();
    const school=document.getElementById('school').value.trim();
    const stage=stageSelectForm.value;
    const group=groupSelectForm.value;
    const note=document.getElementById('note').value.trim();
    const subjects = Array.from(subjectsContainer.querySelectorAll('.subject-row')).map(r=>{
      const [nameInp, teacherSel, feeInp, remInp]=r.querySelectorAll('input,select'); 
      return { name:nameInp.value, teacherId:teacherSel.value, fee:parseFloat(feeInp.value)||0, remaining:parseFloat(remInp.value)||0, payments:r.payments||[] };
    }).filter(s=>s.name);
    if(!name||!phone) return alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨'); 
    if(subjects.length===0) return alert('Ø£Ø¶Ù Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    try{
      await updateDoc(doc(db,'students',id),{name,phone,address,school,stage,group,note,subjects});
      alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨');
      studentForm.reset(); subjectsContainer.innerHTML=''; updateTotalFees(); loadStudents();
      studentForm.onsubmit = defaultSubmit;
    }catch(e){console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');}
  };
}

/* Default submit handler */
const defaultSubmit = studentForm.onsubmit;
</script>
</body>
</html>