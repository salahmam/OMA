<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… OMA - Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…</title>
<style>
:root{
  --primary:#004aad;
  --accent:#ffcc33;
  --bg:#f5f9ff;
  --card:#fff;
}
*{box-sizing:border-box}
body{
  font-family: 'Cairo',sans-serif;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#102027;
}
header{
  background:linear-gradient(90deg,var(--primary),#007bff);
  color:#fff;padding:18px 16px;text-align:center;font-size:20px;font-weight:700;
  box-shadow:0 3px 12px rgba(2,20,40,0.08);
}
.wrap{max-width:1200px;margin:22px auto;padding:12px;}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.btn{background:var(--primary);color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:700}
.btn.warn{background:#ff7043}
.btn.small{padding:4px 8px;font-size:12px;border-radius:6px}
@media print{
  body{background:white;padding:0}
  header, .btn, .actions, .filters { display:none !important; }
  .print-page{box-shadow:none;margin:0;padding:0}
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…</header>
<div class="wrap">

<div class="card">
  <strong>Ù‚Ø§Ø¦Ù…Ø© Ø­ØµØµ Ø§Ù„Ù…Ø¹Ù„Ù…</strong>
  <table id="lessonsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø¯Ø±Ø³</th>
        <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
        <th>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_HERE",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
const currentTeacherId = "TEACHER_ID_HERE";

const lessonsTableBody = document.querySelector("#lessonsTable tbody");
let studentsData = [];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudents(){
  const snapshot = await getDocs(collection(db,"students"));
  studentsData = [];
  snapshot.forEach(docSnap=>{
    const s = {...docSnap.data(),id:docSnap.id};
    studentsData.push(s);
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø­ØµØµ Ø§Ù„Ù…Ø¹Ù„Ù…
async function loadLessons(){
  const snapshot = await getDocs(collection(db,"lessons"));
  lessonsTableBody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const l = {...docSnap.data(),id:docSnap.id};
    if(l.teacherId!==currentTeacherId) return; // ÙÙ‚Ø· Ø­ØµØµ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const studentsInGroup = studentsData.filter(s=>s.stage===l.stage && s.group===l.group);
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${l.name}</td>
      <td>${l.stage}</td>
      <td>${l.group}</td>
      <td>${l.day}</td>
      <td>${l.time}</td>
      <td><button class="btn small" onclick="toggleAttendance('${l.id}')">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button></td>
      <td><button class="btn small" onclick="printAttendance('${l.id}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button></td>
    `;
    lessonsTableBody.appendChild(tr);
  });
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨
window.toggleAttendance = async function(lessonId){
  const lessonDocRef = doc(db,"lessons",lessonId);
  const lessonSnap = await getDocs(collection(db,"lessons"));
  const lessonDoc = lessonSnap.docs.find(d=>d.id===lessonId);
  const lessonData = {...lessonDoc.data(),id:lessonDoc.id};
  const studentsInGroup = studentsData.filter(s=>s.stage===lessonData.stage && s.group===lessonData.group);

  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±/Ø§Ù„ØºØ§Ø¦Ø¨
  const attendance = lessonData.attendance || [];
  for(const s of studentsInGroup){
    const index = attendance.indexOf(s.id);
    if(index===-1){attendance.push(s.id);} // Ø­Ø¶Ø±
    else{attendance.splice(index,1);} // ØºØ§Ø¦Ø¨
  }
  await updateDoc(lessonDocRef,{attendance});
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨");
}

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©
window.printAttendance = async function(lessonId){
  const lessonSnap = await getDocs(collection(db,"lessons"));
  const lessonDoc = lessonSnap.docs.find(d=>d.id===lessonId);
  const lessonData = {...lessonDoc.data(),id:lessonDoc.id};
  const studentsInGroup = studentsData.filter(s=>s.stage===lessonData.stage && s.group===lessonData.group);

  const attendance = lessonData.attendance || [];
  let html = `<div class="print-page" style="padding:20px;font-size:14px">
    <h2>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨</h2>
    <p><b>Ø§Ù„Ù…Ø¹Ù„Ù…:</b> Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <p><b>Ø§Ù„Ø¯Ø±Ø³:</b> ${lessonData.name}</p>
    <p><b>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</b> ${lessonData.stage}</p>
    <p><b>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> ${lessonData.group}</p>
    <p><b>Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª:</b> ${lessonData.day} - ${lessonData.time}</p>
    <table border="1" cellspacing="0" cellpadding="6" style="width:100%;margin-top:10px">
      <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨</th></tr>
      ${studentsInGroup.map(s=>`<tr><td>${s.name}</td><td>${attendance.includes(s.id)?'Ø­Ø§Ø¶Ø±':'ØºØ§Ø¦Ø¨'}</td></tr>`).join("")}
    </table>
    <p style="margin-top:20px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: _________</p>
    <p>Ø®ØªÙ… Ø§Ù„Ù…Ø¹Ù‡Ø¯: _________</p>
  </div>`;
  
  const w = window.open("","_blank");
  w.document.write(html);
  w.print();
}

await loadStudents();
await loadLessons();
</script>
</body>
</html>
