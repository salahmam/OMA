<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA</title>
<style>
body { font-family:'Cairo',sans-serif; background:#f5f9ff; padding:20px; }
h2 { color:#004aad; }
pre { background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.1); overflow:auto; }
button { background:#004aad; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; margin-top:10px; }
</style>
</head>
<body>

<h2>ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA â€” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†</h2>
<pre id="log"></pre>
<button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logEl = document.getElementById("log");
function log(msg){ logEl.textContent += msg + "\n"; }

document.getElementById("startBtn").addEventListener("click", async ()=>{
  logEl.textContent = '';
  log("âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");

  try{
    // ğŸ”¹ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const instSnap = await getDocs(collection(db,'institutes'));
    for(const docSnap of instSnap.docs){
      await deleteDoc(doc(db,'institutes',docSnap.id));
      log(`ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${docSnap.data().name}`);
    }

    // ğŸ”¹ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ† (Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†)
    const usersSnap = await getDocs(collection(db,'users'));
    for(const uDoc of usersSnap.docs){
      try{
        await deleteDoc(doc(db,'users',uDoc.id));
        log(`ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${uDoc.data().email}`);
      }catch(e){ log(`âš ï¸ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${uDoc.data().email}`); }
    }

    // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
    const institutes = [
      {
        name: "Ù…Ø¹Ù‡Ø¯ OMA - Ø¨ØºØ¯Ø§Ø¯",
        adminEmail: "baghdad.admin@test.com",
        adminPassword: "Test1234",
        colors: { primary:'#004aad', bg:'#f5f9ff', card:'#ffffff', accent:'#ffcc33' },
        subscriptionType: "trial",
        trialDays: 30
      },
      {
        name: "Ù…Ø¹Ù‡Ø¯ OMA - Ø§Ù„Ø¨ØµØ±Ø©",
        adminEmail: "basra.admin@test.com",
        adminPassword: "Test1234",
        colors: { primary:'#2e7d32', bg:'#e8f5e9', card:'#ffffff', accent:'#ffcc33' },
        subscriptionType: "trial",
        trialDays: 30
      }
    ];

    for(const inst of institutes){
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Auth
      let userCred;
      try{
        userCred = await createUserWithEmailAndPassword(auth, inst.adminEmail, inst.adminPassword);
        log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…: ${inst.adminEmail}`);
      }catch(err){
        if(err.code === 'auth/email-already-in-use'){
          log(`âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: ${inst.adminEmail} - Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡`);
          userCred = { user: { uid: inst.adminEmail.replace(/[@.]/g,'_') } }; // Ù…Ø¹Ø±Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
        }else throw err;
      }

      const adminId = userCred.user.uid;

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø¹Ù‡Ø¯
      const instRef = doc(collection(db,'institutes'));
      await setDoc(instRef, {
        name: inst.name,
        adminId,
        adminEmail: inst.adminEmail,
        colors: inst.colors,
        subscriptionType: inst.subscriptionType,
        trialDays: inst.trialDays,
        createdAt: new Date().toISOString()
      });
      log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${inst.name} (ID: ${instRef.id})`);

      // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯
      await setDoc(doc(db,'users',adminId), {
        email: inst.adminEmail,
        type: 'instituteAdmin',
        instituteId: instRef.id
      });
      log(`âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯`);
    }

    log("\nğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");

  }catch(err){
    log("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: " + err.message);
    console.error(err);
  }
});
</script>

</body>
</html>