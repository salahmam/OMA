<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - OMA</title>
<style>
body { font-family: 'Cairo', sans-serif; background:#f5f9ff; margin:0; color:#102027; }
header { background:#004aad; color:white; text-align:center; padding:18px; font-size:20px; font-weight:bold; }
.wrap { max-width:1200px; margin:20px auto; padding:12px; }
input, select { padding:8px; border-radius:6px; border:1px solid #d6dde9; width:100%; font-size:14px; margin-bottom:10px;}
button { padding:10px 14px; border:none; border-radius:6px; cursor:pointer; background:#004aad; color:white; font-weight:700; margin-top:6px;}
table { width:100%; border-collapse: collapse; margin-top:12px; }
th, td { padding:8px; border:1px solid #ddd; text-align:center; font-size:14px; }
th { background:#004aad; color:white; }
.actions button { margin:0 4px; font-size:12px; }
.modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal.open{display:flex;}
.modal .box{background:white; padding:16px; border-radius:10px; max-width:900px; width:95%; max-height:90vh; overflow:auto;}
.subject-table th, .subject-table td{border:1px solid #ccc; padding:6px; font-size:13px;}
.signature {margin-top:30px; display:flex; justify-content:space-between; }
.signature div { text-align:center; width:40%; }
.add-payment { margin:10px 0; }

/* Ø·Ø¨Ø§Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¹Ù„Ù‰ A4 */
@media print {
  body{background:white; color:black;}
  header, .wrap > :not(.print-page){display:none;}
  .print-page { width:210mm; min-height:297mm; margin:0 auto; padding:20mm; box-sizing:border-box; display:block; }
  table, th, td { border:1px solid black; }
  th, td { padding:8px; font-size:12pt; }
  h2,h3 { margin:4px 0; }
}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</header>
<div class="wrap">

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div class="card">
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
    <table id="studentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="modal" class="modal">
  <div class="box">
    <button onclick="closeModal()" style="float:left;">Ø¥ØºÙ„Ø§Ù‚</button>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tableBody = document.querySelector('#studentsTable tbody');
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');

async function loadStudents() {
  tableBody.innerHTML='';
  const snapshot = await getDocs(collection(db,'students'));
  snapshot.forEach(docSnap=>{
    const st = docSnap.data();
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${st.name}</td>
      <td>${st.phone}</td>
      <td>${st.stage}</td>
      <td>${st.group}</td>
      <td>
        <button onclick="showStudent('${docSnap.id}')" style="padding:6px 10px;">Ø§Ø³ØªÙ…Ø§Ø±Ø© / Ø·Ø¨Ø§Ø¹Ø©</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

async function showStudent(id){
  const docRef = doc(db,'students',id);
  const docSnap = await getDoc(docRef);
  const st = docSnap.data();

  modalBody.innerHTML=`
    <div class="print-page">
      <h2 style="text-align:center;">Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
      <table style="width:100%; margin-top:10px;">
        <tr><td>Ø§Ù„Ø§Ø³Ù…:</td><td>${st.name}</td></tr>
        <tr><td>Ø§Ù„Ù‡Ø§ØªÙ:</td><td>${st.phone}</td></tr>
        <tr><td>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td>${st.address||'-'}</td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</td><td>${st.school||'-'}</td></tr>
        <tr><td>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</td><td>${st.stage||'-'}</td></tr>
        <tr><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</td><td>${st.group||'-'}</td></tr>
        <tr><td>Ù…Ù„Ø§Ø­Ø¸Ø©:</td><td>${st.note||'-'}</td></tr>
      </table>

      <h3 style="margin-top:20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h3>
      <table class="subject-table" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø·</th>
            <th>Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</th>
          </tr>
        </thead>
        <tbody>
          ${st.subjects.map((sub,index)=>{
            const paid = sub.payments ? sub.payments.reduce((a,p)=>a+p.amount,0) : 0;
            const remaining = sub.total - paid;
            const paymentsText = sub.payments ? sub.payments.map((p,i)=>`${i+1}. ${p.amount} Ø±ÙŠØ§Ù„ (${p.date})`).join('<br>') : '-';
            return `<tr>
              <td>${sub.name}</td>
              <td>${sub.total}</td>
              <td id="payments-${index}">${paymentsText}</td>
              <td id="remaining-${index}">${remaining}</td>
              <td>
                <input type="number" id="pay-input-${index}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="add-payment" onclick="addPayment('${id}',${index})">ğŸ’° Ø¥Ø¶Ø§ÙØ©</button>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>

      <div class="signature">
        <div>
          <hr>
          ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨
        </div>
        <div>
          <hr>
          Ø®ØªÙ… Ø§Ù„Ù…Ø¹Ù‡Ø¯
        </div>
      </div>
    </div>
    <button onclick="window.print()" style="margin-top:15px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
  `;
  modal.classList.add('open');
}

async function addPayment(studentId, subIndex){
  const amountInput = document.getElementById(`pay-input-${subIndex}`);
  const amount = parseFloat(amountInput.value);
  if(!amount || amount<=0){ alert('Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
  const date = new Date().toLocaleDateString('ar-EG');
  const studentRef = doc(db,'students',studentId);
  await updateDoc(studentRef,{
    [`subjects.${subIndex}.payments`]: arrayUnion({amount, date})
  });
  amountInput.value='';
  await showStudent(studentId);
}

function closeModal(){ modal.classList.remove('open'); }

loadStudents();
</script>
</body>
</html>