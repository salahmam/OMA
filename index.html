<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© OMA - SuperAdmin</title>
<style>
body{font-family:'Cairo',sans-serif;background:#f5f9ff;margin:0;padding:20px}
h2{text-align:center;color:#004aad;margin-bottom:20px}
#status{white-space:pre-wrap;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);max-height:500px;overflow:auto;}
button{padding:10px 15px;margin:10px auto;display:block;border:none;border-radius:8px;background:#004aad;color:#fff;font-weight:bold;cursor:pointer}
</style>
</head>
<body>

<h2>âš¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA</h2>
<button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø©</button>
<div id="status"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, serverTimestamp, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

function log(msg){ statusEl.textContent += msg + "\n"; statusEl.scrollTop = statusEl.scrollHeight; }

async function ensureUserInFirestore(email, uid, type){
  const usersRef = collection(db,"users");
  const userDocRef = doc(usersRef, uid);
  const snap = await getDoc(userDocRef);
  if(!snap.exists()){
    await setDoc(userDocRef, { uid, email, type, createdAt: serverTimestamp() });
    log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore: ${email}`);
  } else log(`â„¹ï¸ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§: ${email}`);
}

async function clearPreviousData(){
  log("ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...");
  const snap = await getDocs(collection(db,"institutes"));
  for(const d of snap.docs) await deleteDoc(doc(db,"institutes",d.id));
  const usersSnap = await getDocs(collection(db,"users"));
  for(const d of usersSnap.docs){
    if(d.data().type!=="superAdmin") await deleteDoc(doc(db,"users",d.id));
  }
  log("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©");
}

async function startSetup(){
  startBtn.disabled = true;
  statusEl.textContent = "âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø©...\n";

  try{
    await clearPreviousData();

    // 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ superAdmin
    const superAdmin = { email:"Salahalkaleefa@gmail.com", password:"123456salah", type:"superAdmin" };
    try{
      const cred = await createUserWithEmailAndPassword(auth, superAdmin.email, superAdmin.password);
      await ensureUserInFirestore(superAdmin.email, cred.user.uid, superAdmin.type);
      log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ SuperAdmin");
    }catch(err){
      if(err.code === "auth/email-already-in-use"){
        log("âš ï¸ Ø­Ø³Ø§Ø¨ SuperAdmin Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Firestore Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§");
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID
        const cred = await signInWithEmailAndPassword(auth, superAdmin.email, superAdmin.password);
        await ensureUserInFirestore(superAdmin.email, cred.user.uid, superAdmin.type);
      } else throw err;
    }

    // 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù‡Ø¯ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
    const institutes = [
      { name:"Ù…Ø¹Ù‡Ø¯ Ø¨ØºØ¯Ø§Ø¯", email:"admin1@mail.com", password:"Admin1234" },
      { name:"Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¨ØµØ±Ø©", email:"admin2@mail.com", password:"Admin1234" }
    ];

    for(const inst of institutes){
      try{
        const cred = await createUserWithEmailAndPassword(auth, inst.email, inst.password);
        const adminId = cred.user.uid;
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ users
        await ensureUserInFirestore(inst.email, adminId, "instituteAdmin");
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù‡Ø¯
        const docRef = doc(collection(db,"institutes"));
        await setDoc(docRef, {
          name: inst.name,
          adminId,
          adminEmail: inst.email,
          colors:{ primary:"#004aad", bg:"#f5f9ff", card:"#fff", accent:"#ffcc33" },
          subscriptionType:"trial",
          createdAt: serverTimestamp()
        });
        log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${inst.name} (${inst.email})`);
      }catch(err){
        if(err.code==="auth/email-already-in-use"){
          log(`âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${inst.email} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³ØªÙ†Ø¯ Firestore`);
          // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID
          const cred = await signInWithEmailAndPassword(auth, inst.email, inst.password);
          await ensureUserInFirestore(inst.email, cred.user.uid, "instituteAdmin");
        } else throw err;
      }
    }

    log("ğŸ‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­!");
  }catch(err){
    log("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: " + err.message);
  }
}

startBtn.addEventListener("click", startSetup);
</script>
</body>
</html>