<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… OMA</title>
<style>
body{font-family:'Cairo',sans-serif;background:#f5f9ff;margin:0;padding:20px;}
h2{color:#004aad;text-align:center;margin-bottom:20px;}
#log{white-space:pre-wrap;background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);height:400px;overflow:auto;}
button{padding:10px 15px;background:#004aad;color:white;border:none;border-radius:8px;cursor:pointer;margin-top:15px;}
button:hover{background:#003680;}
</style>
</head>
<body>
<h2>âš¡ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù†Ø¸Ø§Ù… OMA</h2>
<div id="log"></div>
<button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const logEl = document.getElementById('log');
function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

const firebaseConfig = {
  apiKey: "AIzaSyAMANgdrLgoGIjqLZOcS_qyEqCUOVC7gOU",
  authDomain: "oma0-33cc0.firebaseapp.com",
  projectId: "oma0-33cc0",
  storageBucket: "oma0-33cc0.firebasestorage.app",
  messagingSenderId: "899300774863",
  appId: "1:899300774863:web:0a81a7f5747ef37d49b8ba",
  measurementId: "G-5CKWYQT9XZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Ø¨ÙŠØ§Ù†Ø§Øª superAdmin
const superAdmin = { email:"Salahalkaleefa@gmail.com", password:"123456salah", type:"superAdmin" };

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ÙŠÙ† Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
const demoInstitutes = [
  { name:"Ù…Ø¹Ù‡Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø© 1", email:"demo1@oma.edu", password:"123456demo1", colors:{primary:"#004aad", bg:"#f5f9ff", card:"#fff", accent:"#ffcc33"}, plan:"trial", trialDays:30 },
  { name:"Ù…Ø¹Ù‡Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø© 2", email:"demo2@oma.edu", password:"123456demo2", colors:{primary:"#2e7d32", bg:"#f0f8f0", card:"#ffffff", accent:"#66bb6a"}, plan:"yearly" }
];

async function initSystem(){
  log("â³ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");
  try{
    // Ø¥Ø¶Ø§ÙØ© superAdmin
    log("ğŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ superAdmin...");
    const usersRef = collection(db,"users");
    const superDocRef = doc(usersRef, superAdmin.email);
    const superSnap = await getDoc(superDocRef);
    if(!superSnap.exists()){
      log("ğŸ”¸ superAdmin ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ FirestoreØŒ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡...");
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth
      try{
        const userCred = await createUserWithEmailAndPassword(auth, superAdmin.email, superAdmin.password);
        await setDoc(superDocRef, { uid:userCred.user.uid, email:superAdmin.email, type:"superAdmin", createdAt:serverTimestamp() });
        log("âœ… superAdmin ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Firestore");
      }catch(err){
        if(err.code === "auth/email-already-in-use"){
          log("âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ AuthØŒ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙ‚Ø· ÙÙŠ Firestore");
          // Ø¬Ù„Ø¨ UID Ù…Ù† Auth (Firebase Web SDK Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¬Ù„Ø¨ UID Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ ÙŠÙ…ÙƒÙ† Ø­Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„)
          await setDoc(superDocRef, { uid:"UNKNOWN_UID", email:superAdmin.email, type:"superAdmin", createdAt:serverTimestamp() });
          log("âœ… superAdmin Ø£Ø¶ÙŠÙ ÙÙŠ Firestore");
        }else{
          throw err;
        }
      }
    }else log("âœ… superAdmin Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Firestore");

    // Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    log("ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...");
    const instCol = collection(db,"institutes");
    const snaps = await getDocs(instCol);
    for(const s of snaps.docs) await deleteDoc(doc(db,"institutes",s.id));
    log("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù‡Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©");

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯ÙŠÙ† Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
    for(const inst of demoInstitutes){
      log(`ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${inst.name}`);
      let adminId = "";
      try{
        const userCred = await createUserWithEmailAndPassword(auth, inst.email, inst.password);
        adminId = userCred.user.uid;
        log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± (${inst.email})`);
      }catch(err){
        if(err.code==="auth/email-already-in-use"){
          log(`âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ ${inst.email} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯`);
          adminId = "EXISTING_UID"; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§
        }else throw err;
      }

      await addDoc(instCol,{
        name: inst.name,
        adminEmail: inst.email,
        adminId: adminId,
        colors: inst.colors,
        subscriptionType: inst.plan,
        trialDays: inst.trialDays || null,
        createdAt: serverTimestamp()
      });
      log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù‡Ø¯: ${inst.name}`);
    }

    log("ğŸ‰ ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ superAdmin Ø£Ùˆ Ø­Ø³Ø§Ø¨ Ø£ÙŠ Ù…Ø¹Ù‡Ø¯.");
  }catch(err){
    console.error(err);
    log("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: "+err.message);
  }
}

document.getElementById('startBtn').addEventListener('click', initSystem);
</script>
</body>
</html>